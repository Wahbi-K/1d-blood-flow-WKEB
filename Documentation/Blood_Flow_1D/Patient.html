<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 8.0.1" />
    <title>Blood_Flow_1D.Patient API documentation</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2264%22%20height%3D%2264%22%20viewBox%3D%2244.5%202.5%2015%2015%22%3E%3Cpath%20d%3D%22M49.351%2021.041c-.233-.721-.546-2.408-.772-4.076-.042-.09-.067-.187-.046-.288-.166-1.347-.277-2.625-.241-3.351-1.378-1.008-2.271-2.586-2.271-4.362%200-.976.272-1.935.788-2.774.057-.094.122-.18.184-.268-.033-.167-.052-.339-.052-.516%200-1.477%201.202-2.679%202.679-2.679.791%200%201.496.352%201.987.9a6.3%206.3%200%200%201%201.001.029c.492-.564%201.207-.929%202.012-.929%201.477%200%202.679%201.202%202.679%202.679a2.65%202.65%200%200%201-.269%201.148c.383.747.595%201.572.595%202.41%200%202.311-1.507%204.29-3.635%205.107.037.699.147%202.27.423%203.294l.137.461c.156%202.136-4.612%205.166-5.199%203.215zm.127-4.919a4.78%204.78%200%200%200%20.775-.584c-.172-.115-.505-.254-.88-.378zm.331%202.302l.828-.502c-.202-.143-.576-.328-.984-.49zm.45%202.157l.701-.403c-.214-.115-.536-.249-.891-.376l.19.779zM49.13%204.141c0%20.152.123.276.276.276s.275-.124.275-.276-.123-.276-.276-.276-.275.124-.275.276zm.735-.389a1.15%201.15%200%200%201%20.314.783%201.16%201.16%200%200%201-1.162%201.162c-.457%200-.842-.27-1.032-.653-.026.117-.042.238-.042.362a1.68%201.68%200%200%200%201.679%201.679%201.68%201.68%200%200%200%201.679-1.679c0-.843-.626-1.535-1.436-1.654zm3.076%201.654a1.68%201.68%200%200%200%201.679%201.679%201.68%201.68%200%200%200%201.679-1.679c0-.037-.009-.072-.011-.109-.21.3-.541.508-.935.508a1.16%201.16%200%200%201-1.162-1.162%201.14%201.14%200%200%201%20.474-.912c-.015%200-.03-.005-.045-.005-.926.001-1.679.754-1.679%201.68zm1.861-1.265c0%20.152.123.276.276.276s.275-.124.275-.276-.123-.276-.276-.276-.275.124-.275.276zm1.823%204.823c0-.52-.103-1.035-.288-1.52-.466.394-1.06.64-1.717.64-1.144%200-2.116-.725-2.499-1.738-.383%201.012-1.355%201.738-2.499%201.738-.867%200-1.631-.421-2.121-1.062-.307.605-.478%201.267-.478%201.942%200%202.486%202.153%204.51%204.801%204.51s4.801-2.023%204.801-4.51zm-3.032%209.156l-.146-.492c-.276-1.02-.395-2.457-.444-3.268a6.11%206.11%200%200%201-1.18.115%206.01%206.01%200%200%201-2.536-.562l.006.175c.802.215%201.848.612%202.021%201.25.079.295-.021.601-.274.837l-.598.501c.667.304%201.243.698%201.311%201.179.02.144.022.507-.393.787l-.564.365c1.285.521%201.361.96%201.381%201.126.018.142.011.496-.427.746l-.854.489c.064-1.19%201.985-2.585%202.697-3.248zM49.34%209.925c0-.667%201-.667%201%200%200%20.653.818%201.205%201.787%201.205s1.787-.552%201.787-1.205c0-.667%201-.667%201%200%200%201.216-1.25%202.205-2.787%202.205s-2.787-.989-2.787-2.205zm-.887-7.633c-.093.077-.205.114-.317.114a.5.5%200%200%201-.318-.886L49.183.397a.5.5%200%200%201%20.703.068.5.5%200%200%201-.069.703zm7.661-.065c-.086%200-.173-.022-.253-.068l-1.523-.893c-.575-.337-.069-1.2.506-.863l1.523.892a.5.5%200%200%201%20.179.685c-.094.158-.261.247-.432.247z%22%20fill%3D%22%233bb300%22/%3E%3C/svg%3E"/>


<style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
<style>/*! pygments syntax highlighting */pre{line-height:125%;}td.linenos pre{color:#000000; background-color:#f0f0f0; padding-left:5px; padding-right:5px;}span.linenos{color:#000000; background-color:#f0f0f0; padding-left:5px; padding-right:5px;}td.linenos pre.special{color:#000000; background-color:#ffffc0; padding-left:5px; padding-right:5px;}span.linenos.special{color:#000000; background-color:#ffffc0; padding-left:5px; padding-right:5px;}.pdoc .hll{background-color:#ffffcc}.pdoc{background:#f8f8f8;}.pdoc .c{color:#408080; font-style:italic}.pdoc .err{border:1px solid #FF0000}.pdoc .k{color:#008000; font-weight:bold}.pdoc .o{color:#666666}.pdoc .ch{color:#408080; font-style:italic}.pdoc .cm{color:#408080; font-style:italic}.pdoc .cp{color:#BC7A00}.pdoc .cpf{color:#408080; font-style:italic}.pdoc .c1{color:#408080; font-style:italic}.pdoc .cs{color:#408080; font-style:italic}.pdoc .gd{color:#A00000}.pdoc .ge{font-style:italic}.pdoc .gr{color:#FF0000}.pdoc .gh{color:#000080; font-weight:bold}.pdoc .gi{color:#00A000}.pdoc .go{color:#888888}.pdoc .gp{color:#000080; font-weight:bold}.pdoc .gs{font-weight:bold}.pdoc .gu{color:#800080; font-weight:bold}.pdoc .gt{color:#0044DD}.pdoc .kc{color:#008000; font-weight:bold}.pdoc .kd{color:#008000; font-weight:bold}.pdoc .kn{color:#008000; font-weight:bold}.pdoc .kp{color:#008000}.pdoc .kr{color:#008000; font-weight:bold}.pdoc .kt{color:#B00040}.pdoc .m{color:#666666}.pdoc .s{color:#BA2121}.pdoc .na{color:#7D9029}.pdoc .nb{color:#008000}.pdoc .nc{color:#0000FF; font-weight:bold}.pdoc .no{color:#880000}.pdoc .nd{color:#AA22FF}.pdoc .ni{color:#999999; font-weight:bold}.pdoc .ne{color:#D2413A; font-weight:bold}.pdoc .nf{color:#0000FF}.pdoc .nl{color:#A0A000}.pdoc .nn{color:#0000FF; font-weight:bold}.pdoc .nt{color:#008000; font-weight:bold}.pdoc .nv{color:#19177C}.pdoc .ow{color:#AA22FF; font-weight:bold}.pdoc .w{color:#bbbbbb}.pdoc .mb{color:#666666}.pdoc .mf{color:#666666}.pdoc .mh{color:#666666}.pdoc .mi{color:#666666}.pdoc .mo{color:#666666}.pdoc .sa{color:#BA2121}.pdoc .sb{color:#BA2121}.pdoc .sc{color:#BA2121}.pdoc .dl{color:#BA2121}.pdoc .sd{color:#BA2121; font-style:italic}.pdoc .s2{color:#BA2121}.pdoc .se{color:#BB6622; font-weight:bold}.pdoc .sh{color:#BA2121}.pdoc .si{color:#BB6688; font-weight:bold}.pdoc .sx{color:#008000}.pdoc .sr{color:#BB6688}.pdoc .s1{color:#BA2121}.pdoc .ss{color:#19177C}.pdoc .bp{color:#008000}.pdoc .fm{color:#0000FF}.pdoc .vc{color:#19177C}.pdoc .vg{color:#19177C}.pdoc .vi{color:#19177C}.pdoc .vm{color:#19177C}.pdoc .il{color:#666666}</style>
<style>/*! pdoc */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f7f7f7;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}body{background-color:var(--pdoc-background);}html, body{width:100%;height:100%;}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}.git-button{display:none !important;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}#navtoggle{display:none;}}#togglestate{display:none;}nav.pdoc{--pad:1.75rem;--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent }nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc li{display:block;margin:0;padding:.2rem 0 .2rem var(--indent);transition:all 100ms;}nav.pdoc > div > ul > li{padding-left:0;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}html, main{scroll-behavior:smooth;}.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{background-color:var(--code);border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--code);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.pdoc details{--shift:-40px;text-align:right;margin-top:var(--shift);margin-bottom:calc(0px - var(--shift));clear:both;filter:opacity(1);}.pdoc details:not([open]){height:0;overflow:visible;}.pdoc details > summary{font-size:.75rem;cursor:pointer;color:var(--muted);border-width:0;padding:0 .7em;display:inline-block;display:inline list-item;user-select:none;}.pdoc details > summary:focus{outline:0;}.pdoc details > div{margin-top:calc(0px - var(--shift) / 2);text-align:left;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc > section:first-of-type > .docstring{margin-bottom:3rem;}.pdoc .docstring pre{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc .headerlink{position:absolute;width:0;margin-left:-1.5rem;line-height:1.4rem;font-size:1.5rem;font-weight:normal;transition:all 100ms ease-in-out;opacity:0;}.pdoc .attr > .headerlink{margin-left:-2.5rem;}.pdoc *:hover > .headerlink,.pdoc *:target > .attr > .headerlink{opacity:1;}.pdoc .attr{display:block;color:var(--text);margin:1rem 0 .5rem;padding:.4rem 5rem .4rem 1rem;background-color:var(--accent);}.pdoc .classattr{margin-left:2rem;}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{white-space:pre-wrap;}.pdoc .annotation{color:var(--annotation);}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}</style>
</head>
<body>        <nav class="pdoc">
            <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
            <input id="togglestate" type="checkbox">
            <div>
                        <a class="pdoc-button module-list-button" href="../Blood_Flow_1D.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                            &nbsp;Blood_Flow_1D</a>


                        <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                               pattern=".+" required>



                    <h2>API Documentation</h2>
                        <ul class="memberlist">
            <li>
                    <a class="class" href="#Patient">Patient</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#Patient.__init__">Patient</a>
                        </li>
                        <li>
                                <a class="variable" href="#Patient.pool">pool</a>
                        </li>
                        <li>
                                <a class="function" href="#Patient.RedefineDirectionByFlowDirection">RedefineDirectionByFlowDirection</a>
                        </li>
                        <li>
                                <a class="function" href="#Patient.RemoveOldSimFiles">RemoveOldSimFiles</a>
                        </li>
                        <li>
                                <a class="function" href="#Patient.ResetModellingFolder">ResetModellingFolder</a>
                        </li>
                        <li>
                                <a class="function" href="#Patient.LoadBFSimFiles">LoadBFSimFiles</a>
                        </li>
                        <li>
                                <a class="function" href="#Patient.LoadResults">LoadResults</a>
                        </li>
                        <li>
                                <a class="function" href="#Patient.GetMeanResults">GetMeanResults</a>
                        </li>
                        <li>
                                <a class="function" href="#Patient.ExportMeanResults">ExportMeanResults</a>
                        </li>
                        <li>
                                <a class="function" href="#Patient.LoadPatientData">LoadPatientData</a>
                        </li>
                        <li>
                                <a class="function" href="#Patient.LoadClusteringMapping">LoadClusteringMapping</a>
                        </li>
                        <li>
                                <a class="function" href="#Patient.LoadModelParameters">LoadModelParameters</a>
                        </li>
                        <li>
                                <a class="function" href="#Patient.LoadSegmentedVessels">LoadSegmentedVessels</a>
                        </li>
                        <li>
                                <a class="function" href="#Patient.Load1DAnatomy">Load1DAnatomy</a>
                        </li>
                        <li>
                                <a class="function" href="#Patient.Load3DTopFile">Load3DTopFile</a>
                        </li>
                        <li>
                                <a class="function" href="#Patient.LoadPositions">LoadPositions</a>
                        </li>
                        <li>
                                <a class="function" href="#Patient.ClusteringByRegion">ClusteringByRegion</a>
                        </li>
                        <li>
                                <a class="function" href="#Patient.SetFolder">SetFolder</a>
                        </li>
                        <li>
                                <a class="function" href="#Patient.TopologyToVTP">TopologyToVTP</a>
                        </li>
                        <li>
                                <a class="function" href="#Patient.SaveVesselAtlas">SaveVesselAtlas</a>
                        </li>
                        <li>
                                <a class="function" href="#Patient.LoadVTPFile">LoadVTPFile</a>
                        </li>
                        <li>
                                <a class="function" href="#Patient.WriteClusteringMapping">WriteClusteringMapping</a>
                        </li>
                        <li>
                                <a class="function" href="#Patient.WriteModelParameters">WriteModelParameters</a>
                        </li>
                        <li>
                                <a class="function" href="#Patient.CalculateMaximumTimestep">CalculateMaximumTimestep</a>
                        </li>
                        <li>
                                <a class="function" href="#Patient.CalculateDistanceFromTheHeart">CalculateDistanceFromTheHeart</a>
                        </li>
                        <li>
                                <a class="function" href="#Patient.CalculateTimedelayFromTheHeart">CalculateTimedelayFromTheHeart</a>
                        </li>
                        <li>
                                <a class="function" href="#Patient.UpdateNodeType">UpdateNodeType</a>
                        </li>
                        <li>
                                <a class="function" href="#Patient.CorrectforDirectionVectorOutlets">CorrectforDirectionVectorOutlets</a>
                        </li>
                        <li>
                                <a class="function" href="#Patient.CerebellumBrainstemMapping">CerebellumBrainstemMapping</a>
                        </li>
                        <li>
                                <a class="function" href="#Patient.calculate_wk_parameters">calculate_wk_parameters</a>
                        </li>
                        <li>
                                <a class="function" href="#Patient.calculate_wk_parameters_evenly">calculate_wk_parameters_evenly</a>
                        </li>
                        <li>
                                <a class="function" href="#Patient.WriteSimFiles">WriteSimFiles</a>
                        </li>
                        <li>
                                <a class="function" href="#Patient.ExportSurface">ExportSurface</a>
                        </li>
                        <li>
                                <a class="function" href="#Patient.SelectPatient">SelectPatient</a>
                        </li>
                        <li>
                                <a class="function" href="#Patient.SelectDonorNetwork">SelectDonorNetwork</a>
                        </li>
                        <li>
                                <a class="function" href="#Patient.UpdateModelParameters">UpdateModelParameters</a>
                        </li>
                        <li>
                                <a class="function" href="#Patient.WriteFlowProfilesAlastruey2007">WriteFlowProfilesAlastruey2007</a>
                        </li>
                        <li>
                                <a class="function" href="#Patient.WriteFlowProfiles">WriteFlowProfiles</a>
                        </li>
                        <li>
                                <a class="function" href="#Patient.VesselToMeshAllignmentSides">VesselToMeshAllignmentSides</a>
                        </li>
                        <li>
                                <a class="function" href="#Patient.ApplyTransformation">ApplyTransformation</a>
                        </li>
                        <li>
                                <a class="function" href="#Patient.FindCouplingPoints">FindCouplingPoints</a>
                        </li>
                        <li>
                                <a class="function" href="#Patient.RemoveCoWOutletsFromPerfusion">RemoveCoWOutletsFromPerfusion</a>
                        </li>
                        <li>
                                <a class="function" href="#Patient.WriteCouplingPointsFile">WriteCouplingPointsFile</a>
                        </li>
                        <li>
                                <a class="function" href="#Patient.WriteClotFile">WriteClotFile</a>
                        </li>
                        <li>
                                <a class="function" href="#Patient.WriteTopologyFile">WriteTopologyFile</a>
                        </li>
                        <li>
                                <a class="function" href="#Patient.WriteParFile">WriteParFile</a>
                        </li>
                        <li>
                                <a class="function" href="#Patient.WriteRunFile">WriteRunFile</a>
                        </li>
                        <li>
                                <a class="function" href="#Patient.GenerateTreesAtCps">GenerateTreesAtCps</a>
                        </li>
                        <li>
                                <a class="function" href="#Patient.GenerateTrees">GenerateTrees</a>
                        </li>
                        <li>
                                <a class="function" href="#Patient.getTotalEndsofTrees">getTotalEndsofTrees</a>
                        </li>
                        <li>
                                <a class="function" href="#Patient.PerfusionEndsNumber">PerfusionEndsNumber</a>
                        </li>
                        <li>
                                <a class="function" href="#Patient.GenerateTree">GenerateTree</a>
                        </li>
                        <li>
                                <a class="function" href="#Patient.TreesToTopology">TreesToTopology</a>
                        </li>
                        <li>
                                <a class="function" href="#Patient.AddTreesToTop">AddTreesToTop</a>
                        </li>
                        <li>
                                <a class="function" href="#Patient.TreeEndsToEndNodes">TreeEndsToEndNodes</a>
                        </li>
                        <li>
                                <a class="function" href="#Patient.LoadClusters">LoadClusters</a>
                        </li>
                        <li>
                                <a class="function" href="#Patient.LoadSurfaceMapping">LoadSurfaceMapping</a>
                        </li>
                        <li>
                                <a class="function" href="#Patient.DistributeFlowVertex">DistributeFlowVertex</a>
                        </li>
                        <li>
                                <a class="function" href="#Patient.GetMeanFlowRates">GetMeanFlowRates</a>
                        </li>
                        <li>
                                <a class="function" href="#Patient.DistributeFlowTriangles">DistributeFlowTriangles</a>
                        </li>
                        <li>
                                <a class="function" href="#Patient.WriteTimeseriesVessels">WriteTimeseriesVessels</a>
                        </li>
                        <li>
                                <a class="function" href="#Patient.ImportClotNodeFile">ImportClotNodeFile</a>
                        </li>
                        <li>
                                <a class="function" href="#Patient.ImportClots">ImportClots</a>
                        </li>
                        <li>
                                <a class="function" href="#Patient.ShowResults">ShowResults</a>
                        </li>
                        <li>
                                <a class="function" href="#Patient.MappingSixMajorArteries">MappingSixMajorArteries</a>
                        </li>
                        <li>
                                <a class="function" href="#Patient.ExportDualClustering">ExportDualClustering</a>
                        </li>
                        <li>
                                <a class="function" href="#Patient.ExportTriangleFlowData">ExportTriangleFlowData</a>
                        </li>
                        <li>
                                <a class="function" href="#Patient.MajorArteriesToPialSurfaceNN">MajorArteriesToPialSurfaceNN</a>
                        </li>
                        <li>
                                <a class="function" href="#Patient.MajorArteriesToPialSurfaceOutlets">MajorArteriesToPialSurfaceOutlets</a>
                        </li>
                        <li>
                                <a class="function" href="#Patient.WriteRegionMapping">WriteRegionMapping</a>
                        </li>
                        <li>
                                <a class="function" href="#Patient.LoadRegionMapping">LoadRegionMapping</a>
                        </li>
                        <li>
                                <a class="function" href="#Patient.Initiate1DSteadyStateModel">Initiate1DSteadyStateModel</a>
                        </li>
                        <li>
                                <a class="function" href="#Patient.Solve1DSteadyState">Solve1DSteadyState</a>
                        </li>
                        <li>
                                <a class="function" href="#Patient.Solve1DSteadyStateNonLinear">Solve1DSteadyStateNonLinear</a>
                        </li>
                        <li>
                                <a class="function" href="#Patient.UpdateOutletResistanceToPialSurface">UpdateOutletResistanceToPialSurface</a>
                        </li>
                        <li>
                                <a class="function" href="#Patient.UpdatePressureCouplingPoints">UpdatePressureCouplingPoints</a>
                        </li>
                        <li>
                                <a class="function" href="#Patient.UpdateFlowRateCouplingPoints">UpdateFlowRateCouplingPoints</a>
                        </li>
                        <li>
                                <a class="function" href="#Patient.Run1DSteadyStateModel">Run1DSteadyStateModel</a>
                        </li>
                        <li>
                                <a class="function" href="#Patient.Results1DSteadyStateModel">Results1DSteadyStateModel</a>
                        </li>
                        <li>
                                <a class="function" href="#Patient.Export1DSteadyClusterFlowRate">Export1DSteadyClusterFlowRate</a>
                        </li>
                        <li>
                                <a class="function" href="#Patient.ExportClotBFValues">ExportClotBFValues</a>
                        </li>
                </ul>

            </li>
    </ul>



                    <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev">
                        built with <span class="visually-hidden">pdoc</span><img
                            alt="pdoc logo"
                            src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
                    </a>
            </div>
        </nav>
    <main class="pdoc">
            <section>
                    <h1 class="modulename">
<a href="./../Blood_Flow_1D.html">Blood_Flow_1D</a><wbr>.Patient    </h1>

                        <div class="docstring"><p>Contains the Patient object class.</p>
</div>

                        <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span><span class="ch">#!/usr/bin/python3</span>
<span class="c1"># -*- coding:utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Contains the Patient object class.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">csv</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="kn">import</span> <span class="nn">networkx</span> <span class="k">as</span> <span class="nn">nx</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">scipy</span>
<span class="kn">import</span> <span class="nn">scipy.integrate</span>
<span class="kn">import</span> <span class="nn">scipy.spatial</span>
<span class="kn">import</span> <span class="nn">vtk</span>
<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">newton</span>
<span class="kn">from</span> <span class="nn">scipy.sparse.linalg</span> <span class="kn">import</span> <span class="n">spsolve</span> <span class="k">as</span> <span class="n">spsolve</span>
<span class="kn">from</span> <span class="nn">vtk.util.numpy_support</span> <span class="kn">import</span> <span class="n">vtk_to_numpy</span>

<span class="kn">from</span> <span class="nn">Blood_Flow_1D</span> <span class="kn">import</span> <span class="n">BloodFlowEquations</span><span class="p">,</span> <span class="n">Constants</span><span class="p">,</span> <span class="n">GeneralFunctions</span><span class="p">,</span> <span class="n">Metadata</span><span class="p">,</span> <span class="n">Perfusion</span><span class="p">,</span> <span class="n">Results</span><span class="p">,</span> <span class="n">Topology</span>


<span class="k">class</span> <span class="nc">Patient</span><span class="p">:</span>
    <span class="n">pool</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">folder</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]))):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initiate the patient object with default values.</span>
<span class="sd">        :param folder: path to the main folder.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">folder</span> <span class="o">=</span> <span class="n">folder</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Folders</span> <span class="o">=</span> <span class="n">Metadata</span><span class="o">.</span><span class="n">Folders</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ModelParameters</span> <span class="o">=</span> <span class="n">Metadata</span><span class="o">.</span><span class="n">ModelParameter</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">PatientData</span> <span class="o">=</span> <span class="n">Metadata</span><span class="o">.</span><span class="n">PatientData</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span> <span class="o">=</span> <span class="n">Topology</span><span class="o">.</span><span class="n">Topology</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Results</span> <span class="o">=</span> <span class="n">Results</span><span class="o">.</span><span class="n">Results</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Perfusion</span> <span class="o">=</span> <span class="n">Perfusion</span><span class="o">.</span><span class="n">Perfusion</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">Trees</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Patient folder: &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">PatientFolder</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">RedefineDirectionByFlowDirection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reverses the order of the nodes in each vessel if the flow inside the vessel is negative.</span>
<span class="sd">        This simple defines the positive flow direction to be the direction of flow.</span>
<span class="sd">        :return: Nothing</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">flowdict</span> <span class="o">=</span> <span class="p">{</span><span class="n">vessel</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">vessel</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">MeanResults</span><span class="p">}</span>

        <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Vessels</span><span class="p">:</span>
            <span class="c1"># get the volumeflowrate</span>
            <span class="n">volumeflowrate</span> <span class="o">=</span> <span class="n">flowdict</span><span class="p">[</span><span class="n">vessel</span><span class="o">.</span><span class="n">Name</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">volumeflowrate</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Vessel Reversed&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">RemoveOldSimFiles</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Remove results from previous 1-D blood flow simulations.</span>
<span class="sd">        :return: Nothing</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">folder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">ModellingFolder</span>
        <span class="n">deletelist</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Results.dyn&quot;</span><span class="p">,</span> <span class="s2">&quot;ResultsPrev.dyn&quot;</span><span class="p">,</span> <span class="s2">&quot;ResultsTotal.dyn&quot;</span><span class="p">,</span> <span class="s2">&quot;Convergence.csv&quot;</span><span class="p">,</span> <span class="s2">&quot;Conv.txt&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">deletelist</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">folder</span> <span class="o">+</span> <span class="n">name</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">folder</span> <span class="o">+</span> <span class="n">name</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                    <span class="k">pass</span>
        <span class="n">deletefolder</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;TimeSeries&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">deletefolder</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">folder</span> <span class="o">+</span> <span class="n">name</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">ResetModellingFolder</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">folder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">ModellingFolder</span>
        <span class="n">filenames</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">f</span><span class="p">))]</span>
        <span class="n">blacklist</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;boundary_4&amp;21&amp;22&amp;23&amp;24&amp;25&amp;26&amp;30.h5&quot;</span><span class="p">,</span> <span class="s2">&quot;boundary_4&amp;21&amp;22&amp;23&amp;24&amp;25&amp;26&amp;30.ply&quot;</span><span class="p">,</span>
                     <span class="s2">&quot;Boundary.ply&quot;</span><span class="p">,</span> <span class="s2">&quot;labelled_vol_mesh_high.msh&quot;</span><span class="p">,</span> <span class="s2">&quot;labelled_vol_mesh.msh&quot;</span><span class="p">,</span>
                     <span class="s2">&quot;permeability_tensors.h5&quot;</span><span class="p">,</span> <span class="s2">&quot;Model_parameters.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;PialSurface.vtp&quot;</span><span class="p">,</span> <span class="s2">&quot;Distancemat.npy&quot;</span><span class="p">,</span> <span class="s2">&quot;PA.vtp&quot;</span><span class="p">,</span>
                     <span class="s2">&quot;DualPA.vtp&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">filenames</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">blacklist</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">folder</span> <span class="o">+</span> <span class="n">name</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Deleting file: &quot;</span><span class="p">,</span> <span class="n">folder</span> <span class="o">+</span> <span class="n">name</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error while deleting file: &quot;</span><span class="p">,</span> <span class="n">folder</span> <span class="o">+</span> <span class="n">name</span><span class="p">)</span>

        <span class="n">folders</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">f</span><span class="p">))]</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">folders</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">folder</span> <span class="o">+</span> <span class="n">name</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error while deleting file &quot;</span><span class="p">,</span> <span class="n">folder</span> <span class="o">+</span> <span class="n">name</span><span class="p">)</span>

        <span class="c1"># try:</span>
        <span class="c1">#     shutil.rmtree(self.Folders.PatientFolder + &quot;logfile.log&quot;)</span>
        <span class="c1"># except:</span>
        <span class="c1">#     print(&quot;Error while deleting file &quot;, folder + name)</span>

    <span class="k">def</span> <span class="nf">LoadBFSimFiles</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">LoadBFSimFiles</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">ModellingFolder</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">LoadPatientData</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">LoadModelParameters</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">LoadRegionMapping</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">LoadResults</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="s2">&quot;Results.dyn&quot;</span><span class="p">,</span> <span class="n">correct</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">LoadResults</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">ModellingFolder</span> <span class="o">+</span> <span class="n">file</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">correct</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">CorrectforDirectionVectorOutlets</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">CalculateVelocity</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">CalculateMeanResultsPerNode</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">node</span><span class="p">,</span> <span class="n">pressure</span><span class="p">,</span> <span class="n">volumeflowrate</span><span class="p">,</span> <span class="n">velocity</span><span class="p">,</span> <span class="n">radius</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Nodes</span><span class="p">,</span>
                                                                    <span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">Pressure</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                                    <span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">VolumeFlowRate</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                                    <span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">Velocity</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                                    <span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">Radius</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">node</span><span class="o">.</span><span class="n">Pressure</span> <span class="o">=</span> <span class="n">pressure</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">node</span><span class="o">.</span><span class="n">FlowRate</span> <span class="o">=</span> <span class="n">volumeflowrate</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">node</span><span class="o">.</span><span class="n">Velocity</span> <span class="o">=</span> <span class="n">velocity</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">node</span><span class="o">.</span><span class="n">Radius</span> <span class="o">=</span> <span class="n">radius</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">GetMeanResults</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">GetMeanResults</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Vessels</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">ExportMeanResults</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="s2">&quot;ResultsPerVessel.csv&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">ExportMeanResults</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">ModellingFolder</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">LoadPatientData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="s2">&quot;config.xml&quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">file</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span> <span class="o">==</span> <span class="s2">&quot;txt&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">PatientData</span><span class="o">.</span><span class="n">LoadPatientData</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">InputFolder</span> <span class="o">+</span> <span class="n">file</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">file</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span> <span class="o">==</span> <span class="s2">&quot;xml&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">PatientData</span><span class="o">.</span><span class="n">LoadPatientDataXML</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">InputFolder</span> <span class="o">+</span> <span class="n">file</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">file</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span> <span class="o">==</span> <span class="s2">&quot;yml&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">PatientData</span><span class="o">.</span><span class="n">LoadPatientDataYML</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">InputFolder</span> <span class="o">+</span> <span class="n">file</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;File open error&quot;</span><span class="p">)</span>
            <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">LoadClusteringMapping</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Load Clustering map to file: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">file</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">)][</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">cp</span> <span class="o">=</span> <span class="n">Perfusion</span><span class="o">.</span><span class="n">CouplingPoint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">])])</span>
            <span class="n">cp</span><span class="o">.</span><span class="n">Node</span><span class="o">.</span><span class="n">Position</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)]</span>
            <span class="n">cp</span><span class="o">.</span><span class="n">NumberOfTriangles</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">cp</span><span class="o">.</span><span class="n">Area</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
            <span class="n">cp</span><span class="o">.</span><span class="n">Node</span><span class="o">.</span><span class="n">MajorVesselID</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Perfusion</span><span class="o">.</span><span class="n">CouplingPoints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cp</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">LoadModelParameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="s2">&quot;Model_parameters.txt&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ModelParameters</span><span class="o">.</span><span class="n">LoadModelParameters</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">ModellingFolder</span> <span class="o">+</span> <span class="n">file</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">LoadSegmentedVessels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">CoWFile</span><span class="o">=</span><span class="s2">&quot;1-D_Anatomy.txt&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">LoadSegmentedVessels</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">InputFolder</span><span class="p">,</span> <span class="n">CoWFile</span><span class="o">=</span><span class="n">CoWFile</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">Load1DAnatomy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="s2">&quot;1-D_Anatomy_Patient.txt&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Load1DAnatomy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">InputFolder</span> <span class="o">+</span> <span class="n">file</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">Load3DTopFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="s2">&quot;0_2_cutoff.top&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Read3DNodesFromTopFile</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">CheckConnectivity</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">AnatomyToVessels</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">LoadPositions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">vtpfile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">ModellingFolder</span> <span class="o">+</span> <span class="s2">&quot;Topology.vtp&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Loading </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">vtpfile</span><span class="p">)</span>
        <span class="n">reader</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkXMLPolyDataReader</span><span class="p">()</span>
        <span class="n">reader</span><span class="o">.</span><span class="n">SetFileName</span><span class="p">(</span><span class="n">vtpfile</span><span class="p">)</span>
        <span class="n">reader</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span>
        <span class="n">pos_vtk</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">()</span><span class="o">.</span><span class="n">GetPoints</span><span class="p">()</span><span class="o">.</span><span class="n">GetData</span><span class="p">()</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="n">vtk_to_numpy</span><span class="p">(</span><span class="n">pos_vtk</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Nodes</span><span class="p">):</span>
            <span class="n">node</span><span class="o">.</span><span class="n">SetPosition</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="n">index</span><span class="p">]))</span>

    <span class="k">def</span> <span class="nf">ClusteringByRegion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dualgraph</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Perfusion</span><span class="o">.</span><span class="n">ClusteringByRegion</span><span class="p">(</span><span class="n">dualgraph</span><span class="p">,</span> <span class="n">method</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">SetFolder</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">folder</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">SetPatientFolder</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">TopologyToVTP</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s2">&quot;Topology.vtp&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">TopologyToVTP</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">ModellingFolder</span> <span class="o">+</span> <span class="n">filename</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">SaveVesselAtlas</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s2">&quot;Mapping.csv&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">SaveVesselAtlas</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">ModellingFolder</span> <span class="o">+</span> <span class="n">filename</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">LoadVTPFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vtpfile</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">LoadVTPFile</span><span class="p">(</span><span class="n">vtpfile</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">WriteClusteringMapping</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s2">&quot;Clusters.csv&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Perfusion</span><span class="o">.</span><span class="n">WriteClusteringMapping</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">ModellingFolder</span> <span class="o">+</span> <span class="n">filename</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">WriteModelParameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">ModellingFolder</span> <span class="o">+</span> <span class="s2">&quot;Model_parameters.txt&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Writing the Model parameters to </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">file</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ModelParameters</span><span class="o">.</span><span class="n">WriteModelParameters</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">CalculateMaximumTimestep</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">timestep</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">CalculateMaximumTimestep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ModelParameters</span><span class="p">[</span><span class="s2">&quot;Density&quot;</span><span class="p">])</span>
        <span class="n">t</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">format</span><span class="p">(</span><span class="n">timestep</span><span class="p">,</span> <span class="s1">&#39;1.1e&#39;</span><span class="p">))</span>
        <span class="c1"># iterations = numpy.ceil(self.ModelParameters[&quot;Beat_Duration&quot;] / t)</span>
        <span class="c1"># t= self.ModelParameters[&quot;Beat_Duration&quot;] / iterations</span>
        <span class="c1"># if timestep &lt; self.ModelParameters[&quot;TIMESTEP&quot;]:</span>
        <span class="c1">#     print(&quot;Warning: Simulation can be unstable!&quot;)</span>
        <span class="c1">#     print(&quot;Timestep exceeds the maximum timestep.&quot;)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Timestep set to maximum timestep: </span><span class="si">%1.1e</span><span class="s2"> s&quot;</span> <span class="o">%</span> <span class="n">t</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ModelParameters</span><span class="p">[</span><span class="s2">&quot;TIMESTEP&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span>

    <span class="k">def</span> <span class="nf">CalculateDistanceFromTheHeart</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the distance from the heart in the shortest sense bansed on Dijkstra&#39;s distance.</span>
<span class="sd">        Direction is determined by the positive pressure direction.</span>
<span class="sd">        :return: Nothing</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Graph</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">TopologyToGraph</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Graph</span><span class="o">.</span><span class="n">edges</span><span class="p">:</span>
            <span class="n">node1</span> <span class="o">=</span> <span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">node2</span> <span class="o">=</span> <span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">p1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">MeanPressurePerNode</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">node1</span><span class="o">.</span><span class="n">Number</span><span class="p">]</span>
            <span class="n">p2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">MeanPressurePerNode</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">node2</span><span class="o">.</span><span class="n">Number</span><span class="p">]</span>

            <span class="n">dp</span> <span class="o">=</span> <span class="n">p1</span> <span class="o">-</span> <span class="n">p2</span>
            <span class="n">dx</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Graph</span><span class="p">[</span><span class="n">node1</span><span class="p">][</span><span class="n">node2</span><span class="p">][</span><span class="s1">&#39;weight&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">dp</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">dp</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Graph</span><span class="p">[</span><span class="n">node2</span><span class="p">][</span><span class="n">node1</span><span class="p">][</span><span class="s1">&#39;direction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dx</span>
            <span class="k">elif</span> <span class="n">dp</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Graph</span><span class="p">[</span><span class="n">node1</span><span class="p">][</span><span class="n">node2</span><span class="p">][</span><span class="s1">&#39;direction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dx</span>

        <span class="n">length</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">single_source_dijkstra</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Graph</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">weight</span><span class="o">=</span><span class="s1">&#39;direction&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Nodes</span><span class="p">:</span>
            <span class="n">node</span><span class="o">.</span><span class="n">DistancefromHeart</span> <span class="o">=</span> <span class="n">length</span><span class="p">[</span><span class="n">node</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">DistancefromHeart</span> <span class="o">=</span> <span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">DistancefromHeart</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Nodes</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">CalculateTimedelayFromTheHeart</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the timedelay from the heart in the shortest sense bansed on Dijkstra&#39;s distance.</span>
<span class="sd">        Direction is determined by the positive pressure direction.</span>
<span class="sd">        :return: Nothing</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Graph</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">TopologyToGraph</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Graph</span><span class="o">.</span><span class="n">edges</span><span class="p">:</span>
            <span class="n">node1</span> <span class="o">=</span> <span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">node2</span> <span class="o">=</span> <span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">v1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">MeanVelocityPerNode</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">node1</span><span class="o">.</span><span class="n">Number</span><span class="p">]</span>
            <span class="n">v2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">MeanVelocityPerNode</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">node2</span><span class="o">.</span><span class="n">Number</span><span class="p">]</span>

            <span class="n">meanv</span> <span class="o">=</span> <span class="p">(</span><span class="n">v1</span> <span class="o">+</span> <span class="n">v2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="n">dx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Graph</span><span class="p">[</span><span class="n">node1</span><span class="p">][</span><span class="n">node2</span><span class="p">][</span><span class="s1">&#39;weight&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e-3</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">dx</span> <span class="o">/</span> <span class="n">meanv</span>
            <span class="k">if</span> <span class="n">meanv</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Graph</span><span class="p">[</span><span class="n">node2</span><span class="p">][</span><span class="n">node1</span><span class="p">][</span><span class="s1">&#39;timedelay&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">t</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Graph</span><span class="p">[</span><span class="n">node1</span><span class="p">][</span><span class="n">node2</span><span class="p">][</span><span class="s1">&#39;timedelay&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Graph</span><span class="p">[</span><span class="n">node2</span><span class="p">][</span><span class="n">node1</span><span class="p">][</span><span class="s1">&#39;timedelay&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Graph</span><span class="p">[</span><span class="n">node1</span><span class="p">][</span><span class="n">node2</span><span class="p">][</span><span class="s1">&#39;timedelay&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">length</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">single_source_dijkstra</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Graph</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">weight</span><span class="o">=</span><span class="s1">&#39;timedelay&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Nodes</span><span class="p">:</span>
            <span class="n">node</span><span class="o">.</span><span class="n">TimeDelay</span> <span class="o">=</span> <span class="n">length</span><span class="p">[</span><span class="n">node</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">DistancefromHeart</span> <span class="o">=</span> <span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">DistancefromHeart</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Nodes</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">UpdateNodeType</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">UpdateNodeType</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">CorrectforDirectionVectorOutlets</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">numbers</span> <span class="o">=</span> <span class="p">[</span><span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">Number</span> <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Vessels</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">CorrectForDirectionEnds</span><span class="p">(</span><span class="n">numbers</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">CerebellumBrainstemMapping</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># add labels and positions to the vessels.</span>
        <span class="n">cerebellum</span> <span class="o">=</span> <span class="mi">8</span>
        <span class="n">brainstem</span> <span class="o">=</span> <span class="mi">9</span>

        <span class="n">cerebellumnames</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;R. SCA&quot;</span><span class="p">,</span>
                           <span class="s2">&quot;L. SCA&quot;</span><span class="p">,</span>
                           <span class="s2">&quot;R. AICA&quot;</span><span class="p">,</span>
                           <span class="s2">&quot;L. AICA&quot;</span><span class="p">,</span>
                           <span class="s2">&quot;R. PICA&quot;</span><span class="p">,</span>
                           <span class="s2">&quot;L. PICA&quot;</span><span class="p">,</span> <span class="p">]</span>

        <span class="n">brainstemnames</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Pontine I&quot;</span><span class="p">,</span>
                          <span class="s2">&quot;Pontine II&quot;</span><span class="p">,</span>
                          <span class="s2">&quot;Pontine III&quot;</span><span class="p">,</span>
                          <span class="s2">&quot;Pontine IV&quot;</span><span class="p">,</span>
                          <span class="s2">&quot;Pontine V&quot;</span><span class="p">,</span>
                          <span class="s2">&quot;Pontine VI&quot;</span><span class="p">,</span>
                          <span class="s2">&quot;Pontine VII&quot;</span><span class="p">,</span>
                          <span class="s2">&quot;Pontine VIII&quot;</span><span class="p">,</span>
                          <span class="s2">&quot;Pontine IX&quot;</span><span class="p">,</span>
                          <span class="s2">&quot;Pontine X&quot;</span><span class="p">,</span>
                          <span class="s2">&quot;Pontine XI&quot;</span><span class="p">,</span>
                          <span class="s2">&quot;Pontine XII&quot;</span><span class="p">,</span>
                          <span class="s2">&quot;Pontine XIII&quot;</span><span class="p">]</span>

        <span class="n">cerebellumpos</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">25</span><span class="p">,</span> <span class="o">-</span><span class="mi">74</span><span class="p">,</span> <span class="o">-</span><span class="mi">36</span><span class="p">],</span>
                         <span class="p">[</span><span class="o">-</span><span class="mi">25</span><span class="p">,</span> <span class="o">-</span><span class="mi">74</span><span class="p">,</span> <span class="o">-</span><span class="mi">34</span><span class="p">],</span>
                         <span class="p">[</span><span class="mi">28</span><span class="p">,</span> <span class="o">-</span><span class="mi">55</span><span class="p">,</span> <span class="o">-</span><span class="mi">48</span><span class="p">],</span>
                         <span class="p">[</span><span class="o">-</span><span class="mi">28</span><span class="p">,</span> <span class="o">-</span><span class="mi">55</span><span class="p">,</span> <span class="o">-</span><span class="mi">48</span><span class="p">],</span>
                         <span class="p">[</span><span class="mi">32</span><span class="p">,</span> <span class="o">-</span><span class="mi">40</span><span class="p">,</span> <span class="o">-</span><span class="mi">60</span><span class="p">],</span>
                         <span class="p">[</span><span class="o">-</span><span class="mi">30</span><span class="p">,</span> <span class="o">-</span><span class="mi">48</span><span class="p">,</span> <span class="o">-</span><span class="mi">60</span><span class="p">]]</span>

        <span class="c1"># starting at the bottom of the stem</span>
        <span class="n">pontinepos</span> <span class="o">=</span> <span class="p">[[</span><span class="o">-</span><span class="mf">3.1</span><span class="p">,</span> <span class="o">-</span><span class="mf">16.3</span><span class="p">,</span> <span class="o">-</span><span class="mf">58.5</span><span class="p">],</span>
                      <span class="p">[</span><span class="mf">1.6</span><span class="p">,</span> <span class="o">-</span><span class="mf">15.7</span><span class="p">,</span> <span class="o">-</span><span class="mf">57.2</span><span class="p">],</span>
                      <span class="p">[</span><span class="o">-</span><span class="mf">6.1</span><span class="p">,</span> <span class="o">-</span><span class="mf">14.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">50.4</span><span class="p">],</span>
                      <span class="p">[</span><span class="mf">2.2</span><span class="p">,</span> <span class="o">-</span><span class="mf">12.8</span><span class="p">,</span> <span class="o">-</span><span class="mf">51.7</span><span class="p">],</span>
                      <span class="p">[</span><span class="o">-</span><span class="mf">8.2</span><span class="p">,</span> <span class="o">-</span><span class="mf">10.9</span><span class="p">,</span> <span class="o">-</span><span class="mf">48.2</span><span class="p">],</span>
                      <span class="p">[</span><span class="mf">2.39</span><span class="p">,</span> <span class="o">-</span><span class="mf">9.2</span><span class="p">,</span> <span class="o">-</span><span class="mf">48.9</span><span class="p">],</span>
                      <span class="p">[</span><span class="o">-</span><span class="mf">8.8</span><span class="p">,</span> <span class="o">-</span><span class="mf">5.81</span><span class="p">,</span> <span class="o">-</span><span class="mf">46.1</span><span class="p">],</span>
                      <span class="p">[</span><span class="mf">2.7</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.2</span><span class="p">,</span> <span class="o">-</span><span class="mf">46.6</span><span class="p">],</span>
                      <span class="p">[</span><span class="o">-</span><span class="mf">8.4</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.6</span><span class="p">,</span> <span class="o">-</span><span class="mf">40.7</span><span class="p">],</span>
                      <span class="p">[</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">1.3</span><span class="p">,</span> <span class="o">-</span><span class="mf">41.3</span><span class="p">],</span>
                      <span class="p">[</span><span class="o">-</span><span class="mf">6.8</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">34.6</span><span class="p">],</span>
                      <span class="p">[</span><span class="o">-</span><span class="mf">3.0</span><span class="p">,</span> <span class="mf">1.4</span><span class="p">,</span> <span class="o">-</span><span class="mf">34.0</span><span class="p">],</span>
                      <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]</span>

        <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Vessels</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Name</span> <span class="ow">in</span> <span class="n">cerebellumnames</span><span class="p">:</span>
                <span class="n">vessel</span><span class="o">.</span><span class="n">SetMajorVesselID</span><span class="p">(</span><span class="n">cerebellum</span><span class="p">)</span>
                <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">SetPosition</span><span class="p">(</span><span class="n">cerebellumpos</span><span class="p">[</span><span class="n">cerebellumnames</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">vessel</span><span class="o">.</span><span class="n">Name</span><span class="p">)])</span>
                <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">SetMajorVesselID</span><span class="p">(</span><span class="n">cerebellum</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Name</span> <span class="ow">in</span> <span class="n">brainstemnames</span><span class="p">:</span>
                <span class="n">vessel</span><span class="o">.</span><span class="n">SetMajorVesselID</span><span class="p">(</span><span class="n">brainstem</span><span class="p">)</span>
                <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">SetPosition</span><span class="p">(</span><span class="n">pontinepos</span><span class="p">[</span><span class="n">brainstemnames</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">vessel</span><span class="o">.</span><span class="n">Name</span><span class="p">)])</span>
                <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">SetMajorVesselID</span><span class="p">(</span><span class="n">brainstem</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">calculate_wk_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the windkessel parameters for the outlets of the network.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Calculating WindKessel Parameters.&quot;</span><span class="p">)</span>
        <span class="n">scaling</span> <span class="o">=</span> <span class="mf">1e-3</span>  <span class="c1"># default for mm</span>

        <span class="n">C1D</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Vessels</span><span class="p">:</span>
            <span class="c1"># mean radius and thickness</span>
            <span class="n">lengthvessel</span> <span class="o">=</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Length</span> <span class="o">*</span> <span class="n">scaling</span>
            <span class="n">meanradius</span> <span class="o">=</span> <span class="n">vessel</span><span class="o">.</span><span class="n">MeanRadius</span> <span class="o">*</span> <span class="n">scaling</span>
            <span class="n">meanh</span> <span class="o">=</span> <span class="n">vessel</span><span class="o">.</span><span class="n">MeanThickness</span> <span class="o">*</span> <span class="n">scaling</span>
            <span class="n">C1D</span> <span class="o">+=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">meanradius</span> <span class="o">*</span> <span class="n">meanradius</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">)</span> <span class="o">*</span> <span class="n">lengthvessel</span> <span class="o">/</span> <span class="p">(</span>
                    <span class="p">(</span><span class="mi">4</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="n">vessel</span><span class="o">.</span><span class="n">YoungsModules</span> <span class="o">*</span> <span class="n">meanh</span><span class="p">)</span>

        <span class="n">Cperipheral</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ModelParameters</span><span class="p">[</span><span class="s2">&quot;CTotal&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">C1D</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ModelParameters</span><span class="p">[</span><span class="s2">&quot;Cperipheral&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Cperipheral</span>
        <span class="k">if</span> <span class="n">Cperipheral</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Cperipheral should not be negative. The value of Cperipheral was: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">Cperipheral</span><span class="p">))</span>

        <span class="c1"># identify outlets</span>
        <span class="n">outletmap</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">OutletNodes</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Vessels</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">:</span>
                    <span class="n">outletmap</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vessel</span><span class="o">.</span><span class="n">Name</span><span class="p">)</span>

        <span class="n">bodymap</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">out</span> <span class="ow">in</span> <span class="n">outletmap</span><span class="p">:</span>
            <span class="n">part</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">Constants</span><span class="o">.</span><span class="n">fractions</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">body</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">Constants</span><span class="o">.</span><span class="n">bodyparts</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">out</span> <span class="o">==</span> <span class="n">body</span><span class="p">:</span>
                    <span class="n">part</span> <span class="o">=</span> <span class="n">index</span>
            <span class="n">bodymap</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">part</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">bodynumber</span><span class="p">,</span> <span class="n">fraction</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">Constants</span><span class="o">.</span><span class="n">fractions</span><span class="p">):</span>
            <span class="n">outlets</span> <span class="o">=</span> <span class="p">[</span><span class="n">out</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">out</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">OutletNodes</span><span class="p">)</span> <span class="k">if</span> <span class="n">bodymap</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">==</span> <span class="n">bodynumber</span><span class="p">]</span>
            <span class="n">rcubed</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">outlets</span><span class="p">:</span>
                <span class="n">radius</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">Radius</span> <span class="o">*</span> <span class="n">scaling</span>
                <span class="n">rcubed</span> <span class="o">+=</span> <span class="n">math</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">radius</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">outlets</span><span class="p">:</span>
                <span class="n">radius</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">Radius</span> <span class="o">*</span> <span class="n">scaling</span>
                <span class="n">h</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">Thickness</span> <span class="o">*</span> <span class="n">scaling</span>
                <span class="n">rt</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ModelParameters</span><span class="p">[</span><span class="s2">&quot;RTotal&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">fraction</span><span class="p">)</span> <span class="o">*</span> <span class="n">rcubed</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">radius</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
                <span class="n">A</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">radius</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">beta</span> <span class="o">=</span> <span class="p">(</span><span class="mi">4</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="n">i</span><span class="o">.</span><span class="n">YoungsModules</span> <span class="o">*</span> <span class="n">h</span> <span class="o">/</span> <span class="n">A</span>
                <span class="n">c0</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">beta</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ModelParameters</span><span class="p">[</span><span class="s2">&quot;Density&quot;</span><span class="p">])))</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">)</span>
                <span class="n">r1</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ModelParameters</span><span class="p">[</span><span class="s2">&quot;Density&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">A</span><span class="p">)</span> <span class="o">*</span> <span class="n">c0</span>
                <span class="n">r2</span> <span class="o">=</span> <span class="n">rt</span> <span class="o">-</span> <span class="n">r1</span>
                <span class="k">if</span> <span class="n">r2</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">r2</span> <span class="o">=</span> <span class="mf">0.1e9</span>
                    <span class="n">r1</span> <span class="o">=</span> <span class="n">rt</span> <span class="o">-</span> <span class="n">r2</span>
                <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ModelParameters</span><span class="p">[</span><span class="s2">&quot;Cperipheral&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ModelParameters</span><span class="p">[</span><span class="s2">&quot;RTotal&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">rt</span>
                <span class="n">i</span><span class="o">.</span><span class="n">SetWK</span><span class="p">(</span><span class="n">r1</span><span class="p">,</span> <span class="n">r2</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">calculate_wk_parameters_evenly</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the windkessel parameters for the outlets of the network.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Calculating WindKessel Parameters, evenly through out the network.&quot;</span><span class="p">)</span>
        <span class="n">scaling</span> <span class="o">=</span> <span class="mf">1e-3</span>  <span class="c1"># default for mm</span>

        <span class="n">C1D</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Vessels</span><span class="p">:</span>
            <span class="c1"># mean radius and thickness</span>
            <span class="n">lengthvessel</span> <span class="o">=</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Length</span> <span class="o">*</span> <span class="n">scaling</span>
            <span class="n">meanradius</span> <span class="o">=</span> <span class="n">vessel</span><span class="o">.</span><span class="n">MeanRadius</span> <span class="o">*</span> <span class="n">scaling</span>
            <span class="n">meanh</span> <span class="o">=</span> <span class="n">vessel</span><span class="o">.</span><span class="n">MeanThickness</span> <span class="o">*</span> <span class="n">scaling</span>
            <span class="n">C1D</span> <span class="o">+=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">meanradius</span> <span class="o">*</span> <span class="n">meanradius</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">)</span> <span class="o">*</span> <span class="n">lengthvessel</span> <span class="o">/</span> <span class="p">(</span>
                    <span class="p">(</span><span class="mi">4</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="n">vessel</span><span class="o">.</span><span class="n">YoungsModules</span> <span class="o">*</span> <span class="n">meanh</span><span class="p">)</span>

        <span class="n">Cperipheral</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ModelParameters</span><span class="p">[</span><span class="s2">&quot;CTotal&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">C1D</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ModelParameters</span><span class="p">[</span><span class="s2">&quot;Cperipheral&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Cperipheral</span>
        <span class="c1"># if Cperipheral &lt; 0:</span>
        <span class="c1">#     raise Exception(&#39;Cperipheral should not be negative. The value of Cperipheral was: {}&#39;.format(Cperipheral))</span>

        <span class="c1"># identify outlets</span>
        <span class="n">outletmap</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">OutletNodes</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Vessels</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">:</span>
                    <span class="n">outletmap</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vessel</span><span class="o">.</span><span class="n">Name</span><span class="p">)</span>

        <span class="n">outlets</span> <span class="o">=</span> <span class="p">[</span><span class="n">out</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">out</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">OutletNodes</span><span class="p">)]</span>
        <span class="n">rcubed</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">outlets</span><span class="p">:</span>
            <span class="n">radius</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">Radius</span> <span class="o">*</span> <span class="n">scaling</span>
            <span class="n">rcubed</span> <span class="o">+=</span> <span class="n">math</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">radius</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">outlets</span><span class="p">:</span>
            <span class="n">radius</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">Radius</span> <span class="o">*</span> <span class="n">scaling</span>
            <span class="n">h</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">Thickness</span> <span class="o">*</span> <span class="n">scaling</span>
            <span class="n">rt</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ModelParameters</span><span class="p">[</span><span class="s2">&quot;RTotal&quot;</span><span class="p">])</span> <span class="o">*</span> <span class="n">rcubed</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">radius</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
            <span class="n">A</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">radius</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">beta</span> <span class="o">=</span> <span class="p">(</span><span class="mi">4</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="n">i</span><span class="o">.</span><span class="n">YoungsModules</span> <span class="o">*</span> <span class="n">h</span> <span class="o">/</span> <span class="n">A</span>
            <span class="n">c0</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">beta</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ModelParameters</span><span class="p">[</span><span class="s2">&quot;Density&quot;</span><span class="p">])))</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">)</span>
            <span class="n">r1</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ModelParameters</span><span class="p">[</span><span class="s2">&quot;Density&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">A</span><span class="p">)</span> <span class="o">*</span> <span class="n">c0</span>
            <span class="n">r2</span> <span class="o">=</span> <span class="n">rt</span> <span class="o">-</span> <span class="n">r1</span>
            <span class="k">if</span> <span class="n">r2</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">r2</span> <span class="o">=</span> <span class="mf">0.1e9</span>
                <span class="n">r1</span> <span class="o">=</span> <span class="n">rt</span> <span class="o">-</span> <span class="n">r2</span>
            <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ModelParameters</span><span class="p">[</span><span class="s2">&quot;Cperipheral&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ModelParameters</span><span class="p">[</span><span class="s2">&quot;RTotal&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">rt</span>
            <span class="n">i</span><span class="o">.</span><span class="n">SetWK</span><span class="p">(</span><span class="n">r1</span><span class="p">,</span> <span class="n">r2</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">WriteSimFiles</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Writing simulation files.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">UpdateTopology</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">SaveVesselAtlas</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">WriteTopologyFile</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">WriteParFile</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">WriteFlowProfiles</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">WriteRunFile</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">WriteModelParameters</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">WriteClotFile</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">WriteRegionMapping</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">ExportSurface</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">graph</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Perfusion</span><span class="o">.</span><span class="n">ExportSurface</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">graph</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">SelectPatient</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Load input files</span>
        <span class="c1"># Randomly select a patient</span>
        <span class="n">segmentationfolder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">DataFilesFolder</span> <span class="o">+</span> <span class="s2">&quot;/Segmentations/&quot;</span>
        <span class="n">segfolders</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">segmentationfolder</span><span class="p">)]</span>
        <span class="n">selectedfolder</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">segfolders</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">segmentationfile</span> <span class="o">=</span> <span class="n">segmentationfolder</span> <span class="o">+</span> <span class="n">selectedfolder</span> <span class="o">+</span> <span class="s2">&quot;/Feature_Vessel.csv&quot;</span>
        <span class="n">infofile</span> <span class="o">=</span> <span class="n">segmentationfolder</span> <span class="o">+</span> <span class="n">selectedfolder</span> <span class="o">+</span> <span class="s2">&quot;/Image_info.txt&quot;</span>

        <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">segmentationfile</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">InputFolder</span><span class="p">)</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">infofile</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">InputFolder</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ModelParameters</span><span class="p">[</span><span class="s2">&quot;Patient_Segmentation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">selectedfolder</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Selected segmentation: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">selectedfolder</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">SelectDonorNetwork</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Select a network from the Brava set to extend the patient network.</span>
<span class="sd">        For now, the donor is randomly selected from the folder.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">scriptfolder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">DataFilesFolder</span>
        <span class="n">bravafolder</span> <span class="o">=</span> <span class="n">scriptfolder</span> <span class="o">+</span> <span class="s2">&quot;/Brava/&quot;</span>
        <span class="n">bravafiles</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">bravafolder</span><span class="p">)</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">bravafolder</span><span class="p">,</span> <span class="n">f</span><span class="p">))</span> <span class="k">if</span>
                      <span class="n">f</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span> <span class="o">==</span> <span class="s2">&quot;vtp&quot;</span><span class="p">]</span>
        <span class="n">selectedfile</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">bravafiles</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># selectedfile = &quot;BH0023_ColorCoded.CNG.vtp&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ModelParameters</span><span class="p">[</span><span class="s2">&quot;Donor_Network&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">selectedfile</span>

    <span class="k">def</span> <span class="nf">UpdateModelParameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ModelParameters</span><span class="p">[</span><span class="s2">&quot;Beat_Duration&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">60</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">PatientData</span><span class="p">[</span><span class="s2">&quot;HeartRate&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ModelParameters</span><span class="p">[</span><span class="s2">&quot;SISTOLIC_PRESSURE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PatientData</span><span class="p">[</span><span class="s2">&quot;SystolePressure&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ModelParameters</span><span class="p">[</span><span class="s2">&quot;DIASTOLIC_PRESSURE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PatientData</span><span class="p">[</span><span class="s2">&quot;DiastolePressure&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ModelParameters</span><span class="p">[</span><span class="s2">&quot;RTotal&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">PatientData</span><span class="p">[</span><span class="s2">&quot;SystolePressure&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">PatientData</span><span class="p">[</span>
            <span class="s2">&quot;DiastolePressure&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">/</span> <span class="mi">3</span><span class="p">))</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">PatientData</span><span class="p">[</span><span class="s2">&quot;MeanRightAtrialPressure&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span>
                                                 <span class="bp">self</span><span class="o">.</span><span class="n">PatientData</span><span class="p">[</span><span class="s2">&quot;StrokeVolume&quot;</span><span class="p">]</span> <span class="o">*</span>
                                                 <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">PatientData</span><span class="p">[</span><span class="s2">&quot;HeartRate&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">60</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e-6</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ModelParameters</span><span class="p">[</span><span class="s2">&quot;CTotal&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ModelParameters</span><span class="p">[</span><span class="s2">&quot;TimeConstantDiastolicDecay&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">ModelParameters</span><span class="p">[</span>
            <span class="s2">&quot;RTotal&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ModelParameters</span><span class="p">[</span><span class="s2">&quot;ScriptLocation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span> <span class="o">+</span> <span class="s2">&quot;/Check_Convergence.py&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ModelParameters</span><span class="p">[</span><span class="s2">&quot;OUT_PRESSURE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PatientData</span><span class="p">[</span><span class="s2">&quot;MeanRightAtrialPressure&quot;</span><span class="p">]</span>

        <span class="c1"># self.PatientData[&quot;collaterals&quot;]: collateral score, 0:absent, 1:poor, 2:moderate, 3:good</span>
        <span class="n">collateral_map</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span> <span class="mf">0.65</span><span class="p">}</span>  <span class="c1"># detailed collateral model: probability</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ModelParameters</span><span class="p">[</span><span class="s2">&quot;collateralpropability&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">collateral_map</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">PatientData</span><span class="p">[</span><span class="s2">&quot;CollateralScore&quot;</span><span class="p">]]</span>

        <span class="n">collateral_map</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="mf">0.14</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">}</span>  <span class="c1"># two-way coupled model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ModelParameters</span><span class="p">[</span><span class="s2">&quot;coarse_collaterals_number&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">collateral_map</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">PatientData</span><span class="p">[</span><span class="s2">&quot;CollateralScore&quot;</span><span class="p">]]</span>

    <span class="k">def</span> <span class="nf">WriteFlowProfilesAlastruey2007</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Take patient parameters and generate flow profiles.</span>
<span class="sd">        Assumption is that the two inlets with the largest radius are the carotid arteries.</span>
<span class="sd">        Flowrate given here are ml/s</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Writing Flow Profiles.&quot;</span><span class="p">)</span>
        <span class="n">Aortafile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">ModellingFolder</span> <span class="o">+</span> <span class="s2">&quot;Aorta.txt&quot;</span>
        <span class="n">period</span> <span class="o">=</span> <span class="mi">60</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">PatientData</span><span class="p">[</span><span class="s2">&quot;HeartRate&quot;</span><span class="p">]</span>
        <span class="n">time</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>

        <span class="n">VolumeFlowRate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PatientData</span><span class="p">[</span><span class="s2">&quot;StrokeVolume&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">PatientData</span><span class="p">[</span><span class="s2">&quot;HeartRate&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">60</span><span class="p">)</span>
        <span class="c1"># AortaFlow = BloodflowEquations.FlowRateAorta(time, period, VolumeFlowRate)</span>
        <span class="n">scaling</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">integrate</span><span class="o">.</span><span class="n">simps</span><span class="p">(</span><span class="n">BloodFlowEquations</span><span class="o">.</span><span class="n">FlowRateAlastruey2007</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">time</span><span class="p">)</span>
        <span class="n">AortaFlow</span> <span class="o">=</span> <span class="n">BloodFlowEquations</span><span class="o">.</span><span class="n">FlowRateAlastruey2007</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">VolumeFlowRate</span> <span class="o">/</span> <span class="n">scaling</span><span class="p">)</span>
        <span class="c1"># AortaFlow = [self.PatientData[&quot;StrokeVolume&quot;] for i in AortaFlow]</span>
        <span class="c1"># totalflow = numpy.trapz(AortaFlow,time)</span>
        <span class="c1"># totalflows = simps(AortaFlow, time)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">Aortafile</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;1.0e-6</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">time</span><span class="p">)):</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="se">\t</span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">AortaFlow</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>

    <span class="k">def</span> <span class="nf">WriteFlowProfiles</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Take patient parameters and generate flow profiles.</span>
<span class="sd">        Assumption is that the two inlets with the largest radius are the carotid arteries.</span>
<span class="sd">        Flowrate given here are ml/s</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Writing Flow Profiles.&quot;</span><span class="p">)</span>
        <span class="n">Aortafile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">ModellingFolder</span> <span class="o">+</span> <span class="s2">&quot;Aorta.txt&quot;</span>
        <span class="n">period</span> <span class="o">=</span> <span class="mi">60</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">PatientData</span><span class="p">[</span><span class="s2">&quot;HeartRate&quot;</span><span class="p">]</span>
        <span class="n">time</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>

        <span class="n">VolumeFlowRate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PatientData</span><span class="p">[</span><span class="s2">&quot;StrokeVolume&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">PatientData</span><span class="p">[</span><span class="s2">&quot;HeartRate&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">60</span><span class="p">)</span>
        <span class="n">AortaFlow</span> <span class="o">=</span> <span class="n">BloodFlowEquations</span><span class="o">.</span><span class="n">FlowRateAorta</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">VolumeFlowRate</span><span class="p">)</span>
        <span class="c1"># scaling = scipy.integrate.simps(BloodflowEquations.FlowRateAlastruey2007(time,1), time)</span>
        <span class="c1"># AortaFlow = BloodflowEquations.FlowRateAlastruey2007(time, VolumeFlowRate/scaling)</span>
        <span class="c1"># AortaFlow = [self.PatientData[&quot;StrokeVolume&quot;] for i in AortaFlow]</span>
        <span class="c1"># totalflow = numpy.trapz(AortaFlow,time)</span>
        <span class="c1"># totalflows = simps(AortaFlow, time)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">Aortafile</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;1.0e-6</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">time</span><span class="p">)):</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="se">\t</span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">AortaFlow</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>

    <span class="c1"># def WriteResultsToVTP(self):</span>
    <span class="c1">#     print(&quot;Writing Results to vtp files&quot;)</span>
    <span class="c1">#     resultsfolder = self.Folders.ModellingFolder</span>
    <span class="c1">#     if not os.path.exists(resultsfolder):</span>
    <span class="c1">#         os.mkdir(resultsfolder)</span>
    <span class="c1">#</span>
    <span class="c1">#     TimeFile = open(resultsfolder + &quot;Time.txt&quot;, &#39;w&#39;, encoding=&#39;utf-8&#39;)</span>
    <span class="c1">#     for i in range(0, len(self.Results.TimePoints)):</span>
    <span class="c1">#         TimeFile.write(str(i) + &quot; &quot; + str(self.Results.TimePoints[i].WT) + &#39;\n&#39;)</span>
    <span class="c1">#     TimeFile.close()</span>
    <span class="c1">#</span>
    <span class="c1">#     for i in range(0, len(self.Results.TimePoints)):</span>
    <span class="c1">#         self.FrameToVTP(resultsfolder + &quot;TimePoint&quot; + str(i) + &quot;.vtp&quot;, self.Results.TimePoints[i])</span>
    <span class="c1">#</span>
    <span class="c1"># def FrameToVTP(self, filename, timepoint):</span>
    <span class="c1">#     print(&quot;Writing frame at time:%f&quot; % timepoint.WT)</span>
    <span class="c1">#     nodes = vtk.vtkPoints()</span>
    <span class="c1">#     vessels = vtk.vtkCellArray()</span>
    <span class="c1">#</span>
    <span class="c1">#     radius = vtk.vtkFloatArray()</span>
    <span class="c1">#     radius.SetNumberOfComponents(1)</span>
    <span class="c1">#     radius.SetName(&quot;Radius&quot;)</span>
    <span class="c1">#</span>
    <span class="c1">#     pressure = vtk.vtkFloatArray()</span>
    <span class="c1">#     pressure.SetNumberOfComponents(1)</span>
    <span class="c1">#     pressure.SetName(&quot;Pressure&quot;)</span>
    <span class="c1">#</span>
    <span class="c1">#     Flow = vtk.vtkFloatArray()</span>
    <span class="c1">#     Flow.SetNumberOfComponents(1)</span>
    <span class="c1">#     Flow.SetName(&quot;Flow Rate&quot;)</span>
    <span class="c1">#</span>
    <span class="c1">#     Radius = vtk.vtkFloatArray()</span>
    <span class="c1">#     Radius.SetNumberOfComponents(1)</span>
    <span class="c1">#     Radius.SetName(&quot;Radius&quot;)</span>
    <span class="c1">#</span>
    <span class="c1">#     for i in range(0, len(timepoint.Pressure)):</span>
    <span class="c1">#         pressure.InsertNextValue(timepoint.Pressure[i])</span>
    <span class="c1">#         Flow.InsertNextValue(timepoint.Flow[i])</span>
    <span class="c1">#         Radius.InsertNextValue(timepoint.Radius[i])</span>
    <span class="c1">#</span>
    <span class="c1">#     # Add radius and position to data array</span>
    <span class="c1">#     for node in self.Topology.Nodes:</span>
    <span class="c1">#         nodes.InsertNextPoint(node.Position)</span>
    <span class="c1">#         radius.InsertNextValue(node.Radius)</span>
    <span class="c1">#</span>
    <span class="c1">#     # Create a polydata to store everything in</span>
    <span class="c1">#     VesselsPolyData = vtk.vtkPolyData()</span>
    <span class="c1">#</span>
    <span class="c1">#     # Add the points to the dataset</span>
    <span class="c1">#     VesselsPolyData.SetPoints(nodes)</span>
    <span class="c1">#</span>
    <span class="c1">#     # Add vessels to cell array</span>
    <span class="c1">#     for vessel in self.Topology.Vessels:</span>
    <span class="c1">#         line = vtk.vtkLine()</span>
    <span class="c1">#         line.GetPointIds().SetNumberOfIds(len(vessel))</span>
    <span class="c1">#         for i in range(0, len(vessel)):</span>
    <span class="c1">#             line.GetPointIds().SetId(i, vessel[i])</span>
    <span class="c1">#         vessels.InsertNextCell(line)</span>
    <span class="c1">#     # Add the lines to the dataset</span>
    <span class="c1">#     VesselsPolyData.SetLines(vessels)</span>
    <span class="c1">#</span>
    <span class="c1">#     # Assign radii to the nodes</span>
    <span class="c1">#     VesselsPolyData.GetPointData().SetScalars(radius)</span>
    <span class="c1">#     VesselsPolyData.GetPointData().AddArray(pressure)</span>
    <span class="c1">#     VesselsPolyData.GetPointData().AddArray(Flow)</span>
    <span class="c1">#     VesselsPolyData.GetPointData().AddArray(Radius)</span>
    <span class="c1">#</span>
    <span class="c1">#     # Save everyting in a vtk file</span>
    <span class="c1">#     writer = vtk.vtkXMLPolyDataWriter()</span>
    <span class="c1">#     writer.SetFileName(filename)</span>
    <span class="c1">#     writer.SetInputData(VesselsPolyData)</span>
    <span class="c1">#     writer.Write()</span>

    <span class="k">def</span> <span class="nf">VesselToMeshAllignmentSides</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">graph</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Optimizing alignment between the mesh and the outlets.&quot;</span><span class="p">)</span>

        <span class="n">pos</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">majornodesID</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">OutletNodes</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">Position</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">))</span> <span class="ow">and</span> <span class="n">node</span><span class="o">.</span><span class="n">MajorVesselID</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">pos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">Position</span><span class="p">)</span>
                <span class="n">majornodesID</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">MajorVesselID</span><span class="p">)</span>

        <span class="c1"># left and right sides of the pial surface</span>
        <span class="n">rightpialsurface</span> <span class="o">=</span> <span class="p">[</span><span class="n">index</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">graph</span><span class="o">.</span><span class="n">PialSurface</span><span class="p">)</span> <span class="k">if</span> <span class="n">graph</span><span class="o">.</span><span class="n">SideInfo</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">leftpialsurface</span> <span class="o">=</span> <span class="p">[</span><span class="n">index</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">graph</span><span class="o">.</span><span class="n">PialSurface</span><span class="p">)</span> <span class="k">if</span> <span class="n">graph</span><span class="o">.</span><span class="n">SideInfo</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span>

        <span class="c1"># [cow, - , &quot;R. ACA, A2&quot;, &quot;R. MCA&quot;, &quot;L. MCA&quot;, &quot;L. ACA, A2&quot;, &quot;R. PCA, P2&quot;, &quot;L. PCA, P2&quot;]</span>
        <span class="c1"># leftvessels = [4, 5, 7]</span>
        <span class="c1"># rightvessels = [2, 3, 6]</span>
        <span class="n">leftvessels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Perfusion</span><span class="o">.</span><span class="n">leftregionids</span>
        <span class="n">rightvessels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Perfusion</span><span class="o">.</span><span class="n">rightregionids</span>

        <span class="n">leftnodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">index</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span> <span class="k">if</span> <span class="n">majornodesID</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="ow">in</span> <span class="n">leftvessels</span><span class="p">]</span>
        <span class="n">rightnodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">index</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span> <span class="k">if</span> <span class="n">majornodesID</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="ow">in</span> <span class="n">rightvessels</span><span class="p">]</span>

        <span class="n">sys</span><span class="o">.</span><span class="n">setrecursionlimit</span><span class="p">(</span><span class="mi">10000</span><span class="p">)</span>
        <span class="n">KDTreeleft</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">spatial</span><span class="o">.</span><span class="n">KDTree</span><span class="p">([</span><span class="n">graph</span><span class="o">.</span><span class="n">PialSurface</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">leftpialsurface</span><span class="p">])</span>
        <span class="n">KDTreeright</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">spatial</span><span class="o">.</span><span class="n">KDTree</span><span class="p">([</span><span class="n">graph</span><span class="o">.</span><span class="n">PialSurface</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">rightpialsurface</span><span class="p">])</span>

        <span class="k">def</span> <span class="nf">optimfun</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
            <span class="n">scaling</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">translation</span> <span class="o">=</span> <span class="p">[</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">args</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span>
            <span class="n">rotation</span> <span class="o">=</span> <span class="p">[</span><span class="n">args</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">args</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">args</span><span class="p">[</span><span class="mi">6</span><span class="p">]]</span>
            <span class="c1"># Calculate the transform matrix</span>
            <span class="n">tmatrix</span> <span class="o">=</span> <span class="n">GeneralFunctions</span><span class="o">.</span><span class="n">TMatrix</span><span class="p">(</span><span class="n">scaling</span><span class="p">,</span> <span class="n">rotation</span><span class="p">,</span> <span class="n">translation</span><span class="p">)</span>
            <span class="c1"># Apply matrix to the nodes</span>
            <span class="n">tpos</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">pos</span><span class="p">:</span>
                <span class="n">vec</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="p">[</span><span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="p">[</span><span class="n">node</span><span class="p">[</span><span class="mi">2</span><span class="p">]],</span> <span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
                <span class="n">position</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">tmatrix</span><span class="p">,</span> <span class="n">vec</span><span class="p">)</span>
                <span class="n">nodenew</span> <span class="o">=</span> <span class="p">[</span><span class="n">position</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">position</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">position</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>
                <span class="n">tpos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nodenew</span><span class="p">)</span>

            <span class="n">meshdis</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">tpos</span><span class="p">]</span>

            <span class="n">MinDistanceR</span><span class="p">,</span> <span class="n">MinDistanceIndexR</span> <span class="o">=</span> <span class="n">KDTreeright</span><span class="o">.</span><span class="n">query</span><span class="p">([</span><span class="n">tpos</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">rightnodes</span><span class="p">],</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">MinDistanceL</span><span class="p">,</span> <span class="n">MinDistanceIndexL</span> <span class="o">=</span> <span class="n">KDTreeleft</span><span class="o">.</span><span class="n">query</span><span class="p">([</span><span class="n">tpos</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">leftnodes</span><span class="p">],</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">nodeindex</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rightnodes</span><span class="p">):</span>
                <span class="n">meshdis</span><span class="p">[</span><span class="n">nodeindex</span><span class="p">]</span> <span class="o">=</span> <span class="n">MinDistanceR</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">nodeindex</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">leftnodes</span><span class="p">):</span>
                <span class="n">meshdis</span><span class="p">[</span><span class="n">nodeindex</span><span class="p">]</span> <span class="o">=</span> <span class="n">MinDistanceL</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>

            <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">meshdis</span><span class="p">)</span>

        <span class="c1"># initial guess for the allignment</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">optimize</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">optimfun</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]),</span>
                                         <span class="n">method</span><span class="o">=</span><span class="s1">&#39;Nelder-Mead&#39;</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;disp&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>
        <span class="n">values</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">x</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Perfusion</span><span class="o">.</span><span class="n">AllignmentResult</span> <span class="o">=</span> <span class="n">result</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
        <span class="n">scaling</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">translation</span> <span class="o">=</span> <span class="p">[</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">values</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">values</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span>
        <span class="n">rotation</span> <span class="o">=</span> <span class="p">[</span><span class="n">values</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">values</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">values</span><span class="p">[</span><span class="mi">6</span><span class="p">]]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Perfusion</span><span class="o">.</span><span class="n">TMatrix</span> <span class="o">=</span> <span class="n">GeneralFunctions</span><span class="o">.</span><span class="n">TMatrix</span><span class="p">(</span><span class="n">scaling</span><span class="p">,</span> <span class="n">rotation</span><span class="p">,</span> <span class="n">translation</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ApplyTransformation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Perfusion</span><span class="o">.</span><span class="n">TMatrix</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">ApplyTransformation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">matrix</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">vesselnode</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Nodes</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">vesselnode</span><span class="o">.</span><span class="n">Position</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">node</span> <span class="o">=</span> <span class="n">vesselnode</span><span class="o">.</span><span class="n">Position</span>
                <span class="n">vec</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="p">[</span><span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="p">[</span><span class="n">node</span><span class="p">[</span><span class="mi">2</span><span class="p">]],</span> <span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
                <span class="n">position</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">matrix</span><span class="p">,</span> <span class="n">vec</span><span class="p">)</span>
                <span class="n">nodenew</span> <span class="o">=</span> <span class="p">[</span><span class="n">position</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">position</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">position</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>
                <span class="n">vesselnode</span><span class="o">.</span><span class="n">SetPosition</span><span class="p">(</span><span class="n">nodenew</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">FindCouplingPoints</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Map the outlets to the nearest point on the surface.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">surfaceoutlets</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">OutletNodes</span> <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">MajorVesselID</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Finding outlets close to the surface.&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">surfaceoutlets</span><span class="p">):</span>
            <span class="n">couplingpoint</span> <span class="o">=</span> <span class="n">Perfusion</span><span class="o">.</span><span class="n">CouplingPoint</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Perfusion</span><span class="o">.</span><span class="n">AddCouplingPoint</span><span class="p">(</span><span class="n">couplingpoint</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">RemoveCoWOutletsFromPerfusion</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The donor networks have outlets that do not get transferred.</span>
<span class="sd">        These need to be removed.</span>
<span class="sd">        If the coupling point node does not have a number, remove it from the list.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Removing coupling points outside topology.&quot;</span><span class="p">)</span>
        <span class="n">pointstoremove</span> <span class="o">=</span> <span class="p">[</span><span class="n">point</span> <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Perfusion</span><span class="o">.</span><span class="n">CouplingPoints</span> <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">point</span><span class="o">.</span><span class="n">Node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Nodes</span><span class="p">)]</span>
        <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Perfusion</span><span class="o">.</span><span class="n">RemoveCouplingPoint</span><span class="p">(</span><span class="n">point</span><span class="p">)</span> <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="n">pointstoremove</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">WriteCouplingPointsFile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Writing coupling points to file.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">Perfusion</span><span class="o">.</span><span class="n">CouplingPoints</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">FindCouplingPoints</span><span class="p">()</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">ModellingFolder</span> <span class="o">+</span> <span class="s1">&#39;Coupling.csv&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;ID,Position,Direction,Radius,MeshPoint</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">couplingpoint</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Perfusion</span><span class="o">.</span><span class="n">CouplingPoints</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">couplingpoint</span><span class="o">.</span><span class="n">NodeID</span><span class="p">)</span>
                        <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">couplingpoint</span><span class="o">.</span><span class="n">Node</span><span class="o">.</span><span class="n">Position</span><span class="p">)</span>
                        <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">couplingpoint</span><span class="o">.</span><span class="n">Node</span><span class="o">.</span><span class="n">DirectionVector</span><span class="p">)</span>
                        <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">couplingpoint</span><span class="o">.</span><span class="n">Node</span><span class="o">.</span><span class="n">Position</span><span class="o">.</span><span class="n">Radius</span><span class="p">)</span>
                        <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">couplingpoint</span><span class="o">.</span><span class="n">PialSurfacePoint</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">WriteClotFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Clots.txt&#39;</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Writing Clots to file.&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">ModellingFolder</span> <span class="o">+</span> <span class="n">name</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;ClotID,NodeID,Permeability,Porosity</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">clot</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Clots</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">clot</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">Number</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">clot</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">clot</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">WriteTopologyFile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">ModellingFolder</span> <span class="o">+</span> <span class="s2">&quot;System.top&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Writing Topology file to </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">file</span><span class="p">)</span>

        <span class="n">OutputFile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="n">OutputFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Name: System_0&#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Coordinates:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># Output Vessel position and radius</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Nodes</span><span class="p">:</span>
            <span class="n">OutputLine</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">Number</span><span class="p">)</span> \
                         <span class="o">+</span> <span class="s2">&quot; L:&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{0:0.5f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">LengthAlongVessel</span><span class="p">)</span> \
                         <span class="o">+</span> <span class="s2">&quot; R:&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{0:0.5f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">Radius</span><span class="p">)</span> \
                         <span class="o">+</span> <span class="s2">&quot; E:&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{0:0.1f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">YoungsModules</span> <span class="o">*</span> <span class="mf">1e-6</span><span class="p">)</span> \
                         <span class="o">+</span> <span class="s2">&quot; T:&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{0:d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">Type</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>

            <span class="n">OutputFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">OutputLine</span><span class="p">)</span>
        <span class="c1"># Output Connections</span>
        <span class="n">OutputFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Bonds:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Nodes</span><span class="p">:</span>
            <span class="n">BondsLine</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">for</span> <span class="n">bond</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">Connections</span><span class="p">:</span>
                <span class="n">BondsLine</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">bond</span><span class="o">.</span><span class="n">Number</span><span class="p">)</span>
            <span class="n">OutputFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">Number</span><span class="p">)</span> <span class="o">+</span> <span class="n">BondsLine</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">OutputFile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">WriteParFile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">ModellingFolder</span> <span class="o">+</span> <span class="s2">&quot;System.par&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Writing parameter file to </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">file</span><span class="p">)</span>
        <span class="c1"># Output outlets</span>
        <span class="n">OutputFilePar</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="c1"># if self.Topology.OutletNodes[0].R1 is None:</span>
        <span class="c1">#     self.calculate_wk_parameters()</span>

        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">OutletNodes</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">R1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">OutputFilePar</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">Number</span><span class="p">)</span>
                                    <span class="o">+</span> <span class="s1">&#39; R1:&#39;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{0:0.5f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                                    <span class="o">+</span> <span class="s1">&#39; R2:&#39;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{0:0.5f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                                    <span class="o">+</span> <span class="s1">&#39; C:&#39;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{0:0.5f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">OutputFilePar</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">Number</span><span class="p">)</span>
                                    <span class="o">+</span> <span class="s1">&#39; R1:&#39;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{0:0.5f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">R1</span> <span class="o">*</span> <span class="mf">1e-9</span><span class="p">)</span>
                                    <span class="o">+</span> <span class="s1">&#39; R2:&#39;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{0:0.5f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">R2</span> <span class="o">*</span> <span class="mf">1e-9</span><span class="p">)</span>
                                    <span class="o">+</span> <span class="s1">&#39; C:&#39;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{0:0.5f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">C</span> <span class="o">*</span> <span class="mf">1e12</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">OutputFilePar</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">WriteRunFile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">ModellingFolder</span> <span class="o">+</span> <span class="s2">&quot;Run.txt&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Writing run file to </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">file</span><span class="p">)</span>
        <span class="c1"># Output Run file</span>
        <span class="n">OutputRunFile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="n">OutputRunFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&lt;System&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">OutputRunFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Topology: &#39;</span> <span class="o">+</span> <span class="s2">&quot;System.top&quot;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">InletLine</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">InletNodes</span><span class="p">:</span>
            <span class="n">InletLine</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Number</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span>
        <span class="n">OutputRunFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;InletFlux: &#39;</span> <span class="o">+</span> <span class="n">InletLine</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">OutputRunFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;OutletParams: &#39;</span> <span class="o">+</span> <span class="s2">&quot;System.par&quot;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">OutputRunFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Task: &#39;</span><span class="p">)</span>
        <span class="n">OutputRunFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;NumberCoupledPoints: 0&#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">modelparameterfile</span> <span class="o">=</span> <span class="s2">&quot;Model_parameters.txt&quot;</span>
        <span class="n">OutputRunFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Modelparameters: &#39;</span> <span class="o">+</span> <span class="n">modelparameterfile</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">OutputRunFile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">GenerateTreesAtCps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cutoff</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Generating bifurcating arterial trees at the outlet nodes.&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Perfusion</span><span class="o">.</span><span class="n">CouplingPoints</span><span class="p">:</span>
            <span class="n">tree</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GenerateTree</span><span class="p">(</span><span class="nb">id</span><span class="o">.</span><span class="n">Node</span><span class="p">,</span> <span class="n">cutoff</span><span class="p">)</span>
            <span class="nb">id</span><span class="o">.</span><span class="n">Tree</span> <span class="o">=</span> <span class="n">tree</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">UpdateTopology</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Generated </span><span class="si">%d</span><span class="s2"> bifurcating trees.&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Trees</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">GenerateTrees</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cutoff</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Generating bifurcating arterial trees at the outlet nodes.&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">OutletNodes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">GenerateTree</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">cutoff</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Generated </span><span class="si">%d</span><span class="s2"> bifurcating trees.&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Trees</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">getTotalEndsofTrees</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">numberofterminals</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">tree</span><span class="o">.</span><span class="n">EndNodes</span><span class="p">)</span> <span class="k">for</span> <span class="n">tree</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Trees</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Total number of terminal points of the arterial trees: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">numberofterminals</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">PerfusionEndsNumber</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Calculating the number of terminal points per outlet.&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Perfusion</span><span class="o">.</span><span class="n">CouplingPoints</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Perfusion</span><span class="o">.</span><span class="n">CouplingPoints</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">NumberOfPialPoints</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Trees</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">EndNodes</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">GenerateTree</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">cutoff</span><span class="o">=</span><span class="mf">0.125</span><span class="p">):</span>
        <span class="n">tree</span> <span class="o">=</span> <span class="n">Topology</span><span class="o">.</span><span class="n">Tree</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="n">tree</span><span class="o">.</span><span class="n">GenerateTree</span><span class="p">(</span><span class="n">cutoff</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Trees</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tree</span>

    <span class="k">def</span> <span class="nf">TreesToTopology</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Creating a tree topology.&quot;</span><span class="p">)</span>
        <span class="n">treetop</span> <span class="o">=</span> <span class="n">Topology</span><span class="o">.</span><span class="n">Topology</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">tree</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Trees</span><span class="p">:</span>
            <span class="n">treetop</span><span class="o">.</span><span class="n">Nodes</span> <span class="o">+=</span> <span class="n">tree</span><span class="o">.</span><span class="n">Nodes</span>
        <span class="k">return</span> <span class="n">treetop</span>

    <span class="k">def</span> <span class="nf">AddTreesToTop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Adding trees to the vessel topology.&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">tree</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Trees</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tree</span><span class="o">.</span><span class="n">Nodes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">tree</span><span class="o">.</span><span class="n">ConnectTree</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Nodes</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">tree</span><span class="o">.</span><span class="n">Nodes</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">OutletNodes</span> <span class="o">+=</span> <span class="n">tree</span><span class="o">.</span><span class="n">EndNodes</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">OutletNodes</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">tree</span><span class="o">.</span><span class="n">InitialNode</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">BifurcationNodes</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">tree</span><span class="o">.</span><span class="n">BifurcationNodes</span><span class="p">)</span>
                <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">GetVesselNameFromNode</span><span class="p">(</span><span class="n">tree</span><span class="o">.</span><span class="n">InitialNode</span><span class="p">)</span>
                <span class="n">currentvesselnumber</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">ID</span>
                <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">SetID</span><span class="p">(</span><span class="n">currentvesselnumber</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tree</span><span class="o">.</span><span class="n">Vessels</span><span class="p">)]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Vessels</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">tree</span><span class="o">.</span><span class="n">Vessels</span><span class="p">)</span>
                <span class="p">[</span><span class="n">vessel</span><span class="o">.</span><span class="n">SetName</span><span class="p">(</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;Tree_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tree</span><span class="o">.</span><span class="n">Vessels</span><span class="p">)]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">UpdateTopology</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">TreeEndsToEndNodes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">tree</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Trees</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">OutletNodes</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">tree</span><span class="o">.</span><span class="n">InitialNode</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">OutletNodes</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">tree</span><span class="o">.</span><span class="n">EndNodes</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Removing resistance added by the merging of networks.&quot;</span><span class="p">)</span>
        <span class="n">visc</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ModelParameters</span><span class="p">[</span><span class="s2">&quot;BLOOD_VISC&quot;</span><span class="p">])</span>
        <span class="n">density</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ModelParameters</span><span class="p">[</span><span class="s2">&quot;Density&quot;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">tree</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Trees</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">GetVesselNameFromNode</span><span class="p">(</span><span class="n">tree</span><span class="o">.</span><span class="n">InitialNode</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">DownStreamResistance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">visc</span><span class="p">,</span> <span class="n">density</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_Add1TreeToTop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  <span class="c1"># todo fix</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Adding trees to the vessel topology.&quot;</span><span class="p">)</span>
        <span class="n">tree</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Trees</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tree</span><span class="o">.</span><span class="n">Nodes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">tree</span><span class="o">.</span><span class="n">ConnectTree</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Nodes</span> <span class="o">+=</span> <span class="n">tree</span><span class="o">.</span><span class="n">Nodes</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">OutletNodes</span> <span class="o">+=</span> <span class="n">tree</span><span class="o">.</span><span class="n">EndNodes</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">OutletNodes</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">tree</span><span class="o">.</span><span class="n">InitialNode</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">BifurcationNodes</span> <span class="o">+=</span> <span class="n">tree</span><span class="o">.</span><span class="n">BifurcationNodes</span>
            <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">GetVesselNameFromNode</span><span class="p">(</span><span class="n">tree</span><span class="o">.</span><span class="n">InitialNode</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Vessels</span> <span class="o">+=</span> <span class="n">tree</span><span class="o">.</span><span class="n">Vessels</span>
            <span class="p">[</span><span class="n">vessel</span><span class="o">.</span><span class="n">SetName</span><span class="p">(</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;Tree_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tree</span><span class="o">.</span><span class="n">Vessels</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">UpdateTopology</span><span class="p">()</span>

    <span class="c1"># def WriteMeanVesselResultsToVTP(self):</span>
    <span class="c1">#     print(&quot;Writing mean results to Mean.vtp.&quot;)</span>
    <span class="c1">#     self.FrameToVTP(self.Folders.ModellingFolder + &#39;Mean.vtp&#39;, self.Results.CalcMean())</span>

    <span class="k">def</span> <span class="nf">LoadClusters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">ModellingFolder</span> <span class="o">+</span> <span class="s2">&quot;Clusters.csv&quot;</span>
        <span class="n">clusters</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">)]</span>

        <span class="n">NodeID</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">clusters</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span>
        <span class="n">Position</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">clusters</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span>
        <span class="n">Position</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">2</span><span class="p">])]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">Position</span><span class="p">]</span>
        <span class="n">CouplingPointsN</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">clusters</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span>
        <span class="n">ClusterID</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">clusters</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span>
        <span class="n">areas</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">clusters</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span>
        <span class="n">majorvesselid</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">clusters</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span>
        <span class="c1"># nodes = [i[5] for i in clusters[1:]]</span>

        <span class="k">return</span> <span class="n">NodeID</span><span class="p">,</span> <span class="n">Position</span><span class="p">,</span> <span class="n">CouplingPointsN</span><span class="p">,</span> <span class="n">ClusterID</span><span class="p">,</span> <span class="n">areas</span><span class="p">,</span> <span class="n">majorvesselid</span>

    <span class="k">def</span> <span class="nf">LoadSurfaceMapping</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s2">&quot;SurfaceNodesMapping.csv&quot;</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Loading surface mapping.&quot;</span><span class="p">)</span>
        <span class="n">file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">ModellingFolder</span> <span class="o">+</span> <span class="n">filename</span>
        <span class="k">if</span> <span class="n">file</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span> <span class="o">==</span> <span class="s2">&quot;csv&quot;</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">csvfile</span><span class="p">:</span>
                <span class="n">spamreader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">csvfile</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
                <span class="n">clusters</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">spamreader</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">csvfile</span><span class="p">:</span>
                <span class="n">spamreader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">csvfile</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">clusters</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">spamreader</span><span class="p">]</span>

        <span class="c1"># clusters = [i.strip(&#39;\n&#39;).split(&#39;,&#39;) for i in open(file)]</span>

        <span class="n">NodeID</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">clusters</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span>
        <span class="n">ClusterID</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">int</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">clusters</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span>
        <span class="n">Areas</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">clusters</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span>
        <span class="c1"># print(len(self.Perfusion.CouplingPoints) == len(set([y for x in ClusterID for y in x])))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Perfusion</span><span class="o">.</span><span class="n">CouplingPoints</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">y</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ClusterID</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">x</span><span class="p">])):</span>
            <span class="k">for</span> <span class="n">node</span><span class="p">,</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">NodeID</span><span class="p">,</span> <span class="n">ClusterID</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">id_number</span> <span class="ow">in</span> <span class="n">cluster</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">Perfusion</span><span class="o">.</span><span class="n">CouplingPoints</span><span class="p">[</span><span class="n">id_number</span><span class="p">]</span><span class="o">.</span><span class="n">SurfaceNodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">NodeID</span><span class="p">,</span> <span class="n">ClusterID</span><span class="p">,</span> <span class="n">Areas</span>

    <span class="k">def</span> <span class="nf">DistributeFlowVertex</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Distributing flow to the coupling points&quot;</span><span class="p">)</span>
        <span class="c1"># use this when the clustering is done with the primal graph, i.e. the vertices.</span>
        <span class="c1"># the only difference with the dual graph clustering is the type of data,</span>
        <span class="c1"># cell vs point and the cluster size might be different</span>
        <span class="n">nodeids</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">clusterids</span><span class="p">,</span> <span class="n">Areas</span><span class="p">,</span> <span class="n">majorvesselid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">LoadClusters</span><span class="p">()</span>
        <span class="n">surfacenodes</span><span class="p">,</span> <span class="n">clustermap</span><span class="p">,</span> <span class="n">triangleArea</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">LoadSurfaceMapping</span><span class="p">()</span>

        <span class="n">pointspercluster</span> <span class="o">=</span> <span class="p">[</span><span class="nb">sum</span><span class="p">([</span><span class="mi">1</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">clustermap</span> <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">id_number</span><span class="p">])</span> <span class="k">for</span> <span class="n">id_number</span> <span class="ow">in</span> <span class="n">clusterids</span><span class="p">]</span>

        <span class="n">reader</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkXMLPolyDataReader</span><span class="p">()</span>
        <span class="n">reader</span><span class="o">.</span><span class="n">SetFileName</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">ModellingFolder</span> <span class="o">+</span> <span class="s2">&quot;Clustering_mapped.vtp&quot;</span><span class="p">)</span>
        <span class="n">reader</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">()</span>
        <span class="n">resultsfolder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">ModellingFolder</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">resultsfolder</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">resultsfolder</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">timeindex</span><span class="p">,</span> <span class="n">timepoint</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">TimePoints</span><span class="p">):</span>
            <span class="n">flow</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkFloatArray</span><span class="p">()</span>
            <span class="n">flow</span><span class="o">.</span><span class="n">SetNumberOfComponents</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">flow</span><span class="o">.</span><span class="n">SetName</span><span class="p">(</span><span class="s2">&quot;Flow&quot;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">surfacenode</span> <span class="ow">in</span> <span class="n">surfacenodes</span><span class="p">:</span>
                <span class="n">cluster</span> <span class="o">=</span> <span class="n">clustermap</span><span class="p">[</span><span class="n">surfacenode</span><span class="p">]</span>
                <span class="n">fractionflow</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">cluster</span><span class="p">:</span>
                    <span class="n">outlet</span> <span class="o">=</span> <span class="n">nodeids</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">outletflow</span> <span class="o">=</span> <span class="n">timepoint</span><span class="o">.</span><span class="n">Flow</span><span class="p">[</span><span class="n">outlet</span><span class="p">]</span>
                    <span class="n">clustersize</span> <span class="o">=</span> <span class="n">pointspercluster</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">fractionflow</span> <span class="o">+=</span> <span class="n">outletflow</span> <span class="o">/</span> <span class="n">clustersize</span>

                <span class="n">flow</span><span class="o">.</span><span class="n">InsertNextValue</span><span class="p">(</span><span class="n">fractionflow</span><span class="p">)</span>

            <span class="n">writer</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkXMLPolyDataWriter</span><span class="p">()</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">resultsfolder</span> <span class="o">+</span> <span class="s2">&quot;FlowDistributed&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">timeindex</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.vtp&quot;</span>
            <span class="n">writer</span><span class="o">.</span><span class="n">SetFileName</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
            <span class="n">data</span><span class="o">.</span><span class="n">GetPointData</span><span class="p">()</span><span class="o">.</span><span class="n">AddArray</span><span class="p">(</span><span class="n">flow</span><span class="p">)</span>
            <span class="n">writer</span><span class="o">.</span><span class="n">SetInputData</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">writer</span><span class="o">.</span><span class="n">Write</span><span class="p">()</span>

        <span class="n">meanflow</span> <span class="o">=</span> <span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">tp</span><span class="o">.</span><span class="n">Flow</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="k">for</span> <span class="n">tp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">TimePoints</span><span class="p">])</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodeids</span><span class="p">]</span>
        <span class="n">flow</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkFloatArray</span><span class="p">()</span>
        <span class="n">flow</span><span class="o">.</span><span class="n">SetNumberOfComponents</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">flow</span><span class="o">.</span><span class="n">SetName</span><span class="p">(</span><span class="s2">&quot;Flow&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">surfacenode</span> <span class="ow">in</span> <span class="n">surfacenodes</span><span class="p">:</span>
            <span class="n">cluster</span> <span class="o">=</span> <span class="n">clustermap</span><span class="p">[</span><span class="n">surfacenode</span><span class="p">]</span>
            <span class="n">fractionflow</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">cluster</span><span class="p">:</span>
                <span class="n">outletflow</span> <span class="o">=</span> <span class="n">meanflow</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">clustersize</span> <span class="o">=</span> <span class="n">pointspercluster</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">fractionflow</span> <span class="o">+=</span> <span class="n">outletflow</span> <span class="o">/</span> <span class="n">clustersize</span>
            <span class="n">flow</span><span class="o">.</span><span class="n">InsertNextValue</span><span class="p">(</span><span class="n">fractionflow</span><span class="p">)</span>

        <span class="n">writer</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkXMLPolyDataWriter</span><span class="p">()</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">resultsfolder</span> <span class="o">+</span> <span class="s2">&quot;FlowDistributedMean.vtp&quot;</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">SetFileName</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">data</span><span class="o">.</span><span class="n">GetPointData</span><span class="p">()</span><span class="o">.</span><span class="n">AddArray</span><span class="p">(</span><span class="n">flow</span><span class="p">)</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">SetInputData</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">Write</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">GetMeanFlowRates</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">nodeids</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">clusterids</span><span class="p">,</span> <span class="n">areas</span><span class="p">,</span> <span class="n">majorvesselid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">LoadClusters</span><span class="p">()</span>
        <span class="n">time</span> <span class="o">=</span> <span class="p">[</span><span class="n">tp</span><span class="o">.</span><span class="n">WT</span> <span class="k">for</span> <span class="n">tp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">TimePoints</span><span class="p">]</span>
        <span class="n">totalflow</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">regionsflowvolume</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">)]</span>
        <span class="n">clusterflowrate</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">clusterPressure</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">nodeids</span><span class="p">):</span>
            <span class="n">flowdatanode</span> <span class="o">=</span> <span class="p">[</span><span class="n">tp</span><span class="o">.</span><span class="n">Flow</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="k">for</span> <span class="n">tp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">TimePoints</span><span class="p">]</span>
            <span class="n">flowvolume</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="n">flowdatanode</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span>
            <span class="n">flowrate</span> <span class="o">=</span> <span class="n">flowvolume</span> <span class="o">/</span> <span class="n">time</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">totalflow</span> <span class="o">+=</span> <span class="n">flowvolume</span>
            <span class="n">major</span> <span class="o">=</span> <span class="n">majorvesselid</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span>
            <span class="n">regionsflowvolume</span><span class="p">[</span><span class="n">major</span><span class="p">]</span> <span class="o">+=</span> <span class="n">flowvolume</span>
            <span class="n">clusterflowrate</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">flowrate</span><span class="p">)</span>

            <span class="n">pressuredatanode</span> <span class="o">=</span> <span class="p">[</span><span class="n">tp</span><span class="o">.</span><span class="n">Pressure</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="k">for</span> <span class="n">tp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">TimePoints</span><span class="p">]</span>
            <span class="n">pressureall</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="n">pressuredatanode</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span>
            <span class="n">pressurefinal</span> <span class="o">=</span> <span class="n">pressureall</span> <span class="o">/</span> <span class="n">time</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">clusterPressure</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pressurefinal</span><span class="p">)</span>

        <span class="n">regionsflowrateregion</span> <span class="o">=</span> <span class="p">[</span><span class="n">element</span> <span class="o">/</span> <span class="n">time</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">regionsflowvolume</span><span class="p">]</span>
        <span class="n">sumflow</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">flow</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">flow</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">clusterflowrate</span><span class="p">)</span> <span class="k">if</span> <span class="n">majorvesselid</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">regionsflowrateregion</span><span class="p">,</span> <span class="n">clusterflowrate</span><span class="p">,</span> <span class="n">clusterPressure</span>

    <span class="k">def</span> <span class="nf">DistributeFlowTriangles</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Distributing flow to the coupling points&quot;</span><span class="p">)</span>
        <span class="c1"># use this when the clustering is done with the primal graph, i.e. the vertices.</span>
        <span class="c1"># the only difference with the dual graph clustering is the type of data,</span>
        <span class="c1"># cell vs point and the cluster size might be different</span>
        <span class="n">nodeids</span><span class="p">,</span> <span class="n">positions</span><span class="p">,</span> <span class="n">couplingpointsN</span><span class="p">,</span> <span class="n">clusterids</span><span class="p">,</span> <span class="n">areas</span><span class="p">,</span> <span class="n">majorvesselid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">LoadClusters</span><span class="p">()</span>
        <span class="n">surfacenodes</span><span class="p">,</span> <span class="n">clustermap</span><span class="p">,</span> <span class="n">triangleAreas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">LoadSurfaceMapping</span><span class="p">()</span>

        <span class="n">reader</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkXMLPolyDataReader</span><span class="p">()</span>
        <span class="n">reader</span><span class="o">.</span><span class="n">SetFileName</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">ModellingFolder</span> <span class="o">+</span> <span class="s2">&quot;Clustering.vtp&quot;</span><span class="p">)</span>
        <span class="n">reader</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">()</span>
        <span class="n">outputfolder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">ModellingFolder</span> <span class="o">+</span> <span class="s2">&quot;TimeSeries/&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">outputfolder</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">outputfolder</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">timeindex</span><span class="p">,</span> <span class="n">timepoint</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">TimePoints</span><span class="p">):</span>
            <span class="n">flow</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkFloatArray</span><span class="p">()</span>
            <span class="n">flow</span><span class="o">.</span><span class="n">SetNumberOfComponents</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">flow</span><span class="o">.</span><span class="n">SetName</span><span class="p">(</span><span class="s2">&quot;Volume Flow Rate (mL/s)&quot;</span><span class="p">)</span>

            <span class="n">pressure</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkFloatArray</span><span class="p">()</span>
            <span class="n">pressure</span><span class="o">.</span><span class="n">SetNumberOfComponents</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">pressure</span><span class="o">.</span><span class="n">SetName</span><span class="p">(</span><span class="s2">&quot;Pressure (Pa)&quot;</span><span class="p">)</span>

            <span class="n">flowrate</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkFloatArray</span><span class="p">()</span>
            <span class="n">flowrate</span><span class="o">.</span><span class="n">SetNumberOfComponents</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">flowrate</span><span class="o">.</span><span class="n">SetName</span><span class="p">(</span><span class="s2">&quot;Flow Velocity (m/s)&quot;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">clusters</span><span class="p">,</span> <span class="n">surfacenode</span><span class="p">,</span> <span class="n">triangleArea</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">clustermap</span><span class="p">,</span> <span class="n">surfacenodes</span><span class="p">,</span> <span class="n">triangleAreas</span><span class="p">):</span>
                <span class="n">FlowRatePerOutlet</span> <span class="o">=</span> <span class="p">[</span><span class="n">timepoint</span><span class="o">.</span><span class="n">Flow</span><span class="p">[</span><span class="n">nodeids</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">/</span> <span class="n">areas</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">clusters</span><span class="p">]</span>
                <span class="n">PressurePerCluster</span> <span class="o">=</span> <span class="p">[</span><span class="n">timepoint</span><span class="o">.</span><span class="n">Pressure</span><span class="p">[</span><span class="n">nodeids</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">clusters</span><span class="p">]</span>
                <span class="n">FlowPerTriangle</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">FlowRatePerOutlet</span><span class="p">)</span> <span class="o">*</span> <span class="n">triangleArea</span>

                <span class="n">flow</span><span class="o">.</span><span class="n">InsertNextValue</span><span class="p">(</span><span class="n">FlowPerTriangle</span><span class="p">)</span>
                <span class="n">flowrate</span><span class="o">.</span><span class="n">InsertNextValue</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">FlowRatePerOutlet</span><span class="p">))</span>
                <span class="n">pressure</span><span class="o">.</span><span class="n">InsertNextValue</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">PressurePerCluster</span><span class="p">))</span>

            <span class="n">writer</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkXMLPolyDataWriter</span><span class="p">()</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">outputfolder</span> <span class="o">+</span> <span class="s2">&quot;FlowDistributed&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">timeindex</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.vtp&quot;</span>
            <span class="n">writer</span><span class="o">.</span><span class="n">SetFileName</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
            <span class="n">data</span><span class="o">.</span><span class="n">GetCellData</span><span class="p">()</span><span class="o">.</span><span class="n">AddArray</span><span class="p">(</span><span class="n">flow</span><span class="p">)</span>
            <span class="n">data</span><span class="o">.</span><span class="n">GetCellData</span><span class="p">()</span><span class="o">.</span><span class="n">AddArray</span><span class="p">(</span><span class="n">flowrate</span><span class="p">)</span>
            <span class="n">data</span><span class="o">.</span><span class="n">GetCellData</span><span class="p">()</span><span class="o">.</span><span class="n">AddArray</span><span class="p">(</span><span class="n">pressure</span><span class="p">)</span>
            <span class="n">writer</span><span class="o">.</span><span class="n">SetInputData</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">writer</span><span class="o">.</span><span class="n">Write</span><span class="p">()</span>

        <span class="n">time</span> <span class="o">=</span> <span class="p">[</span><span class="n">tp</span><span class="o">.</span><span class="n">WT</span> <span class="k">for</span> <span class="n">tp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">TimePoints</span><span class="p">]</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">meanflowrate</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetMeanFlowRates</span><span class="p">()</span>
        <span class="n">flow</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkFloatArray</span><span class="p">()</span>
        <span class="n">flow</span><span class="o">.</span><span class="n">SetNumberOfComponents</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">flow</span><span class="o">.</span><span class="n">SetName</span><span class="p">(</span><span class="s2">&quot;Volume Flow Rate (mL/s)&quot;</span><span class="p">)</span>
        <span class="n">flowrate</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkFloatArray</span><span class="p">()</span>
        <span class="n">flowrate</span><span class="o">.</span><span class="n">SetNumberOfComponents</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">flowrate</span><span class="o">.</span><span class="n">SetName</span><span class="p">(</span><span class="s2">&quot;Flow Velocity (m/s)&quot;</span><span class="p">)</span>
        <span class="n">pressure</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkFloatArray</span><span class="p">()</span>
        <span class="n">pressure</span><span class="o">.</span><span class="n">SetNumberOfComponents</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">pressure</span><span class="o">.</span><span class="n">SetName</span><span class="p">(</span><span class="s2">&quot;Pressure (Pa)&quot;</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">ModellingFolder</span> <span class="o">+</span> <span class="s2">&quot;Results.pvd&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&lt;?xml version=</span><span class="se">\&quot;</span><span class="s2">1.0</span><span class="se">\&quot;</span><span class="s2">?&gt;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                <span class="s2">&quot;&lt;VTKFile type=</span><span class="se">\&quot;</span><span class="s2">Collection</span><span class="se">\&quot;</span><span class="s2"> version=</span><span class="se">\&quot;</span><span class="s2">0.1</span><span class="se">\&quot;</span><span class="s2"> byte_order=</span><span class="se">\&quot;</span><span class="s2">LittleEndian</span><span class="se">\&quot;</span><span class="s2"> compressor=</span><span class="se">\&quot;</span><span class="s2">vtkZLibDataCompressor</span><span class="se">\&quot;</span><span class="s2">&gt;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&lt;Collection&gt;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">timeindex</span><span class="p">,</span> <span class="n">timepoint</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">TimePoints</span><span class="p">):</span>
                <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;TimeSeries/FlowDistributed&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">timeindex</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.vtp&quot;</span>
                <span class="n">time</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">timepoint</span><span class="o">.</span><span class="n">WT</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&lt;DataSet timestep=</span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">time</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2"> group=</span><span class="se">\&quot;\&quot;</span><span class="s2"> part=</span><span class="se">\&quot;</span><span class="s2">0</span><span class="se">\&quot;</span><span class="s2"> file=</span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">/&gt;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&lt;/Collection&gt;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&lt;/VTKFile&gt;&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">clusters</span><span class="p">,</span> <span class="n">surfacenode</span><span class="p">,</span> <span class="n">triangleArea</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">clustermap</span><span class="p">,</span> <span class="n">surfacenodes</span><span class="p">,</span> <span class="n">triangleAreas</span><span class="p">):</span>
            <span class="n">FlowRatePerOutlet</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">MeanVolumeFlowRatePerNode</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">nodeids</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">/</span> <span class="n">areas</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">clusters</span><span class="p">]</span>
            <span class="n">PressurePerCluster</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">MeanPressurePerNode</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">nodeids</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">clusters</span><span class="p">]</span>
            <span class="n">FlowPerTriangle</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">FlowRatePerOutlet</span><span class="p">)</span> <span class="o">*</span> <span class="n">triangleArea</span>

            <span class="n">flow</span><span class="o">.</span><span class="n">InsertNextValue</span><span class="p">(</span><span class="n">FlowPerTriangle</span><span class="p">)</span>
            <span class="n">flowrate</span><span class="o">.</span><span class="n">InsertNextValue</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">FlowRatePerOutlet</span><span class="p">))</span>
            <span class="n">pressure</span><span class="o">.</span><span class="n">InsertNextValue</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">PressurePerCluster</span><span class="p">))</span>

        <span class="n">writer</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkXMLPolyDataWriter</span><span class="p">()</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">ModellingFolder</span> <span class="o">+</span> <span class="s2">&quot;FlowDistributedMean.vtp&quot;</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">SetFileName</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">data</span><span class="o">.</span><span class="n">GetCellData</span><span class="p">()</span><span class="o">.</span><span class="n">AddArray</span><span class="p">(</span><span class="n">flow</span><span class="p">)</span>
        <span class="n">data</span><span class="o">.</span><span class="n">GetCellData</span><span class="p">()</span><span class="o">.</span><span class="n">AddArray</span><span class="p">(</span><span class="n">flowrate</span><span class="p">)</span>
        <span class="n">data</span><span class="o">.</span><span class="n">GetCellData</span><span class="p">()</span><span class="o">.</span><span class="n">AddArray</span><span class="p">(</span><span class="n">pressure</span><span class="p">)</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">SetInputData</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">Write</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">WriteTimeseriesVessels</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">reader</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkXMLPolyDataReader</span><span class="p">()</span>
        <span class="n">reader</span><span class="o">.</span><span class="n">SetFileName</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">ModellingFolder</span> <span class="o">+</span> <span class="s2">&quot;Topology.vtp&quot;</span><span class="p">)</span>
        <span class="n">reader</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">()</span>
        <span class="n">outputfolder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">ModellingFolder</span> <span class="o">+</span> <span class="s2">&quot;TimeSeriesBF/&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">outputfolder</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">outputfolder</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">timeindex</span><span class="p">,</span> <span class="n">timepoint</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">Time</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">flow</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkFloatArray</span><span class="p">()</span>
            <span class="n">flow</span><span class="o">.</span><span class="n">SetNumberOfComponents</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">flow</span><span class="o">.</span><span class="n">SetName</span><span class="p">(</span><span class="s2">&quot;Volume Flowrate (mL/s)&quot;</span><span class="p">)</span>

            <span class="n">velocity</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkFloatArray</span><span class="p">()</span>
            <span class="n">velocity</span><span class="o">.</span><span class="n">SetNumberOfComponents</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">velocity</span><span class="o">.</span><span class="n">SetName</span><span class="p">(</span><span class="s2">&quot;Velocity (m/s)&quot;</span><span class="p">)</span>

            <span class="n">pressure</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkFloatArray</span><span class="p">()</span>
            <span class="n">pressure</span><span class="o">.</span><span class="n">SetNumberOfComponents</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">pressure</span><span class="o">.</span><span class="n">SetName</span><span class="p">(</span><span class="s2">&quot;Pressure (pa)&quot;</span><span class="p">)</span>

            <span class="n">radius</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkFloatArray</span><span class="p">()</span>
            <span class="n">radius</span><span class="o">.</span><span class="n">SetNumberOfComponents</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">radius</span><span class="o">.</span><span class="n">SetName</span><span class="p">(</span><span class="s2">&quot;Radius (mm)&quot;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">nodeindex</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">Pressure</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])):</span>
                <span class="n">flow</span><span class="o">.</span><span class="n">InsertNextValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">VolumeFlowRate</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">nodeindex</span><span class="p">][</span><span class="n">timeindex</span><span class="p">])</span>
                <span class="n">velocity</span><span class="o">.</span><span class="n">InsertNextValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">Velocity</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">nodeindex</span><span class="p">][</span><span class="n">timeindex</span><span class="p">])</span>
                <span class="n">pressure</span><span class="o">.</span><span class="n">InsertNextValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">Pressure</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">nodeindex</span><span class="p">][</span><span class="n">timeindex</span><span class="p">])</span>
                <span class="n">radius</span><span class="o">.</span><span class="n">InsertNextValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">Radius</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">nodeindex</span><span class="p">][</span><span class="n">timeindex</span><span class="p">])</span>

            <span class="n">writer</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkXMLPolyDataWriter</span><span class="p">()</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">outputfolder</span> <span class="o">+</span> <span class="s2">&quot;Bloodflow&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">timeindex</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.vtp&quot;</span>
            <span class="n">writer</span><span class="o">.</span><span class="n">SetFileName</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
            <span class="n">data</span><span class="o">.</span><span class="n">GetPointData</span><span class="p">()</span><span class="o">.</span><span class="n">AddArray</span><span class="p">(</span><span class="n">flow</span><span class="p">)</span>
            <span class="n">data</span><span class="o">.</span><span class="n">GetPointData</span><span class="p">()</span><span class="o">.</span><span class="n">AddArray</span><span class="p">(</span><span class="n">velocity</span><span class="p">)</span>
            <span class="n">data</span><span class="o">.</span><span class="n">GetPointData</span><span class="p">()</span><span class="o">.</span><span class="n">AddArray</span><span class="p">(</span><span class="n">pressure</span><span class="p">)</span>
            <span class="n">data</span><span class="o">.</span><span class="n">GetPointData</span><span class="p">()</span><span class="o">.</span><span class="n">AddArray</span><span class="p">(</span><span class="n">radius</span><span class="p">)</span>
            <span class="n">writer</span><span class="o">.</span><span class="n">SetInputData</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">writer</span><span class="o">.</span><span class="n">Write</span><span class="p">()</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">ModellingFolder</span> <span class="o">+</span> <span class="s2">&quot;ResultsBF.pvd&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&lt;?xml version=</span><span class="se">\&quot;</span><span class="s2">1.0</span><span class="se">\&quot;</span><span class="s2">?&gt;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                <span class="s2">&quot;&lt;VTKFile type=</span><span class="se">\&quot;</span><span class="s2">Collection</span><span class="se">\&quot;</span><span class="s2"> version=</span><span class="se">\&quot;</span><span class="s2">0.1</span><span class="se">\&quot;</span><span class="s2"> byte_order=</span><span class="se">\&quot;</span><span class="s2">LittleEndian</span><span class="se">\&quot;</span><span class="s2"> compressor=</span><span class="se">\&quot;</span><span class="s2">vtkZLibDataCompressor</span><span class="se">\&quot;</span><span class="s2">&gt;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&lt;Collection&gt;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">timeindex</span><span class="p">,</span> <span class="n">timepoint</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">TimePoints</span><span class="p">):</span>
                <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;TimeSeriesBF/Bloodflow&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">timeindex</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.vtp&quot;</span>
                <span class="n">time</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">timepoint</span><span class="o">.</span><span class="n">WT</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&lt;DataSet timestep=</span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">time</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2"> group=</span><span class="se">\&quot;\&quot;</span><span class="s2"> part=</span><span class="se">\&quot;</span><span class="s2">0</span><span class="se">\&quot;</span><span class="s2"> file=</span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">/&gt;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&lt;/Collection&gt;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&lt;/VTKFile&gt;&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">ImportClotNodeFile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">ModellingFolder</span> <span class="o">+</span> <span class="s2">&quot;Clots.txt&quot;</span>
        <span class="n">clotdata</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">)][</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">ClotID</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">clotdata</span><span class="p">]</span>
        <span class="n">NodeID</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">clotdata</span><span class="p">]</span>
        <span class="n">Permeability</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">clotdata</span><span class="p">]</span>
        <span class="n">Porosity</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">clotdata</span><span class="p">]</span>
        <span class="n">uniqueclots</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">ClotID</span><span class="p">)</span>
        <span class="n">clots</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">uniqueclots</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">id_number</span> <span class="ow">in</span> <span class="n">uniqueclots</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">clotid</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ClotID</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">clotid</span> <span class="o">==</span> <span class="n">id_number</span><span class="p">:</span>
                    <span class="n">clots</span><span class="p">[</span><span class="n">id_number</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">NodeID</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">Permeability</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">Porosity</span><span class="p">[</span><span class="n">index</span><span class="p">]))</span>

    <span class="k">def</span> <span class="nf">ImportClots</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">InputFolder</span> <span class="o">+</span> <span class="s2">&quot;Clots.txt&quot;</span>
        <span class="c1"># first add new nodes with at the location of the clot</span>
        <span class="c1"># then map the clot to the node</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">GeneralFunctions</span><span class="o">.</span><span class="n">is_non_zero_file</span><span class="p">(</span><span class="n">file</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No clotfile found.&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Importing Clots.&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="k">as</span> <span class="n">csvfile</span><span class="p">:</span>
            <span class="n">reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictReader</span><span class="p">(</span><span class="n">csvfile</span><span class="p">)</span>
            <span class="n">Clots</span> <span class="o">=</span> <span class="p">[</span><span class="n">clot</span> <span class="k">for</span> <span class="n">clot</span> <span class="ow">in</span> <span class="n">reader</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">clot</span> <span class="ow">in</span> <span class="n">Clots</span><span class="p">:</span>
            <span class="n">vesselname</span> <span class="o">=</span> <span class="n">clot</span><span class="p">[</span><span class="s1">&#39;Vesselname&#39;</span><span class="p">]</span>
            <span class="n">location</span> <span class="o">=</span> <span class="n">clot</span><span class="p">[</span><span class="s1">&#39;Clotlocation(mm)&#39;</span><span class="p">]</span>
            <span class="n">length</span> <span class="o">=</span> <span class="n">clot</span><span class="p">[</span><span class="s1">&#39;Clotlength(mm)&#39;</span><span class="p">]</span>
            <span class="n">permeability</span> <span class="o">=</span> <span class="n">clot</span><span class="p">[</span><span class="s1">&#39;Permeability&#39;</span><span class="p">]</span>
            <span class="n">porosity</span> <span class="o">=</span> <span class="n">clot</span><span class="p">[</span><span class="s1">&#39;Porosity&#39;</span><span class="p">]</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">vessel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">VesselAtlas</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">vesselname</span><span class="p">)]</span>
                <span class="n">numbergridnodes</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">vessel</span><span class="o">.</span><span class="n">Length</span> <span class="o">/</span> <span class="mf">0.5</span><span class="p">))</span>  <span class="c1"># update resolution to about 0.5mm</span>
                <span class="n">vessel</span><span class="o">.</span><span class="n">UpdateResolution</span><span class="p">(</span><span class="n">numbergridnodes</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">UpdateTopology</span><span class="p">()</span>
                <span class="n">location</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">permeability</span><span class="p">,</span> <span class="n">porosity</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">location</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">length</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">permeability</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span>
                    <span class="n">porosity</span><span class="p">)</span>

                <span class="c1"># this will break compatibility with the pulsatile model so only do this when using the steady state model.</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ModelParameters</span><span class="p">[</span><span class="s2">&quot;Model&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Steady&quot;</span><span class="p">:</span>
                    <span class="n">vessel</span><span class="o">.</span><span class="n">add_node_interp_length</span><span class="p">(</span><span class="n">location</span><span class="p">)</span>
                    <span class="n">vessel</span><span class="o">.</span><span class="n">add_node_interp_length</span><span class="p">(</span><span class="n">location</span><span class="o">+</span><span class="n">length</span><span class="p">)</span>

                <span class="c1"># nearest node in the vessel</span>
                <span class="n">clotnodes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                <span class="c1"># boundary</span>
                <span class="n">boundary1</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">argmin</span><span class="p">([</span><span class="nb">abs</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">LengthAlongVessel</span> <span class="o">-</span> <span class="n">location</span><span class="p">)</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">])</span>
                <span class="n">clotnodes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="n">boundary1</span><span class="p">])</span>
                <span class="c1"># internal nodes</span>
                <span class="p">[</span><span class="n">clotnodes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span> <span class="k">if</span>
                 <span class="n">node</span><span class="o">.</span><span class="n">LengthAlongVessel</span> <span class="o">&gt;=</span> <span class="n">location</span> <span class="ow">and</span> <span class="n">node</span><span class="o">.</span><span class="n">LengthAlongVessel</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">location</span> <span class="o">+</span> <span class="n">length</span><span class="p">)]</span>
                <span class="c1"># other boundary</span>
                <span class="n">boundary2</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span>
                    <span class="p">[</span><span class="nb">abs</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">LengthAlongVessel</span> <span class="o">-</span> <span class="p">(</span><span class="n">location</span> <span class="o">+</span> <span class="n">length</span><span class="p">))</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">])</span>
                <span class="n">clotnodes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="n">boundary2</span><span class="p">])</span>

                <span class="n">clotnodes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">clotnodes</span><span class="p">)</span>
                <span class="c1"># if clot extends past a bifurcation, map the clot nodes to the same clot</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Clots</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">clotnodes</span><span class="p">,</span> <span class="n">permeability</span><span class="p">,</span> <span class="n">porosity</span><span class="p">,</span> <span class="n">length</span><span class="p">))</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: Likely caused by the clot file listing non-existent vessels.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">UpdateTopology</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">ShowResults</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># wait for results to be saved</span>
        <span class="c1"># while not is_non_zero_file(self.Results.File):</span>
        <span class="c1">#     print(&quot;Waiting for data.&quot;)</span>
        <span class="c1">#     time.sleep(1)</span>
        <span class="c1"># self.Results.LoadResults(self.Results.File)</span>
        <span class="c1"># open the results window</span>
        <span class="n">app</span> <span class="o">=</span> <span class="n">Results</span><span class="o">.</span><span class="n">QtWidgets</span><span class="o">.</span><span class="n">QApplication</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span>
        <span class="n">win</span> <span class="o">=</span> <span class="n">Results</span><span class="o">.</span><span class="n">ResultsWindow</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">app</span><span class="o">.</span><span class="n">exec</span><span class="p">()</span>
        <span class="c1"># sys.exit(app.exec_())</span>

    <span class="k">def</span> <span class="nf">MappingSixMajorArteries</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Follow the major cerebreal arteries upstream and return the outlets.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Mapping the outlets of the six major cerebral arteries.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">RedefineDirection</span><span class="p">()</span>
        <span class="n">arteries</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;R. ACA, A2&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;R. MCA&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;L. MCA&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;L. ACA, A2&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;R. PCA, P2&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;L. PCA, P2&quot;</span><span class="p">,</span> <span class="p">]</span>

        <span class="n">upstream</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="n">arteries</span><span class="p">:</span>
            <span class="n">upstream</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">GetDownstreamVessels</span><span class="p">(</span><span class="n">vessel</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">region</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">upstream</span><span class="p">):</span>
            <span class="n">vessels</span> <span class="o">=</span> <span class="n">region</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="n">vessels</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">:</span>
                    <span class="n">node</span><span class="o">.</span><span class="n">MajorVesselID</span> <span class="o">=</span> <span class="n">index</span> <span class="o">+</span> <span class="mi">2</span>

        <span class="n">artertydict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Nodes</span><span class="p">):</span>
            <span class="n">artertydict</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">MajorVesselID</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Perfusion</span><span class="o">.</span><span class="n">MajorArteries</span> <span class="o">=</span> <span class="n">artertydict</span>

        <span class="n">outletarteries</span> <span class="o">=</span> <span class="p">[</span><span class="n">artertydict</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">OutletNodes</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">indexregion</span><span class="p">,</span> <span class="n">region</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">arteries</span><span class="p">):</span>
            <span class="n">numberofoutlets</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="n">out</span> <span class="k">for</span> <span class="n">out</span> <span class="ow">in</span> <span class="n">outletarteries</span> <span class="k">if</span> <span class="n">out</span> <span class="o">==</span> <span class="n">indexregion</span> <span class="o">+</span> <span class="mi">2</span><span class="p">])</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">region</span> <span class="o">+</span> <span class="s2">&quot;: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">numberofoutlets</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; outlets&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">ExportDualClustering</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">primal</span><span class="o">=</span><span class="s2">&quot;GMsurface.vtp&quot;</span><span class="p">,</span> <span class="n">dual</span><span class="o">=</span><span class="s2">&quot;Clustering_mapped.vtp&quot;</span><span class="p">):</span>
        <span class="c1"># import the primal graph</span>
        <span class="k">if</span> <span class="n">primal</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span> <span class="o">==</span> <span class="s2">&quot;vtp&quot;</span><span class="p">:</span>
            <span class="n">reader</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkXMLPolyDataReader</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">primal</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span> <span class="o">==</span> <span class="s2">&quot;ply&quot;</span><span class="p">:</span>
            <span class="n">reader</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkPLYReader</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: unreadable file.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">1</span>

        <span class="n">reader</span><span class="o">.</span><span class="n">SetFileName</span><span class="p">(</span><span class="n">primal</span><span class="p">)</span>
        <span class="n">reader</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span>
        <span class="n">primaldata</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">()</span>

        <span class="c1"># import the dual graph with the triangle colour</span>
        <span class="k">if</span> <span class="n">dual</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span> <span class="o">==</span> <span class="s2">&quot;vtp&quot;</span><span class="p">:</span>
            <span class="n">reader</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkXMLPolyDataReader</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">dual</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span> <span class="o">==</span> <span class="s2">&quot;ply&quot;</span><span class="p">:</span>
            <span class="n">reader</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkPLYReader</span><span class="p">()</span>
        <span class="n">reader</span><span class="o">.</span><span class="n">SetFileName</span><span class="p">(</span><span class="n">dual</span><span class="p">)</span>
        <span class="n">reader</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span>

        <span class="n">narray</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">()</span><span class="o">.</span><span class="n">GetPointData</span><span class="p">()</span><span class="o">.</span><span class="n">GetNumberOfArrays</span><span class="p">()</span>
        <span class="c1"># vertex colour of the dual graph is the triangle colour of the primal graph</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">narray</span><span class="p">):</span>
            <span class="n">arrayname</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">()</span><span class="o">.</span><span class="n">GetPointData</span><span class="p">()</span><span class="o">.</span><span class="n">GetArrayName</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">arrayname</span> <span class="o">==</span> <span class="s2">&quot;Colour&quot;</span><span class="p">:</span>
                <span class="n">clusteringdata</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">()</span><span class="o">.</span><span class="n">GetPointData</span><span class="p">()</span><span class="o">.</span><span class="n">GetArray</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">primaldata</span><span class="o">.</span><span class="n">GetCellData</span><span class="p">()</span><span class="o">.</span><span class="n">AddArray</span><span class="p">(</span><span class="n">clusteringdata</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">arrayname</span> <span class="o">==</span> <span class="s2">&quot;Major Cerebral Artery&quot;</span><span class="p">:</span>
                <span class="n">clusteringdata</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">()</span><span class="o">.</span><span class="n">GetPointData</span><span class="p">()</span><span class="o">.</span><span class="n">GetArray</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">primaldata</span><span class="o">.</span><span class="n">GetCellData</span><span class="p">()</span><span class="o">.</span><span class="n">AddArray</span><span class="p">(</span><span class="n">clusteringdata</span><span class="p">)</span>

        <span class="c1"># export to new file</span>
        <span class="n">writer</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkXMLPolyDataWriter</span><span class="p">()</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">ModellingFolder</span> <span class="o">+</span> <span class="s2">&quot;ClusteringByTriangle.vtp&quot;</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">SetFileName</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">SetInputData</span><span class="p">(</span><span class="n">primaldata</span><span class="p">)</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">Write</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">ExportTriangleFlowData</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Exporting Flow Data.&quot;</span><span class="p">)</span>
        <span class="n">file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">ModellingFolder</span> <span class="o">+</span> <span class="s2">&quot;FlowDistributedMean.vtp&quot;</span>

        <span class="n">reader</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkXMLPolyDataReader</span><span class="p">()</span>
        <span class="n">reader</span><span class="o">.</span><span class="n">SetFileName</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
        <span class="n">reader</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span>

        <span class="n">narray</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">()</span><span class="o">.</span><span class="n">GetCellData</span><span class="p">()</span><span class="o">.</span><span class="n">GetNumberOfArrays</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">narray</span><span class="p">):</span>
            <span class="n">arrayname</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">()</span><span class="o">.</span><span class="n">GetCellData</span><span class="p">()</span><span class="o">.</span><span class="n">GetArrayName</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">arrayname</span> <span class="o">==</span> <span class="s2">&quot;Major Cerebral Artery&quot;</span><span class="p">:</span>
                <span class="n">mapCA</span> <span class="o">=</span> <span class="n">vtk_to_numpy</span><span class="p">(</span><span class="n">reader</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">()</span><span class="o">.</span><span class="n">GetCellData</span><span class="p">()</span><span class="o">.</span><span class="n">GetArray</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">arrayname</span> <span class="o">==</span> <span class="s2">&quot;Volume Flow Rate (mL/s)&quot;</span><span class="p">:</span>
                <span class="n">flowdata</span> <span class="o">=</span> <span class="n">vtk_to_numpy</span><span class="p">(</span><span class="n">reader</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">()</span><span class="o">.</span><span class="n">GetCellData</span><span class="p">()</span><span class="o">.</span><span class="n">GetArray</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">arrayname</span> <span class="o">==</span> <span class="s2">&quot;Pressure (Pa)&quot;</span><span class="p">:</span>
                <span class="n">pressuredata</span> <span class="o">=</span> <span class="n">vtk_to_numpy</span><span class="p">(</span><span class="n">reader</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">()</span><span class="o">.</span><span class="n">GetCellData</span><span class="p">()</span><span class="o">.</span><span class="n">GetArray</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">arrayname</span> <span class="o">==</span> <span class="s2">&quot;Colour&quot;</span><span class="p">:</span>
                <span class="n">flowpercluster</span> <span class="o">=</span> <span class="n">vtk_to_numpy</span><span class="p">(</span><span class="n">reader</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">()</span><span class="o">.</span><span class="n">GetCellData</span><span class="p">()</span><span class="o">.</span><span class="n">GetArray</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
                <span class="c1"># todo change for multiple elements per cluster</span>
                <span class="n">flowpercluster</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">flowpercluster</span><span class="p">]</span>

        <span class="n">flowrateperregion</span><span class="p">,</span> <span class="n">clusterflowrate</span><span class="p">,</span> <span class="n">clusterpressure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetMeanFlowRates</span><span class="p">()</span>

        <span class="n">trianglesperregion</span> <span class="o">=</span> <span class="p">[</span><span class="nb">sum</span><span class="p">([</span><span class="mi">1</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">mapCA</span> <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">cluster</span> <span class="o">+</span> <span class="mi">2</span><span class="p">])</span> <span class="k">for</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">)]</span>
        <span class="n">surfacenodes</span><span class="p">,</span> <span class="n">clustermap</span><span class="p">,</span> <span class="n">triangleAreas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">LoadSurfaceMapping</span><span class="p">()</span>

        <span class="n">numberofclusters</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">flowpercluster</span><span class="p">)))</span>
        <span class="n">trianglespercluster</span> <span class="o">=</span> <span class="p">[</span><span class="nb">sum</span><span class="p">([</span><span class="mi">1</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">flowpercluster</span> <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">cluster</span><span class="p">])</span> <span class="k">for</span> <span class="n">cluster</span> <span class="ow">in</span>
                               <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">numberofclusters</span><span class="p">)]</span>

        <span class="n">totalAreaPerCluster</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numberofclusters</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">clusterid</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">numberofclusters</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">triangle</span><span class="p">,</span> <span class="n">area</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">clustermap</span><span class="p">,</span> <span class="n">triangleAreas</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">clusterid</span> <span class="ow">in</span> <span class="n">triangle</span><span class="p">:</span>
                    <span class="n">totalAreaPerCluster</span><span class="p">[</span><span class="n">clusterid</span><span class="p">]</span> <span class="o">+=</span> <span class="n">area</span>

        <span class="n">flowPerAreaPerCluster</span> <span class="o">=</span> <span class="p">[</span><span class="n">clusterflowrate</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="n">totalAreaPerCluster</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">numberofclusters</span><span class="p">)]</span>

        <span class="n">flowPerTriangle</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">surfacenodes</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">triandleID</span><span class="p">,</span> <span class="n">trianglemapping</span><span class="p">,</span> <span class="n">area</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">surfacenodes</span><span class="p">,</span> <span class="n">clustermap</span><span class="p">,</span> <span class="n">triangleAreas</span><span class="p">):</span>
            <span class="n">flowPerTriangle</span><span class="p">[</span><span class="n">triandleID</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">flowPerAreaPerCluster</span><span class="p">[</span><span class="n">id_number</span><span class="p">]</span> <span class="o">*</span> <span class="n">area</span> <span class="k">for</span> <span class="n">id_number</span> <span class="ow">in</span> <span class="n">trianglemapping</span><span class="p">])</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">ModellingFolder</span> <span class="o">+</span> <span class="s2">&quot;TriangleToRegion.csv&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Triangle ID,Cluster ID,Region ID,Flowrate over the triangle(mL/s),Pressure(Pa)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">flow</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">surfacenodes</span><span class="p">,</span> <span class="n">flowPerTriangle</span><span class="p">):</span>
                <span class="n">clustersPerTriangle</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">clustermap</span><span class="p">[</span><span class="n">index</span><span class="p">]))</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">,</span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s2">,</span><span class="si">%d</span><span class="s2">,</span><span class="si">%.10f</span><span class="s2">,</span><span class="si">%.10f</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">index</span><span class="p">,</span> <span class="n">clustersPerTriangle</span><span class="p">,</span> <span class="n">mapCA</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">flow</span><span class="p">,</span> <span class="n">pressuredata</span><span class="p">[</span><span class="n">index</span><span class="p">]))</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">ModellingFolder</span> <span class="o">+</span> <span class="s2">&quot;RegionFlowData.csv&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Region ID,Flow rate over the region(mL/s),number of triangles</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">):</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">,</span><span class="si">%.10f</span><span class="s2">,</span><span class="si">%d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">flowrateperregion</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">trianglesperregion</span><span class="p">[</span><span class="n">index</span><span class="p">]))</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">ModellingFolder</span> <span class="o">+</span> <span class="s2">&quot;ClusterFlowData.csv&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Cluster ID,Flow rate over the region(mL/s),number of triangles,Pressure(Pa)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">numberofclusters</span><span class="p">):</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">,</span><span class="si">%.10f</span><span class="s2">,</span><span class="si">%d</span><span class="s2">,</span><span class="si">%.10f</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">index</span><span class="p">,</span> <span class="n">clusterflowrate</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">trianglespercluster</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">clusterpressure</span><span class="p">[</span><span class="n">index</span><span class="p">]))</span>

    <span class="k">def</span> <span class="nf">MajorArteriesToPialSurfaceNN</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">graph</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Map surface to to nearest node, colour based on nearest vessel.</span>
<span class="sd">        Output is nearest major vessel ID.</span>
<span class="sd">        Note that the left and right halves of the brain are taken into account</span>
<span class="sd">        :param graph: The surface graph to map with the major vessel id of the nearest vessel</span>
<span class="sd">        :return: graph.MajorVesselID is updated to the mapping.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Mapping the surface to the nearest major artery.&quot;</span><span class="p">)</span>
        <span class="n">majornodes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">majornodesID</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Vessels</span><span class="p">:</span>
            <span class="c1"># interpolation of nodes in the vessel</span>
            <span class="n">nodeslengths</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Length</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">vessel</span><span class="o">.</span><span class="n">InterpolationFunctions</span><span class="p">[</span><span class="mi">0</span><span class="p">](</span><span class="n">nodeslengths</span><span class="p">)</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">vessel</span><span class="o">.</span><span class="n">InterpolationFunctions</span><span class="p">[</span><span class="mi">1</span><span class="p">](</span><span class="n">nodeslengths</span><span class="p">)</span>
            <span class="n">z</span> <span class="o">=</span> <span class="n">vessel</span><span class="o">.</span><span class="n">InterpolationFunctions</span><span class="p">[</span><span class="mi">2</span><span class="p">](</span><span class="n">nodeslengths</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">xpos</span><span class="p">,</span> <span class="n">ypos</span><span class="p">,</span> <span class="n">zpos</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
                <span class="n">majornodes</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">xpos</span><span class="p">,</span> <span class="n">ypos</span><span class="p">,</span> <span class="n">zpos</span><span class="p">))</span>
                <span class="n">majornodesID</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vessel</span><span class="o">.</span><span class="n">MajorVesselID</span><span class="p">)</span>

        <span class="c1"># for index, node in enumerate(self.Topology.Nodes):</span>
        <span class="c1">#     if (not (node.Position is None)) and node.MajorVesselID &gt;= 0:</span>
        <span class="c1">#         majornodes.append(node.Position)</span>
        <span class="c1">#         majornodesID.append(node.MajorVesselID)</span>

        <span class="c1"># left and right sides of the pial surface</span>
        <span class="n">rightpialsurface</span> <span class="o">=</span> <span class="p">[</span><span class="n">index</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">graph</span><span class="o">.</span><span class="n">PialSurface</span><span class="p">)</span> <span class="k">if</span>
                            <span class="n">graph</span><span class="o">.</span><span class="n">SideInfo</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">leftpialsurface</span> <span class="o">=</span> <span class="p">[</span><span class="n">index</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">graph</span><span class="o">.</span><span class="n">PialSurface</span><span class="p">)</span> <span class="k">if</span>
                           <span class="n">graph</span><span class="o">.</span><span class="n">SideInfo</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span>

        <span class="c1"># [cow, - , &quot;R. ACA, A2&quot;, &quot;R. MCA&quot;, &quot;L. MCA&quot;, &quot;L. ACA, A2&quot;, &quot;R. PCA, P2&quot;, &quot;L. PCA, P2&quot;]</span>
        <span class="n">leftvessels</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">]</span>
        <span class="n">rightvessels</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">]</span>

        <span class="n">leftnodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">index</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">majornodes</span><span class="p">)</span> <span class="k">if</span> <span class="n">majornodesID</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="ow">in</span> <span class="n">leftvessels</span><span class="p">]</span>
        <span class="n">rightnodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">index</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">majornodes</span><span class="p">)</span> <span class="k">if</span> <span class="n">majornodesID</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="ow">in</span> <span class="n">rightvessels</span><span class="p">]</span>

        <span class="n">sys</span><span class="o">.</span><span class="n">setrecursionlimit</span><span class="p">(</span><span class="mi">10000</span><span class="p">)</span>
        <span class="n">KDTreeleft</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">spatial</span><span class="o">.</span><span class="n">KDTree</span><span class="p">([</span><span class="n">majornodes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">leftnodes</span><span class="p">])</span>
        <span class="n">KDTreeright</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">spatial</span><span class="o">.</span><span class="n">KDTree</span><span class="p">([</span><span class="n">majornodes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">rightnodes</span><span class="p">])</span>

        <span class="n">meshcolour</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">graph</span><span class="o">.</span><span class="n">PialSurface</span><span class="p">]</span>

        <span class="n">MinDistanceR</span><span class="p">,</span> <span class="n">MinDistanceIndexR</span> <span class="o">=</span> <span class="n">KDTreeright</span><span class="o">.</span><span class="n">query</span><span class="p">([</span><span class="n">graph</span><span class="o">.</span><span class="n">PialSurface</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">rightpialsurface</span><span class="p">],</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">MinDistanceL</span><span class="p">,</span> <span class="n">MinDistanceIndexL</span> <span class="o">=</span> <span class="n">KDTreeleft</span><span class="o">.</span><span class="n">query</span><span class="p">([</span><span class="n">graph</span><span class="o">.</span><span class="n">PialSurface</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">leftpialsurface</span><span class="p">],</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">nodeindex</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rightpialsurface</span><span class="p">):</span>
            <span class="n">meshcolour</span><span class="p">[</span><span class="n">nodeindex</span><span class="p">]</span> <span class="o">=</span> <span class="n">majornodesID</span><span class="p">[</span><span class="n">rightnodes</span><span class="p">[</span><span class="n">MinDistanceIndexR</span><span class="p">[</span><span class="n">index</span><span class="p">]]]</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">nodeindex</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">leftpialsurface</span><span class="p">):</span>
            <span class="n">meshcolour</span><span class="p">[</span><span class="n">nodeindex</span><span class="p">]</span> <span class="o">=</span> <span class="n">majornodesID</span><span class="p">[</span><span class="n">leftnodes</span><span class="p">[</span><span class="n">MinDistanceIndexL</span><span class="p">[</span><span class="n">index</span><span class="p">]]]</span>

        <span class="n">graph</span><span class="o">.</span><span class="n">MajorVesselID</span> <span class="o">=</span> <span class="n">meshcolour</span>

    <span class="k">def</span> <span class="nf">MajorArteriesToPialSurfaceOutlets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">graph</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Mapping the surface to the nearest major artery.&quot;</span><span class="p">)</span>
        <span class="c1"># map to nearest node</span>
        <span class="c1"># colour based on nearest outlet node.</span>
        <span class="n">majornodes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">majornodesID</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">OutletNodes</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">Position</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">))</span> <span class="ow">and</span> <span class="n">node</span><span class="o">.</span><span class="n">MajorVesselID</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">majornodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">Position</span><span class="p">)</span>
                <span class="n">majornodesID</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">MajorVesselID</span><span class="p">)</span>

        <span class="c1"># left and right sides of the pial surface</span>
        <span class="n">rightpialsurface</span> <span class="o">=</span> <span class="p">[</span><span class="n">index</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">graph</span><span class="o">.</span><span class="n">PialSurface</span><span class="p">)</span> <span class="k">if</span>
                            <span class="n">graph</span><span class="o">.</span><span class="n">SideInfo</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">leftpialsurface</span> <span class="o">=</span> <span class="p">[</span><span class="n">index</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">graph</span><span class="o">.</span><span class="n">PialSurface</span><span class="p">)</span> <span class="k">if</span>
                           <span class="n">graph</span><span class="o">.</span><span class="n">SideInfo</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span>

        <span class="c1"># [cow, - , &quot;R. ACA, A2&quot;, &quot;R. MCA&quot;, &quot;L. MCA&quot;, &quot;L. ACA, A2&quot;, &quot;R. PCA, P2&quot;, &quot;L. PCA, P2&quot;]</span>
        <span class="n">leftvessels</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">]</span>
        <span class="n">rightvessels</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">]</span>

        <span class="n">leftnodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">index</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">majornodes</span><span class="p">)</span> <span class="k">if</span> <span class="n">majornodesID</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="ow">in</span> <span class="n">leftvessels</span><span class="p">]</span>
        <span class="n">rightnodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">index</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">majornodes</span><span class="p">)</span> <span class="k">if</span> <span class="n">majornodesID</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="ow">in</span> <span class="n">rightvessels</span><span class="p">]</span>

        <span class="n">sys</span><span class="o">.</span><span class="n">setrecursionlimit</span><span class="p">(</span><span class="mi">10000</span><span class="p">)</span>
        <span class="n">KDTreeleft</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">spatial</span><span class="o">.</span><span class="n">KDTree</span><span class="p">([</span><span class="n">majornodes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">leftnodes</span><span class="p">])</span>
        <span class="n">KDTreeright</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">spatial</span><span class="o">.</span><span class="n">KDTree</span><span class="p">([</span><span class="n">majornodes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">rightnodes</span><span class="p">])</span>

        <span class="n">meshcolour</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">graph</span><span class="o">.</span><span class="n">PialSurface</span><span class="p">]</span>

        <span class="n">MinDistanceR</span><span class="p">,</span> <span class="n">MinDistanceIndexR</span> <span class="o">=</span> <span class="n">KDTreeright</span><span class="o">.</span><span class="n">query</span><span class="p">([</span><span class="n">graph</span><span class="o">.</span><span class="n">PialSurface</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">rightpialsurface</span><span class="p">],</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">MinDistanceL</span><span class="p">,</span> <span class="n">MinDistanceIndexL</span> <span class="o">=</span> <span class="n">KDTreeleft</span><span class="o">.</span><span class="n">query</span><span class="p">([</span><span class="n">graph</span><span class="o">.</span><span class="n">PialSurface</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">leftpialsurface</span><span class="p">],</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">nodeindex</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rightpialsurface</span><span class="p">):</span>
            <span class="n">meshcolour</span><span class="p">[</span><span class="n">nodeindex</span><span class="p">]</span> <span class="o">=</span> <span class="n">majornodesID</span><span class="p">[</span><span class="n">rightnodes</span><span class="p">[</span><span class="n">MinDistanceIndexR</span><span class="p">[</span><span class="n">index</span><span class="p">]]]</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">nodeindex</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">leftpialsurface</span><span class="p">):</span>
            <span class="n">meshcolour</span><span class="p">[</span><span class="n">nodeindex</span><span class="p">]</span> <span class="o">=</span> <span class="n">majornodesID</span><span class="p">[</span><span class="n">leftnodes</span><span class="p">[</span><span class="n">MinDistanceIndexL</span><span class="p">[</span><span class="n">index</span><span class="p">]]]</span>

        <span class="n">graph</span><span class="o">.</span><span class="n">MajorVesselID</span> <span class="o">=</span> <span class="n">meshcolour</span>

    <span class="k">def</span> <span class="nf">WriteRegionMapping</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s2">&quot;RegionMap.csv&quot;</span><span class="p">):</span>
        <span class="n">file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">ModellingFolder</span> <span class="o">+</span> <span class="n">filename</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Writing the mapping per region to file: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">file</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;NodeID,MajorVesselID</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Nodes</span><span class="p">):</span>
                <span class="n">regionid</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">MajorVesselID</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">Number</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">regionid</span><span class="p">))</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">LoadRegionMapping</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s2">&quot;RegionMap.csv&quot;</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Loading region map&quot;</span><span class="p">)</span>
        <span class="n">file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">ModellingFolder</span> <span class="o">+</span> <span class="n">filename</span>
        <span class="n">regiondata</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">)]</span>
        <span class="n">regiondict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">nodedata</span> <span class="ow">in</span> <span class="n">regiondata</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="n">regiondict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">nodedata</span><span class="p">[</span><span class="mi">0</span><span class="p">])]]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">nodedata</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">nodedata</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span><span class="o">.</span><span class="n">MajorVesselID</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">nodedata</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Perfusion</span><span class="o">.</span><span class="n">MajorArteries</span> <span class="o">=</span> <span class="n">regiondict</span>

    <span class="k">def</span> <span class="nf">Initiate1DSteadyStateModel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Initiating steady state model.&quot;</span><span class="p">)</span>
        <span class="n">referencepressure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PatientData</span><span class="p">[</span><span class="s2">&quot;DiastolePressure&quot;</span><span class="p">]</span>
        <span class="c1"># outpressure = self.ModelParameters[&quot;OUT_PRESSURE&quot;]</span>
        <span class="n">outpressure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PatientData</span><span class="p">[</span><span class="s2">&quot;MeanRightAtrialPressure&quot;</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">inlet</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">InletNodes</span><span class="p">:</span>
            <span class="n">inlet</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">InletFlowRate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PatientData</span><span class="p">[</span><span class="s2">&quot;StrokeVolume&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">PatientData</span><span class="p">[</span><span class="s2">&quot;HeartRate&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">60</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e-6</span>
            <span class="n">inlet</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">InletPressure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PatientData</span><span class="p">[</span><span class="s2">&quot;SystolePressure&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">PatientData</span><span class="p">[</span>
                <span class="s2">&quot;DiastolePressure&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Nodes</span><span class="p">:</span>
            <span class="n">node</span><span class="o">.</span><span class="n">RefRadius</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">Radius</span><span class="p">)</span>
            <span class="n">node</span><span class="o">.</span><span class="n">RefPressure</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">referencepressure</span><span class="p">)</span>
            <span class="n">node</span><span class="o">.</span><span class="n">SetPressureAreaEquation</span><span class="p">()</span>
            <span class="n">node</span><span class="o">.</span><span class="n">Pressure</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">node</span><span class="o">.</span><span class="n">FlowRate</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">node</span><span class="o">.</span><span class="n">Velocity</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Set pressure at the outlets (without windkessel)</span>
        <span class="k">for</span> <span class="n">outlet</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">OutletNodes</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">outlet</span><span class="o">.</span><span class="n">R1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">outlet</span><span class="o">.</span><span class="n">OutPressure</span> <span class="o">=</span> <span class="n">outlet</span><span class="o">.</span><span class="n">InputPressure</span>  <span class="c1"># set pressure here per outlet</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">outlet</span><span class="o">.</span><span class="n">OutPressure</span> <span class="o">=</span> <span class="n">outpressure</span>
            <span class="n">outlet</span><span class="o">.</span><span class="n">OutletFlowRate</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">Solve1DSteadyState</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">clotactive</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">PressureInlets</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">coarseCollaterals</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                           <span class="n">FlowRateOutlets</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">frictionconstant</span><span class="o">=</span><span class="mi">22</span><span class="p">):</span>
        <span class="n">visc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ModelParameters</span><span class="p">[</span><span class="s2">&quot;BLOOD_VISC&quot;</span><span class="p">]</span>

        <span class="n">matrix</span><span class="p">,</span> <span class="n">inputvector</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">edges</span><span class="p">,</span> <span class="n">mapping</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Get1DsteadyNetwork</span><span class="p">(</span><span class="n">visc</span><span class="p">,</span> <span class="n">clotactive</span><span class="p">,</span> <span class="n">PressureInlets</span><span class="p">,</span>
                                                                                      <span class="n">coarseCollaterals</span><span class="p">,</span>
                                                                                      <span class="n">FlowRateOutlets</span><span class="p">,</span> <span class="n">frictionconstant</span><span class="p">)</span>
        <span class="n">oldnodes1</span><span class="p">,</span> <span class="n">oldnodes2</span> <span class="o">=</span> <span class="n">mapping</span>

        <span class="c1"># solve system</span>
        <span class="c1"># solution = scipy.linalg.solve(matrix.todense(), inputvector)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Solving system of size: </span><span class="si">{</span><span class="n">matrix</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">solve</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">factorized</span><span class="p">(</span><span class="n">matrix</span><span class="p">)</span>
        <span class="n">solution</span> <span class="o">=</span> <span class="n">solve</span><span class="p">(</span><span class="n">inputvector</span><span class="p">)</span>
        <span class="c1"># solution = spsolve(matrix, inputvector) # without pre-conditioning</span>
        <span class="c1"># print(f&quot;Condition number: {numpy.linalg.cond(matrix)}&quot;)</span>
        <span class="c1"># print(info)</span>
        <span class="c1"># set pressure to all nodes</span>
        <span class="c1"># clotnodes = [node for clot in self.Topology.Clots for node in clot[0]]</span>
        <span class="c1">#</span>
        <span class="c1"># for node in clotnodes:  # internal clot nodes are not part of the solution from the solver.</span>
        <span class="c1">#     node.Pressure = 0</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">nodes</span><span class="p">)):</span>
            <span class="n">nodes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">Pressure</span> <span class="o">=</span> <span class="n">solution</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">bif</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">BifurcationNodes</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">bif</span><span class="o">.</span><span class="n">Connections</span><span class="p">:</span>
                <span class="n">node</span><span class="o">.</span><span class="n">Pressure</span> <span class="o">=</span> <span class="n">bif</span><span class="o">.</span><span class="n">Pressure</span>

        <span class="c1"># update edges to include the dublicate ends again.</span>
        <span class="k">for</span> <span class="n">replace</span> <span class="ow">in</span> <span class="n">oldnodes1</span><span class="p">:</span>
            <span class="n">edges</span><span class="p">[</span><span class="n">replace</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">replace</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">replace</span> <span class="ow">in</span> <span class="n">oldnodes2</span><span class="p">:</span>
            <span class="n">edges</span><span class="p">[</span><span class="n">replace</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">replace</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># note that the collateral vessels alter the flow rates at the outlets.</span>
        <span class="c1"># the outlet flow rates therefore have to be summed over all connections</span>
        <span class="c1"># (should be zero for any bifurcation and internal vessel node)</span>
        <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">edges</span><span class="p">:</span>
            <span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">AccumulatedFlowRate</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">AccumulatedFlowRate</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">edges</span><span class="p">:</span>
            <span class="n">dp</span> <span class="o">=</span> <span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Pressure</span> <span class="o">-</span> <span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">Pressure</span>
            <span class="n">flowrate</span> <span class="o">=</span> <span class="n">dp</span> <span class="o">*</span> <span class="n">edge</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e6</span>
            <span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">FlowRate</span> <span class="o">=</span> <span class="n">flowrate</span>
            <span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">FlowRate</span> <span class="o">=</span> <span class="n">flowrate</span>
            <span class="n">radius</span> <span class="o">=</span> <span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Radius</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">Radius</span>
            <span class="n">velocity</span> <span class="o">=</span> <span class="n">flowrate</span> <span class="o">/</span> <span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">radius</span> <span class="o">*</span> <span class="n">radius</span><span class="p">)</span>
            <span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Velocity</span> <span class="o">=</span> <span class="n">velocity</span>
            <span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">Velocity</span> <span class="o">=</span> <span class="n">velocity</span>
            <span class="c1"># accumulated flow</span>
            <span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">AccumulatedFlowRate</span> <span class="o">-=</span> <span class="n">flowrate</span>
            <span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">AccumulatedFlowRate</span> <span class="o">+=</span> <span class="n">flowrate</span>

        <span class="k">if</span> <span class="n">clotactive</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">clot</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Clots</span><span class="p">:</span>
                <span class="n">clotnodes</span> <span class="o">=</span> <span class="n">clot</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">porocity</span> <span class="o">=</span> <span class="n">clot</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">clotnode</span> <span class="ow">in</span> <span class="n">clotnodes</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">porocity</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">clotnode</span><span class="o">.</span><span class="n">Velocity</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># effective area</span>
                        <span class="n">area</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">clotnode</span><span class="o">.</span><span class="n">RefRadius</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">pi</span>
                        <span class="n">clotnode</span><span class="o">.</span><span class="n">Velocity</span> <span class="o">=</span> <span class="n">clotnode</span><span class="o">.</span><span class="n">FlowRate</span> <span class="o">/</span> <span class="p">(</span><span class="n">area</span><span class="o">*</span><span class="n">porocity</span><span class="p">)</span>

            <span class="c1"># for edge in edges:</span>
            <span class="c1">#     if (edge[0] in clotnodes) and (edge[1] in clotnodes):</span>
            <span class="c1">#         if porocity == 0:</span>
            <span class="c1">#             edge[0].Velocity = 0</span>
            <span class="c1">#             edge[1].Velocity = 0</span>
            <span class="c1">#         else:</span>
            <span class="c1">#             edge[0].Velocity = edge[0].FlowRate/porocity</span>
            <span class="c1">#             edge[1].Velocity = edge[0].FlowRate/porocity</span>

        <span class="c1"># define flow rate at the outlet as the accumulation of flow (source term)</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">OutletNodes</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">R1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">node</span><span class="o">.</span><span class="n">FlowRate</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">WKNode</span><span class="o">.</span><span class="n">AccumulatedFlowRate</span>

        <span class="c1"># calculate new radius</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Nodes</span><span class="p">:</span>
            <span class="n">node</span><span class="o">.</span><span class="n">UpdateRadius</span><span class="p">()</span>
            <span class="c1"># vessel.CalculateMeanRadius()</span>

        <span class="n">solution</span> <span class="o">=</span> <span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">Pressure</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Nodes</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">solution</span>

    <span class="k">def</span> <span class="nf">Solve1DSteadyStateNonLinear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">visc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ModelParameters</span><span class="p">[</span><span class="s2">&quot;BLOOD_VISC&quot;</span><span class="p">]</span>

        <span class="n">solution</span><span class="p">,</span> <span class="n">nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">nonlinearmodel</span><span class="p">(</span><span class="n">visc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ModelParameters</span><span class="p">[</span><span class="s2">&quot;Density&quot;</span><span class="p">])</span>

        <span class="c1"># solve system</span>
        <span class="c1"># solution = scipy.linalg.solve(matrix.todense(), inputvector)</span>
        <span class="c1"># solved = numpy.allclose(matrix.dot(solution), inputvector)</span>

        <span class="c1"># set pressure to all nodes</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">nodes</span><span class="p">)):</span>
            <span class="n">nodes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">Pressure</span> <span class="o">=</span> <span class="n">solution</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="c1"># for bif in self.Topology.BifurcationNodes:</span>
        <span class="c1">#     for node in bif.Connections:</span>
        <span class="c1">#         node.Pressure = bif.Pressure</span>

        <span class="c1"># calculate new radius</span>
        <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Vessels</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">:</span>
                <span class="n">node</span><span class="o">.</span><span class="n">UpdateRadius</span><span class="p">()</span>
            <span class="n">vessel</span><span class="o">.</span><span class="n">CalculateMeanRadius</span><span class="p">()</span>

        <span class="n">solution</span> <span class="o">=</span> <span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">Pressure</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Nodes</span><span class="p">]</span>
        <span class="c1"># self.Topology.nonlinearmodel(visc, self.ModelParameters[&quot;Density&quot;])</span>
        <span class="k">return</span> <span class="n">solution</span>

    <span class="k">def</span> <span class="nf">UpdateOutletResistanceToPialSurface</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">PialSurfacePressure</span><span class="o">=</span><span class="mi">9000</span><span class="p">):</span>
        <span class="c1"># todo update  to include C and R2 for pulsatile simulations</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">cp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Perfusion</span><span class="o">.</span><span class="n">CouplingPoints</span><span class="p">):</span>
            <span class="n">newresistancetotal</span> <span class="o">=</span> <span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">Node</span><span class="o">.</span><span class="n">Pressure</span> <span class="o">-</span> <span class="n">PialSurfacePressure</span><span class="p">[</span><span class="n">index</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">Node</span><span class="o">.</span><span class="n">FlowRate</span> <span class="o">*</span> <span class="mf">1e-6</span><span class="p">)</span>
            <span class="n">cp</span><span class="o">.</span><span class="n">Node</span><span class="o">.</span><span class="n">R1</span> <span class="o">=</span> <span class="n">newresistancetotal</span>  <span class="c1"># - cp.Node.R1</span>
            <span class="n">cp</span><span class="o">.</span><span class="n">Node</span><span class="o">.</span><span class="n">R2</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Resistance: </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">newresistancetotal</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">newresistancetotal</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># for index, cp in enumerate(self.Perfusion.CouplingPoints):</span>
                <span class="c1">#     print(&quot;1D model: %f - Perfusion model: %f\n&quot; % (cp.Node.Pressure, PialSurfacePressure[index]))</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Error: Negative resistance. Pial surface pressure is higher than the arterial pressure.&quot;</span><span class="p">)</span>
            <span class="c1"># if cp.Node.R2 &lt; 0:</span>
            <span class="c1">#     cp.Node.R2 = 0</span>
            <span class="c1"># cp.Node.R1 = newresistancetotal - cp.Node.R2</span>
            <span class="c1"># print(&quot;Error: R2&lt;0. Setting R2 to 0.1e9 and updating R1.&quot;)</span>
            <span class="n">cp</span><span class="o">.</span><span class="n">Node</span><span class="o">.</span><span class="n">OutPressure</span> <span class="o">=</span> <span class="n">PialSurfacePressure</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>  <span class="c1"># pressure now fixed to this value at this node</span>

    <span class="k">def</span> <span class="nf">UpdatePressureCouplingPoints</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pressures</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the pressure at the coupling points to the perfusion model.</span>
<span class="sd">        :param pressures: (iterable or number) Pressure in pa to be assigned at the coupling point.</span>
<span class="sd">        Order of the pressures given should be in the same order as the coupling points.</span>
<span class="sd">        Coupling point index is equal to the cluster id.</span>
<span class="sd">        :return: Nothing</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">cp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Perfusion</span><span class="o">.</span><span class="n">CouplingPoints</span><span class="p">):</span>
                <span class="c1"># cp.Node.R1 = None  # remove wk elements</span>
                <span class="n">cp</span><span class="o">.</span><span class="n">Node</span><span class="o">.</span><span class="n">OutPressure</span> <span class="o">=</span> <span class="n">pressures</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>  <span class="c1"># pressure now fixed to this value at this node</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">cp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Perfusion</span><span class="o">.</span><span class="n">CouplingPoints</span><span class="p">):</span>
                <span class="c1"># cp.Node.R1 = None  # remove wk elements</span>
                <span class="n">cp</span><span class="o">.</span><span class="n">Node</span><span class="o">.</span><span class="n">OutPressure</span> <span class="o">=</span> <span class="n">pressures</span>  <span class="c1"># pressure now fixed to this value at this node</span>

    <span class="k">def</span> <span class="nf">UpdateFlowRateCouplingPoints</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flowrates</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the flowrate at the coupling points to the perfusion model.</span>
<span class="sd">        :param flowrates: (iterable or number) Flow rate in mL/s to be assigned at the coupling point.</span>
<span class="sd">        Order of the flowrate given should be in the same order as the coupling points.</span>
<span class="sd">        Coupling point index is equal to the cluster id.</span>
<span class="sd">        :return: Nothing</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">cp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Perfusion</span><span class="o">.</span><span class="n">CouplingPoints</span><span class="p">):</span>
                <span class="c1"># cp.Node.R1 = None  # remove wk elements</span>
                <span class="n">cp</span><span class="o">.</span><span class="n">Node</span><span class="o">.</span><span class="n">OutletFlowRate</span> <span class="o">=</span> <span class="n">flowrates</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>  <span class="c1"># flowrate now fixed to this value at this node</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">cp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Perfusion</span><span class="o">.</span><span class="n">CouplingPoints</span><span class="p">):</span>
                <span class="c1"># cp.Node.R1 = None  # remove wk elements</span>
                <span class="n">cp</span><span class="o">.</span><span class="n">Node</span><span class="o">.</span><span class="n">OutletFlowRate</span> <span class="o">=</span> <span class="n">flowrates</span>  <span class="c1"># flowrate now fixed to this value at this node</span>

    <span class="k">def</span> <span class="nf">Run1DSteadyStateModel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="s2">&quot;Linear&quot;</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-10</span><span class="p">,</span> <span class="n">clotactive</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">PressureInlets</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                              <span class="n">coarseCollaterals</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">FlowRateOutlets</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">frictionconstant</span><span class="o">=</span><span class="mi">22</span><span class="p">,</span>
                              <span class="n">scale_resistance</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">clotactive</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Solving steady state: stroke scenario.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Solving steady state: healthy scenario.&quot;</span><span class="p">)</span>
        <span class="c1"># initialise all values</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="n">solutionold</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Solve1DSteadyState</span><span class="p">(</span><span class="n">clotactive</span><span class="p">,</span> <span class="n">PressureInlets</span><span class="p">,</span> <span class="n">coarseCollaterals</span><span class="p">,</span>
                                              <span class="n">FlowRateOutlets</span><span class="p">,</span> <span class="n">frictionconstant</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">model</span> <span class="o">==</span> <span class="s2">&quot;NonLinear&quot;</span><span class="p">:</span>
            <span class="n">solutionold</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Solve1DSteadyStateNonLinear</span><span class="p">()</span>
        <span class="c1"># iterate system again</span>
        <span class="nb">iter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">model</span> <span class="o">==</span> <span class="s2">&quot;Linear&quot;</span><span class="p">:</span>
                <span class="n">solutionnew</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Solve1DSteadyState</span><span class="p">(</span><span class="n">clotactive</span><span class="p">,</span> <span class="n">PressureInlets</span><span class="p">,</span> <span class="n">coarseCollaterals</span><span class="p">,</span>
                                                      <span class="n">FlowRateOutlets</span><span class="p">,</span> <span class="n">frictionconstant</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">model</span> <span class="o">==</span> <span class="s2">&quot;NonLinear&quot;</span><span class="p">:</span>
                <span class="n">solutionnew</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Solve1DSteadyStateNonLinear</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Please specify if model is Linear or NonLinear.&quot;</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="c1"># scale resistances to get both proper flow and pressure at the inlet</span>
            <span class="k">if</span> <span class="n">scale_resistance</span><span class="p">:</span>
                <span class="n">pressure_diff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">InletNodes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Pressure</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">InletNodes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">InletPressure</span>
                <span class="n">flow_rate_diff</span> <span class="o">=</span> <span class="mf">1e-6</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">InletNodes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">FlowRate</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">InletNodes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">InletFlowRate</span>
                <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">pressure_diff</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1e-6</span> <span class="ow">or</span> <span class="nb">abs</span><span class="p">(</span><span class="n">flow_rate_diff</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1e-6</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Detected a difference in inlet boundary conditions, scaling outlet resistance.&quot;</span><span class="p">)</span>
                    <span class="c1"># print(self.Topology.InletNodes[0][0].Pressure)</span>
                    <span class="c1"># print(self.Topology.InletNodes[0][0].InletPressure)</span>
                    <span class="c1"># print(1e-6 * self.Topology.InletNodes[0][0].FlowRate)</span>
                    <span class="c1"># print(self.Topology.InletNodes[0][0].InletFlowRate)</span>

                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Pressure ratio:</span><span class="si">{</span><span class="n">pressure_diff</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Flow Rate ratio:</span><span class="si">{</span><span class="n">flow_rate_diff</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">OutletNodes</span><span class="p">:</span>
                        <span class="c1"># print(node.R2)</span>
                        <span class="c1"># total resistance of the outlet needs to change, but R1 is constant</span>
                        <span class="c1"># scale R2 to compensate, (r1+r2)*p = r1+r2*F</span>
                        <span class="c1"># assumption is also that either pressure or flow rate diff is equal to one already</span>
                        <span class="n">fraction</span> <span class="o">=</span> <span class="p">((</span><span class="n">node</span><span class="o">.</span><span class="n">R1</span><span class="o">+</span><span class="n">node</span><span class="o">.</span><span class="n">R2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">pressure_diff</span><span class="o">*</span><span class="mi">1</span><span class="o">/</span><span class="n">flow_rate_diff</span><span class="p">)</span><span class="o">-</span><span class="n">node</span><span class="o">.</span><span class="n">R1</span><span class="p">)</span><span class="o">/</span><span class="n">node</span><span class="o">.</span><span class="n">R2</span>
                        <span class="n">node</span><span class="o">.</span><span class="n">R2</span> <span class="o">=</span> <span class="n">fraction</span><span class="o">*</span><span class="n">node</span><span class="o">.</span><span class="n">R2</span>
                    <span class="k">continue</span>
            <span class="n">difference</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span>
                <span class="p">[</span><span class="n">solutionold</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">solution</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">solution</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">solutionnew</span><span class="p">)])</span> <span class="o">/</span> <span class="n">numpy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">solutionnew</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Convergence criteria </span><span class="si">%0.12g</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">difference</span><span class="p">)</span>
            <span class="n">solutionold</span> <span class="o">=</span> <span class="n">solutionnew</span>
            <span class="nb">iter</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="k">if</span> <span class="n">difference</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Steady state convergence in </span><span class="si">%d</span><span class="s2"> iterations.&quot;</span> <span class="o">%</span> <span class="nb">iter</span><span class="p">)</span>
                <span class="n">time_elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Time elapsed </span><span class="si">%f</span><span class="s1"> seconds&#39;</span> <span class="o">%</span> <span class="n">time_elapsed</span><span class="p">)</span>
                <span class="k">break</span>

        <span class="c1"># calculate flowrate</span>
        <span class="c1"># visc = self.ModelParameters[&quot;BLOOD_VISC&quot;]</span>
        <span class="c1"># for vessel in self.Topology.Vessels:</span>
        <span class="c1">#     for i in range(1, len(vessel.Nodes)):</span>
        <span class="c1">#         dp = vessel.Nodes[i - 1].Pressure - vessel.Nodes[i].Pressure</span>
        <span class="c1">#         flowrate = dp * self.Topology.SegmentConductance(vessel.Nodes[i - 1], vessel.Nodes[i],</span>
        <span class="c1">#                                                          visc) * 1e6</span>
        <span class="c1">#         vessel.Nodes[i - 1].FlowRate = flowrate</span>
        <span class="c1">#         vessel.Nodes[i - 1].Velocity = flowrate / (</span>
        <span class="c1">#                 scipy.pi * vessel.Nodes[i - 1].Radius * vessel.Nodes[i - 1].Radius)</span>

        <span class="c1"># # vessel ends</span>
        <span class="c1"># for vessel in self.Topology.Vessels:</span>
        <span class="c1">#     dp = vessel.Nodes[-2].Pressure - vessel.Nodes[-1].Pressure</span>
        <span class="c1">#     flowrate = dp * self.Topology.SegmentConductance(vessel.Nodes[-1], vessel.Nodes[-2],</span>
        <span class="c1">#                                                      visc) * 1e6</span>
        <span class="c1">#     vessel.Nodes[- 1].FlowRate = flowrate</span>
        <span class="c1">#     vessel.Nodes[- 1].Velocity = flowrate / (</span>
        <span class="c1">#             scipy.pi * vessel.Nodes[- 1].Radius * vessel.Nodes[- 1].Radius)</span>
        <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Vessels</span><span class="p">:</span>
            <span class="n">vessel</span><span class="o">.</span><span class="n">CalculateMeanRadius</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">bif</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">BifurcationNodes</span><span class="p">:</span>
            <span class="n">bif</span><span class="o">.</span><span class="n">Pressure</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">node</span><span class="o">.</span><span class="n">Pressure</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">bif</span><span class="o">.</span><span class="n">Connections</span><span class="p">)])</span>
            <span class="n">bif</span><span class="o">.</span><span class="n">FlowRate</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># numpy.mean([node.FlowRate for node in list(bif.Connections)])</span>
            <span class="n">bif</span><span class="o">.</span><span class="n">Velocity</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># numpy.mean([node.Velocity for node in list(bif.Connections)])</span>

        <span class="k">if</span> <span class="n">coarseCollaterals</span><span class="p">:</span>
            <span class="n">totalflowrate</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Collaterals</span><span class="p">:</span>
                <span class="n">dp</span> <span class="o">=</span> <span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Pressure</span> <span class="o">-</span> <span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">Pressure</span>
                <span class="n">totalflowrate</span> <span class="o">+=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">dp</span> <span class="o">*</span> <span class="n">edge</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e6</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Total Collateral flow: </span><span class="si">{</span><span class="n">totalflowrate</span><span class="si">}</span><span class="s2"> mL/s&quot;</span><span class="p">)</span>
        <span class="c1"># for node in self.Topology.OutletNodes:</span>
        <span class="c1">#     print(node.WKNode.AccumulatedFlowRate)</span>
        <span class="c1"># totaloutflow = sum([node.WKNode.AccumulatedFlowRate for node in self.Topology.OutletNodes])</span>
        <span class="c1"># print(f&quot;Total outflow: {totaloutflow}&quot;)</span>

    <span class="k">def</span> <span class="nf">Results1DSteadyStateModel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># export to results</span>
        <span class="c1"># we get mean results per node by definition.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">MeanPressurePerNode</span> <span class="o">=</span> <span class="p">[[</span><span class="n">node</span><span class="o">.</span><span class="n">Pressure</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Nodes</span><span class="p">]]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">MeanVelocityPerNode</span> <span class="o">=</span> <span class="p">[[</span><span class="n">node</span><span class="o">.</span><span class="n">Velocity</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Nodes</span><span class="p">]]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">MeanVolumeFlowRatePerNode</span> <span class="o">=</span> <span class="p">[[</span><span class="n">node</span><span class="o">.</span><span class="n">FlowRate</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Nodes</span><span class="p">]]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">MeanRadiusPerNode</span> <span class="o">=</span> <span class="p">[[</span><span class="n">node</span><span class="o">.</span><span class="n">Radius</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Nodes</span><span class="p">]]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">PulsatilityIndexPressure</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Nodes</span><span class="p">]]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">PulsatilityIndexVelocity</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Nodes</span><span class="p">]]</span>

        <span class="n">vesselnames</span> <span class="o">=</span> <span class="p">[</span><span class="n">vessel</span><span class="o">.</span><span class="n">Name</span> <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Vessels</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">MeanResults</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">vesselnodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span> <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Vessels</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">vesselnodes</span><span class="p">):</span>
            <span class="n">meanvalues</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">CalculateMeanVessel</span><span class="p">(</span><span class="n">vessel</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">MeanResults</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">vesselnames</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">meanvalues</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">Export1DSteadyClusterFlowRate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="s2">&quot;ClusterFlowData.csv&quot;</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">ModellingFolder</span> <span class="o">+</span> <span class="n">file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Cluster ID,Flow rate over the region(mL/s),number of triangles,Pressure(Pa)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">cp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Perfusion</span><span class="o">.</span><span class="n">CouplingPoints</span><span class="p">):</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">,</span><span class="si">%.10f</span><span class="s2">,</span><span class="si">%d</span><span class="s2">,</span><span class="si">%.10f</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">cp</span><span class="o">.</span><span class="n">Node</span><span class="o">.</span><span class="n">FlowRate</span><span class="p">,</span> <span class="n">cp</span><span class="o">.</span><span class="n">NumberOfTriangles</span><span class="p">,</span> <span class="n">cp</span><span class="o">.</span><span class="n">Node</span><span class="o">.</span><span class="n">Pressure</span><span class="p">))</span>
    
    <span class="k">def</span> <span class="nf">ExportClotBFValues</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="s2">&quot;BFClotValues.csv&quot;</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">ModellingFolder</span> <span class="o">+</span> <span class="n">file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Clot index,Flow rate(mL/s),Pressure drop(Pa),Proximal pressure (Pa),Distal pressure (Pa),Pressure ratio</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">clot</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Clots</span><span class="p">):</span>
                <span class="n">node1</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">clot</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="n">item</span><span class="o">.</span><span class="n">Number</span><span class="p">)</span>
                <span class="n">node2</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">clot</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="n">item</span><span class="o">.</span><span class="n">Number</span><span class="p">)</span>
                <span class="n">proximal_pressure</span> <span class="o">=</span> <span class="n">node1</span><span class="o">.</span><span class="n">Pressure</span>
                <span class="n">distal_pressure</span> <span class="o">=</span> <span class="n">node2</span><span class="o">.</span><span class="n">Pressure</span>
                <span class="n">pressure_drop</span> <span class="o">=</span> <span class="n">proximal_pressure</span> <span class="o">-</span> <span class="n">distal_pressure</span>
                <span class="n">pressure_ratio</span> <span class="o">=</span> <span class="n">distal_pressure</span><span class="o">/</span><span class="n">proximal_pressure</span>
                <span class="n">flow_rate</span> <span class="o">=</span> <span class="n">node1</span><span class="o">.</span><span class="n">FlowRate</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">,</span><span class="si">%.10f</span><span class="s2">,</span><span class="si">%.10f</span><span class="s2">,</span><span class="si">%.10f</span><span class="s2">,</span><span class="si">%.10f</span><span class="s2">,</span><span class="si">%.10f</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">flow_rate</span><span class="p">,</span> <span class="n">pressure_drop</span><span class="p">,</span> <span class="n">proximal_pressure</span><span class="p">,</span>
                                                                <span class="n">distal_pressure</span><span class="p">,</span> <span class="n">pressure_ratio</span><span class="p">))</span>
</pre></div>

        </details>

            </section>
                <section id="Patient">
                                <div class="attr class">
        <a class="headerlink" href="#Patient">#&nbsp;&nbsp</a>

        
        <span class="def">class</span>
        <span class="name">Patient</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">Patient</span><span class="p">:</span>
    <span class="n">pool</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">folder</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]))):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initiate the patient object with default values.</span>
<span class="sd">        :param folder: path to the main folder.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">folder</span> <span class="o">=</span> <span class="n">folder</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Folders</span> <span class="o">=</span> <span class="n">Metadata</span><span class="o">.</span><span class="n">Folders</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ModelParameters</span> <span class="o">=</span> <span class="n">Metadata</span><span class="o">.</span><span class="n">ModelParameter</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">PatientData</span> <span class="o">=</span> <span class="n">Metadata</span><span class="o">.</span><span class="n">PatientData</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span> <span class="o">=</span> <span class="n">Topology</span><span class="o">.</span><span class="n">Topology</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Results</span> <span class="o">=</span> <span class="n">Results</span><span class="o">.</span><span class="n">Results</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Perfusion</span> <span class="o">=</span> <span class="n">Perfusion</span><span class="o">.</span><span class="n">Perfusion</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">Trees</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Patient folder: &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">PatientFolder</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">RedefineDirectionByFlowDirection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reverses the order of the nodes in each vessel if the flow inside the vessel is negative.</span>
<span class="sd">        This simple defines the positive flow direction to be the direction of flow.</span>
<span class="sd">        :return: Nothing</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">flowdict</span> <span class="o">=</span> <span class="p">{</span><span class="n">vessel</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">vessel</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">MeanResults</span><span class="p">}</span>

        <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Vessels</span><span class="p">:</span>
            <span class="c1"># get the volumeflowrate</span>
            <span class="n">volumeflowrate</span> <span class="o">=</span> <span class="n">flowdict</span><span class="p">[</span><span class="n">vessel</span><span class="o">.</span><span class="n">Name</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">volumeflowrate</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Vessel Reversed&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">RemoveOldSimFiles</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Remove results from previous 1-D blood flow simulations.</span>
<span class="sd">        :return: Nothing</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">folder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">ModellingFolder</span>
        <span class="n">deletelist</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Results.dyn&quot;</span><span class="p">,</span> <span class="s2">&quot;ResultsPrev.dyn&quot;</span><span class="p">,</span> <span class="s2">&quot;ResultsTotal.dyn&quot;</span><span class="p">,</span> <span class="s2">&quot;Convergence.csv&quot;</span><span class="p">,</span> <span class="s2">&quot;Conv.txt&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">deletelist</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">folder</span> <span class="o">+</span> <span class="n">name</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">folder</span> <span class="o">+</span> <span class="n">name</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                    <span class="k">pass</span>
        <span class="n">deletefolder</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;TimeSeries&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">deletefolder</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">folder</span> <span class="o">+</span> <span class="n">name</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">ResetModellingFolder</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">folder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">ModellingFolder</span>
        <span class="n">filenames</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">f</span><span class="p">))]</span>
        <span class="n">blacklist</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;boundary_4&amp;21&amp;22&amp;23&amp;24&amp;25&amp;26&amp;30.h5&quot;</span><span class="p">,</span> <span class="s2">&quot;boundary_4&amp;21&amp;22&amp;23&amp;24&amp;25&amp;26&amp;30.ply&quot;</span><span class="p">,</span>
                     <span class="s2">&quot;Boundary.ply&quot;</span><span class="p">,</span> <span class="s2">&quot;labelled_vol_mesh_high.msh&quot;</span><span class="p">,</span> <span class="s2">&quot;labelled_vol_mesh.msh&quot;</span><span class="p">,</span>
                     <span class="s2">&quot;permeability_tensors.h5&quot;</span><span class="p">,</span> <span class="s2">&quot;Model_parameters.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;PialSurface.vtp&quot;</span><span class="p">,</span> <span class="s2">&quot;Distancemat.npy&quot;</span><span class="p">,</span> <span class="s2">&quot;PA.vtp&quot;</span><span class="p">,</span>
                     <span class="s2">&quot;DualPA.vtp&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">filenames</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">blacklist</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">folder</span> <span class="o">+</span> <span class="n">name</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Deleting file: &quot;</span><span class="p">,</span> <span class="n">folder</span> <span class="o">+</span> <span class="n">name</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error while deleting file: &quot;</span><span class="p">,</span> <span class="n">folder</span> <span class="o">+</span> <span class="n">name</span><span class="p">)</span>

        <span class="n">folders</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">f</span><span class="p">))]</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">folders</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">folder</span> <span class="o">+</span> <span class="n">name</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error while deleting file &quot;</span><span class="p">,</span> <span class="n">folder</span> <span class="o">+</span> <span class="n">name</span><span class="p">)</span>

        <span class="c1"># try:</span>
        <span class="c1">#     shutil.rmtree(self.Folders.PatientFolder + &quot;logfile.log&quot;)</span>
        <span class="c1"># except:</span>
        <span class="c1">#     print(&quot;Error while deleting file &quot;, folder + name)</span>

    <span class="k">def</span> <span class="nf">LoadBFSimFiles</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">LoadBFSimFiles</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">ModellingFolder</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">LoadPatientData</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">LoadModelParameters</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">LoadRegionMapping</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">LoadResults</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="s2">&quot;Results.dyn&quot;</span><span class="p">,</span> <span class="n">correct</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">LoadResults</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">ModellingFolder</span> <span class="o">+</span> <span class="n">file</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">correct</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">CorrectforDirectionVectorOutlets</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">CalculateVelocity</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">CalculateMeanResultsPerNode</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">node</span><span class="p">,</span> <span class="n">pressure</span><span class="p">,</span> <span class="n">volumeflowrate</span><span class="p">,</span> <span class="n">velocity</span><span class="p">,</span> <span class="n">radius</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Nodes</span><span class="p">,</span>
                                                                    <span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">Pressure</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                                    <span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">VolumeFlowRate</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                                    <span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">Velocity</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                                    <span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">Radius</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">node</span><span class="o">.</span><span class="n">Pressure</span> <span class="o">=</span> <span class="n">pressure</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">node</span><span class="o">.</span><span class="n">FlowRate</span> <span class="o">=</span> <span class="n">volumeflowrate</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">node</span><span class="o">.</span><span class="n">Velocity</span> <span class="o">=</span> <span class="n">velocity</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">node</span><span class="o">.</span><span class="n">Radius</span> <span class="o">=</span> <span class="n">radius</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">GetMeanResults</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">GetMeanResults</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Vessels</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">ExportMeanResults</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="s2">&quot;ResultsPerVessel.csv&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">ExportMeanResults</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">ModellingFolder</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">LoadPatientData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="s2">&quot;config.xml&quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">file</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span> <span class="o">==</span> <span class="s2">&quot;txt&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">PatientData</span><span class="o">.</span><span class="n">LoadPatientData</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">InputFolder</span> <span class="o">+</span> <span class="n">file</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">file</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span> <span class="o">==</span> <span class="s2">&quot;xml&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">PatientData</span><span class="o">.</span><span class="n">LoadPatientDataXML</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">InputFolder</span> <span class="o">+</span> <span class="n">file</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">file</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span> <span class="o">==</span> <span class="s2">&quot;yml&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">PatientData</span><span class="o">.</span><span class="n">LoadPatientDataYML</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">InputFolder</span> <span class="o">+</span> <span class="n">file</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;File open error&quot;</span><span class="p">)</span>
            <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">LoadClusteringMapping</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Load Clustering map to file: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">file</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">)][</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">cp</span> <span class="o">=</span> <span class="n">Perfusion</span><span class="o">.</span><span class="n">CouplingPoint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">])])</span>
            <span class="n">cp</span><span class="o">.</span><span class="n">Node</span><span class="o">.</span><span class="n">Position</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)]</span>
            <span class="n">cp</span><span class="o">.</span><span class="n">NumberOfTriangles</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">cp</span><span class="o">.</span><span class="n">Area</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
            <span class="n">cp</span><span class="o">.</span><span class="n">Node</span><span class="o">.</span><span class="n">MajorVesselID</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Perfusion</span><span class="o">.</span><span class="n">CouplingPoints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cp</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">LoadModelParameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="s2">&quot;Model_parameters.txt&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ModelParameters</span><span class="o">.</span><span class="n">LoadModelParameters</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">ModellingFolder</span> <span class="o">+</span> <span class="n">file</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">LoadSegmentedVessels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">CoWFile</span><span class="o">=</span><span class="s2">&quot;1-D_Anatomy.txt&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">LoadSegmentedVessels</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">InputFolder</span><span class="p">,</span> <span class="n">CoWFile</span><span class="o">=</span><span class="n">CoWFile</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">Load1DAnatomy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="s2">&quot;1-D_Anatomy_Patient.txt&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Load1DAnatomy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">InputFolder</span> <span class="o">+</span> <span class="n">file</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">Load3DTopFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="s2">&quot;0_2_cutoff.top&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Read3DNodesFromTopFile</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">CheckConnectivity</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">AnatomyToVessels</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">LoadPositions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">vtpfile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">ModellingFolder</span> <span class="o">+</span> <span class="s2">&quot;Topology.vtp&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Loading </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">vtpfile</span><span class="p">)</span>
        <span class="n">reader</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkXMLPolyDataReader</span><span class="p">()</span>
        <span class="n">reader</span><span class="o">.</span><span class="n">SetFileName</span><span class="p">(</span><span class="n">vtpfile</span><span class="p">)</span>
        <span class="n">reader</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span>
        <span class="n">pos_vtk</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">()</span><span class="o">.</span><span class="n">GetPoints</span><span class="p">()</span><span class="o">.</span><span class="n">GetData</span><span class="p">()</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="n">vtk_to_numpy</span><span class="p">(</span><span class="n">pos_vtk</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Nodes</span><span class="p">):</span>
            <span class="n">node</span><span class="o">.</span><span class="n">SetPosition</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="n">index</span><span class="p">]))</span>

    <span class="k">def</span> <span class="nf">ClusteringByRegion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dualgraph</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Perfusion</span><span class="o">.</span><span class="n">ClusteringByRegion</span><span class="p">(</span><span class="n">dualgraph</span><span class="p">,</span> <span class="n">method</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">SetFolder</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">folder</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">SetPatientFolder</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">TopologyToVTP</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s2">&quot;Topology.vtp&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">TopologyToVTP</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">ModellingFolder</span> <span class="o">+</span> <span class="n">filename</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">SaveVesselAtlas</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s2">&quot;Mapping.csv&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">SaveVesselAtlas</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">ModellingFolder</span> <span class="o">+</span> <span class="n">filename</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">LoadVTPFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vtpfile</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">LoadVTPFile</span><span class="p">(</span><span class="n">vtpfile</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">WriteClusteringMapping</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s2">&quot;Clusters.csv&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Perfusion</span><span class="o">.</span><span class="n">WriteClusteringMapping</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">ModellingFolder</span> <span class="o">+</span> <span class="n">filename</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">WriteModelParameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">ModellingFolder</span> <span class="o">+</span> <span class="s2">&quot;Model_parameters.txt&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Writing the Model parameters to </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">file</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ModelParameters</span><span class="o">.</span><span class="n">WriteModelParameters</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">CalculateMaximumTimestep</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">timestep</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">CalculateMaximumTimestep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ModelParameters</span><span class="p">[</span><span class="s2">&quot;Density&quot;</span><span class="p">])</span>
        <span class="n">t</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">format</span><span class="p">(</span><span class="n">timestep</span><span class="p">,</span> <span class="s1">&#39;1.1e&#39;</span><span class="p">))</span>
        <span class="c1"># iterations = numpy.ceil(self.ModelParameters[&quot;Beat_Duration&quot;] / t)</span>
        <span class="c1"># t= self.ModelParameters[&quot;Beat_Duration&quot;] / iterations</span>
        <span class="c1"># if timestep &lt; self.ModelParameters[&quot;TIMESTEP&quot;]:</span>
        <span class="c1">#     print(&quot;Warning: Simulation can be unstable!&quot;)</span>
        <span class="c1">#     print(&quot;Timestep exceeds the maximum timestep.&quot;)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Timestep set to maximum timestep: </span><span class="si">%1.1e</span><span class="s2"> s&quot;</span> <span class="o">%</span> <span class="n">t</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ModelParameters</span><span class="p">[</span><span class="s2">&quot;TIMESTEP&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span>

    <span class="k">def</span> <span class="nf">CalculateDistanceFromTheHeart</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the distance from the heart in the shortest sense bansed on Dijkstra&#39;s distance.</span>
<span class="sd">        Direction is determined by the positive pressure direction.</span>
<span class="sd">        :return: Nothing</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Graph</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">TopologyToGraph</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Graph</span><span class="o">.</span><span class="n">edges</span><span class="p">:</span>
            <span class="n">node1</span> <span class="o">=</span> <span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">node2</span> <span class="o">=</span> <span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">p1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">MeanPressurePerNode</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">node1</span><span class="o">.</span><span class="n">Number</span><span class="p">]</span>
            <span class="n">p2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">MeanPressurePerNode</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">node2</span><span class="o">.</span><span class="n">Number</span><span class="p">]</span>

            <span class="n">dp</span> <span class="o">=</span> <span class="n">p1</span> <span class="o">-</span> <span class="n">p2</span>
            <span class="n">dx</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Graph</span><span class="p">[</span><span class="n">node1</span><span class="p">][</span><span class="n">node2</span><span class="p">][</span><span class="s1">&#39;weight&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">dp</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">dp</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Graph</span><span class="p">[</span><span class="n">node2</span><span class="p">][</span><span class="n">node1</span><span class="p">][</span><span class="s1">&#39;direction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dx</span>
            <span class="k">elif</span> <span class="n">dp</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Graph</span><span class="p">[</span><span class="n">node1</span><span class="p">][</span><span class="n">node2</span><span class="p">][</span><span class="s1">&#39;direction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dx</span>

        <span class="n">length</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">single_source_dijkstra</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Graph</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">weight</span><span class="o">=</span><span class="s1">&#39;direction&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Nodes</span><span class="p">:</span>
            <span class="n">node</span><span class="o">.</span><span class="n">DistancefromHeart</span> <span class="o">=</span> <span class="n">length</span><span class="p">[</span><span class="n">node</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">DistancefromHeart</span> <span class="o">=</span> <span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">DistancefromHeart</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Nodes</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">CalculateTimedelayFromTheHeart</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the timedelay from the heart in the shortest sense bansed on Dijkstra&#39;s distance.</span>
<span class="sd">        Direction is determined by the positive pressure direction.</span>
<span class="sd">        :return: Nothing</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Graph</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">TopologyToGraph</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Graph</span><span class="o">.</span><span class="n">edges</span><span class="p">:</span>
            <span class="n">node1</span> <span class="o">=</span> <span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">node2</span> <span class="o">=</span> <span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">v1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">MeanVelocityPerNode</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">node1</span><span class="o">.</span><span class="n">Number</span><span class="p">]</span>
            <span class="n">v2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">MeanVelocityPerNode</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">node2</span><span class="o">.</span><span class="n">Number</span><span class="p">]</span>

            <span class="n">meanv</span> <span class="o">=</span> <span class="p">(</span><span class="n">v1</span> <span class="o">+</span> <span class="n">v2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="n">dx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Graph</span><span class="p">[</span><span class="n">node1</span><span class="p">][</span><span class="n">node2</span><span class="p">][</span><span class="s1">&#39;weight&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e-3</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">dx</span> <span class="o">/</span> <span class="n">meanv</span>
            <span class="k">if</span> <span class="n">meanv</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Graph</span><span class="p">[</span><span class="n">node2</span><span class="p">][</span><span class="n">node1</span><span class="p">][</span><span class="s1">&#39;timedelay&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">t</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Graph</span><span class="p">[</span><span class="n">node1</span><span class="p">][</span><span class="n">node2</span><span class="p">][</span><span class="s1">&#39;timedelay&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Graph</span><span class="p">[</span><span class="n">node2</span><span class="p">][</span><span class="n">node1</span><span class="p">][</span><span class="s1">&#39;timedelay&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Graph</span><span class="p">[</span><span class="n">node1</span><span class="p">][</span><span class="n">node2</span><span class="p">][</span><span class="s1">&#39;timedelay&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">length</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">single_source_dijkstra</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Graph</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">weight</span><span class="o">=</span><span class="s1">&#39;timedelay&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Nodes</span><span class="p">:</span>
            <span class="n">node</span><span class="o">.</span><span class="n">TimeDelay</span> <span class="o">=</span> <span class="n">length</span><span class="p">[</span><span class="n">node</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">DistancefromHeart</span> <span class="o">=</span> <span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">DistancefromHeart</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Nodes</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">UpdateNodeType</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">UpdateNodeType</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">CorrectforDirectionVectorOutlets</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">numbers</span> <span class="o">=</span> <span class="p">[</span><span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">Number</span> <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Vessels</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">CorrectForDirectionEnds</span><span class="p">(</span><span class="n">numbers</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">CerebellumBrainstemMapping</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># add labels and positions to the vessels.</span>
        <span class="n">cerebellum</span> <span class="o">=</span> <span class="mi">8</span>
        <span class="n">brainstem</span> <span class="o">=</span> <span class="mi">9</span>

        <span class="n">cerebellumnames</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;R. SCA&quot;</span><span class="p">,</span>
                           <span class="s2">&quot;L. SCA&quot;</span><span class="p">,</span>
                           <span class="s2">&quot;R. AICA&quot;</span><span class="p">,</span>
                           <span class="s2">&quot;L. AICA&quot;</span><span class="p">,</span>
                           <span class="s2">&quot;R. PICA&quot;</span><span class="p">,</span>
                           <span class="s2">&quot;L. PICA&quot;</span><span class="p">,</span> <span class="p">]</span>

        <span class="n">brainstemnames</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Pontine I&quot;</span><span class="p">,</span>
                          <span class="s2">&quot;Pontine II&quot;</span><span class="p">,</span>
                          <span class="s2">&quot;Pontine III&quot;</span><span class="p">,</span>
                          <span class="s2">&quot;Pontine IV&quot;</span><span class="p">,</span>
                          <span class="s2">&quot;Pontine V&quot;</span><span class="p">,</span>
                          <span class="s2">&quot;Pontine VI&quot;</span><span class="p">,</span>
                          <span class="s2">&quot;Pontine VII&quot;</span><span class="p">,</span>
                          <span class="s2">&quot;Pontine VIII&quot;</span><span class="p">,</span>
                          <span class="s2">&quot;Pontine IX&quot;</span><span class="p">,</span>
                          <span class="s2">&quot;Pontine X&quot;</span><span class="p">,</span>
                          <span class="s2">&quot;Pontine XI&quot;</span><span class="p">,</span>
                          <span class="s2">&quot;Pontine XII&quot;</span><span class="p">,</span>
                          <span class="s2">&quot;Pontine XIII&quot;</span><span class="p">]</span>

        <span class="n">cerebellumpos</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">25</span><span class="p">,</span> <span class="o">-</span><span class="mi">74</span><span class="p">,</span> <span class="o">-</span><span class="mi">36</span><span class="p">],</span>
                         <span class="p">[</span><span class="o">-</span><span class="mi">25</span><span class="p">,</span> <span class="o">-</span><span class="mi">74</span><span class="p">,</span> <span class="o">-</span><span class="mi">34</span><span class="p">],</span>
                         <span class="p">[</span><span class="mi">28</span><span class="p">,</span> <span class="o">-</span><span class="mi">55</span><span class="p">,</span> <span class="o">-</span><span class="mi">48</span><span class="p">],</span>
                         <span class="p">[</span><span class="o">-</span><span class="mi">28</span><span class="p">,</span> <span class="o">-</span><span class="mi">55</span><span class="p">,</span> <span class="o">-</span><span class="mi">48</span><span class="p">],</span>
                         <span class="p">[</span><span class="mi">32</span><span class="p">,</span> <span class="o">-</span><span class="mi">40</span><span class="p">,</span> <span class="o">-</span><span class="mi">60</span><span class="p">],</span>
                         <span class="p">[</span><span class="o">-</span><span class="mi">30</span><span class="p">,</span> <span class="o">-</span><span class="mi">48</span><span class="p">,</span> <span class="o">-</span><span class="mi">60</span><span class="p">]]</span>

        <span class="c1"># starting at the bottom of the stem</span>
        <span class="n">pontinepos</span> <span class="o">=</span> <span class="p">[[</span><span class="o">-</span><span class="mf">3.1</span><span class="p">,</span> <span class="o">-</span><span class="mf">16.3</span><span class="p">,</span> <span class="o">-</span><span class="mf">58.5</span><span class="p">],</span>
                      <span class="p">[</span><span class="mf">1.6</span><span class="p">,</span> <span class="o">-</span><span class="mf">15.7</span><span class="p">,</span> <span class="o">-</span><span class="mf">57.2</span><span class="p">],</span>
                      <span class="p">[</span><span class="o">-</span><span class="mf">6.1</span><span class="p">,</span> <span class="o">-</span><span class="mf">14.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">50.4</span><span class="p">],</span>
                      <span class="p">[</span><span class="mf">2.2</span><span class="p">,</span> <span class="o">-</span><span class="mf">12.8</span><span class="p">,</span> <span class="o">-</span><span class="mf">51.7</span><span class="p">],</span>
                      <span class="p">[</span><span class="o">-</span><span class="mf">8.2</span><span class="p">,</span> <span class="o">-</span><span class="mf">10.9</span><span class="p">,</span> <span class="o">-</span><span class="mf">48.2</span><span class="p">],</span>
                      <span class="p">[</span><span class="mf">2.39</span><span class="p">,</span> <span class="o">-</span><span class="mf">9.2</span><span class="p">,</span> <span class="o">-</span><span class="mf">48.9</span><span class="p">],</span>
                      <span class="p">[</span><span class="o">-</span><span class="mf">8.8</span><span class="p">,</span> <span class="o">-</span><span class="mf">5.81</span><span class="p">,</span> <span class="o">-</span><span class="mf">46.1</span><span class="p">],</span>
                      <span class="p">[</span><span class="mf">2.7</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.2</span><span class="p">,</span> <span class="o">-</span><span class="mf">46.6</span><span class="p">],</span>
                      <span class="p">[</span><span class="o">-</span><span class="mf">8.4</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.6</span><span class="p">,</span> <span class="o">-</span><span class="mf">40.7</span><span class="p">],</span>
                      <span class="p">[</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">1.3</span><span class="p">,</span> <span class="o">-</span><span class="mf">41.3</span><span class="p">],</span>
                      <span class="p">[</span><span class="o">-</span><span class="mf">6.8</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">34.6</span><span class="p">],</span>
                      <span class="p">[</span><span class="o">-</span><span class="mf">3.0</span><span class="p">,</span> <span class="mf">1.4</span><span class="p">,</span> <span class="o">-</span><span class="mf">34.0</span><span class="p">],</span>
                      <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]</span>

        <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Vessels</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Name</span> <span class="ow">in</span> <span class="n">cerebellumnames</span><span class="p">:</span>
                <span class="n">vessel</span><span class="o">.</span><span class="n">SetMajorVesselID</span><span class="p">(</span><span class="n">cerebellum</span><span class="p">)</span>
                <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">SetPosition</span><span class="p">(</span><span class="n">cerebellumpos</span><span class="p">[</span><span class="n">cerebellumnames</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">vessel</span><span class="o">.</span><span class="n">Name</span><span class="p">)])</span>
                <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">SetMajorVesselID</span><span class="p">(</span><span class="n">cerebellum</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Name</span> <span class="ow">in</span> <span class="n">brainstemnames</span><span class="p">:</span>
                <span class="n">vessel</span><span class="o">.</span><span class="n">SetMajorVesselID</span><span class="p">(</span><span class="n">brainstem</span><span class="p">)</span>
                <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">SetPosition</span><span class="p">(</span><span class="n">pontinepos</span><span class="p">[</span><span class="n">brainstemnames</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">vessel</span><span class="o">.</span><span class="n">Name</span><span class="p">)])</span>
                <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">SetMajorVesselID</span><span class="p">(</span><span class="n">brainstem</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">calculate_wk_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the windkessel parameters for the outlets of the network.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Calculating WindKessel Parameters.&quot;</span><span class="p">)</span>
        <span class="n">scaling</span> <span class="o">=</span> <span class="mf">1e-3</span>  <span class="c1"># default for mm</span>

        <span class="n">C1D</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Vessels</span><span class="p">:</span>
            <span class="c1"># mean radius and thickness</span>
            <span class="n">lengthvessel</span> <span class="o">=</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Length</span> <span class="o">*</span> <span class="n">scaling</span>
            <span class="n">meanradius</span> <span class="o">=</span> <span class="n">vessel</span><span class="o">.</span><span class="n">MeanRadius</span> <span class="o">*</span> <span class="n">scaling</span>
            <span class="n">meanh</span> <span class="o">=</span> <span class="n">vessel</span><span class="o">.</span><span class="n">MeanThickness</span> <span class="o">*</span> <span class="n">scaling</span>
            <span class="n">C1D</span> <span class="o">+=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">meanradius</span> <span class="o">*</span> <span class="n">meanradius</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">)</span> <span class="o">*</span> <span class="n">lengthvessel</span> <span class="o">/</span> <span class="p">(</span>
                    <span class="p">(</span><span class="mi">4</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="n">vessel</span><span class="o">.</span><span class="n">YoungsModules</span> <span class="o">*</span> <span class="n">meanh</span><span class="p">)</span>

        <span class="n">Cperipheral</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ModelParameters</span><span class="p">[</span><span class="s2">&quot;CTotal&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">C1D</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ModelParameters</span><span class="p">[</span><span class="s2">&quot;Cperipheral&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Cperipheral</span>
        <span class="k">if</span> <span class="n">Cperipheral</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Cperipheral should not be negative. The value of Cperipheral was: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">Cperipheral</span><span class="p">))</span>

        <span class="c1"># identify outlets</span>
        <span class="n">outletmap</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">OutletNodes</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Vessels</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">:</span>
                    <span class="n">outletmap</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vessel</span><span class="o">.</span><span class="n">Name</span><span class="p">)</span>

        <span class="n">bodymap</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">out</span> <span class="ow">in</span> <span class="n">outletmap</span><span class="p">:</span>
            <span class="n">part</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">Constants</span><span class="o">.</span><span class="n">fractions</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">body</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">Constants</span><span class="o">.</span><span class="n">bodyparts</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">out</span> <span class="o">==</span> <span class="n">body</span><span class="p">:</span>
                    <span class="n">part</span> <span class="o">=</span> <span class="n">index</span>
            <span class="n">bodymap</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">part</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">bodynumber</span><span class="p">,</span> <span class="n">fraction</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">Constants</span><span class="o">.</span><span class="n">fractions</span><span class="p">):</span>
            <span class="n">outlets</span> <span class="o">=</span> <span class="p">[</span><span class="n">out</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">out</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">OutletNodes</span><span class="p">)</span> <span class="k">if</span> <span class="n">bodymap</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">==</span> <span class="n">bodynumber</span><span class="p">]</span>
            <span class="n">rcubed</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">outlets</span><span class="p">:</span>
                <span class="n">radius</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">Radius</span> <span class="o">*</span> <span class="n">scaling</span>
                <span class="n">rcubed</span> <span class="o">+=</span> <span class="n">math</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">radius</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">outlets</span><span class="p">:</span>
                <span class="n">radius</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">Radius</span> <span class="o">*</span> <span class="n">scaling</span>
                <span class="n">h</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">Thickness</span> <span class="o">*</span> <span class="n">scaling</span>
                <span class="n">rt</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ModelParameters</span><span class="p">[</span><span class="s2">&quot;RTotal&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">fraction</span><span class="p">)</span> <span class="o">*</span> <span class="n">rcubed</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">radius</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
                <span class="n">A</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">radius</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">beta</span> <span class="o">=</span> <span class="p">(</span><span class="mi">4</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="n">i</span><span class="o">.</span><span class="n">YoungsModules</span> <span class="o">*</span> <span class="n">h</span> <span class="o">/</span> <span class="n">A</span>
                <span class="n">c0</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">beta</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ModelParameters</span><span class="p">[</span><span class="s2">&quot;Density&quot;</span><span class="p">])))</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">)</span>
                <span class="n">r1</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ModelParameters</span><span class="p">[</span><span class="s2">&quot;Density&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">A</span><span class="p">)</span> <span class="o">*</span> <span class="n">c0</span>
                <span class="n">r2</span> <span class="o">=</span> <span class="n">rt</span> <span class="o">-</span> <span class="n">r1</span>
                <span class="k">if</span> <span class="n">r2</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">r2</span> <span class="o">=</span> <span class="mf">0.1e9</span>
                    <span class="n">r1</span> <span class="o">=</span> <span class="n">rt</span> <span class="o">-</span> <span class="n">r2</span>
                <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ModelParameters</span><span class="p">[</span><span class="s2">&quot;Cperipheral&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ModelParameters</span><span class="p">[</span><span class="s2">&quot;RTotal&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">rt</span>
                <span class="n">i</span><span class="o">.</span><span class="n">SetWK</span><span class="p">(</span><span class="n">r1</span><span class="p">,</span> <span class="n">r2</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">calculate_wk_parameters_evenly</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the windkessel parameters for the outlets of the network.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Calculating WindKessel Parameters, evenly through out the network.&quot;</span><span class="p">)</span>
        <span class="n">scaling</span> <span class="o">=</span> <span class="mf">1e-3</span>  <span class="c1"># default for mm</span>

        <span class="n">C1D</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Vessels</span><span class="p">:</span>
            <span class="c1"># mean radius and thickness</span>
            <span class="n">lengthvessel</span> <span class="o">=</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Length</span> <span class="o">*</span> <span class="n">scaling</span>
            <span class="n">meanradius</span> <span class="o">=</span> <span class="n">vessel</span><span class="o">.</span><span class="n">MeanRadius</span> <span class="o">*</span> <span class="n">scaling</span>
            <span class="n">meanh</span> <span class="o">=</span> <span class="n">vessel</span><span class="o">.</span><span class="n">MeanThickness</span> <span class="o">*</span> <span class="n">scaling</span>
            <span class="n">C1D</span> <span class="o">+=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">meanradius</span> <span class="o">*</span> <span class="n">meanradius</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">)</span> <span class="o">*</span> <span class="n">lengthvessel</span> <span class="o">/</span> <span class="p">(</span>
                    <span class="p">(</span><span class="mi">4</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="n">vessel</span><span class="o">.</span><span class="n">YoungsModules</span> <span class="o">*</span> <span class="n">meanh</span><span class="p">)</span>

        <span class="n">Cperipheral</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ModelParameters</span><span class="p">[</span><span class="s2">&quot;CTotal&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">C1D</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ModelParameters</span><span class="p">[</span><span class="s2">&quot;Cperipheral&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Cperipheral</span>
        <span class="c1"># if Cperipheral &lt; 0:</span>
        <span class="c1">#     raise Exception(&#39;Cperipheral should not be negative. The value of Cperipheral was: {}&#39;.format(Cperipheral))</span>

        <span class="c1"># identify outlets</span>
        <span class="n">outletmap</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">OutletNodes</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Vessels</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">:</span>
                    <span class="n">outletmap</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vessel</span><span class="o">.</span><span class="n">Name</span><span class="p">)</span>

        <span class="n">outlets</span> <span class="o">=</span> <span class="p">[</span><span class="n">out</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">out</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">OutletNodes</span><span class="p">)]</span>
        <span class="n">rcubed</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">outlets</span><span class="p">:</span>
            <span class="n">radius</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">Radius</span> <span class="o">*</span> <span class="n">scaling</span>
            <span class="n">rcubed</span> <span class="o">+=</span> <span class="n">math</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">radius</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">outlets</span><span class="p">:</span>
            <span class="n">radius</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">Radius</span> <span class="o">*</span> <span class="n">scaling</span>
            <span class="n">h</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">Thickness</span> <span class="o">*</span> <span class="n">scaling</span>
            <span class="n">rt</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ModelParameters</span><span class="p">[</span><span class="s2">&quot;RTotal&quot;</span><span class="p">])</span> <span class="o">*</span> <span class="n">rcubed</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">radius</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
            <span class="n">A</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">radius</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">beta</span> <span class="o">=</span> <span class="p">(</span><span class="mi">4</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="n">i</span><span class="o">.</span><span class="n">YoungsModules</span> <span class="o">*</span> <span class="n">h</span> <span class="o">/</span> <span class="n">A</span>
            <span class="n">c0</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">beta</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ModelParameters</span><span class="p">[</span><span class="s2">&quot;Density&quot;</span><span class="p">])))</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">)</span>
            <span class="n">r1</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ModelParameters</span><span class="p">[</span><span class="s2">&quot;Density&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">A</span><span class="p">)</span> <span class="o">*</span> <span class="n">c0</span>
            <span class="n">r2</span> <span class="o">=</span> <span class="n">rt</span> <span class="o">-</span> <span class="n">r1</span>
            <span class="k">if</span> <span class="n">r2</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">r2</span> <span class="o">=</span> <span class="mf">0.1e9</span>
                <span class="n">r1</span> <span class="o">=</span> <span class="n">rt</span> <span class="o">-</span> <span class="n">r2</span>
            <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ModelParameters</span><span class="p">[</span><span class="s2">&quot;Cperipheral&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ModelParameters</span><span class="p">[</span><span class="s2">&quot;RTotal&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">rt</span>
            <span class="n">i</span><span class="o">.</span><span class="n">SetWK</span><span class="p">(</span><span class="n">r1</span><span class="p">,</span> <span class="n">r2</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">WriteSimFiles</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Writing simulation files.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">UpdateTopology</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">SaveVesselAtlas</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">WriteTopologyFile</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">WriteParFile</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">WriteFlowProfiles</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">WriteRunFile</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">WriteModelParameters</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">WriteClotFile</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">WriteRegionMapping</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">ExportSurface</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">graph</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Perfusion</span><span class="o">.</span><span class="n">ExportSurface</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">graph</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">SelectPatient</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Load input files</span>
        <span class="c1"># Randomly select a patient</span>
        <span class="n">segmentationfolder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">DataFilesFolder</span> <span class="o">+</span> <span class="s2">&quot;/Segmentations/&quot;</span>
        <span class="n">segfolders</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">segmentationfolder</span><span class="p">)]</span>
        <span class="n">selectedfolder</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">segfolders</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">segmentationfile</span> <span class="o">=</span> <span class="n">segmentationfolder</span> <span class="o">+</span> <span class="n">selectedfolder</span> <span class="o">+</span> <span class="s2">&quot;/Feature_Vessel.csv&quot;</span>
        <span class="n">infofile</span> <span class="o">=</span> <span class="n">segmentationfolder</span> <span class="o">+</span> <span class="n">selectedfolder</span> <span class="o">+</span> <span class="s2">&quot;/Image_info.txt&quot;</span>

        <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">segmentationfile</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">InputFolder</span><span class="p">)</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">infofile</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">InputFolder</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ModelParameters</span><span class="p">[</span><span class="s2">&quot;Patient_Segmentation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">selectedfolder</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Selected segmentation: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">selectedfolder</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">SelectDonorNetwork</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Select a network from the Brava set to extend the patient network.</span>
<span class="sd">        For now, the donor is randomly selected from the folder.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">scriptfolder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">DataFilesFolder</span>
        <span class="n">bravafolder</span> <span class="o">=</span> <span class="n">scriptfolder</span> <span class="o">+</span> <span class="s2">&quot;/Brava/&quot;</span>
        <span class="n">bravafiles</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">bravafolder</span><span class="p">)</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">bravafolder</span><span class="p">,</span> <span class="n">f</span><span class="p">))</span> <span class="k">if</span>
                      <span class="n">f</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span> <span class="o">==</span> <span class="s2">&quot;vtp&quot;</span><span class="p">]</span>
        <span class="n">selectedfile</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">bravafiles</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># selectedfile = &quot;BH0023_ColorCoded.CNG.vtp&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ModelParameters</span><span class="p">[</span><span class="s2">&quot;Donor_Network&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">selectedfile</span>

    <span class="k">def</span> <span class="nf">UpdateModelParameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ModelParameters</span><span class="p">[</span><span class="s2">&quot;Beat_Duration&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">60</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">PatientData</span><span class="p">[</span><span class="s2">&quot;HeartRate&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ModelParameters</span><span class="p">[</span><span class="s2">&quot;SISTOLIC_PRESSURE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PatientData</span><span class="p">[</span><span class="s2">&quot;SystolePressure&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ModelParameters</span><span class="p">[</span><span class="s2">&quot;DIASTOLIC_PRESSURE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PatientData</span><span class="p">[</span><span class="s2">&quot;DiastolePressure&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ModelParameters</span><span class="p">[</span><span class="s2">&quot;RTotal&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">PatientData</span><span class="p">[</span><span class="s2">&quot;SystolePressure&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">PatientData</span><span class="p">[</span>
            <span class="s2">&quot;DiastolePressure&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">/</span> <span class="mi">3</span><span class="p">))</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">PatientData</span><span class="p">[</span><span class="s2">&quot;MeanRightAtrialPressure&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span>
                                                 <span class="bp">self</span><span class="o">.</span><span class="n">PatientData</span><span class="p">[</span><span class="s2">&quot;StrokeVolume&quot;</span><span class="p">]</span> <span class="o">*</span>
                                                 <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">PatientData</span><span class="p">[</span><span class="s2">&quot;HeartRate&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">60</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e-6</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ModelParameters</span><span class="p">[</span><span class="s2">&quot;CTotal&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ModelParameters</span><span class="p">[</span><span class="s2">&quot;TimeConstantDiastolicDecay&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">ModelParameters</span><span class="p">[</span>
            <span class="s2">&quot;RTotal&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ModelParameters</span><span class="p">[</span><span class="s2">&quot;ScriptLocation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span> <span class="o">+</span> <span class="s2">&quot;/Check_Convergence.py&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ModelParameters</span><span class="p">[</span><span class="s2">&quot;OUT_PRESSURE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PatientData</span><span class="p">[</span><span class="s2">&quot;MeanRightAtrialPressure&quot;</span><span class="p">]</span>

        <span class="c1"># self.PatientData[&quot;collaterals&quot;]: collateral score, 0:absent, 1:poor, 2:moderate, 3:good</span>
        <span class="n">collateral_map</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span> <span class="mf">0.65</span><span class="p">}</span>  <span class="c1"># detailed collateral model: probability</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ModelParameters</span><span class="p">[</span><span class="s2">&quot;collateralpropability&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">collateral_map</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">PatientData</span><span class="p">[</span><span class="s2">&quot;CollateralScore&quot;</span><span class="p">]]</span>

        <span class="n">collateral_map</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="mf">0.14</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">}</span>  <span class="c1"># two-way coupled model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ModelParameters</span><span class="p">[</span><span class="s2">&quot;coarse_collaterals_number&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">collateral_map</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">PatientData</span><span class="p">[</span><span class="s2">&quot;CollateralScore&quot;</span><span class="p">]]</span>

    <span class="k">def</span> <span class="nf">WriteFlowProfilesAlastruey2007</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Take patient parameters and generate flow profiles.</span>
<span class="sd">        Assumption is that the two inlets with the largest radius are the carotid arteries.</span>
<span class="sd">        Flowrate given here are ml/s</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Writing Flow Profiles.&quot;</span><span class="p">)</span>
        <span class="n">Aortafile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">ModellingFolder</span> <span class="o">+</span> <span class="s2">&quot;Aorta.txt&quot;</span>
        <span class="n">period</span> <span class="o">=</span> <span class="mi">60</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">PatientData</span><span class="p">[</span><span class="s2">&quot;HeartRate&quot;</span><span class="p">]</span>
        <span class="n">time</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>

        <span class="n">VolumeFlowRate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PatientData</span><span class="p">[</span><span class="s2">&quot;StrokeVolume&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">PatientData</span><span class="p">[</span><span class="s2">&quot;HeartRate&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">60</span><span class="p">)</span>
        <span class="c1"># AortaFlow = BloodflowEquations.FlowRateAorta(time, period, VolumeFlowRate)</span>
        <span class="n">scaling</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">integrate</span><span class="o">.</span><span class="n">simps</span><span class="p">(</span><span class="n">BloodFlowEquations</span><span class="o">.</span><span class="n">FlowRateAlastruey2007</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">time</span><span class="p">)</span>
        <span class="n">AortaFlow</span> <span class="o">=</span> <span class="n">BloodFlowEquations</span><span class="o">.</span><span class="n">FlowRateAlastruey2007</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">VolumeFlowRate</span> <span class="o">/</span> <span class="n">scaling</span><span class="p">)</span>
        <span class="c1"># AortaFlow = [self.PatientData[&quot;StrokeVolume&quot;] for i in AortaFlow]</span>
        <span class="c1"># totalflow = numpy.trapz(AortaFlow,time)</span>
        <span class="c1"># totalflows = simps(AortaFlow, time)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">Aortafile</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;1.0e-6</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">time</span><span class="p">)):</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="se">\t</span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">AortaFlow</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>

    <span class="k">def</span> <span class="nf">WriteFlowProfiles</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Take patient parameters and generate flow profiles.</span>
<span class="sd">        Assumption is that the two inlets with the largest radius are the carotid arteries.</span>
<span class="sd">        Flowrate given here are ml/s</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Writing Flow Profiles.&quot;</span><span class="p">)</span>
        <span class="n">Aortafile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">ModellingFolder</span> <span class="o">+</span> <span class="s2">&quot;Aorta.txt&quot;</span>
        <span class="n">period</span> <span class="o">=</span> <span class="mi">60</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">PatientData</span><span class="p">[</span><span class="s2">&quot;HeartRate&quot;</span><span class="p">]</span>
        <span class="n">time</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>

        <span class="n">VolumeFlowRate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PatientData</span><span class="p">[</span><span class="s2">&quot;StrokeVolume&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">PatientData</span><span class="p">[</span><span class="s2">&quot;HeartRate&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">60</span><span class="p">)</span>
        <span class="n">AortaFlow</span> <span class="o">=</span> <span class="n">BloodFlowEquations</span><span class="o">.</span><span class="n">FlowRateAorta</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">VolumeFlowRate</span><span class="p">)</span>
        <span class="c1"># scaling = scipy.integrate.simps(BloodflowEquations.FlowRateAlastruey2007(time,1), time)</span>
        <span class="c1"># AortaFlow = BloodflowEquations.FlowRateAlastruey2007(time, VolumeFlowRate/scaling)</span>
        <span class="c1"># AortaFlow = [self.PatientData[&quot;StrokeVolume&quot;] for i in AortaFlow]</span>
        <span class="c1"># totalflow = numpy.trapz(AortaFlow,time)</span>
        <span class="c1"># totalflows = simps(AortaFlow, time)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">Aortafile</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;1.0e-6</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">time</span><span class="p">)):</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="se">\t</span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">AortaFlow</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>

    <span class="c1"># def WriteResultsToVTP(self):</span>
    <span class="c1">#     print(&quot;Writing Results to vtp files&quot;)</span>
    <span class="c1">#     resultsfolder = self.Folders.ModellingFolder</span>
    <span class="c1">#     if not os.path.exists(resultsfolder):</span>
    <span class="c1">#         os.mkdir(resultsfolder)</span>
    <span class="c1">#</span>
    <span class="c1">#     TimeFile = open(resultsfolder + &quot;Time.txt&quot;, &#39;w&#39;, encoding=&#39;utf-8&#39;)</span>
    <span class="c1">#     for i in range(0, len(self.Results.TimePoints)):</span>
    <span class="c1">#         TimeFile.write(str(i) + &quot; &quot; + str(self.Results.TimePoints[i].WT) + &#39;\n&#39;)</span>
    <span class="c1">#     TimeFile.close()</span>
    <span class="c1">#</span>
    <span class="c1">#     for i in range(0, len(self.Results.TimePoints)):</span>
    <span class="c1">#         self.FrameToVTP(resultsfolder + &quot;TimePoint&quot; + str(i) + &quot;.vtp&quot;, self.Results.TimePoints[i])</span>
    <span class="c1">#</span>
    <span class="c1"># def FrameToVTP(self, filename, timepoint):</span>
    <span class="c1">#     print(&quot;Writing frame at time:%f&quot; % timepoint.WT)</span>
    <span class="c1">#     nodes = vtk.vtkPoints()</span>
    <span class="c1">#     vessels = vtk.vtkCellArray()</span>
    <span class="c1">#</span>
    <span class="c1">#     radius = vtk.vtkFloatArray()</span>
    <span class="c1">#     radius.SetNumberOfComponents(1)</span>
    <span class="c1">#     radius.SetName(&quot;Radius&quot;)</span>
    <span class="c1">#</span>
    <span class="c1">#     pressure = vtk.vtkFloatArray()</span>
    <span class="c1">#     pressure.SetNumberOfComponents(1)</span>
    <span class="c1">#     pressure.SetName(&quot;Pressure&quot;)</span>
    <span class="c1">#</span>
    <span class="c1">#     Flow = vtk.vtkFloatArray()</span>
    <span class="c1">#     Flow.SetNumberOfComponents(1)</span>
    <span class="c1">#     Flow.SetName(&quot;Flow Rate&quot;)</span>
    <span class="c1">#</span>
    <span class="c1">#     Radius = vtk.vtkFloatArray()</span>
    <span class="c1">#     Radius.SetNumberOfComponents(1)</span>
    <span class="c1">#     Radius.SetName(&quot;Radius&quot;)</span>
    <span class="c1">#</span>
    <span class="c1">#     for i in range(0, len(timepoint.Pressure)):</span>
    <span class="c1">#         pressure.InsertNextValue(timepoint.Pressure[i])</span>
    <span class="c1">#         Flow.InsertNextValue(timepoint.Flow[i])</span>
    <span class="c1">#         Radius.InsertNextValue(timepoint.Radius[i])</span>
    <span class="c1">#</span>
    <span class="c1">#     # Add radius and position to data array</span>
    <span class="c1">#     for node in self.Topology.Nodes:</span>
    <span class="c1">#         nodes.InsertNextPoint(node.Position)</span>
    <span class="c1">#         radius.InsertNextValue(node.Radius)</span>
    <span class="c1">#</span>
    <span class="c1">#     # Create a polydata to store everything in</span>
    <span class="c1">#     VesselsPolyData = vtk.vtkPolyData()</span>
    <span class="c1">#</span>
    <span class="c1">#     # Add the points to the dataset</span>
    <span class="c1">#     VesselsPolyData.SetPoints(nodes)</span>
    <span class="c1">#</span>
    <span class="c1">#     # Add vessels to cell array</span>
    <span class="c1">#     for vessel in self.Topology.Vessels:</span>
    <span class="c1">#         line = vtk.vtkLine()</span>
    <span class="c1">#         line.GetPointIds().SetNumberOfIds(len(vessel))</span>
    <span class="c1">#         for i in range(0, len(vessel)):</span>
    <span class="c1">#             line.GetPointIds().SetId(i, vessel[i])</span>
    <span class="c1">#         vessels.InsertNextCell(line)</span>
    <span class="c1">#     # Add the lines to the dataset</span>
    <span class="c1">#     VesselsPolyData.SetLines(vessels)</span>
    <span class="c1">#</span>
    <span class="c1">#     # Assign radii to the nodes</span>
    <span class="c1">#     VesselsPolyData.GetPointData().SetScalars(radius)</span>
    <span class="c1">#     VesselsPolyData.GetPointData().AddArray(pressure)</span>
    <span class="c1">#     VesselsPolyData.GetPointData().AddArray(Flow)</span>
    <span class="c1">#     VesselsPolyData.GetPointData().AddArray(Radius)</span>
    <span class="c1">#</span>
    <span class="c1">#     # Save everyting in a vtk file</span>
    <span class="c1">#     writer = vtk.vtkXMLPolyDataWriter()</span>
    <span class="c1">#     writer.SetFileName(filename)</span>
    <span class="c1">#     writer.SetInputData(VesselsPolyData)</span>
    <span class="c1">#     writer.Write()</span>

    <span class="k">def</span> <span class="nf">VesselToMeshAllignmentSides</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">graph</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Optimizing alignment between the mesh and the outlets.&quot;</span><span class="p">)</span>

        <span class="n">pos</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">majornodesID</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">OutletNodes</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">Position</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">))</span> <span class="ow">and</span> <span class="n">node</span><span class="o">.</span><span class="n">MajorVesselID</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">pos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">Position</span><span class="p">)</span>
                <span class="n">majornodesID</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">MajorVesselID</span><span class="p">)</span>

        <span class="c1"># left and right sides of the pial surface</span>
        <span class="n">rightpialsurface</span> <span class="o">=</span> <span class="p">[</span><span class="n">index</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">graph</span><span class="o">.</span><span class="n">PialSurface</span><span class="p">)</span> <span class="k">if</span> <span class="n">graph</span><span class="o">.</span><span class="n">SideInfo</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">leftpialsurface</span> <span class="o">=</span> <span class="p">[</span><span class="n">index</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">graph</span><span class="o">.</span><span class="n">PialSurface</span><span class="p">)</span> <span class="k">if</span> <span class="n">graph</span><span class="o">.</span><span class="n">SideInfo</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span>

        <span class="c1"># [cow, - , &quot;R. ACA, A2&quot;, &quot;R. MCA&quot;, &quot;L. MCA&quot;, &quot;L. ACA, A2&quot;, &quot;R. PCA, P2&quot;, &quot;L. PCA, P2&quot;]</span>
        <span class="c1"># leftvessels = [4, 5, 7]</span>
        <span class="c1"># rightvessels = [2, 3, 6]</span>
        <span class="n">leftvessels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Perfusion</span><span class="o">.</span><span class="n">leftregionids</span>
        <span class="n">rightvessels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Perfusion</span><span class="o">.</span><span class="n">rightregionids</span>

        <span class="n">leftnodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">index</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span> <span class="k">if</span> <span class="n">majornodesID</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="ow">in</span> <span class="n">leftvessels</span><span class="p">]</span>
        <span class="n">rightnodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">index</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span> <span class="k">if</span> <span class="n">majornodesID</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="ow">in</span> <span class="n">rightvessels</span><span class="p">]</span>

        <span class="n">sys</span><span class="o">.</span><span class="n">setrecursionlimit</span><span class="p">(</span><span class="mi">10000</span><span class="p">)</span>
        <span class="n">KDTreeleft</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">spatial</span><span class="o">.</span><span class="n">KDTree</span><span class="p">([</span><span class="n">graph</span><span class="o">.</span><span class="n">PialSurface</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">leftpialsurface</span><span class="p">])</span>
        <span class="n">KDTreeright</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">spatial</span><span class="o">.</span><span class="n">KDTree</span><span class="p">([</span><span class="n">graph</span><span class="o">.</span><span class="n">PialSurface</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">rightpialsurface</span><span class="p">])</span>

        <span class="k">def</span> <span class="nf">optimfun</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
            <span class="n">scaling</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">translation</span> <span class="o">=</span> <span class="p">[</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">args</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span>
            <span class="n">rotation</span> <span class="o">=</span> <span class="p">[</span><span class="n">args</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">args</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">args</span><span class="p">[</span><span class="mi">6</span><span class="p">]]</span>
            <span class="c1"># Calculate the transform matrix</span>
            <span class="n">tmatrix</span> <span class="o">=</span> <span class="n">GeneralFunctions</span><span class="o">.</span><span class="n">TMatrix</span><span class="p">(</span><span class="n">scaling</span><span class="p">,</span> <span class="n">rotation</span><span class="p">,</span> <span class="n">translation</span><span class="p">)</span>
            <span class="c1"># Apply matrix to the nodes</span>
            <span class="n">tpos</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">pos</span><span class="p">:</span>
                <span class="n">vec</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="p">[</span><span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="p">[</span><span class="n">node</span><span class="p">[</span><span class="mi">2</span><span class="p">]],</span> <span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
                <span class="n">position</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">tmatrix</span><span class="p">,</span> <span class="n">vec</span><span class="p">)</span>
                <span class="n">nodenew</span> <span class="o">=</span> <span class="p">[</span><span class="n">position</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">position</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">position</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>
                <span class="n">tpos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nodenew</span><span class="p">)</span>

            <span class="n">meshdis</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">tpos</span><span class="p">]</span>

            <span class="n">MinDistanceR</span><span class="p">,</span> <span class="n">MinDistanceIndexR</span> <span class="o">=</span> <span class="n">KDTreeright</span><span class="o">.</span><span class="n">query</span><span class="p">([</span><span class="n">tpos</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">rightnodes</span><span class="p">],</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">MinDistanceL</span><span class="p">,</span> <span class="n">MinDistanceIndexL</span> <span class="o">=</span> <span class="n">KDTreeleft</span><span class="o">.</span><span class="n">query</span><span class="p">([</span><span class="n">tpos</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">leftnodes</span><span class="p">],</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">nodeindex</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rightnodes</span><span class="p">):</span>
                <span class="n">meshdis</span><span class="p">[</span><span class="n">nodeindex</span><span class="p">]</span> <span class="o">=</span> <span class="n">MinDistanceR</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">nodeindex</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">leftnodes</span><span class="p">):</span>
                <span class="n">meshdis</span><span class="p">[</span><span class="n">nodeindex</span><span class="p">]</span> <span class="o">=</span> <span class="n">MinDistanceL</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>

            <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">meshdis</span><span class="p">)</span>

        <span class="c1"># initial guess for the allignment</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">optimize</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">optimfun</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]),</span>
                                         <span class="n">method</span><span class="o">=</span><span class="s1">&#39;Nelder-Mead&#39;</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;disp&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>
        <span class="n">values</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">x</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Perfusion</span><span class="o">.</span><span class="n">AllignmentResult</span> <span class="o">=</span> <span class="n">result</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
        <span class="n">scaling</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">translation</span> <span class="o">=</span> <span class="p">[</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">values</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">values</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span>
        <span class="n">rotation</span> <span class="o">=</span> <span class="p">[</span><span class="n">values</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">values</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">values</span><span class="p">[</span><span class="mi">6</span><span class="p">]]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Perfusion</span><span class="o">.</span><span class="n">TMatrix</span> <span class="o">=</span> <span class="n">GeneralFunctions</span><span class="o">.</span><span class="n">TMatrix</span><span class="p">(</span><span class="n">scaling</span><span class="p">,</span> <span class="n">rotation</span><span class="p">,</span> <span class="n">translation</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ApplyTransformation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Perfusion</span><span class="o">.</span><span class="n">TMatrix</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">ApplyTransformation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">matrix</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">vesselnode</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Nodes</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">vesselnode</span><span class="o">.</span><span class="n">Position</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">node</span> <span class="o">=</span> <span class="n">vesselnode</span><span class="o">.</span><span class="n">Position</span>
                <span class="n">vec</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="p">[</span><span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="p">[</span><span class="n">node</span><span class="p">[</span><span class="mi">2</span><span class="p">]],</span> <span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
                <span class="n">position</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">matrix</span><span class="p">,</span> <span class="n">vec</span><span class="p">)</span>
                <span class="n">nodenew</span> <span class="o">=</span> <span class="p">[</span><span class="n">position</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">position</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">position</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>
                <span class="n">vesselnode</span><span class="o">.</span><span class="n">SetPosition</span><span class="p">(</span><span class="n">nodenew</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">FindCouplingPoints</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Map the outlets to the nearest point on the surface.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">surfaceoutlets</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">OutletNodes</span> <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">MajorVesselID</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Finding outlets close to the surface.&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">surfaceoutlets</span><span class="p">):</span>
            <span class="n">couplingpoint</span> <span class="o">=</span> <span class="n">Perfusion</span><span class="o">.</span><span class="n">CouplingPoint</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Perfusion</span><span class="o">.</span><span class="n">AddCouplingPoint</span><span class="p">(</span><span class="n">couplingpoint</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">RemoveCoWOutletsFromPerfusion</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The donor networks have outlets that do not get transferred.</span>
<span class="sd">        These need to be removed.</span>
<span class="sd">        If the coupling point node does not have a number, remove it from the list.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Removing coupling points outside topology.&quot;</span><span class="p">)</span>
        <span class="n">pointstoremove</span> <span class="o">=</span> <span class="p">[</span><span class="n">point</span> <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Perfusion</span><span class="o">.</span><span class="n">CouplingPoints</span> <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">point</span><span class="o">.</span><span class="n">Node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Nodes</span><span class="p">)]</span>
        <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Perfusion</span><span class="o">.</span><span class="n">RemoveCouplingPoint</span><span class="p">(</span><span class="n">point</span><span class="p">)</span> <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="n">pointstoremove</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">WriteCouplingPointsFile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Writing coupling points to file.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">Perfusion</span><span class="o">.</span><span class="n">CouplingPoints</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">FindCouplingPoints</span><span class="p">()</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">ModellingFolder</span> <span class="o">+</span> <span class="s1">&#39;Coupling.csv&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;ID,Position,Direction,Radius,MeshPoint</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">couplingpoint</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Perfusion</span><span class="o">.</span><span class="n">CouplingPoints</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">couplingpoint</span><span class="o">.</span><span class="n">NodeID</span><span class="p">)</span>
                        <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">couplingpoint</span><span class="o">.</span><span class="n">Node</span><span class="o">.</span><span class="n">Position</span><span class="p">)</span>
                        <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">couplingpoint</span><span class="o">.</span><span class="n">Node</span><span class="o">.</span><span class="n">DirectionVector</span><span class="p">)</span>
                        <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">couplingpoint</span><span class="o">.</span><span class="n">Node</span><span class="o">.</span><span class="n">Position</span><span class="o">.</span><span class="n">Radius</span><span class="p">)</span>
                        <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">couplingpoint</span><span class="o">.</span><span class="n">PialSurfacePoint</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">WriteClotFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Clots.txt&#39;</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Writing Clots to file.&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">ModellingFolder</span> <span class="o">+</span> <span class="n">name</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;ClotID,NodeID,Permeability,Porosity</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">clot</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Clots</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">clot</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">Number</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">clot</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">clot</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">WriteTopologyFile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">ModellingFolder</span> <span class="o">+</span> <span class="s2">&quot;System.top&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Writing Topology file to </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">file</span><span class="p">)</span>

        <span class="n">OutputFile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="n">OutputFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Name: System_0&#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Coordinates:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># Output Vessel position and radius</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Nodes</span><span class="p">:</span>
            <span class="n">OutputLine</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">Number</span><span class="p">)</span> \
                         <span class="o">+</span> <span class="s2">&quot; L:&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{0:0.5f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">LengthAlongVessel</span><span class="p">)</span> \
                         <span class="o">+</span> <span class="s2">&quot; R:&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{0:0.5f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">Radius</span><span class="p">)</span> \
                         <span class="o">+</span> <span class="s2">&quot; E:&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{0:0.1f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">YoungsModules</span> <span class="o">*</span> <span class="mf">1e-6</span><span class="p">)</span> \
                         <span class="o">+</span> <span class="s2">&quot; T:&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{0:d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">Type</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>

            <span class="n">OutputFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">OutputLine</span><span class="p">)</span>
        <span class="c1"># Output Connections</span>
        <span class="n">OutputFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Bonds:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Nodes</span><span class="p">:</span>
            <span class="n">BondsLine</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">for</span> <span class="n">bond</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">Connections</span><span class="p">:</span>
                <span class="n">BondsLine</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">bond</span><span class="o">.</span><span class="n">Number</span><span class="p">)</span>
            <span class="n">OutputFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">Number</span><span class="p">)</span> <span class="o">+</span> <span class="n">BondsLine</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">OutputFile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">WriteParFile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">ModellingFolder</span> <span class="o">+</span> <span class="s2">&quot;System.par&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Writing parameter file to </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">file</span><span class="p">)</span>
        <span class="c1"># Output outlets</span>
        <span class="n">OutputFilePar</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="c1"># if self.Topology.OutletNodes[0].R1 is None:</span>
        <span class="c1">#     self.calculate_wk_parameters()</span>

        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">OutletNodes</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">R1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">OutputFilePar</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">Number</span><span class="p">)</span>
                                    <span class="o">+</span> <span class="s1">&#39; R1:&#39;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{0:0.5f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                                    <span class="o">+</span> <span class="s1">&#39; R2:&#39;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{0:0.5f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                                    <span class="o">+</span> <span class="s1">&#39; C:&#39;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{0:0.5f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">OutputFilePar</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">Number</span><span class="p">)</span>
                                    <span class="o">+</span> <span class="s1">&#39; R1:&#39;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{0:0.5f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">R1</span> <span class="o">*</span> <span class="mf">1e-9</span><span class="p">)</span>
                                    <span class="o">+</span> <span class="s1">&#39; R2:&#39;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{0:0.5f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">R2</span> <span class="o">*</span> <span class="mf">1e-9</span><span class="p">)</span>
                                    <span class="o">+</span> <span class="s1">&#39; C:&#39;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{0:0.5f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">C</span> <span class="o">*</span> <span class="mf">1e12</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">OutputFilePar</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">WriteRunFile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">ModellingFolder</span> <span class="o">+</span> <span class="s2">&quot;Run.txt&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Writing run file to </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">file</span><span class="p">)</span>
        <span class="c1"># Output Run file</span>
        <span class="n">OutputRunFile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="n">OutputRunFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&lt;System&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">OutputRunFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Topology: &#39;</span> <span class="o">+</span> <span class="s2">&quot;System.top&quot;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">InletLine</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">InletNodes</span><span class="p">:</span>
            <span class="n">InletLine</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Number</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span>
        <span class="n">OutputRunFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;InletFlux: &#39;</span> <span class="o">+</span> <span class="n">InletLine</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">OutputRunFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;OutletParams: &#39;</span> <span class="o">+</span> <span class="s2">&quot;System.par&quot;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">OutputRunFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Task: &#39;</span><span class="p">)</span>
        <span class="n">OutputRunFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;NumberCoupledPoints: 0&#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">modelparameterfile</span> <span class="o">=</span> <span class="s2">&quot;Model_parameters.txt&quot;</span>
        <span class="n">OutputRunFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Modelparameters: &#39;</span> <span class="o">+</span> <span class="n">modelparameterfile</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">OutputRunFile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">GenerateTreesAtCps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cutoff</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Generating bifurcating arterial trees at the outlet nodes.&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Perfusion</span><span class="o">.</span><span class="n">CouplingPoints</span><span class="p">:</span>
            <span class="n">tree</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GenerateTree</span><span class="p">(</span><span class="nb">id</span><span class="o">.</span><span class="n">Node</span><span class="p">,</span> <span class="n">cutoff</span><span class="p">)</span>
            <span class="nb">id</span><span class="o">.</span><span class="n">Tree</span> <span class="o">=</span> <span class="n">tree</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">UpdateTopology</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Generated </span><span class="si">%d</span><span class="s2"> bifurcating trees.&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Trees</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">GenerateTrees</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cutoff</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Generating bifurcating arterial trees at the outlet nodes.&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">OutletNodes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">GenerateTree</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">cutoff</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Generated </span><span class="si">%d</span><span class="s2"> bifurcating trees.&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Trees</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">getTotalEndsofTrees</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">numberofterminals</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">tree</span><span class="o">.</span><span class="n">EndNodes</span><span class="p">)</span> <span class="k">for</span> <span class="n">tree</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Trees</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Total number of terminal points of the arterial trees: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">numberofterminals</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">PerfusionEndsNumber</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Calculating the number of terminal points per outlet.&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Perfusion</span><span class="o">.</span><span class="n">CouplingPoints</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Perfusion</span><span class="o">.</span><span class="n">CouplingPoints</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">NumberOfPialPoints</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Trees</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">EndNodes</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">GenerateTree</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">cutoff</span><span class="o">=</span><span class="mf">0.125</span><span class="p">):</span>
        <span class="n">tree</span> <span class="o">=</span> <span class="n">Topology</span><span class="o">.</span><span class="n">Tree</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="n">tree</span><span class="o">.</span><span class="n">GenerateTree</span><span class="p">(</span><span class="n">cutoff</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Trees</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tree</span>

    <span class="k">def</span> <span class="nf">TreesToTopology</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Creating a tree topology.&quot;</span><span class="p">)</span>
        <span class="n">treetop</span> <span class="o">=</span> <span class="n">Topology</span><span class="o">.</span><span class="n">Topology</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">tree</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Trees</span><span class="p">:</span>
            <span class="n">treetop</span><span class="o">.</span><span class="n">Nodes</span> <span class="o">+=</span> <span class="n">tree</span><span class="o">.</span><span class="n">Nodes</span>
        <span class="k">return</span> <span class="n">treetop</span>

    <span class="k">def</span> <span class="nf">AddTreesToTop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Adding trees to the vessel topology.&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">tree</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Trees</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tree</span><span class="o">.</span><span class="n">Nodes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">tree</span><span class="o">.</span><span class="n">ConnectTree</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Nodes</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">tree</span><span class="o">.</span><span class="n">Nodes</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">OutletNodes</span> <span class="o">+=</span> <span class="n">tree</span><span class="o">.</span><span class="n">EndNodes</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">OutletNodes</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">tree</span><span class="o">.</span><span class="n">InitialNode</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">BifurcationNodes</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">tree</span><span class="o">.</span><span class="n">BifurcationNodes</span><span class="p">)</span>
                <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">GetVesselNameFromNode</span><span class="p">(</span><span class="n">tree</span><span class="o">.</span><span class="n">InitialNode</span><span class="p">)</span>
                <span class="n">currentvesselnumber</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">ID</span>
                <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">SetID</span><span class="p">(</span><span class="n">currentvesselnumber</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tree</span><span class="o">.</span><span class="n">Vessels</span><span class="p">)]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Vessels</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">tree</span><span class="o">.</span><span class="n">Vessels</span><span class="p">)</span>
                <span class="p">[</span><span class="n">vessel</span><span class="o">.</span><span class="n">SetName</span><span class="p">(</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;Tree_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tree</span><span class="o">.</span><span class="n">Vessels</span><span class="p">)]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">UpdateTopology</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">TreeEndsToEndNodes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">tree</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Trees</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">OutletNodes</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">tree</span><span class="o">.</span><span class="n">InitialNode</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">OutletNodes</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">tree</span><span class="o">.</span><span class="n">EndNodes</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Removing resistance added by the merging of networks.&quot;</span><span class="p">)</span>
        <span class="n">visc</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ModelParameters</span><span class="p">[</span><span class="s2">&quot;BLOOD_VISC&quot;</span><span class="p">])</span>
        <span class="n">density</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ModelParameters</span><span class="p">[</span><span class="s2">&quot;Density&quot;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">tree</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Trees</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">GetVesselNameFromNode</span><span class="p">(</span><span class="n">tree</span><span class="o">.</span><span class="n">InitialNode</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">DownStreamResistance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">visc</span><span class="p">,</span> <span class="n">density</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_Add1TreeToTop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  <span class="c1"># todo fix</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Adding trees to the vessel topology.&quot;</span><span class="p">)</span>
        <span class="n">tree</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Trees</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tree</span><span class="o">.</span><span class="n">Nodes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">tree</span><span class="o">.</span><span class="n">ConnectTree</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Nodes</span> <span class="o">+=</span> <span class="n">tree</span><span class="o">.</span><span class="n">Nodes</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">OutletNodes</span> <span class="o">+=</span> <span class="n">tree</span><span class="o">.</span><span class="n">EndNodes</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">OutletNodes</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">tree</span><span class="o">.</span><span class="n">InitialNode</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">BifurcationNodes</span> <span class="o">+=</span> <span class="n">tree</span><span class="o">.</span><span class="n">BifurcationNodes</span>
            <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">GetVesselNameFromNode</span><span class="p">(</span><span class="n">tree</span><span class="o">.</span><span class="n">InitialNode</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Vessels</span> <span class="o">+=</span> <span class="n">tree</span><span class="o">.</span><span class="n">Vessels</span>
            <span class="p">[</span><span class="n">vessel</span><span class="o">.</span><span class="n">SetName</span><span class="p">(</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;Tree_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tree</span><span class="o">.</span><span class="n">Vessels</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">UpdateTopology</span><span class="p">()</span>

    <span class="c1"># def WriteMeanVesselResultsToVTP(self):</span>
    <span class="c1">#     print(&quot;Writing mean results to Mean.vtp.&quot;)</span>
    <span class="c1">#     self.FrameToVTP(self.Folders.ModellingFolder + &#39;Mean.vtp&#39;, self.Results.CalcMean())</span>

    <span class="k">def</span> <span class="nf">LoadClusters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">ModellingFolder</span> <span class="o">+</span> <span class="s2">&quot;Clusters.csv&quot;</span>
        <span class="n">clusters</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">)]</span>

        <span class="n">NodeID</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">clusters</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span>
        <span class="n">Position</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">clusters</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span>
        <span class="n">Position</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">2</span><span class="p">])]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">Position</span><span class="p">]</span>
        <span class="n">CouplingPointsN</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">clusters</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span>
        <span class="n">ClusterID</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">clusters</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span>
        <span class="n">areas</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">clusters</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span>
        <span class="n">majorvesselid</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">clusters</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span>
        <span class="c1"># nodes = [i[5] for i in clusters[1:]]</span>

        <span class="k">return</span> <span class="n">NodeID</span><span class="p">,</span> <span class="n">Position</span><span class="p">,</span> <span class="n">CouplingPointsN</span><span class="p">,</span> <span class="n">ClusterID</span><span class="p">,</span> <span class="n">areas</span><span class="p">,</span> <span class="n">majorvesselid</span>

    <span class="k">def</span> <span class="nf">LoadSurfaceMapping</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s2">&quot;SurfaceNodesMapping.csv&quot;</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Loading surface mapping.&quot;</span><span class="p">)</span>
        <span class="n">file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">ModellingFolder</span> <span class="o">+</span> <span class="n">filename</span>
        <span class="k">if</span> <span class="n">file</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span> <span class="o">==</span> <span class="s2">&quot;csv&quot;</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">csvfile</span><span class="p">:</span>
                <span class="n">spamreader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">csvfile</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
                <span class="n">clusters</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">spamreader</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">csvfile</span><span class="p">:</span>
                <span class="n">spamreader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">csvfile</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">clusters</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">spamreader</span><span class="p">]</span>

        <span class="c1"># clusters = [i.strip(&#39;\n&#39;).split(&#39;,&#39;) for i in open(file)]</span>

        <span class="n">NodeID</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">clusters</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span>
        <span class="n">ClusterID</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">int</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">clusters</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span>
        <span class="n">Areas</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">clusters</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span>
        <span class="c1"># print(len(self.Perfusion.CouplingPoints) == len(set([y for x in ClusterID for y in x])))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Perfusion</span><span class="o">.</span><span class="n">CouplingPoints</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">y</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ClusterID</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">x</span><span class="p">])):</span>
            <span class="k">for</span> <span class="n">node</span><span class="p">,</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">NodeID</span><span class="p">,</span> <span class="n">ClusterID</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">id_number</span> <span class="ow">in</span> <span class="n">cluster</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">Perfusion</span><span class="o">.</span><span class="n">CouplingPoints</span><span class="p">[</span><span class="n">id_number</span><span class="p">]</span><span class="o">.</span><span class="n">SurfaceNodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">NodeID</span><span class="p">,</span> <span class="n">ClusterID</span><span class="p">,</span> <span class="n">Areas</span>

    <span class="k">def</span> <span class="nf">DistributeFlowVertex</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Distributing flow to the coupling points&quot;</span><span class="p">)</span>
        <span class="c1"># use this when the clustering is done with the primal graph, i.e. the vertices.</span>
        <span class="c1"># the only difference with the dual graph clustering is the type of data,</span>
        <span class="c1"># cell vs point and the cluster size might be different</span>
        <span class="n">nodeids</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">clusterids</span><span class="p">,</span> <span class="n">Areas</span><span class="p">,</span> <span class="n">majorvesselid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">LoadClusters</span><span class="p">()</span>
        <span class="n">surfacenodes</span><span class="p">,</span> <span class="n">clustermap</span><span class="p">,</span> <span class="n">triangleArea</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">LoadSurfaceMapping</span><span class="p">()</span>

        <span class="n">pointspercluster</span> <span class="o">=</span> <span class="p">[</span><span class="nb">sum</span><span class="p">([</span><span class="mi">1</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">clustermap</span> <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">id_number</span><span class="p">])</span> <span class="k">for</span> <span class="n">id_number</span> <span class="ow">in</span> <span class="n">clusterids</span><span class="p">]</span>

        <span class="n">reader</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkXMLPolyDataReader</span><span class="p">()</span>
        <span class="n">reader</span><span class="o">.</span><span class="n">SetFileName</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">ModellingFolder</span> <span class="o">+</span> <span class="s2">&quot;Clustering_mapped.vtp&quot;</span><span class="p">)</span>
        <span class="n">reader</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">()</span>
        <span class="n">resultsfolder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">ModellingFolder</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">resultsfolder</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">resultsfolder</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">timeindex</span><span class="p">,</span> <span class="n">timepoint</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">TimePoints</span><span class="p">):</span>
            <span class="n">flow</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkFloatArray</span><span class="p">()</span>
            <span class="n">flow</span><span class="o">.</span><span class="n">SetNumberOfComponents</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">flow</span><span class="o">.</span><span class="n">SetName</span><span class="p">(</span><span class="s2">&quot;Flow&quot;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">surfacenode</span> <span class="ow">in</span> <span class="n">surfacenodes</span><span class="p">:</span>
                <span class="n">cluster</span> <span class="o">=</span> <span class="n">clustermap</span><span class="p">[</span><span class="n">surfacenode</span><span class="p">]</span>
                <span class="n">fractionflow</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">cluster</span><span class="p">:</span>
                    <span class="n">outlet</span> <span class="o">=</span> <span class="n">nodeids</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">outletflow</span> <span class="o">=</span> <span class="n">timepoint</span><span class="o">.</span><span class="n">Flow</span><span class="p">[</span><span class="n">outlet</span><span class="p">]</span>
                    <span class="n">clustersize</span> <span class="o">=</span> <span class="n">pointspercluster</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">fractionflow</span> <span class="o">+=</span> <span class="n">outletflow</span> <span class="o">/</span> <span class="n">clustersize</span>

                <span class="n">flow</span><span class="o">.</span><span class="n">InsertNextValue</span><span class="p">(</span><span class="n">fractionflow</span><span class="p">)</span>

            <span class="n">writer</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkXMLPolyDataWriter</span><span class="p">()</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">resultsfolder</span> <span class="o">+</span> <span class="s2">&quot;FlowDistributed&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">timeindex</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.vtp&quot;</span>
            <span class="n">writer</span><span class="o">.</span><span class="n">SetFileName</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
            <span class="n">data</span><span class="o">.</span><span class="n">GetPointData</span><span class="p">()</span><span class="o">.</span><span class="n">AddArray</span><span class="p">(</span><span class="n">flow</span><span class="p">)</span>
            <span class="n">writer</span><span class="o">.</span><span class="n">SetInputData</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">writer</span><span class="o">.</span><span class="n">Write</span><span class="p">()</span>

        <span class="n">meanflow</span> <span class="o">=</span> <span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">tp</span><span class="o">.</span><span class="n">Flow</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="k">for</span> <span class="n">tp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">TimePoints</span><span class="p">])</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodeids</span><span class="p">]</span>
        <span class="n">flow</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkFloatArray</span><span class="p">()</span>
        <span class="n">flow</span><span class="o">.</span><span class="n">SetNumberOfComponents</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">flow</span><span class="o">.</span><span class="n">SetName</span><span class="p">(</span><span class="s2">&quot;Flow&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">surfacenode</span> <span class="ow">in</span> <span class="n">surfacenodes</span><span class="p">:</span>
            <span class="n">cluster</span> <span class="o">=</span> <span class="n">clustermap</span><span class="p">[</span><span class="n">surfacenode</span><span class="p">]</span>
            <span class="n">fractionflow</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">cluster</span><span class="p">:</span>
                <span class="n">outletflow</span> <span class="o">=</span> <span class="n">meanflow</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">clustersize</span> <span class="o">=</span> <span class="n">pointspercluster</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">fractionflow</span> <span class="o">+=</span> <span class="n">outletflow</span> <span class="o">/</span> <span class="n">clustersize</span>
            <span class="n">flow</span><span class="o">.</span><span class="n">InsertNextValue</span><span class="p">(</span><span class="n">fractionflow</span><span class="p">)</span>

        <span class="n">writer</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkXMLPolyDataWriter</span><span class="p">()</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">resultsfolder</span> <span class="o">+</span> <span class="s2">&quot;FlowDistributedMean.vtp&quot;</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">SetFileName</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">data</span><span class="o">.</span><span class="n">GetPointData</span><span class="p">()</span><span class="o">.</span><span class="n">AddArray</span><span class="p">(</span><span class="n">flow</span><span class="p">)</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">SetInputData</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">Write</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">GetMeanFlowRates</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">nodeids</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">clusterids</span><span class="p">,</span> <span class="n">areas</span><span class="p">,</span> <span class="n">majorvesselid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">LoadClusters</span><span class="p">()</span>
        <span class="n">time</span> <span class="o">=</span> <span class="p">[</span><span class="n">tp</span><span class="o">.</span><span class="n">WT</span> <span class="k">for</span> <span class="n">tp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">TimePoints</span><span class="p">]</span>
        <span class="n">totalflow</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">regionsflowvolume</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">)]</span>
        <span class="n">clusterflowrate</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">clusterPressure</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">nodeids</span><span class="p">):</span>
            <span class="n">flowdatanode</span> <span class="o">=</span> <span class="p">[</span><span class="n">tp</span><span class="o">.</span><span class="n">Flow</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="k">for</span> <span class="n">tp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">TimePoints</span><span class="p">]</span>
            <span class="n">flowvolume</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="n">flowdatanode</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span>
            <span class="n">flowrate</span> <span class="o">=</span> <span class="n">flowvolume</span> <span class="o">/</span> <span class="n">time</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">totalflow</span> <span class="o">+=</span> <span class="n">flowvolume</span>
            <span class="n">major</span> <span class="o">=</span> <span class="n">majorvesselid</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span>
            <span class="n">regionsflowvolume</span><span class="p">[</span><span class="n">major</span><span class="p">]</span> <span class="o">+=</span> <span class="n">flowvolume</span>
            <span class="n">clusterflowrate</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">flowrate</span><span class="p">)</span>

            <span class="n">pressuredatanode</span> <span class="o">=</span> <span class="p">[</span><span class="n">tp</span><span class="o">.</span><span class="n">Pressure</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="k">for</span> <span class="n">tp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">TimePoints</span><span class="p">]</span>
            <span class="n">pressureall</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="n">pressuredatanode</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span>
            <span class="n">pressurefinal</span> <span class="o">=</span> <span class="n">pressureall</span> <span class="o">/</span> <span class="n">time</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">clusterPressure</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pressurefinal</span><span class="p">)</span>

        <span class="n">regionsflowrateregion</span> <span class="o">=</span> <span class="p">[</span><span class="n">element</span> <span class="o">/</span> <span class="n">time</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">regionsflowvolume</span><span class="p">]</span>
        <span class="n">sumflow</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">flow</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">flow</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">clusterflowrate</span><span class="p">)</span> <span class="k">if</span> <span class="n">majorvesselid</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">regionsflowrateregion</span><span class="p">,</span> <span class="n">clusterflowrate</span><span class="p">,</span> <span class="n">clusterPressure</span>

    <span class="k">def</span> <span class="nf">DistributeFlowTriangles</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Distributing flow to the coupling points&quot;</span><span class="p">)</span>
        <span class="c1"># use this when the clustering is done with the primal graph, i.e. the vertices.</span>
        <span class="c1"># the only difference with the dual graph clustering is the type of data,</span>
        <span class="c1"># cell vs point and the cluster size might be different</span>
        <span class="n">nodeids</span><span class="p">,</span> <span class="n">positions</span><span class="p">,</span> <span class="n">couplingpointsN</span><span class="p">,</span> <span class="n">clusterids</span><span class="p">,</span> <span class="n">areas</span><span class="p">,</span> <span class="n">majorvesselid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">LoadClusters</span><span class="p">()</span>
        <span class="n">surfacenodes</span><span class="p">,</span> <span class="n">clustermap</span><span class="p">,</span> <span class="n">triangleAreas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">LoadSurfaceMapping</span><span class="p">()</span>

        <span class="n">reader</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkXMLPolyDataReader</span><span class="p">()</span>
        <span class="n">reader</span><span class="o">.</span><span class="n">SetFileName</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">ModellingFolder</span> <span class="o">+</span> <span class="s2">&quot;Clustering.vtp&quot;</span><span class="p">)</span>
        <span class="n">reader</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">()</span>
        <span class="n">outputfolder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">ModellingFolder</span> <span class="o">+</span> <span class="s2">&quot;TimeSeries/&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">outputfolder</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">outputfolder</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">timeindex</span><span class="p">,</span> <span class="n">timepoint</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">TimePoints</span><span class="p">):</span>
            <span class="n">flow</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkFloatArray</span><span class="p">()</span>
            <span class="n">flow</span><span class="o">.</span><span class="n">SetNumberOfComponents</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">flow</span><span class="o">.</span><span class="n">SetName</span><span class="p">(</span><span class="s2">&quot;Volume Flow Rate (mL/s)&quot;</span><span class="p">)</span>

            <span class="n">pressure</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkFloatArray</span><span class="p">()</span>
            <span class="n">pressure</span><span class="o">.</span><span class="n">SetNumberOfComponents</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">pressure</span><span class="o">.</span><span class="n">SetName</span><span class="p">(</span><span class="s2">&quot;Pressure (Pa)&quot;</span><span class="p">)</span>

            <span class="n">flowrate</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkFloatArray</span><span class="p">()</span>
            <span class="n">flowrate</span><span class="o">.</span><span class="n">SetNumberOfComponents</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">flowrate</span><span class="o">.</span><span class="n">SetName</span><span class="p">(</span><span class="s2">&quot;Flow Velocity (m/s)&quot;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">clusters</span><span class="p">,</span> <span class="n">surfacenode</span><span class="p">,</span> <span class="n">triangleArea</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">clustermap</span><span class="p">,</span> <span class="n">surfacenodes</span><span class="p">,</span> <span class="n">triangleAreas</span><span class="p">):</span>
                <span class="n">FlowRatePerOutlet</span> <span class="o">=</span> <span class="p">[</span><span class="n">timepoint</span><span class="o">.</span><span class="n">Flow</span><span class="p">[</span><span class="n">nodeids</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">/</span> <span class="n">areas</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">clusters</span><span class="p">]</span>
                <span class="n">PressurePerCluster</span> <span class="o">=</span> <span class="p">[</span><span class="n">timepoint</span><span class="o">.</span><span class="n">Pressure</span><span class="p">[</span><span class="n">nodeids</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">clusters</span><span class="p">]</span>
                <span class="n">FlowPerTriangle</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">FlowRatePerOutlet</span><span class="p">)</span> <span class="o">*</span> <span class="n">triangleArea</span>

                <span class="n">flow</span><span class="o">.</span><span class="n">InsertNextValue</span><span class="p">(</span><span class="n">FlowPerTriangle</span><span class="p">)</span>
                <span class="n">flowrate</span><span class="o">.</span><span class="n">InsertNextValue</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">FlowRatePerOutlet</span><span class="p">))</span>
                <span class="n">pressure</span><span class="o">.</span><span class="n">InsertNextValue</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">PressurePerCluster</span><span class="p">))</span>

            <span class="n">writer</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkXMLPolyDataWriter</span><span class="p">()</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">outputfolder</span> <span class="o">+</span> <span class="s2">&quot;FlowDistributed&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">timeindex</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.vtp&quot;</span>
            <span class="n">writer</span><span class="o">.</span><span class="n">SetFileName</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
            <span class="n">data</span><span class="o">.</span><span class="n">GetCellData</span><span class="p">()</span><span class="o">.</span><span class="n">AddArray</span><span class="p">(</span><span class="n">flow</span><span class="p">)</span>
            <span class="n">data</span><span class="o">.</span><span class="n">GetCellData</span><span class="p">()</span><span class="o">.</span><span class="n">AddArray</span><span class="p">(</span><span class="n">flowrate</span><span class="p">)</span>
            <span class="n">data</span><span class="o">.</span><span class="n">GetCellData</span><span class="p">()</span><span class="o">.</span><span class="n">AddArray</span><span class="p">(</span><span class="n">pressure</span><span class="p">)</span>
            <span class="n">writer</span><span class="o">.</span><span class="n">SetInputData</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">writer</span><span class="o">.</span><span class="n">Write</span><span class="p">()</span>

        <span class="n">time</span> <span class="o">=</span> <span class="p">[</span><span class="n">tp</span><span class="o">.</span><span class="n">WT</span> <span class="k">for</span> <span class="n">tp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">TimePoints</span><span class="p">]</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">meanflowrate</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetMeanFlowRates</span><span class="p">()</span>
        <span class="n">flow</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkFloatArray</span><span class="p">()</span>
        <span class="n">flow</span><span class="o">.</span><span class="n">SetNumberOfComponents</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">flow</span><span class="o">.</span><span class="n">SetName</span><span class="p">(</span><span class="s2">&quot;Volume Flow Rate (mL/s)&quot;</span><span class="p">)</span>
        <span class="n">flowrate</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkFloatArray</span><span class="p">()</span>
        <span class="n">flowrate</span><span class="o">.</span><span class="n">SetNumberOfComponents</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">flowrate</span><span class="o">.</span><span class="n">SetName</span><span class="p">(</span><span class="s2">&quot;Flow Velocity (m/s)&quot;</span><span class="p">)</span>
        <span class="n">pressure</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkFloatArray</span><span class="p">()</span>
        <span class="n">pressure</span><span class="o">.</span><span class="n">SetNumberOfComponents</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">pressure</span><span class="o">.</span><span class="n">SetName</span><span class="p">(</span><span class="s2">&quot;Pressure (Pa)&quot;</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">ModellingFolder</span> <span class="o">+</span> <span class="s2">&quot;Results.pvd&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&lt;?xml version=</span><span class="se">\&quot;</span><span class="s2">1.0</span><span class="se">\&quot;</span><span class="s2">?&gt;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                <span class="s2">&quot;&lt;VTKFile type=</span><span class="se">\&quot;</span><span class="s2">Collection</span><span class="se">\&quot;</span><span class="s2"> version=</span><span class="se">\&quot;</span><span class="s2">0.1</span><span class="se">\&quot;</span><span class="s2"> byte_order=</span><span class="se">\&quot;</span><span class="s2">LittleEndian</span><span class="se">\&quot;</span><span class="s2"> compressor=</span><span class="se">\&quot;</span><span class="s2">vtkZLibDataCompressor</span><span class="se">\&quot;</span><span class="s2">&gt;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&lt;Collection&gt;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">timeindex</span><span class="p">,</span> <span class="n">timepoint</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">TimePoints</span><span class="p">):</span>
                <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;TimeSeries/FlowDistributed&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">timeindex</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.vtp&quot;</span>
                <span class="n">time</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">timepoint</span><span class="o">.</span><span class="n">WT</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&lt;DataSet timestep=</span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">time</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2"> group=</span><span class="se">\&quot;\&quot;</span><span class="s2"> part=</span><span class="se">\&quot;</span><span class="s2">0</span><span class="se">\&quot;</span><span class="s2"> file=</span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">/&gt;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&lt;/Collection&gt;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&lt;/VTKFile&gt;&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">clusters</span><span class="p">,</span> <span class="n">surfacenode</span><span class="p">,</span> <span class="n">triangleArea</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">clustermap</span><span class="p">,</span> <span class="n">surfacenodes</span><span class="p">,</span> <span class="n">triangleAreas</span><span class="p">):</span>
            <span class="n">FlowRatePerOutlet</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">MeanVolumeFlowRatePerNode</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">nodeids</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">/</span> <span class="n">areas</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">clusters</span><span class="p">]</span>
            <span class="n">PressurePerCluster</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">MeanPressurePerNode</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">nodeids</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">clusters</span><span class="p">]</span>
            <span class="n">FlowPerTriangle</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">FlowRatePerOutlet</span><span class="p">)</span> <span class="o">*</span> <span class="n">triangleArea</span>

            <span class="n">flow</span><span class="o">.</span><span class="n">InsertNextValue</span><span class="p">(</span><span class="n">FlowPerTriangle</span><span class="p">)</span>
            <span class="n">flowrate</span><span class="o">.</span><span class="n">InsertNextValue</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">FlowRatePerOutlet</span><span class="p">))</span>
            <span class="n">pressure</span><span class="o">.</span><span class="n">InsertNextValue</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">PressurePerCluster</span><span class="p">))</span>

        <span class="n">writer</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkXMLPolyDataWriter</span><span class="p">()</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">ModellingFolder</span> <span class="o">+</span> <span class="s2">&quot;FlowDistributedMean.vtp&quot;</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">SetFileName</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">data</span><span class="o">.</span><span class="n">GetCellData</span><span class="p">()</span><span class="o">.</span><span class="n">AddArray</span><span class="p">(</span><span class="n">flow</span><span class="p">)</span>
        <span class="n">data</span><span class="o">.</span><span class="n">GetCellData</span><span class="p">()</span><span class="o">.</span><span class="n">AddArray</span><span class="p">(</span><span class="n">flowrate</span><span class="p">)</span>
        <span class="n">data</span><span class="o">.</span><span class="n">GetCellData</span><span class="p">()</span><span class="o">.</span><span class="n">AddArray</span><span class="p">(</span><span class="n">pressure</span><span class="p">)</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">SetInputData</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">Write</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">WriteTimeseriesVessels</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">reader</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkXMLPolyDataReader</span><span class="p">()</span>
        <span class="n">reader</span><span class="o">.</span><span class="n">SetFileName</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">ModellingFolder</span> <span class="o">+</span> <span class="s2">&quot;Topology.vtp&quot;</span><span class="p">)</span>
        <span class="n">reader</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">()</span>
        <span class="n">outputfolder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">ModellingFolder</span> <span class="o">+</span> <span class="s2">&quot;TimeSeriesBF/&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">outputfolder</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">outputfolder</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">timeindex</span><span class="p">,</span> <span class="n">timepoint</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">Time</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">flow</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkFloatArray</span><span class="p">()</span>
            <span class="n">flow</span><span class="o">.</span><span class="n">SetNumberOfComponents</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">flow</span><span class="o">.</span><span class="n">SetName</span><span class="p">(</span><span class="s2">&quot;Volume Flowrate (mL/s)&quot;</span><span class="p">)</span>

            <span class="n">velocity</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkFloatArray</span><span class="p">()</span>
            <span class="n">velocity</span><span class="o">.</span><span class="n">SetNumberOfComponents</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">velocity</span><span class="o">.</span><span class="n">SetName</span><span class="p">(</span><span class="s2">&quot;Velocity (m/s)&quot;</span><span class="p">)</span>

            <span class="n">pressure</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkFloatArray</span><span class="p">()</span>
            <span class="n">pressure</span><span class="o">.</span><span class="n">SetNumberOfComponents</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">pressure</span><span class="o">.</span><span class="n">SetName</span><span class="p">(</span><span class="s2">&quot;Pressure (pa)&quot;</span><span class="p">)</span>

            <span class="n">radius</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkFloatArray</span><span class="p">()</span>
            <span class="n">radius</span><span class="o">.</span><span class="n">SetNumberOfComponents</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">radius</span><span class="o">.</span><span class="n">SetName</span><span class="p">(</span><span class="s2">&quot;Radius (mm)&quot;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">nodeindex</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">Pressure</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])):</span>
                <span class="n">flow</span><span class="o">.</span><span class="n">InsertNextValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">VolumeFlowRate</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">nodeindex</span><span class="p">][</span><span class="n">timeindex</span><span class="p">])</span>
                <span class="n">velocity</span><span class="o">.</span><span class="n">InsertNextValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">Velocity</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">nodeindex</span><span class="p">][</span><span class="n">timeindex</span><span class="p">])</span>
                <span class="n">pressure</span><span class="o">.</span><span class="n">InsertNextValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">Pressure</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">nodeindex</span><span class="p">][</span><span class="n">timeindex</span><span class="p">])</span>
                <span class="n">radius</span><span class="o">.</span><span class="n">InsertNextValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">Radius</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">nodeindex</span><span class="p">][</span><span class="n">timeindex</span><span class="p">])</span>

            <span class="n">writer</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkXMLPolyDataWriter</span><span class="p">()</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">outputfolder</span> <span class="o">+</span> <span class="s2">&quot;Bloodflow&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">timeindex</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.vtp&quot;</span>
            <span class="n">writer</span><span class="o">.</span><span class="n">SetFileName</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
            <span class="n">data</span><span class="o">.</span><span class="n">GetPointData</span><span class="p">()</span><span class="o">.</span><span class="n">AddArray</span><span class="p">(</span><span class="n">flow</span><span class="p">)</span>
            <span class="n">data</span><span class="o">.</span><span class="n">GetPointData</span><span class="p">()</span><span class="o">.</span><span class="n">AddArray</span><span class="p">(</span><span class="n">velocity</span><span class="p">)</span>
            <span class="n">data</span><span class="o">.</span><span class="n">GetPointData</span><span class="p">()</span><span class="o">.</span><span class="n">AddArray</span><span class="p">(</span><span class="n">pressure</span><span class="p">)</span>
            <span class="n">data</span><span class="o">.</span><span class="n">GetPointData</span><span class="p">()</span><span class="o">.</span><span class="n">AddArray</span><span class="p">(</span><span class="n">radius</span><span class="p">)</span>
            <span class="n">writer</span><span class="o">.</span><span class="n">SetInputData</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">writer</span><span class="o">.</span><span class="n">Write</span><span class="p">()</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">ModellingFolder</span> <span class="o">+</span> <span class="s2">&quot;ResultsBF.pvd&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&lt;?xml version=</span><span class="se">\&quot;</span><span class="s2">1.0</span><span class="se">\&quot;</span><span class="s2">?&gt;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                <span class="s2">&quot;&lt;VTKFile type=</span><span class="se">\&quot;</span><span class="s2">Collection</span><span class="se">\&quot;</span><span class="s2"> version=</span><span class="se">\&quot;</span><span class="s2">0.1</span><span class="se">\&quot;</span><span class="s2"> byte_order=</span><span class="se">\&quot;</span><span class="s2">LittleEndian</span><span class="se">\&quot;</span><span class="s2"> compressor=</span><span class="se">\&quot;</span><span class="s2">vtkZLibDataCompressor</span><span class="se">\&quot;</span><span class="s2">&gt;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&lt;Collection&gt;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">timeindex</span><span class="p">,</span> <span class="n">timepoint</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">TimePoints</span><span class="p">):</span>
                <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;TimeSeriesBF/Bloodflow&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">timeindex</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.vtp&quot;</span>
                <span class="n">time</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">timepoint</span><span class="o">.</span><span class="n">WT</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&lt;DataSet timestep=</span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">time</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2"> group=</span><span class="se">\&quot;\&quot;</span><span class="s2"> part=</span><span class="se">\&quot;</span><span class="s2">0</span><span class="se">\&quot;</span><span class="s2"> file=</span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">/&gt;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&lt;/Collection&gt;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&lt;/VTKFile&gt;&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">ImportClotNodeFile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">ModellingFolder</span> <span class="o">+</span> <span class="s2">&quot;Clots.txt&quot;</span>
        <span class="n">clotdata</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">)][</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">ClotID</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">clotdata</span><span class="p">]</span>
        <span class="n">NodeID</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">clotdata</span><span class="p">]</span>
        <span class="n">Permeability</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">clotdata</span><span class="p">]</span>
        <span class="n">Porosity</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">clotdata</span><span class="p">]</span>
        <span class="n">uniqueclots</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">ClotID</span><span class="p">)</span>
        <span class="n">clots</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">uniqueclots</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">id_number</span> <span class="ow">in</span> <span class="n">uniqueclots</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">clotid</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ClotID</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">clotid</span> <span class="o">==</span> <span class="n">id_number</span><span class="p">:</span>
                    <span class="n">clots</span><span class="p">[</span><span class="n">id_number</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">NodeID</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">Permeability</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">Porosity</span><span class="p">[</span><span class="n">index</span><span class="p">]))</span>

    <span class="k">def</span> <span class="nf">ImportClots</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">InputFolder</span> <span class="o">+</span> <span class="s2">&quot;Clots.txt&quot;</span>
        <span class="c1"># first add new nodes with at the location of the clot</span>
        <span class="c1"># then map the clot to the node</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">GeneralFunctions</span><span class="o">.</span><span class="n">is_non_zero_file</span><span class="p">(</span><span class="n">file</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No clotfile found.&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Importing Clots.&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="k">as</span> <span class="n">csvfile</span><span class="p">:</span>
            <span class="n">reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictReader</span><span class="p">(</span><span class="n">csvfile</span><span class="p">)</span>
            <span class="n">Clots</span> <span class="o">=</span> <span class="p">[</span><span class="n">clot</span> <span class="k">for</span> <span class="n">clot</span> <span class="ow">in</span> <span class="n">reader</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">clot</span> <span class="ow">in</span> <span class="n">Clots</span><span class="p">:</span>
            <span class="n">vesselname</span> <span class="o">=</span> <span class="n">clot</span><span class="p">[</span><span class="s1">&#39;Vesselname&#39;</span><span class="p">]</span>
            <span class="n">location</span> <span class="o">=</span> <span class="n">clot</span><span class="p">[</span><span class="s1">&#39;Clotlocation(mm)&#39;</span><span class="p">]</span>
            <span class="n">length</span> <span class="o">=</span> <span class="n">clot</span><span class="p">[</span><span class="s1">&#39;Clotlength(mm)&#39;</span><span class="p">]</span>
            <span class="n">permeability</span> <span class="o">=</span> <span class="n">clot</span><span class="p">[</span><span class="s1">&#39;Permeability&#39;</span><span class="p">]</span>
            <span class="n">porosity</span> <span class="o">=</span> <span class="n">clot</span><span class="p">[</span><span class="s1">&#39;Porosity&#39;</span><span class="p">]</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">vessel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">VesselAtlas</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">vesselname</span><span class="p">)]</span>
                <span class="n">numbergridnodes</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">vessel</span><span class="o">.</span><span class="n">Length</span> <span class="o">/</span> <span class="mf">0.5</span><span class="p">))</span>  <span class="c1"># update resolution to about 0.5mm</span>
                <span class="n">vessel</span><span class="o">.</span><span class="n">UpdateResolution</span><span class="p">(</span><span class="n">numbergridnodes</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">UpdateTopology</span><span class="p">()</span>
                <span class="n">location</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">permeability</span><span class="p">,</span> <span class="n">porosity</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">location</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">length</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">permeability</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span>
                    <span class="n">porosity</span><span class="p">)</span>

                <span class="c1"># this will break compatibility with the pulsatile model so only do this when using the steady state model.</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ModelParameters</span><span class="p">[</span><span class="s2">&quot;Model&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Steady&quot;</span><span class="p">:</span>
                    <span class="n">vessel</span><span class="o">.</span><span class="n">add_node_interp_length</span><span class="p">(</span><span class="n">location</span><span class="p">)</span>
                    <span class="n">vessel</span><span class="o">.</span><span class="n">add_node_interp_length</span><span class="p">(</span><span class="n">location</span><span class="o">+</span><span class="n">length</span><span class="p">)</span>

                <span class="c1"># nearest node in the vessel</span>
                <span class="n">clotnodes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                <span class="c1"># boundary</span>
                <span class="n">boundary1</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">argmin</span><span class="p">([</span><span class="nb">abs</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">LengthAlongVessel</span> <span class="o">-</span> <span class="n">location</span><span class="p">)</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">])</span>
                <span class="n">clotnodes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="n">boundary1</span><span class="p">])</span>
                <span class="c1"># internal nodes</span>
                <span class="p">[</span><span class="n">clotnodes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span> <span class="k">if</span>
                 <span class="n">node</span><span class="o">.</span><span class="n">LengthAlongVessel</span> <span class="o">&gt;=</span> <span class="n">location</span> <span class="ow">and</span> <span class="n">node</span><span class="o">.</span><span class="n">LengthAlongVessel</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">location</span> <span class="o">+</span> <span class="n">length</span><span class="p">)]</span>
                <span class="c1"># other boundary</span>
                <span class="n">boundary2</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span>
                    <span class="p">[</span><span class="nb">abs</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">LengthAlongVessel</span> <span class="o">-</span> <span class="p">(</span><span class="n">location</span> <span class="o">+</span> <span class="n">length</span><span class="p">))</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">])</span>
                <span class="n">clotnodes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="n">boundary2</span><span class="p">])</span>

                <span class="n">clotnodes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">clotnodes</span><span class="p">)</span>
                <span class="c1"># if clot extends past a bifurcation, map the clot nodes to the same clot</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Clots</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">clotnodes</span><span class="p">,</span> <span class="n">permeability</span><span class="p">,</span> <span class="n">porosity</span><span class="p">,</span> <span class="n">length</span><span class="p">))</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: Likely caused by the clot file listing non-existent vessels.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">UpdateTopology</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">ShowResults</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># wait for results to be saved</span>
        <span class="c1"># while not is_non_zero_file(self.Results.File):</span>
        <span class="c1">#     print(&quot;Waiting for data.&quot;)</span>
        <span class="c1">#     time.sleep(1)</span>
        <span class="c1"># self.Results.LoadResults(self.Results.File)</span>
        <span class="c1"># open the results window</span>
        <span class="n">app</span> <span class="o">=</span> <span class="n">Results</span><span class="o">.</span><span class="n">QtWidgets</span><span class="o">.</span><span class="n">QApplication</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span>
        <span class="n">win</span> <span class="o">=</span> <span class="n">Results</span><span class="o">.</span><span class="n">ResultsWindow</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">app</span><span class="o">.</span><span class="n">exec</span><span class="p">()</span>
        <span class="c1"># sys.exit(app.exec_())</span>

    <span class="k">def</span> <span class="nf">MappingSixMajorArteries</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Follow the major cerebreal arteries upstream and return the outlets.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Mapping the outlets of the six major cerebral arteries.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">RedefineDirection</span><span class="p">()</span>
        <span class="n">arteries</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;R. ACA, A2&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;R. MCA&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;L. MCA&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;L. ACA, A2&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;R. PCA, P2&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;L. PCA, P2&quot;</span><span class="p">,</span> <span class="p">]</span>

        <span class="n">upstream</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="n">arteries</span><span class="p">:</span>
            <span class="n">upstream</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">GetDownstreamVessels</span><span class="p">(</span><span class="n">vessel</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">region</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">upstream</span><span class="p">):</span>
            <span class="n">vessels</span> <span class="o">=</span> <span class="n">region</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="n">vessels</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">:</span>
                    <span class="n">node</span><span class="o">.</span><span class="n">MajorVesselID</span> <span class="o">=</span> <span class="n">index</span> <span class="o">+</span> <span class="mi">2</span>

        <span class="n">artertydict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Nodes</span><span class="p">):</span>
            <span class="n">artertydict</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">MajorVesselID</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Perfusion</span><span class="o">.</span><span class="n">MajorArteries</span> <span class="o">=</span> <span class="n">artertydict</span>

        <span class="n">outletarteries</span> <span class="o">=</span> <span class="p">[</span><span class="n">artertydict</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">OutletNodes</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">indexregion</span><span class="p">,</span> <span class="n">region</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">arteries</span><span class="p">):</span>
            <span class="n">numberofoutlets</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="n">out</span> <span class="k">for</span> <span class="n">out</span> <span class="ow">in</span> <span class="n">outletarteries</span> <span class="k">if</span> <span class="n">out</span> <span class="o">==</span> <span class="n">indexregion</span> <span class="o">+</span> <span class="mi">2</span><span class="p">])</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">region</span> <span class="o">+</span> <span class="s2">&quot;: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">numberofoutlets</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; outlets&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">ExportDualClustering</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">primal</span><span class="o">=</span><span class="s2">&quot;GMsurface.vtp&quot;</span><span class="p">,</span> <span class="n">dual</span><span class="o">=</span><span class="s2">&quot;Clustering_mapped.vtp&quot;</span><span class="p">):</span>
        <span class="c1"># import the primal graph</span>
        <span class="k">if</span> <span class="n">primal</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span> <span class="o">==</span> <span class="s2">&quot;vtp&quot;</span><span class="p">:</span>
            <span class="n">reader</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkXMLPolyDataReader</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">primal</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span> <span class="o">==</span> <span class="s2">&quot;ply&quot;</span><span class="p">:</span>
            <span class="n">reader</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkPLYReader</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: unreadable file.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">1</span>

        <span class="n">reader</span><span class="o">.</span><span class="n">SetFileName</span><span class="p">(</span><span class="n">primal</span><span class="p">)</span>
        <span class="n">reader</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span>
        <span class="n">primaldata</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">()</span>

        <span class="c1"># import the dual graph with the triangle colour</span>
        <span class="k">if</span> <span class="n">dual</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span> <span class="o">==</span> <span class="s2">&quot;vtp&quot;</span><span class="p">:</span>
            <span class="n">reader</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkXMLPolyDataReader</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">dual</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span> <span class="o">==</span> <span class="s2">&quot;ply&quot;</span><span class="p">:</span>
            <span class="n">reader</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkPLYReader</span><span class="p">()</span>
        <span class="n">reader</span><span class="o">.</span><span class="n">SetFileName</span><span class="p">(</span><span class="n">dual</span><span class="p">)</span>
        <span class="n">reader</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span>

        <span class="n">narray</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">()</span><span class="o">.</span><span class="n">GetPointData</span><span class="p">()</span><span class="o">.</span><span class="n">GetNumberOfArrays</span><span class="p">()</span>
        <span class="c1"># vertex colour of the dual graph is the triangle colour of the primal graph</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">narray</span><span class="p">):</span>
            <span class="n">arrayname</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">()</span><span class="o">.</span><span class="n">GetPointData</span><span class="p">()</span><span class="o">.</span><span class="n">GetArrayName</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">arrayname</span> <span class="o">==</span> <span class="s2">&quot;Colour&quot;</span><span class="p">:</span>
                <span class="n">clusteringdata</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">()</span><span class="o">.</span><span class="n">GetPointData</span><span class="p">()</span><span class="o">.</span><span class="n">GetArray</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">primaldata</span><span class="o">.</span><span class="n">GetCellData</span><span class="p">()</span><span class="o">.</span><span class="n">AddArray</span><span class="p">(</span><span class="n">clusteringdata</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">arrayname</span> <span class="o">==</span> <span class="s2">&quot;Major Cerebral Artery&quot;</span><span class="p">:</span>
                <span class="n">clusteringdata</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">()</span><span class="o">.</span><span class="n">GetPointData</span><span class="p">()</span><span class="o">.</span><span class="n">GetArray</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">primaldata</span><span class="o">.</span><span class="n">GetCellData</span><span class="p">()</span><span class="o">.</span><span class="n">AddArray</span><span class="p">(</span><span class="n">clusteringdata</span><span class="p">)</span>

        <span class="c1"># export to new file</span>
        <span class="n">writer</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkXMLPolyDataWriter</span><span class="p">()</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">ModellingFolder</span> <span class="o">+</span> <span class="s2">&quot;ClusteringByTriangle.vtp&quot;</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">SetFileName</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">SetInputData</span><span class="p">(</span><span class="n">primaldata</span><span class="p">)</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">Write</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">ExportTriangleFlowData</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Exporting Flow Data.&quot;</span><span class="p">)</span>
        <span class="n">file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">ModellingFolder</span> <span class="o">+</span> <span class="s2">&quot;FlowDistributedMean.vtp&quot;</span>

        <span class="n">reader</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkXMLPolyDataReader</span><span class="p">()</span>
        <span class="n">reader</span><span class="o">.</span><span class="n">SetFileName</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
        <span class="n">reader</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span>

        <span class="n">narray</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">()</span><span class="o">.</span><span class="n">GetCellData</span><span class="p">()</span><span class="o">.</span><span class="n">GetNumberOfArrays</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">narray</span><span class="p">):</span>
            <span class="n">arrayname</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">()</span><span class="o">.</span><span class="n">GetCellData</span><span class="p">()</span><span class="o">.</span><span class="n">GetArrayName</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">arrayname</span> <span class="o">==</span> <span class="s2">&quot;Major Cerebral Artery&quot;</span><span class="p">:</span>
                <span class="n">mapCA</span> <span class="o">=</span> <span class="n">vtk_to_numpy</span><span class="p">(</span><span class="n">reader</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">()</span><span class="o">.</span><span class="n">GetCellData</span><span class="p">()</span><span class="o">.</span><span class="n">GetArray</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">arrayname</span> <span class="o">==</span> <span class="s2">&quot;Volume Flow Rate (mL/s)&quot;</span><span class="p">:</span>
                <span class="n">flowdata</span> <span class="o">=</span> <span class="n">vtk_to_numpy</span><span class="p">(</span><span class="n">reader</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">()</span><span class="o">.</span><span class="n">GetCellData</span><span class="p">()</span><span class="o">.</span><span class="n">GetArray</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">arrayname</span> <span class="o">==</span> <span class="s2">&quot;Pressure (Pa)&quot;</span><span class="p">:</span>
                <span class="n">pressuredata</span> <span class="o">=</span> <span class="n">vtk_to_numpy</span><span class="p">(</span><span class="n">reader</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">()</span><span class="o">.</span><span class="n">GetCellData</span><span class="p">()</span><span class="o">.</span><span class="n">GetArray</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">arrayname</span> <span class="o">==</span> <span class="s2">&quot;Colour&quot;</span><span class="p">:</span>
                <span class="n">flowpercluster</span> <span class="o">=</span> <span class="n">vtk_to_numpy</span><span class="p">(</span><span class="n">reader</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">()</span><span class="o">.</span><span class="n">GetCellData</span><span class="p">()</span><span class="o">.</span><span class="n">GetArray</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
                <span class="c1"># todo change for multiple elements per cluster</span>
                <span class="n">flowpercluster</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">flowpercluster</span><span class="p">]</span>

        <span class="n">flowrateperregion</span><span class="p">,</span> <span class="n">clusterflowrate</span><span class="p">,</span> <span class="n">clusterpressure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetMeanFlowRates</span><span class="p">()</span>

        <span class="n">trianglesperregion</span> <span class="o">=</span> <span class="p">[</span><span class="nb">sum</span><span class="p">([</span><span class="mi">1</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">mapCA</span> <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">cluster</span> <span class="o">+</span> <span class="mi">2</span><span class="p">])</span> <span class="k">for</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">)]</span>
        <span class="n">surfacenodes</span><span class="p">,</span> <span class="n">clustermap</span><span class="p">,</span> <span class="n">triangleAreas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">LoadSurfaceMapping</span><span class="p">()</span>

        <span class="n">numberofclusters</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">flowpercluster</span><span class="p">)))</span>
        <span class="n">trianglespercluster</span> <span class="o">=</span> <span class="p">[</span><span class="nb">sum</span><span class="p">([</span><span class="mi">1</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">flowpercluster</span> <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">cluster</span><span class="p">])</span> <span class="k">for</span> <span class="n">cluster</span> <span class="ow">in</span>
                               <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">numberofclusters</span><span class="p">)]</span>

        <span class="n">totalAreaPerCluster</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numberofclusters</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">clusterid</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">numberofclusters</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">triangle</span><span class="p">,</span> <span class="n">area</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">clustermap</span><span class="p">,</span> <span class="n">triangleAreas</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">clusterid</span> <span class="ow">in</span> <span class="n">triangle</span><span class="p">:</span>
                    <span class="n">totalAreaPerCluster</span><span class="p">[</span><span class="n">clusterid</span><span class="p">]</span> <span class="o">+=</span> <span class="n">area</span>

        <span class="n">flowPerAreaPerCluster</span> <span class="o">=</span> <span class="p">[</span><span class="n">clusterflowrate</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="n">totalAreaPerCluster</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">numberofclusters</span><span class="p">)]</span>

        <span class="n">flowPerTriangle</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">surfacenodes</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">triandleID</span><span class="p">,</span> <span class="n">trianglemapping</span><span class="p">,</span> <span class="n">area</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">surfacenodes</span><span class="p">,</span> <span class="n">clustermap</span><span class="p">,</span> <span class="n">triangleAreas</span><span class="p">):</span>
            <span class="n">flowPerTriangle</span><span class="p">[</span><span class="n">triandleID</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">flowPerAreaPerCluster</span><span class="p">[</span><span class="n">id_number</span><span class="p">]</span> <span class="o">*</span> <span class="n">area</span> <span class="k">for</span> <span class="n">id_number</span> <span class="ow">in</span> <span class="n">trianglemapping</span><span class="p">])</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">ModellingFolder</span> <span class="o">+</span> <span class="s2">&quot;TriangleToRegion.csv&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Triangle ID,Cluster ID,Region ID,Flowrate over the triangle(mL/s),Pressure(Pa)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">flow</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">surfacenodes</span><span class="p">,</span> <span class="n">flowPerTriangle</span><span class="p">):</span>
                <span class="n">clustersPerTriangle</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">clustermap</span><span class="p">[</span><span class="n">index</span><span class="p">]))</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">,</span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s2">,</span><span class="si">%d</span><span class="s2">,</span><span class="si">%.10f</span><span class="s2">,</span><span class="si">%.10f</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">index</span><span class="p">,</span> <span class="n">clustersPerTriangle</span><span class="p">,</span> <span class="n">mapCA</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">flow</span><span class="p">,</span> <span class="n">pressuredata</span><span class="p">[</span><span class="n">index</span><span class="p">]))</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">ModellingFolder</span> <span class="o">+</span> <span class="s2">&quot;RegionFlowData.csv&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Region ID,Flow rate over the region(mL/s),number of triangles</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">):</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">,</span><span class="si">%.10f</span><span class="s2">,</span><span class="si">%d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">flowrateperregion</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">trianglesperregion</span><span class="p">[</span><span class="n">index</span><span class="p">]))</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">ModellingFolder</span> <span class="o">+</span> <span class="s2">&quot;ClusterFlowData.csv&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Cluster ID,Flow rate over the region(mL/s),number of triangles,Pressure(Pa)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">numberofclusters</span><span class="p">):</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">,</span><span class="si">%.10f</span><span class="s2">,</span><span class="si">%d</span><span class="s2">,</span><span class="si">%.10f</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">index</span><span class="p">,</span> <span class="n">clusterflowrate</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">trianglespercluster</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">clusterpressure</span><span class="p">[</span><span class="n">index</span><span class="p">]))</span>

    <span class="k">def</span> <span class="nf">MajorArteriesToPialSurfaceNN</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">graph</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Map surface to to nearest node, colour based on nearest vessel.</span>
<span class="sd">        Output is nearest major vessel ID.</span>
<span class="sd">        Note that the left and right halves of the brain are taken into account</span>
<span class="sd">        :param graph: The surface graph to map with the major vessel id of the nearest vessel</span>
<span class="sd">        :return: graph.MajorVesselID is updated to the mapping.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Mapping the surface to the nearest major artery.&quot;</span><span class="p">)</span>
        <span class="n">majornodes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">majornodesID</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Vessels</span><span class="p">:</span>
            <span class="c1"># interpolation of nodes in the vessel</span>
            <span class="n">nodeslengths</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Length</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">vessel</span><span class="o">.</span><span class="n">InterpolationFunctions</span><span class="p">[</span><span class="mi">0</span><span class="p">](</span><span class="n">nodeslengths</span><span class="p">)</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">vessel</span><span class="o">.</span><span class="n">InterpolationFunctions</span><span class="p">[</span><span class="mi">1</span><span class="p">](</span><span class="n">nodeslengths</span><span class="p">)</span>
            <span class="n">z</span> <span class="o">=</span> <span class="n">vessel</span><span class="o">.</span><span class="n">InterpolationFunctions</span><span class="p">[</span><span class="mi">2</span><span class="p">](</span><span class="n">nodeslengths</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">xpos</span><span class="p">,</span> <span class="n">ypos</span><span class="p">,</span> <span class="n">zpos</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
                <span class="n">majornodes</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">xpos</span><span class="p">,</span> <span class="n">ypos</span><span class="p">,</span> <span class="n">zpos</span><span class="p">))</span>
                <span class="n">majornodesID</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vessel</span><span class="o">.</span><span class="n">MajorVesselID</span><span class="p">)</span>

        <span class="c1"># for index, node in enumerate(self.Topology.Nodes):</span>
        <span class="c1">#     if (not (node.Position is None)) and node.MajorVesselID &gt;= 0:</span>
        <span class="c1">#         majornodes.append(node.Position)</span>
        <span class="c1">#         majornodesID.append(node.MajorVesselID)</span>

        <span class="c1"># left and right sides of the pial surface</span>
        <span class="n">rightpialsurface</span> <span class="o">=</span> <span class="p">[</span><span class="n">index</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">graph</span><span class="o">.</span><span class="n">PialSurface</span><span class="p">)</span> <span class="k">if</span>
                            <span class="n">graph</span><span class="o">.</span><span class="n">SideInfo</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">leftpialsurface</span> <span class="o">=</span> <span class="p">[</span><span class="n">index</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">graph</span><span class="o">.</span><span class="n">PialSurface</span><span class="p">)</span> <span class="k">if</span>
                           <span class="n">graph</span><span class="o">.</span><span class="n">SideInfo</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span>

        <span class="c1"># [cow, - , &quot;R. ACA, A2&quot;, &quot;R. MCA&quot;, &quot;L. MCA&quot;, &quot;L. ACA, A2&quot;, &quot;R. PCA, P2&quot;, &quot;L. PCA, P2&quot;]</span>
        <span class="n">leftvessels</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">]</span>
        <span class="n">rightvessels</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">]</span>

        <span class="n">leftnodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">index</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">majornodes</span><span class="p">)</span> <span class="k">if</span> <span class="n">majornodesID</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="ow">in</span> <span class="n">leftvessels</span><span class="p">]</span>
        <span class="n">rightnodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">index</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">majornodes</span><span class="p">)</span> <span class="k">if</span> <span class="n">majornodesID</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="ow">in</span> <span class="n">rightvessels</span><span class="p">]</span>

        <span class="n">sys</span><span class="o">.</span><span class="n">setrecursionlimit</span><span class="p">(</span><span class="mi">10000</span><span class="p">)</span>
        <span class="n">KDTreeleft</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">spatial</span><span class="o">.</span><span class="n">KDTree</span><span class="p">([</span><span class="n">majornodes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">leftnodes</span><span class="p">])</span>
        <span class="n">KDTreeright</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">spatial</span><span class="o">.</span><span class="n">KDTree</span><span class="p">([</span><span class="n">majornodes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">rightnodes</span><span class="p">])</span>

        <span class="n">meshcolour</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">graph</span><span class="o">.</span><span class="n">PialSurface</span><span class="p">]</span>

        <span class="n">MinDistanceR</span><span class="p">,</span> <span class="n">MinDistanceIndexR</span> <span class="o">=</span> <span class="n">KDTreeright</span><span class="o">.</span><span class="n">query</span><span class="p">([</span><span class="n">graph</span><span class="o">.</span><span class="n">PialSurface</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">rightpialsurface</span><span class="p">],</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">MinDistanceL</span><span class="p">,</span> <span class="n">MinDistanceIndexL</span> <span class="o">=</span> <span class="n">KDTreeleft</span><span class="o">.</span><span class="n">query</span><span class="p">([</span><span class="n">graph</span><span class="o">.</span><span class="n">PialSurface</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">leftpialsurface</span><span class="p">],</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">nodeindex</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rightpialsurface</span><span class="p">):</span>
            <span class="n">meshcolour</span><span class="p">[</span><span class="n">nodeindex</span><span class="p">]</span> <span class="o">=</span> <span class="n">majornodesID</span><span class="p">[</span><span class="n">rightnodes</span><span class="p">[</span><span class="n">MinDistanceIndexR</span><span class="p">[</span><span class="n">index</span><span class="p">]]]</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">nodeindex</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">leftpialsurface</span><span class="p">):</span>
            <span class="n">meshcolour</span><span class="p">[</span><span class="n">nodeindex</span><span class="p">]</span> <span class="o">=</span> <span class="n">majornodesID</span><span class="p">[</span><span class="n">leftnodes</span><span class="p">[</span><span class="n">MinDistanceIndexL</span><span class="p">[</span><span class="n">index</span><span class="p">]]]</span>

        <span class="n">graph</span><span class="o">.</span><span class="n">MajorVesselID</span> <span class="o">=</span> <span class="n">meshcolour</span>

    <span class="k">def</span> <span class="nf">MajorArteriesToPialSurfaceOutlets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">graph</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Mapping the surface to the nearest major artery.&quot;</span><span class="p">)</span>
        <span class="c1"># map to nearest node</span>
        <span class="c1"># colour based on nearest outlet node.</span>
        <span class="n">majornodes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">majornodesID</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">OutletNodes</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">Position</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">))</span> <span class="ow">and</span> <span class="n">node</span><span class="o">.</span><span class="n">MajorVesselID</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">majornodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">Position</span><span class="p">)</span>
                <span class="n">majornodesID</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">MajorVesselID</span><span class="p">)</span>

        <span class="c1"># left and right sides of the pial surface</span>
        <span class="n">rightpialsurface</span> <span class="o">=</span> <span class="p">[</span><span class="n">index</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">graph</span><span class="o">.</span><span class="n">PialSurface</span><span class="p">)</span> <span class="k">if</span>
                            <span class="n">graph</span><span class="o">.</span><span class="n">SideInfo</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">leftpialsurface</span> <span class="o">=</span> <span class="p">[</span><span class="n">index</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">graph</span><span class="o">.</span><span class="n">PialSurface</span><span class="p">)</span> <span class="k">if</span>
                           <span class="n">graph</span><span class="o">.</span><span class="n">SideInfo</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span>

        <span class="c1"># [cow, - , &quot;R. ACA, A2&quot;, &quot;R. MCA&quot;, &quot;L. MCA&quot;, &quot;L. ACA, A2&quot;, &quot;R. PCA, P2&quot;, &quot;L. PCA, P2&quot;]</span>
        <span class="n">leftvessels</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">]</span>
        <span class="n">rightvessels</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">]</span>

        <span class="n">leftnodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">index</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">majornodes</span><span class="p">)</span> <span class="k">if</span> <span class="n">majornodesID</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="ow">in</span> <span class="n">leftvessels</span><span class="p">]</span>
        <span class="n">rightnodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">index</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">majornodes</span><span class="p">)</span> <span class="k">if</span> <span class="n">majornodesID</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="ow">in</span> <span class="n">rightvessels</span><span class="p">]</span>

        <span class="n">sys</span><span class="o">.</span><span class="n">setrecursionlimit</span><span class="p">(</span><span class="mi">10000</span><span class="p">)</span>
        <span class="n">KDTreeleft</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">spatial</span><span class="o">.</span><span class="n">KDTree</span><span class="p">([</span><span class="n">majornodes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">leftnodes</span><span class="p">])</span>
        <span class="n">KDTreeright</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">spatial</span><span class="o">.</span><span class="n">KDTree</span><span class="p">([</span><span class="n">majornodes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">rightnodes</span><span class="p">])</span>

        <span class="n">meshcolour</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">graph</span><span class="o">.</span><span class="n">PialSurface</span><span class="p">]</span>

        <span class="n">MinDistanceR</span><span class="p">,</span> <span class="n">MinDistanceIndexR</span> <span class="o">=</span> <span class="n">KDTreeright</span><span class="o">.</span><span class="n">query</span><span class="p">([</span><span class="n">graph</span><span class="o">.</span><span class="n">PialSurface</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">rightpialsurface</span><span class="p">],</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">MinDistanceL</span><span class="p">,</span> <span class="n">MinDistanceIndexL</span> <span class="o">=</span> <span class="n">KDTreeleft</span><span class="o">.</span><span class="n">query</span><span class="p">([</span><span class="n">graph</span><span class="o">.</span><span class="n">PialSurface</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">leftpialsurface</span><span class="p">],</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">nodeindex</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rightpialsurface</span><span class="p">):</span>
            <span class="n">meshcolour</span><span class="p">[</span><span class="n">nodeindex</span><span class="p">]</span> <span class="o">=</span> <span class="n">majornodesID</span><span class="p">[</span><span class="n">rightnodes</span><span class="p">[</span><span class="n">MinDistanceIndexR</span><span class="p">[</span><span class="n">index</span><span class="p">]]]</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">nodeindex</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">leftpialsurface</span><span class="p">):</span>
            <span class="n">meshcolour</span><span class="p">[</span><span class="n">nodeindex</span><span class="p">]</span> <span class="o">=</span> <span class="n">majornodesID</span><span class="p">[</span><span class="n">leftnodes</span><span class="p">[</span><span class="n">MinDistanceIndexL</span><span class="p">[</span><span class="n">index</span><span class="p">]]]</span>

        <span class="n">graph</span><span class="o">.</span><span class="n">MajorVesselID</span> <span class="o">=</span> <span class="n">meshcolour</span>

    <span class="k">def</span> <span class="nf">WriteRegionMapping</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s2">&quot;RegionMap.csv&quot;</span><span class="p">):</span>
        <span class="n">file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">ModellingFolder</span> <span class="o">+</span> <span class="n">filename</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Writing the mapping per region to file: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">file</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;NodeID,MajorVesselID</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Nodes</span><span class="p">):</span>
                <span class="n">regionid</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">MajorVesselID</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">Number</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">regionid</span><span class="p">))</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">LoadRegionMapping</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s2">&quot;RegionMap.csv&quot;</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Loading region map&quot;</span><span class="p">)</span>
        <span class="n">file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">ModellingFolder</span> <span class="o">+</span> <span class="n">filename</span>
        <span class="n">regiondata</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">)]</span>
        <span class="n">regiondict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">nodedata</span> <span class="ow">in</span> <span class="n">regiondata</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="n">regiondict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">nodedata</span><span class="p">[</span><span class="mi">0</span><span class="p">])]]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">nodedata</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">nodedata</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span><span class="o">.</span><span class="n">MajorVesselID</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">nodedata</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Perfusion</span><span class="o">.</span><span class="n">MajorArteries</span> <span class="o">=</span> <span class="n">regiondict</span>

    <span class="k">def</span> <span class="nf">Initiate1DSteadyStateModel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Initiating steady state model.&quot;</span><span class="p">)</span>
        <span class="n">referencepressure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PatientData</span><span class="p">[</span><span class="s2">&quot;DiastolePressure&quot;</span><span class="p">]</span>
        <span class="c1"># outpressure = self.ModelParameters[&quot;OUT_PRESSURE&quot;]</span>
        <span class="n">outpressure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PatientData</span><span class="p">[</span><span class="s2">&quot;MeanRightAtrialPressure&quot;</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">inlet</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">InletNodes</span><span class="p">:</span>
            <span class="n">inlet</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">InletFlowRate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PatientData</span><span class="p">[</span><span class="s2">&quot;StrokeVolume&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">PatientData</span><span class="p">[</span><span class="s2">&quot;HeartRate&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">60</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e-6</span>
            <span class="n">inlet</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">InletPressure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PatientData</span><span class="p">[</span><span class="s2">&quot;SystolePressure&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">PatientData</span><span class="p">[</span>
                <span class="s2">&quot;DiastolePressure&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Nodes</span><span class="p">:</span>
            <span class="n">node</span><span class="o">.</span><span class="n">RefRadius</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">Radius</span><span class="p">)</span>
            <span class="n">node</span><span class="o">.</span><span class="n">RefPressure</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">referencepressure</span><span class="p">)</span>
            <span class="n">node</span><span class="o">.</span><span class="n">SetPressureAreaEquation</span><span class="p">()</span>
            <span class="n">node</span><span class="o">.</span><span class="n">Pressure</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">node</span><span class="o">.</span><span class="n">FlowRate</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">node</span><span class="o">.</span><span class="n">Velocity</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Set pressure at the outlets (without windkessel)</span>
        <span class="k">for</span> <span class="n">outlet</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">OutletNodes</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">outlet</span><span class="o">.</span><span class="n">R1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">outlet</span><span class="o">.</span><span class="n">OutPressure</span> <span class="o">=</span> <span class="n">outlet</span><span class="o">.</span><span class="n">InputPressure</span>  <span class="c1"># set pressure here per outlet</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">outlet</span><span class="o">.</span><span class="n">OutPressure</span> <span class="o">=</span> <span class="n">outpressure</span>
            <span class="n">outlet</span><span class="o">.</span><span class="n">OutletFlowRate</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">Solve1DSteadyState</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">clotactive</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">PressureInlets</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">coarseCollaterals</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                           <span class="n">FlowRateOutlets</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">frictionconstant</span><span class="o">=</span><span class="mi">22</span><span class="p">):</span>
        <span class="n">visc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ModelParameters</span><span class="p">[</span><span class="s2">&quot;BLOOD_VISC&quot;</span><span class="p">]</span>

        <span class="n">matrix</span><span class="p">,</span> <span class="n">inputvector</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">edges</span><span class="p">,</span> <span class="n">mapping</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Get1DsteadyNetwork</span><span class="p">(</span><span class="n">visc</span><span class="p">,</span> <span class="n">clotactive</span><span class="p">,</span> <span class="n">PressureInlets</span><span class="p">,</span>
                                                                                      <span class="n">coarseCollaterals</span><span class="p">,</span>
                                                                                      <span class="n">FlowRateOutlets</span><span class="p">,</span> <span class="n">frictionconstant</span><span class="p">)</span>
        <span class="n">oldnodes1</span><span class="p">,</span> <span class="n">oldnodes2</span> <span class="o">=</span> <span class="n">mapping</span>

        <span class="c1"># solve system</span>
        <span class="c1"># solution = scipy.linalg.solve(matrix.todense(), inputvector)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Solving system of size: </span><span class="si">{</span><span class="n">matrix</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">solve</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">factorized</span><span class="p">(</span><span class="n">matrix</span><span class="p">)</span>
        <span class="n">solution</span> <span class="o">=</span> <span class="n">solve</span><span class="p">(</span><span class="n">inputvector</span><span class="p">)</span>
        <span class="c1"># solution = spsolve(matrix, inputvector) # without pre-conditioning</span>
        <span class="c1"># print(f&quot;Condition number: {numpy.linalg.cond(matrix)}&quot;)</span>
        <span class="c1"># print(info)</span>
        <span class="c1"># set pressure to all nodes</span>
        <span class="c1"># clotnodes = [node for clot in self.Topology.Clots for node in clot[0]]</span>
        <span class="c1">#</span>
        <span class="c1"># for node in clotnodes:  # internal clot nodes are not part of the solution from the solver.</span>
        <span class="c1">#     node.Pressure = 0</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">nodes</span><span class="p">)):</span>
            <span class="n">nodes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">Pressure</span> <span class="o">=</span> <span class="n">solution</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">bif</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">BifurcationNodes</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">bif</span><span class="o">.</span><span class="n">Connections</span><span class="p">:</span>
                <span class="n">node</span><span class="o">.</span><span class="n">Pressure</span> <span class="o">=</span> <span class="n">bif</span><span class="o">.</span><span class="n">Pressure</span>

        <span class="c1"># update edges to include the dublicate ends again.</span>
        <span class="k">for</span> <span class="n">replace</span> <span class="ow">in</span> <span class="n">oldnodes1</span><span class="p">:</span>
            <span class="n">edges</span><span class="p">[</span><span class="n">replace</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">replace</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">replace</span> <span class="ow">in</span> <span class="n">oldnodes2</span><span class="p">:</span>
            <span class="n">edges</span><span class="p">[</span><span class="n">replace</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">replace</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># note that the collateral vessels alter the flow rates at the outlets.</span>
        <span class="c1"># the outlet flow rates therefore have to be summed over all connections</span>
        <span class="c1"># (should be zero for any bifurcation and internal vessel node)</span>
        <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">edges</span><span class="p">:</span>
            <span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">AccumulatedFlowRate</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">AccumulatedFlowRate</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">edges</span><span class="p">:</span>
            <span class="n">dp</span> <span class="o">=</span> <span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Pressure</span> <span class="o">-</span> <span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">Pressure</span>
            <span class="n">flowrate</span> <span class="o">=</span> <span class="n">dp</span> <span class="o">*</span> <span class="n">edge</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e6</span>
            <span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">FlowRate</span> <span class="o">=</span> <span class="n">flowrate</span>
            <span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">FlowRate</span> <span class="o">=</span> <span class="n">flowrate</span>
            <span class="n">radius</span> <span class="o">=</span> <span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Radius</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">Radius</span>
            <span class="n">velocity</span> <span class="o">=</span> <span class="n">flowrate</span> <span class="o">/</span> <span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">radius</span> <span class="o">*</span> <span class="n">radius</span><span class="p">)</span>
            <span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Velocity</span> <span class="o">=</span> <span class="n">velocity</span>
            <span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">Velocity</span> <span class="o">=</span> <span class="n">velocity</span>
            <span class="c1"># accumulated flow</span>
            <span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">AccumulatedFlowRate</span> <span class="o">-=</span> <span class="n">flowrate</span>
            <span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">AccumulatedFlowRate</span> <span class="o">+=</span> <span class="n">flowrate</span>

        <span class="k">if</span> <span class="n">clotactive</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">clot</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Clots</span><span class="p">:</span>
                <span class="n">clotnodes</span> <span class="o">=</span> <span class="n">clot</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">porocity</span> <span class="o">=</span> <span class="n">clot</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">clotnode</span> <span class="ow">in</span> <span class="n">clotnodes</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">porocity</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">clotnode</span><span class="o">.</span><span class="n">Velocity</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># effective area</span>
                        <span class="n">area</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">clotnode</span><span class="o">.</span><span class="n">RefRadius</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">pi</span>
                        <span class="n">clotnode</span><span class="o">.</span><span class="n">Velocity</span> <span class="o">=</span> <span class="n">clotnode</span><span class="o">.</span><span class="n">FlowRate</span> <span class="o">/</span> <span class="p">(</span><span class="n">area</span><span class="o">*</span><span class="n">porocity</span><span class="p">)</span>

            <span class="c1"># for edge in edges:</span>
            <span class="c1">#     if (edge[0] in clotnodes) and (edge[1] in clotnodes):</span>
            <span class="c1">#         if porocity == 0:</span>
            <span class="c1">#             edge[0].Velocity = 0</span>
            <span class="c1">#             edge[1].Velocity = 0</span>
            <span class="c1">#         else:</span>
            <span class="c1">#             edge[0].Velocity = edge[0].FlowRate/porocity</span>
            <span class="c1">#             edge[1].Velocity = edge[0].FlowRate/porocity</span>

        <span class="c1"># define flow rate at the outlet as the accumulation of flow (source term)</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">OutletNodes</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">R1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">node</span><span class="o">.</span><span class="n">FlowRate</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">WKNode</span><span class="o">.</span><span class="n">AccumulatedFlowRate</span>

        <span class="c1"># calculate new radius</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Nodes</span><span class="p">:</span>
            <span class="n">node</span><span class="o">.</span><span class="n">UpdateRadius</span><span class="p">()</span>
            <span class="c1"># vessel.CalculateMeanRadius()</span>

        <span class="n">solution</span> <span class="o">=</span> <span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">Pressure</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Nodes</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">solution</span>

    <span class="k">def</span> <span class="nf">Solve1DSteadyStateNonLinear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">visc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ModelParameters</span><span class="p">[</span><span class="s2">&quot;BLOOD_VISC&quot;</span><span class="p">]</span>

        <span class="n">solution</span><span class="p">,</span> <span class="n">nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">nonlinearmodel</span><span class="p">(</span><span class="n">visc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ModelParameters</span><span class="p">[</span><span class="s2">&quot;Density&quot;</span><span class="p">])</span>

        <span class="c1"># solve system</span>
        <span class="c1"># solution = scipy.linalg.solve(matrix.todense(), inputvector)</span>
        <span class="c1"># solved = numpy.allclose(matrix.dot(solution), inputvector)</span>

        <span class="c1"># set pressure to all nodes</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">nodes</span><span class="p">)):</span>
            <span class="n">nodes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">Pressure</span> <span class="o">=</span> <span class="n">solution</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="c1"># for bif in self.Topology.BifurcationNodes:</span>
        <span class="c1">#     for node in bif.Connections:</span>
        <span class="c1">#         node.Pressure = bif.Pressure</span>

        <span class="c1"># calculate new radius</span>
        <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Vessels</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">:</span>
                <span class="n">node</span><span class="o">.</span><span class="n">UpdateRadius</span><span class="p">()</span>
            <span class="n">vessel</span><span class="o">.</span><span class="n">CalculateMeanRadius</span><span class="p">()</span>

        <span class="n">solution</span> <span class="o">=</span> <span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">Pressure</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Nodes</span><span class="p">]</span>
        <span class="c1"># self.Topology.nonlinearmodel(visc, self.ModelParameters[&quot;Density&quot;])</span>
        <span class="k">return</span> <span class="n">solution</span>

    <span class="k">def</span> <span class="nf">UpdateOutletResistanceToPialSurface</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">PialSurfacePressure</span><span class="o">=</span><span class="mi">9000</span><span class="p">):</span>
        <span class="c1"># todo update  to include C and R2 for pulsatile simulations</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">cp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Perfusion</span><span class="o">.</span><span class="n">CouplingPoints</span><span class="p">):</span>
            <span class="n">newresistancetotal</span> <span class="o">=</span> <span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">Node</span><span class="o">.</span><span class="n">Pressure</span> <span class="o">-</span> <span class="n">PialSurfacePressure</span><span class="p">[</span><span class="n">index</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">Node</span><span class="o">.</span><span class="n">FlowRate</span> <span class="o">*</span> <span class="mf">1e-6</span><span class="p">)</span>
            <span class="n">cp</span><span class="o">.</span><span class="n">Node</span><span class="o">.</span><span class="n">R1</span> <span class="o">=</span> <span class="n">newresistancetotal</span>  <span class="c1"># - cp.Node.R1</span>
            <span class="n">cp</span><span class="o">.</span><span class="n">Node</span><span class="o">.</span><span class="n">R2</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Resistance: </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">newresistancetotal</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">newresistancetotal</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># for index, cp in enumerate(self.Perfusion.CouplingPoints):</span>
                <span class="c1">#     print(&quot;1D model: %f - Perfusion model: %f\n&quot; % (cp.Node.Pressure, PialSurfacePressure[index]))</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Error: Negative resistance. Pial surface pressure is higher than the arterial pressure.&quot;</span><span class="p">)</span>
            <span class="c1"># if cp.Node.R2 &lt; 0:</span>
            <span class="c1">#     cp.Node.R2 = 0</span>
            <span class="c1"># cp.Node.R1 = newresistancetotal - cp.Node.R2</span>
            <span class="c1"># print(&quot;Error: R2&lt;0. Setting R2 to 0.1e9 and updating R1.&quot;)</span>
            <span class="n">cp</span><span class="o">.</span><span class="n">Node</span><span class="o">.</span><span class="n">OutPressure</span> <span class="o">=</span> <span class="n">PialSurfacePressure</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>  <span class="c1"># pressure now fixed to this value at this node</span>

    <span class="k">def</span> <span class="nf">UpdatePressureCouplingPoints</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pressures</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the pressure at the coupling points to the perfusion model.</span>
<span class="sd">        :param pressures: (iterable or number) Pressure in pa to be assigned at the coupling point.</span>
<span class="sd">        Order of the pressures given should be in the same order as the coupling points.</span>
<span class="sd">        Coupling point index is equal to the cluster id.</span>
<span class="sd">        :return: Nothing</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">cp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Perfusion</span><span class="o">.</span><span class="n">CouplingPoints</span><span class="p">):</span>
                <span class="c1"># cp.Node.R1 = None  # remove wk elements</span>
                <span class="n">cp</span><span class="o">.</span><span class="n">Node</span><span class="o">.</span><span class="n">OutPressure</span> <span class="o">=</span> <span class="n">pressures</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>  <span class="c1"># pressure now fixed to this value at this node</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">cp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Perfusion</span><span class="o">.</span><span class="n">CouplingPoints</span><span class="p">):</span>
                <span class="c1"># cp.Node.R1 = None  # remove wk elements</span>
                <span class="n">cp</span><span class="o">.</span><span class="n">Node</span><span class="o">.</span><span class="n">OutPressure</span> <span class="o">=</span> <span class="n">pressures</span>  <span class="c1"># pressure now fixed to this value at this node</span>

    <span class="k">def</span> <span class="nf">UpdateFlowRateCouplingPoints</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flowrates</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the flowrate at the coupling points to the perfusion model.</span>
<span class="sd">        :param flowrates: (iterable or number) Flow rate in mL/s to be assigned at the coupling point.</span>
<span class="sd">        Order of the flowrate given should be in the same order as the coupling points.</span>
<span class="sd">        Coupling point index is equal to the cluster id.</span>
<span class="sd">        :return: Nothing</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">cp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Perfusion</span><span class="o">.</span><span class="n">CouplingPoints</span><span class="p">):</span>
                <span class="c1"># cp.Node.R1 = None  # remove wk elements</span>
                <span class="n">cp</span><span class="o">.</span><span class="n">Node</span><span class="o">.</span><span class="n">OutletFlowRate</span> <span class="o">=</span> <span class="n">flowrates</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>  <span class="c1"># flowrate now fixed to this value at this node</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">cp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Perfusion</span><span class="o">.</span><span class="n">CouplingPoints</span><span class="p">):</span>
                <span class="c1"># cp.Node.R1 = None  # remove wk elements</span>
                <span class="n">cp</span><span class="o">.</span><span class="n">Node</span><span class="o">.</span><span class="n">OutletFlowRate</span> <span class="o">=</span> <span class="n">flowrates</span>  <span class="c1"># flowrate now fixed to this value at this node</span>

    <span class="k">def</span> <span class="nf">Run1DSteadyStateModel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="s2">&quot;Linear&quot;</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-10</span><span class="p">,</span> <span class="n">clotactive</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">PressureInlets</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                              <span class="n">coarseCollaterals</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">FlowRateOutlets</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">frictionconstant</span><span class="o">=</span><span class="mi">22</span><span class="p">,</span>
                              <span class="n">scale_resistance</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">clotactive</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Solving steady state: stroke scenario.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Solving steady state: healthy scenario.&quot;</span><span class="p">)</span>
        <span class="c1"># initialise all values</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="n">solutionold</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Solve1DSteadyState</span><span class="p">(</span><span class="n">clotactive</span><span class="p">,</span> <span class="n">PressureInlets</span><span class="p">,</span> <span class="n">coarseCollaterals</span><span class="p">,</span>
                                              <span class="n">FlowRateOutlets</span><span class="p">,</span> <span class="n">frictionconstant</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">model</span> <span class="o">==</span> <span class="s2">&quot;NonLinear&quot;</span><span class="p">:</span>
            <span class="n">solutionold</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Solve1DSteadyStateNonLinear</span><span class="p">()</span>
        <span class="c1"># iterate system again</span>
        <span class="nb">iter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">model</span> <span class="o">==</span> <span class="s2">&quot;Linear&quot;</span><span class="p">:</span>
                <span class="n">solutionnew</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Solve1DSteadyState</span><span class="p">(</span><span class="n">clotactive</span><span class="p">,</span> <span class="n">PressureInlets</span><span class="p">,</span> <span class="n">coarseCollaterals</span><span class="p">,</span>
                                                      <span class="n">FlowRateOutlets</span><span class="p">,</span> <span class="n">frictionconstant</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">model</span> <span class="o">==</span> <span class="s2">&quot;NonLinear&quot;</span><span class="p">:</span>
                <span class="n">solutionnew</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Solve1DSteadyStateNonLinear</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Please specify if model is Linear or NonLinear.&quot;</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="c1"># scale resistances to get both proper flow and pressure at the inlet</span>
            <span class="k">if</span> <span class="n">scale_resistance</span><span class="p">:</span>
                <span class="n">pressure_diff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">InletNodes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Pressure</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">InletNodes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">InletPressure</span>
                <span class="n">flow_rate_diff</span> <span class="o">=</span> <span class="mf">1e-6</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">InletNodes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">FlowRate</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">InletNodes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">InletFlowRate</span>
                <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">pressure_diff</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1e-6</span> <span class="ow">or</span> <span class="nb">abs</span><span class="p">(</span><span class="n">flow_rate_diff</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1e-6</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Detected a difference in inlet boundary conditions, scaling outlet resistance.&quot;</span><span class="p">)</span>
                    <span class="c1"># print(self.Topology.InletNodes[0][0].Pressure)</span>
                    <span class="c1"># print(self.Topology.InletNodes[0][0].InletPressure)</span>
                    <span class="c1"># print(1e-6 * self.Topology.InletNodes[0][0].FlowRate)</span>
                    <span class="c1"># print(self.Topology.InletNodes[0][0].InletFlowRate)</span>

                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Pressure ratio:</span><span class="si">{</span><span class="n">pressure_diff</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Flow Rate ratio:</span><span class="si">{</span><span class="n">flow_rate_diff</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">OutletNodes</span><span class="p">:</span>
                        <span class="c1"># print(node.R2)</span>
                        <span class="c1"># total resistance of the outlet needs to change, but R1 is constant</span>
                        <span class="c1"># scale R2 to compensate, (r1+r2)*p = r1+r2*F</span>
                        <span class="c1"># assumption is also that either pressure or flow rate diff is equal to one already</span>
                        <span class="n">fraction</span> <span class="o">=</span> <span class="p">((</span><span class="n">node</span><span class="o">.</span><span class="n">R1</span><span class="o">+</span><span class="n">node</span><span class="o">.</span><span class="n">R2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">pressure_diff</span><span class="o">*</span><span class="mi">1</span><span class="o">/</span><span class="n">flow_rate_diff</span><span class="p">)</span><span class="o">-</span><span class="n">node</span><span class="o">.</span><span class="n">R1</span><span class="p">)</span><span class="o">/</span><span class="n">node</span><span class="o">.</span><span class="n">R2</span>
                        <span class="n">node</span><span class="o">.</span><span class="n">R2</span> <span class="o">=</span> <span class="n">fraction</span><span class="o">*</span><span class="n">node</span><span class="o">.</span><span class="n">R2</span>
                    <span class="k">continue</span>
            <span class="n">difference</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span>
                <span class="p">[</span><span class="n">solutionold</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">solution</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">solution</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">solutionnew</span><span class="p">)])</span> <span class="o">/</span> <span class="n">numpy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">solutionnew</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Convergence criteria </span><span class="si">%0.12g</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">difference</span><span class="p">)</span>
            <span class="n">solutionold</span> <span class="o">=</span> <span class="n">solutionnew</span>
            <span class="nb">iter</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="k">if</span> <span class="n">difference</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Steady state convergence in </span><span class="si">%d</span><span class="s2"> iterations.&quot;</span> <span class="o">%</span> <span class="nb">iter</span><span class="p">)</span>
                <span class="n">time_elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Time elapsed </span><span class="si">%f</span><span class="s1"> seconds&#39;</span> <span class="o">%</span> <span class="n">time_elapsed</span><span class="p">)</span>
                <span class="k">break</span>

        <span class="c1"># calculate flowrate</span>
        <span class="c1"># visc = self.ModelParameters[&quot;BLOOD_VISC&quot;]</span>
        <span class="c1"># for vessel in self.Topology.Vessels:</span>
        <span class="c1">#     for i in range(1, len(vessel.Nodes)):</span>
        <span class="c1">#         dp = vessel.Nodes[i - 1].Pressure - vessel.Nodes[i].Pressure</span>
        <span class="c1">#         flowrate = dp * self.Topology.SegmentConductance(vessel.Nodes[i - 1], vessel.Nodes[i],</span>
        <span class="c1">#                                                          visc) * 1e6</span>
        <span class="c1">#         vessel.Nodes[i - 1].FlowRate = flowrate</span>
        <span class="c1">#         vessel.Nodes[i - 1].Velocity = flowrate / (</span>
        <span class="c1">#                 scipy.pi * vessel.Nodes[i - 1].Radius * vessel.Nodes[i - 1].Radius)</span>

        <span class="c1"># # vessel ends</span>
        <span class="c1"># for vessel in self.Topology.Vessels:</span>
        <span class="c1">#     dp = vessel.Nodes[-2].Pressure - vessel.Nodes[-1].Pressure</span>
        <span class="c1">#     flowrate = dp * self.Topology.SegmentConductance(vessel.Nodes[-1], vessel.Nodes[-2],</span>
        <span class="c1">#                                                      visc) * 1e6</span>
        <span class="c1">#     vessel.Nodes[- 1].FlowRate = flowrate</span>
        <span class="c1">#     vessel.Nodes[- 1].Velocity = flowrate / (</span>
        <span class="c1">#             scipy.pi * vessel.Nodes[- 1].Radius * vessel.Nodes[- 1].Radius)</span>
        <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Vessels</span><span class="p">:</span>
            <span class="n">vessel</span><span class="o">.</span><span class="n">CalculateMeanRadius</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">bif</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">BifurcationNodes</span><span class="p">:</span>
            <span class="n">bif</span><span class="o">.</span><span class="n">Pressure</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">node</span><span class="o">.</span><span class="n">Pressure</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">bif</span><span class="o">.</span><span class="n">Connections</span><span class="p">)])</span>
            <span class="n">bif</span><span class="o">.</span><span class="n">FlowRate</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># numpy.mean([node.FlowRate for node in list(bif.Connections)])</span>
            <span class="n">bif</span><span class="o">.</span><span class="n">Velocity</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># numpy.mean([node.Velocity for node in list(bif.Connections)])</span>

        <span class="k">if</span> <span class="n">coarseCollaterals</span><span class="p">:</span>
            <span class="n">totalflowrate</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Collaterals</span><span class="p">:</span>
                <span class="n">dp</span> <span class="o">=</span> <span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Pressure</span> <span class="o">-</span> <span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">Pressure</span>
                <span class="n">totalflowrate</span> <span class="o">+=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">dp</span> <span class="o">*</span> <span class="n">edge</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e6</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Total Collateral flow: </span><span class="si">{</span><span class="n">totalflowrate</span><span class="si">}</span><span class="s2"> mL/s&quot;</span><span class="p">)</span>
        <span class="c1"># for node in self.Topology.OutletNodes:</span>
        <span class="c1">#     print(node.WKNode.AccumulatedFlowRate)</span>
        <span class="c1"># totaloutflow = sum([node.WKNode.AccumulatedFlowRate for node in self.Topology.OutletNodes])</span>
        <span class="c1"># print(f&quot;Total outflow: {totaloutflow}&quot;)</span>

    <span class="k">def</span> <span class="nf">Results1DSteadyStateModel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># export to results</span>
        <span class="c1"># we get mean results per node by definition.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">MeanPressurePerNode</span> <span class="o">=</span> <span class="p">[[</span><span class="n">node</span><span class="o">.</span><span class="n">Pressure</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Nodes</span><span class="p">]]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">MeanVelocityPerNode</span> <span class="o">=</span> <span class="p">[[</span><span class="n">node</span><span class="o">.</span><span class="n">Velocity</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Nodes</span><span class="p">]]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">MeanVolumeFlowRatePerNode</span> <span class="o">=</span> <span class="p">[[</span><span class="n">node</span><span class="o">.</span><span class="n">FlowRate</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Nodes</span><span class="p">]]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">MeanRadiusPerNode</span> <span class="o">=</span> <span class="p">[[</span><span class="n">node</span><span class="o">.</span><span class="n">Radius</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Nodes</span><span class="p">]]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">PulsatilityIndexPressure</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Nodes</span><span class="p">]]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">PulsatilityIndexVelocity</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Nodes</span><span class="p">]]</span>

        <span class="n">vesselnames</span> <span class="o">=</span> <span class="p">[</span><span class="n">vessel</span><span class="o">.</span><span class="n">Name</span> <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Vessels</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">MeanResults</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">vesselnodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span> <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Vessels</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">vesselnodes</span><span class="p">):</span>
            <span class="n">meanvalues</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">CalculateMeanVessel</span><span class="p">(</span><span class="n">vessel</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">MeanResults</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">vesselnames</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">meanvalues</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">Export1DSteadyClusterFlowRate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="s2">&quot;ClusterFlowData.csv&quot;</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">ModellingFolder</span> <span class="o">+</span> <span class="n">file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Cluster ID,Flow rate over the region(mL/s),number of triangles,Pressure(Pa)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">cp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Perfusion</span><span class="o">.</span><span class="n">CouplingPoints</span><span class="p">):</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">,</span><span class="si">%.10f</span><span class="s2">,</span><span class="si">%d</span><span class="s2">,</span><span class="si">%.10f</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">cp</span><span class="o">.</span><span class="n">Node</span><span class="o">.</span><span class="n">FlowRate</span><span class="p">,</span> <span class="n">cp</span><span class="o">.</span><span class="n">NumberOfTriangles</span><span class="p">,</span> <span class="n">cp</span><span class="o">.</span><span class="n">Node</span><span class="o">.</span><span class="n">Pressure</span><span class="p">))</span>
    
    <span class="k">def</span> <span class="nf">ExportClotBFValues</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="s2">&quot;BFClotValues.csv&quot;</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">ModellingFolder</span> <span class="o">+</span> <span class="n">file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Clot index,Flow rate(mL/s),Pressure drop(Pa),Proximal pressure (Pa),Distal pressure (Pa),Pressure ratio</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">clot</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Clots</span><span class="p">):</span>
                <span class="n">node1</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">clot</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="n">item</span><span class="o">.</span><span class="n">Number</span><span class="p">)</span>
                <span class="n">node2</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">clot</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="n">item</span><span class="o">.</span><span class="n">Number</span><span class="p">)</span>
                <span class="n">proximal_pressure</span> <span class="o">=</span> <span class="n">node1</span><span class="o">.</span><span class="n">Pressure</span>
                <span class="n">distal_pressure</span> <span class="o">=</span> <span class="n">node2</span><span class="o">.</span><span class="n">Pressure</span>
                <span class="n">pressure_drop</span> <span class="o">=</span> <span class="n">proximal_pressure</span> <span class="o">-</span> <span class="n">distal_pressure</span>
                <span class="n">pressure_ratio</span> <span class="o">=</span> <span class="n">distal_pressure</span><span class="o">/</span><span class="n">proximal_pressure</span>
                <span class="n">flow_rate</span> <span class="o">=</span> <span class="n">node1</span><span class="o">.</span><span class="n">FlowRate</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">,</span><span class="si">%.10f</span><span class="s2">,</span><span class="si">%.10f</span><span class="s2">,</span><span class="si">%.10f</span><span class="s2">,</span><span class="si">%.10f</span><span class="s2">,</span><span class="si">%.10f</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">flow_rate</span><span class="p">,</span> <span class="n">pressure_drop</span><span class="p">,</span> <span class="n">proximal_pressure</span><span class="p">,</span>
                                                                <span class="n">distal_pressure</span><span class="p">,</span> <span class="n">pressure_ratio</span><span class="p">))</span>
</pre></div>

        </details>

    

                            <div id="Patient.__init__" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Patient.__init__">#&nbsp;&nbsp</a>

        
            <span class="name">Patient</span><span class="signature">(folder=&#39;/home/raymond/anaconda3/envs/1d-blood-flow/bin&#39;)</span>
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">folder</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]))):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initiate the patient object with default values.</span>
<span class="sd">        :param folder: path to the main folder.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">folder</span> <span class="o">=</span> <span class="n">folder</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Folders</span> <span class="o">=</span> <span class="n">Metadata</span><span class="o">.</span><span class="n">Folders</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ModelParameters</span> <span class="o">=</span> <span class="n">Metadata</span><span class="o">.</span><span class="n">ModelParameter</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">PatientData</span> <span class="o">=</span> <span class="n">Metadata</span><span class="o">.</span><span class="n">PatientData</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span> <span class="o">=</span> <span class="n">Topology</span><span class="o">.</span><span class="n">Topology</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Results</span> <span class="o">=</span> <span class="n">Results</span><span class="o">.</span><span class="n">Results</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Perfusion</span> <span class="o">=</span> <span class="n">Perfusion</span><span class="o">.</span><span class="n">Perfusion</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">Trees</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Patient folder: &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">PatientFolder</span><span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><p>Initiate the patient object with default values.
:param folder: path to the main folder.</p>
</div>


                            </div>
                            <div id="Patient.pool" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#Patient.pool">#&nbsp;&nbsp</a>

        <span class="name">pool</span><span class="default_value"> = None</span>
    </div>

    

                            </div>
                            <div id="Patient.RedefineDirectionByFlowDirection" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Patient.RedefineDirectionByFlowDirection">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">RedefineDirectionByFlowDirection</span><span class="signature">(self)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">RedefineDirectionByFlowDirection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reverses the order of the nodes in each vessel if the flow inside the vessel is negative.</span>
<span class="sd">        This simple defines the positive flow direction to be the direction of flow.</span>
<span class="sd">        :return: Nothing</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">flowdict</span> <span class="o">=</span> <span class="p">{</span><span class="n">vessel</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">vessel</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">MeanResults</span><span class="p">}</span>

        <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Vessels</span><span class="p">:</span>
            <span class="c1"># get the volumeflowrate</span>
            <span class="n">volumeflowrate</span> <span class="o">=</span> <span class="n">flowdict</span><span class="p">[</span><span class="n">vessel</span><span class="o">.</span><span class="n">Name</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">volumeflowrate</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Vessel Reversed&quot;</span><span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><p>Reverses the order of the nodes in each vessel if the flow inside the vessel is negative.
This simple defines the positive flow direction to be the direction of flow.
:return: Nothing</p>
</div>


                            </div>
                            <div id="Patient.RemoveOldSimFiles" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Patient.RemoveOldSimFiles">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">RemoveOldSimFiles</span><span class="signature">(self)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">RemoveOldSimFiles</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Remove results from previous 1-D blood flow simulations.</span>
<span class="sd">        :return: Nothing</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">folder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">ModellingFolder</span>
        <span class="n">deletelist</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Results.dyn&quot;</span><span class="p">,</span> <span class="s2">&quot;ResultsPrev.dyn&quot;</span><span class="p">,</span> <span class="s2">&quot;ResultsTotal.dyn&quot;</span><span class="p">,</span> <span class="s2">&quot;Convergence.csv&quot;</span><span class="p">,</span> <span class="s2">&quot;Conv.txt&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">deletelist</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">folder</span> <span class="o">+</span> <span class="n">name</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">folder</span> <span class="o">+</span> <span class="n">name</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                    <span class="k">pass</span>
        <span class="n">deletefolder</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;TimeSeries&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">deletefolder</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">folder</span> <span class="o">+</span> <span class="n">name</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                <span class="k">pass</span>
</pre></div>

        </details>

            <div class="docstring"><p>Remove results from previous 1-D blood flow simulations.
:return: Nothing</p>
</div>


                            </div>
                            <div id="Patient.ResetModellingFolder" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Patient.ResetModellingFolder">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">ResetModellingFolder</span><span class="signature">(self)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">ResetModellingFolder</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">folder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">ModellingFolder</span>
        <span class="n">filenames</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">f</span><span class="p">))]</span>
        <span class="n">blacklist</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;boundary_4&amp;21&amp;22&amp;23&amp;24&amp;25&amp;26&amp;30.h5&quot;</span><span class="p">,</span> <span class="s2">&quot;boundary_4&amp;21&amp;22&amp;23&amp;24&amp;25&amp;26&amp;30.ply&quot;</span><span class="p">,</span>
                     <span class="s2">&quot;Boundary.ply&quot;</span><span class="p">,</span> <span class="s2">&quot;labelled_vol_mesh_high.msh&quot;</span><span class="p">,</span> <span class="s2">&quot;labelled_vol_mesh.msh&quot;</span><span class="p">,</span>
                     <span class="s2">&quot;permeability_tensors.h5&quot;</span><span class="p">,</span> <span class="s2">&quot;Model_parameters.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;PialSurface.vtp&quot;</span><span class="p">,</span> <span class="s2">&quot;Distancemat.npy&quot;</span><span class="p">,</span> <span class="s2">&quot;PA.vtp&quot;</span><span class="p">,</span>
                     <span class="s2">&quot;DualPA.vtp&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">filenames</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">blacklist</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">folder</span> <span class="o">+</span> <span class="n">name</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Deleting file: &quot;</span><span class="p">,</span> <span class="n">folder</span> <span class="o">+</span> <span class="n">name</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error while deleting file: &quot;</span><span class="p">,</span> <span class="n">folder</span> <span class="o">+</span> <span class="n">name</span><span class="p">)</span>

        <span class="n">folders</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">f</span><span class="p">))]</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">folders</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">folder</span> <span class="o">+</span> <span class="n">name</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error while deleting file &quot;</span><span class="p">,</span> <span class="n">folder</span> <span class="o">+</span> <span class="n">name</span><span class="p">)</span>

        <span class="c1"># try:</span>
        <span class="c1">#     shutil.rmtree(self.Folders.PatientFolder + &quot;logfile.log&quot;)</span>
        <span class="c1"># except:</span>
        <span class="c1">#     print(&quot;Error while deleting file &quot;, folder + name)</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="Patient.LoadBFSimFiles" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Patient.LoadBFSimFiles">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">LoadBFSimFiles</span><span class="signature">(self)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">LoadBFSimFiles</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">LoadBFSimFiles</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">ModellingFolder</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">LoadPatientData</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">LoadModelParameters</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">LoadRegionMapping</span><span class="p">()</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="Patient.LoadResults" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Patient.LoadResults">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">LoadResults</span><span class="signature">(self, file=&#39;Results.dyn&#39;, correct=True)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">LoadResults</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="s2">&quot;Results.dyn&quot;</span><span class="p">,</span> <span class="n">correct</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">LoadResults</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">ModellingFolder</span> <span class="o">+</span> <span class="n">file</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">correct</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">CorrectforDirectionVectorOutlets</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">CalculateVelocity</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">CalculateMeanResultsPerNode</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">node</span><span class="p">,</span> <span class="n">pressure</span><span class="p">,</span> <span class="n">volumeflowrate</span><span class="p">,</span> <span class="n">velocity</span><span class="p">,</span> <span class="n">radius</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Nodes</span><span class="p">,</span>
                                                                    <span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">Pressure</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                                    <span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">VolumeFlowRate</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                                    <span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">Velocity</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                                    <span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">Radius</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">node</span><span class="o">.</span><span class="n">Pressure</span> <span class="o">=</span> <span class="n">pressure</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">node</span><span class="o">.</span><span class="n">FlowRate</span> <span class="o">=</span> <span class="n">volumeflowrate</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">node</span><span class="o">.</span><span class="n">Velocity</span> <span class="o">=</span> <span class="n">velocity</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">node</span><span class="o">.</span><span class="n">Radius</span> <span class="o">=</span> <span class="n">radius</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="Patient.GetMeanResults" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Patient.GetMeanResults">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">GetMeanResults</span><span class="signature">(self)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">GetMeanResults</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">GetMeanResults</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Vessels</span><span class="p">)</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="Patient.ExportMeanResults" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Patient.ExportMeanResults">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">ExportMeanResults</span><span class="signature">(self, file=&#39;ResultsPerVessel.csv&#39;)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">ExportMeanResults</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="s2">&quot;ResultsPerVessel.csv&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">ExportMeanResults</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">ModellingFolder</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="Patient.LoadPatientData" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Patient.LoadPatientData">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">LoadPatientData</span><span class="signature">(self, file=&#39;config.xml&#39;)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">LoadPatientData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="s2">&quot;config.xml&quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">file</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span> <span class="o">==</span> <span class="s2">&quot;txt&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">PatientData</span><span class="o">.</span><span class="n">LoadPatientData</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">InputFolder</span> <span class="o">+</span> <span class="n">file</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">file</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span> <span class="o">==</span> <span class="s2">&quot;xml&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">PatientData</span><span class="o">.</span><span class="n">LoadPatientDataXML</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">InputFolder</span> <span class="o">+</span> <span class="n">file</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">file</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span> <span class="o">==</span> <span class="s2">&quot;yml&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">PatientData</span><span class="o">.</span><span class="n">LoadPatientDataYML</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">InputFolder</span> <span class="o">+</span> <span class="n">file</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;File open error&quot;</span><span class="p">)</span>
            <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="Patient.LoadClusteringMapping" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Patient.LoadClusteringMapping">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">LoadClusteringMapping</span><span class="signature">(self, file)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">LoadClusteringMapping</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Load Clustering map to file: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">file</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">)][</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">cp</span> <span class="o">=</span> <span class="n">Perfusion</span><span class="o">.</span><span class="n">CouplingPoint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">])])</span>
            <span class="n">cp</span><span class="o">.</span><span class="n">Node</span><span class="o">.</span><span class="n">Position</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)]</span>
            <span class="n">cp</span><span class="o">.</span><span class="n">NumberOfTriangles</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">cp</span><span class="o">.</span><span class="n">Area</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
            <span class="n">cp</span><span class="o">.</span><span class="n">Node</span><span class="o">.</span><span class="n">MajorVesselID</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Perfusion</span><span class="o">.</span><span class="n">CouplingPoints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cp</span><span class="p">)</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="Patient.LoadModelParameters" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Patient.LoadModelParameters">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">LoadModelParameters</span><span class="signature">(self, file=&#39;Model_parameters.txt&#39;)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">LoadModelParameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="s2">&quot;Model_parameters.txt&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ModelParameters</span><span class="o">.</span><span class="n">LoadModelParameters</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">ModellingFolder</span> <span class="o">+</span> <span class="n">file</span><span class="p">)</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="Patient.LoadSegmentedVessels" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Patient.LoadSegmentedVessels">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">LoadSegmentedVessels</span><span class="signature">(self, CoWFile=&#39;1-D_Anatomy.txt&#39;)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">LoadSegmentedVessels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">CoWFile</span><span class="o">=</span><span class="s2">&quot;1-D_Anatomy.txt&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">LoadSegmentedVessels</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">InputFolder</span><span class="p">,</span> <span class="n">CoWFile</span><span class="o">=</span><span class="n">CoWFile</span><span class="p">)</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="Patient.Load1DAnatomy" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Patient.Load1DAnatomy">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">Load1DAnatomy</span><span class="signature">(self, file=&#39;1-D_Anatomy_Patient.txt&#39;)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">Load1DAnatomy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="s2">&quot;1-D_Anatomy_Patient.txt&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Load1DAnatomy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">InputFolder</span> <span class="o">+</span> <span class="n">file</span><span class="p">)</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="Patient.Load3DTopFile" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Patient.Load3DTopFile">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">Load3DTopFile</span><span class="signature">(self, file=&#39;0_2_cutoff.top&#39;)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">Load3DTopFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="s2">&quot;0_2_cutoff.top&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Read3DNodesFromTopFile</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">CheckConnectivity</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">AnatomyToVessels</span><span class="p">()</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="Patient.LoadPositions" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Patient.LoadPositions">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">LoadPositions</span><span class="signature">(self)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">LoadPositions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">vtpfile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">ModellingFolder</span> <span class="o">+</span> <span class="s2">&quot;Topology.vtp&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Loading </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">vtpfile</span><span class="p">)</span>
        <span class="n">reader</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkXMLPolyDataReader</span><span class="p">()</span>
        <span class="n">reader</span><span class="o">.</span><span class="n">SetFileName</span><span class="p">(</span><span class="n">vtpfile</span><span class="p">)</span>
        <span class="n">reader</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span>
        <span class="n">pos_vtk</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">()</span><span class="o">.</span><span class="n">GetPoints</span><span class="p">()</span><span class="o">.</span><span class="n">GetData</span><span class="p">()</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="n">vtk_to_numpy</span><span class="p">(</span><span class="n">pos_vtk</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Nodes</span><span class="p">):</span>
            <span class="n">node</span><span class="o">.</span><span class="n">SetPosition</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="n">index</span><span class="p">]))</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="Patient.ClusteringByRegion" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Patient.ClusteringByRegion">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">ClusteringByRegion</span><span class="signature">(self, dualgraph, method=&#39;&#39;)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">ClusteringByRegion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dualgraph</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Perfusion</span><span class="o">.</span><span class="n">ClusteringByRegion</span><span class="p">(</span><span class="n">dualgraph</span><span class="p">,</span> <span class="n">method</span><span class="p">)</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="Patient.SetFolder" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Patient.SetFolder">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">SetFolder</span><span class="signature">(self, folder)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">SetFolder</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">folder</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">SetPatientFolder</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="Patient.TopologyToVTP" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Patient.TopologyToVTP">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">TopologyToVTP</span><span class="signature">(self, filename=&#39;Topology.vtp&#39;)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">TopologyToVTP</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s2">&quot;Topology.vtp&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">TopologyToVTP</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">ModellingFolder</span> <span class="o">+</span> <span class="n">filename</span><span class="p">)</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="Patient.SaveVesselAtlas" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Patient.SaveVesselAtlas">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">SaveVesselAtlas</span><span class="signature">(self, filename=&#39;Mapping.csv&#39;)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">SaveVesselAtlas</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s2">&quot;Mapping.csv&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">SaveVesselAtlas</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">ModellingFolder</span> <span class="o">+</span> <span class="n">filename</span><span class="p">)</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="Patient.LoadVTPFile" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Patient.LoadVTPFile">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">LoadVTPFile</span><span class="signature">(self, vtpfile)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">LoadVTPFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vtpfile</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">LoadVTPFile</span><span class="p">(</span><span class="n">vtpfile</span><span class="p">)</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="Patient.WriteClusteringMapping" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Patient.WriteClusteringMapping">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">WriteClusteringMapping</span><span class="signature">(self, filename=&#39;Clusters.csv&#39;)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">WriteClusteringMapping</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s2">&quot;Clusters.csv&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Perfusion</span><span class="o">.</span><span class="n">WriteClusteringMapping</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">ModellingFolder</span> <span class="o">+</span> <span class="n">filename</span><span class="p">)</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="Patient.WriteModelParameters" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Patient.WriteModelParameters">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">WriteModelParameters</span><span class="signature">(self)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">WriteModelParameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">ModellingFolder</span> <span class="o">+</span> <span class="s2">&quot;Model_parameters.txt&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Writing the Model parameters to </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">file</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ModelParameters</span><span class="o">.</span><span class="n">WriteModelParameters</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="Patient.CalculateMaximumTimestep" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Patient.CalculateMaximumTimestep">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">CalculateMaximumTimestep</span><span class="signature">(self)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">CalculateMaximumTimestep</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">timestep</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">CalculateMaximumTimestep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ModelParameters</span><span class="p">[</span><span class="s2">&quot;Density&quot;</span><span class="p">])</span>
        <span class="n">t</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">format</span><span class="p">(</span><span class="n">timestep</span><span class="p">,</span> <span class="s1">&#39;1.1e&#39;</span><span class="p">))</span>
        <span class="c1"># iterations = numpy.ceil(self.ModelParameters[&quot;Beat_Duration&quot;] / t)</span>
        <span class="c1"># t= self.ModelParameters[&quot;Beat_Duration&quot;] / iterations</span>
        <span class="c1"># if timestep &lt; self.ModelParameters[&quot;TIMESTEP&quot;]:</span>
        <span class="c1">#     print(&quot;Warning: Simulation can be unstable!&quot;)</span>
        <span class="c1">#     print(&quot;Timestep exceeds the maximum timestep.&quot;)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Timestep set to maximum timestep: </span><span class="si">%1.1e</span><span class="s2"> s&quot;</span> <span class="o">%</span> <span class="n">t</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ModelParameters</span><span class="p">[</span><span class="s2">&quot;TIMESTEP&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="Patient.CalculateDistanceFromTheHeart" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Patient.CalculateDistanceFromTheHeart">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">CalculateDistanceFromTheHeart</span><span class="signature">(self)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">CalculateDistanceFromTheHeart</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the distance from the heart in the shortest sense bansed on Dijkstra&#39;s distance.</span>
<span class="sd">        Direction is determined by the positive pressure direction.</span>
<span class="sd">        :return: Nothing</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Graph</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">TopologyToGraph</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Graph</span><span class="o">.</span><span class="n">edges</span><span class="p">:</span>
            <span class="n">node1</span> <span class="o">=</span> <span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">node2</span> <span class="o">=</span> <span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">p1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">MeanPressurePerNode</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">node1</span><span class="o">.</span><span class="n">Number</span><span class="p">]</span>
            <span class="n">p2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">MeanPressurePerNode</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">node2</span><span class="o">.</span><span class="n">Number</span><span class="p">]</span>

            <span class="n">dp</span> <span class="o">=</span> <span class="n">p1</span> <span class="o">-</span> <span class="n">p2</span>
            <span class="n">dx</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Graph</span><span class="p">[</span><span class="n">node1</span><span class="p">][</span><span class="n">node2</span><span class="p">][</span><span class="s1">&#39;weight&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">dp</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">dp</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Graph</span><span class="p">[</span><span class="n">node2</span><span class="p">][</span><span class="n">node1</span><span class="p">][</span><span class="s1">&#39;direction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dx</span>
            <span class="k">elif</span> <span class="n">dp</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Graph</span><span class="p">[</span><span class="n">node1</span><span class="p">][</span><span class="n">node2</span><span class="p">][</span><span class="s1">&#39;direction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dx</span>

        <span class="n">length</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">single_source_dijkstra</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Graph</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">weight</span><span class="o">=</span><span class="s1">&#39;direction&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Nodes</span><span class="p">:</span>
            <span class="n">node</span><span class="o">.</span><span class="n">DistancefromHeart</span> <span class="o">=</span> <span class="n">length</span><span class="p">[</span><span class="n">node</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">DistancefromHeart</span> <span class="o">=</span> <span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">DistancefromHeart</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Nodes</span><span class="p">]</span>
</pre></div>

        </details>

            <div class="docstring"><p>Returns the distance from the heart in the shortest sense bansed on Dijkstra's distance.
Direction is determined by the positive pressure direction.
:return: Nothing</p>
</div>


                            </div>
                            <div id="Patient.CalculateTimedelayFromTheHeart" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Patient.CalculateTimedelayFromTheHeart">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">CalculateTimedelayFromTheHeart</span><span class="signature">(self)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">CalculateTimedelayFromTheHeart</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the timedelay from the heart in the shortest sense bansed on Dijkstra&#39;s distance.</span>
<span class="sd">        Direction is determined by the positive pressure direction.</span>
<span class="sd">        :return: Nothing</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Graph</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">TopologyToGraph</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Graph</span><span class="o">.</span><span class="n">edges</span><span class="p">:</span>
            <span class="n">node1</span> <span class="o">=</span> <span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">node2</span> <span class="o">=</span> <span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">v1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">MeanVelocityPerNode</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">node1</span><span class="o">.</span><span class="n">Number</span><span class="p">]</span>
            <span class="n">v2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">MeanVelocityPerNode</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">node2</span><span class="o">.</span><span class="n">Number</span><span class="p">]</span>

            <span class="n">meanv</span> <span class="o">=</span> <span class="p">(</span><span class="n">v1</span> <span class="o">+</span> <span class="n">v2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="n">dx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Graph</span><span class="p">[</span><span class="n">node1</span><span class="p">][</span><span class="n">node2</span><span class="p">][</span><span class="s1">&#39;weight&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e-3</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">dx</span> <span class="o">/</span> <span class="n">meanv</span>
            <span class="k">if</span> <span class="n">meanv</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Graph</span><span class="p">[</span><span class="n">node2</span><span class="p">][</span><span class="n">node1</span><span class="p">][</span><span class="s1">&#39;timedelay&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">t</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Graph</span><span class="p">[</span><span class="n">node1</span><span class="p">][</span><span class="n">node2</span><span class="p">][</span><span class="s1">&#39;timedelay&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Graph</span><span class="p">[</span><span class="n">node2</span><span class="p">][</span><span class="n">node1</span><span class="p">][</span><span class="s1">&#39;timedelay&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Graph</span><span class="p">[</span><span class="n">node1</span><span class="p">][</span><span class="n">node2</span><span class="p">][</span><span class="s1">&#39;timedelay&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">length</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">single_source_dijkstra</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Graph</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">weight</span><span class="o">=</span><span class="s1">&#39;timedelay&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Nodes</span><span class="p">:</span>
            <span class="n">node</span><span class="o">.</span><span class="n">TimeDelay</span> <span class="o">=</span> <span class="n">length</span><span class="p">[</span><span class="n">node</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">DistancefromHeart</span> <span class="o">=</span> <span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">DistancefromHeart</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Nodes</span><span class="p">]</span>
</pre></div>

        </details>

            <div class="docstring"><p>Returns the timedelay from the heart in the shortest sense bansed on Dijkstra's distance.
Direction is determined by the positive pressure direction.
:return: Nothing</p>
</div>


                            </div>
                            <div id="Patient.UpdateNodeType" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Patient.UpdateNodeType">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">UpdateNodeType</span><span class="signature">(self)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">UpdateNodeType</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">UpdateNodeType</span><span class="p">()</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="Patient.CorrectforDirectionVectorOutlets" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Patient.CorrectforDirectionVectorOutlets">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">CorrectforDirectionVectorOutlets</span><span class="signature">(self)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">CorrectforDirectionVectorOutlets</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">numbers</span> <span class="o">=</span> <span class="p">[</span><span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">Number</span> <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Vessels</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">CorrectForDirectionEnds</span><span class="p">(</span><span class="n">numbers</span><span class="p">)</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="Patient.CerebellumBrainstemMapping" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Patient.CerebellumBrainstemMapping">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">CerebellumBrainstemMapping</span><span class="signature">(self)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">CerebellumBrainstemMapping</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># add labels and positions to the vessels.</span>
        <span class="n">cerebellum</span> <span class="o">=</span> <span class="mi">8</span>
        <span class="n">brainstem</span> <span class="o">=</span> <span class="mi">9</span>

        <span class="n">cerebellumnames</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;R. SCA&quot;</span><span class="p">,</span>
                           <span class="s2">&quot;L. SCA&quot;</span><span class="p">,</span>
                           <span class="s2">&quot;R. AICA&quot;</span><span class="p">,</span>
                           <span class="s2">&quot;L. AICA&quot;</span><span class="p">,</span>
                           <span class="s2">&quot;R. PICA&quot;</span><span class="p">,</span>
                           <span class="s2">&quot;L. PICA&quot;</span><span class="p">,</span> <span class="p">]</span>

        <span class="n">brainstemnames</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Pontine I&quot;</span><span class="p">,</span>
                          <span class="s2">&quot;Pontine II&quot;</span><span class="p">,</span>
                          <span class="s2">&quot;Pontine III&quot;</span><span class="p">,</span>
                          <span class="s2">&quot;Pontine IV&quot;</span><span class="p">,</span>
                          <span class="s2">&quot;Pontine V&quot;</span><span class="p">,</span>
                          <span class="s2">&quot;Pontine VI&quot;</span><span class="p">,</span>
                          <span class="s2">&quot;Pontine VII&quot;</span><span class="p">,</span>
                          <span class="s2">&quot;Pontine VIII&quot;</span><span class="p">,</span>
                          <span class="s2">&quot;Pontine IX&quot;</span><span class="p">,</span>
                          <span class="s2">&quot;Pontine X&quot;</span><span class="p">,</span>
                          <span class="s2">&quot;Pontine XI&quot;</span><span class="p">,</span>
                          <span class="s2">&quot;Pontine XII&quot;</span><span class="p">,</span>
                          <span class="s2">&quot;Pontine XIII&quot;</span><span class="p">]</span>

        <span class="n">cerebellumpos</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">25</span><span class="p">,</span> <span class="o">-</span><span class="mi">74</span><span class="p">,</span> <span class="o">-</span><span class="mi">36</span><span class="p">],</span>
                         <span class="p">[</span><span class="o">-</span><span class="mi">25</span><span class="p">,</span> <span class="o">-</span><span class="mi">74</span><span class="p">,</span> <span class="o">-</span><span class="mi">34</span><span class="p">],</span>
                         <span class="p">[</span><span class="mi">28</span><span class="p">,</span> <span class="o">-</span><span class="mi">55</span><span class="p">,</span> <span class="o">-</span><span class="mi">48</span><span class="p">],</span>
                         <span class="p">[</span><span class="o">-</span><span class="mi">28</span><span class="p">,</span> <span class="o">-</span><span class="mi">55</span><span class="p">,</span> <span class="o">-</span><span class="mi">48</span><span class="p">],</span>
                         <span class="p">[</span><span class="mi">32</span><span class="p">,</span> <span class="o">-</span><span class="mi">40</span><span class="p">,</span> <span class="o">-</span><span class="mi">60</span><span class="p">],</span>
                         <span class="p">[</span><span class="o">-</span><span class="mi">30</span><span class="p">,</span> <span class="o">-</span><span class="mi">48</span><span class="p">,</span> <span class="o">-</span><span class="mi">60</span><span class="p">]]</span>

        <span class="c1"># starting at the bottom of the stem</span>
        <span class="n">pontinepos</span> <span class="o">=</span> <span class="p">[[</span><span class="o">-</span><span class="mf">3.1</span><span class="p">,</span> <span class="o">-</span><span class="mf">16.3</span><span class="p">,</span> <span class="o">-</span><span class="mf">58.5</span><span class="p">],</span>
                      <span class="p">[</span><span class="mf">1.6</span><span class="p">,</span> <span class="o">-</span><span class="mf">15.7</span><span class="p">,</span> <span class="o">-</span><span class="mf">57.2</span><span class="p">],</span>
                      <span class="p">[</span><span class="o">-</span><span class="mf">6.1</span><span class="p">,</span> <span class="o">-</span><span class="mf">14.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">50.4</span><span class="p">],</span>
                      <span class="p">[</span><span class="mf">2.2</span><span class="p">,</span> <span class="o">-</span><span class="mf">12.8</span><span class="p">,</span> <span class="o">-</span><span class="mf">51.7</span><span class="p">],</span>
                      <span class="p">[</span><span class="o">-</span><span class="mf">8.2</span><span class="p">,</span> <span class="o">-</span><span class="mf">10.9</span><span class="p">,</span> <span class="o">-</span><span class="mf">48.2</span><span class="p">],</span>
                      <span class="p">[</span><span class="mf">2.39</span><span class="p">,</span> <span class="o">-</span><span class="mf">9.2</span><span class="p">,</span> <span class="o">-</span><span class="mf">48.9</span><span class="p">],</span>
                      <span class="p">[</span><span class="o">-</span><span class="mf">8.8</span><span class="p">,</span> <span class="o">-</span><span class="mf">5.81</span><span class="p">,</span> <span class="o">-</span><span class="mf">46.1</span><span class="p">],</span>
                      <span class="p">[</span><span class="mf">2.7</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.2</span><span class="p">,</span> <span class="o">-</span><span class="mf">46.6</span><span class="p">],</span>
                      <span class="p">[</span><span class="o">-</span><span class="mf">8.4</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.6</span><span class="p">,</span> <span class="o">-</span><span class="mf">40.7</span><span class="p">],</span>
                      <span class="p">[</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">1.3</span><span class="p">,</span> <span class="o">-</span><span class="mf">41.3</span><span class="p">],</span>
                      <span class="p">[</span><span class="o">-</span><span class="mf">6.8</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">34.6</span><span class="p">],</span>
                      <span class="p">[</span><span class="o">-</span><span class="mf">3.0</span><span class="p">,</span> <span class="mf">1.4</span><span class="p">,</span> <span class="o">-</span><span class="mf">34.0</span><span class="p">],</span>
                      <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]</span>

        <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Vessels</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Name</span> <span class="ow">in</span> <span class="n">cerebellumnames</span><span class="p">:</span>
                <span class="n">vessel</span><span class="o">.</span><span class="n">SetMajorVesselID</span><span class="p">(</span><span class="n">cerebellum</span><span class="p">)</span>
                <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">SetPosition</span><span class="p">(</span><span class="n">cerebellumpos</span><span class="p">[</span><span class="n">cerebellumnames</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">vessel</span><span class="o">.</span><span class="n">Name</span><span class="p">)])</span>
                <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">SetMajorVesselID</span><span class="p">(</span><span class="n">cerebellum</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Name</span> <span class="ow">in</span> <span class="n">brainstemnames</span><span class="p">:</span>
                <span class="n">vessel</span><span class="o">.</span><span class="n">SetMajorVesselID</span><span class="p">(</span><span class="n">brainstem</span><span class="p">)</span>
                <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">SetPosition</span><span class="p">(</span><span class="n">pontinepos</span><span class="p">[</span><span class="n">brainstemnames</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">vessel</span><span class="o">.</span><span class="n">Name</span><span class="p">)])</span>
                <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">SetMajorVesselID</span><span class="p">(</span><span class="n">brainstem</span><span class="p">)</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="Patient.calculate_wk_parameters" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Patient.calculate_wk_parameters">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">calculate_wk_parameters</span><span class="signature">(self)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">calculate_wk_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the windkessel parameters for the outlets of the network.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Calculating WindKessel Parameters.&quot;</span><span class="p">)</span>
        <span class="n">scaling</span> <span class="o">=</span> <span class="mf">1e-3</span>  <span class="c1"># default for mm</span>

        <span class="n">C1D</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Vessels</span><span class="p">:</span>
            <span class="c1"># mean radius and thickness</span>
            <span class="n">lengthvessel</span> <span class="o">=</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Length</span> <span class="o">*</span> <span class="n">scaling</span>
            <span class="n">meanradius</span> <span class="o">=</span> <span class="n">vessel</span><span class="o">.</span><span class="n">MeanRadius</span> <span class="o">*</span> <span class="n">scaling</span>
            <span class="n">meanh</span> <span class="o">=</span> <span class="n">vessel</span><span class="o">.</span><span class="n">MeanThickness</span> <span class="o">*</span> <span class="n">scaling</span>
            <span class="n">C1D</span> <span class="o">+=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">meanradius</span> <span class="o">*</span> <span class="n">meanradius</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">)</span> <span class="o">*</span> <span class="n">lengthvessel</span> <span class="o">/</span> <span class="p">(</span>
                    <span class="p">(</span><span class="mi">4</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="n">vessel</span><span class="o">.</span><span class="n">YoungsModules</span> <span class="o">*</span> <span class="n">meanh</span><span class="p">)</span>

        <span class="n">Cperipheral</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ModelParameters</span><span class="p">[</span><span class="s2">&quot;CTotal&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">C1D</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ModelParameters</span><span class="p">[</span><span class="s2">&quot;Cperipheral&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Cperipheral</span>
        <span class="k">if</span> <span class="n">Cperipheral</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Cperipheral should not be negative. The value of Cperipheral was: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">Cperipheral</span><span class="p">))</span>

        <span class="c1"># identify outlets</span>
        <span class="n">outletmap</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">OutletNodes</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Vessels</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">:</span>
                    <span class="n">outletmap</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vessel</span><span class="o">.</span><span class="n">Name</span><span class="p">)</span>

        <span class="n">bodymap</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">out</span> <span class="ow">in</span> <span class="n">outletmap</span><span class="p">:</span>
            <span class="n">part</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">Constants</span><span class="o">.</span><span class="n">fractions</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">body</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">Constants</span><span class="o">.</span><span class="n">bodyparts</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">out</span> <span class="o">==</span> <span class="n">body</span><span class="p">:</span>
                    <span class="n">part</span> <span class="o">=</span> <span class="n">index</span>
            <span class="n">bodymap</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">part</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">bodynumber</span><span class="p">,</span> <span class="n">fraction</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">Constants</span><span class="o">.</span><span class="n">fractions</span><span class="p">):</span>
            <span class="n">outlets</span> <span class="o">=</span> <span class="p">[</span><span class="n">out</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">out</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">OutletNodes</span><span class="p">)</span> <span class="k">if</span> <span class="n">bodymap</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">==</span> <span class="n">bodynumber</span><span class="p">]</span>
            <span class="n">rcubed</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">outlets</span><span class="p">:</span>
                <span class="n">radius</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">Radius</span> <span class="o">*</span> <span class="n">scaling</span>
                <span class="n">rcubed</span> <span class="o">+=</span> <span class="n">math</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">radius</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">outlets</span><span class="p">:</span>
                <span class="n">radius</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">Radius</span> <span class="o">*</span> <span class="n">scaling</span>
                <span class="n">h</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">Thickness</span> <span class="o">*</span> <span class="n">scaling</span>
                <span class="n">rt</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ModelParameters</span><span class="p">[</span><span class="s2">&quot;RTotal&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">fraction</span><span class="p">)</span> <span class="o">*</span> <span class="n">rcubed</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">radius</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
                <span class="n">A</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">radius</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">beta</span> <span class="o">=</span> <span class="p">(</span><span class="mi">4</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="n">i</span><span class="o">.</span><span class="n">YoungsModules</span> <span class="o">*</span> <span class="n">h</span> <span class="o">/</span> <span class="n">A</span>
                <span class="n">c0</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">beta</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ModelParameters</span><span class="p">[</span><span class="s2">&quot;Density&quot;</span><span class="p">])))</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">)</span>
                <span class="n">r1</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ModelParameters</span><span class="p">[</span><span class="s2">&quot;Density&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">A</span><span class="p">)</span> <span class="o">*</span> <span class="n">c0</span>
                <span class="n">r2</span> <span class="o">=</span> <span class="n">rt</span> <span class="o">-</span> <span class="n">r1</span>
                <span class="k">if</span> <span class="n">r2</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">r2</span> <span class="o">=</span> <span class="mf">0.1e9</span>
                    <span class="n">r1</span> <span class="o">=</span> <span class="n">rt</span> <span class="o">-</span> <span class="n">r2</span>
                <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ModelParameters</span><span class="p">[</span><span class="s2">&quot;Cperipheral&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ModelParameters</span><span class="p">[</span><span class="s2">&quot;RTotal&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">rt</span>
                <span class="n">i</span><span class="o">.</span><span class="n">SetWK</span><span class="p">(</span><span class="n">r1</span><span class="p">,</span> <span class="n">r2</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><p>Calculate the windkessel parameters for the outlets of the network.</p>
</div>


                            </div>
                            <div id="Patient.calculate_wk_parameters_evenly" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Patient.calculate_wk_parameters_evenly">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">calculate_wk_parameters_evenly</span><span class="signature">(self)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">calculate_wk_parameters_evenly</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the windkessel parameters for the outlets of the network.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Calculating WindKessel Parameters, evenly through out the network.&quot;</span><span class="p">)</span>
        <span class="n">scaling</span> <span class="o">=</span> <span class="mf">1e-3</span>  <span class="c1"># default for mm</span>

        <span class="n">C1D</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Vessels</span><span class="p">:</span>
            <span class="c1"># mean radius and thickness</span>
            <span class="n">lengthvessel</span> <span class="o">=</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Length</span> <span class="o">*</span> <span class="n">scaling</span>
            <span class="n">meanradius</span> <span class="o">=</span> <span class="n">vessel</span><span class="o">.</span><span class="n">MeanRadius</span> <span class="o">*</span> <span class="n">scaling</span>
            <span class="n">meanh</span> <span class="o">=</span> <span class="n">vessel</span><span class="o">.</span><span class="n">MeanThickness</span> <span class="o">*</span> <span class="n">scaling</span>
            <span class="n">C1D</span> <span class="o">+=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">meanradius</span> <span class="o">*</span> <span class="n">meanradius</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">)</span> <span class="o">*</span> <span class="n">lengthvessel</span> <span class="o">/</span> <span class="p">(</span>
                    <span class="p">(</span><span class="mi">4</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="n">vessel</span><span class="o">.</span><span class="n">YoungsModules</span> <span class="o">*</span> <span class="n">meanh</span><span class="p">)</span>

        <span class="n">Cperipheral</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ModelParameters</span><span class="p">[</span><span class="s2">&quot;CTotal&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">C1D</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ModelParameters</span><span class="p">[</span><span class="s2">&quot;Cperipheral&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Cperipheral</span>
        <span class="c1"># if Cperipheral &lt; 0:</span>
        <span class="c1">#     raise Exception(&#39;Cperipheral should not be negative. The value of Cperipheral was: {}&#39;.format(Cperipheral))</span>

        <span class="c1"># identify outlets</span>
        <span class="n">outletmap</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">OutletNodes</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Vessels</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">:</span>
                    <span class="n">outletmap</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vessel</span><span class="o">.</span><span class="n">Name</span><span class="p">)</span>

        <span class="n">outlets</span> <span class="o">=</span> <span class="p">[</span><span class="n">out</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">out</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">OutletNodes</span><span class="p">)]</span>
        <span class="n">rcubed</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">outlets</span><span class="p">:</span>
            <span class="n">radius</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">Radius</span> <span class="o">*</span> <span class="n">scaling</span>
            <span class="n">rcubed</span> <span class="o">+=</span> <span class="n">math</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">radius</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">outlets</span><span class="p">:</span>
            <span class="n">radius</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">Radius</span> <span class="o">*</span> <span class="n">scaling</span>
            <span class="n">h</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">Thickness</span> <span class="o">*</span> <span class="n">scaling</span>
            <span class="n">rt</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ModelParameters</span><span class="p">[</span><span class="s2">&quot;RTotal&quot;</span><span class="p">])</span> <span class="o">*</span> <span class="n">rcubed</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">radius</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
            <span class="n">A</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">radius</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">beta</span> <span class="o">=</span> <span class="p">(</span><span class="mi">4</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="n">i</span><span class="o">.</span><span class="n">YoungsModules</span> <span class="o">*</span> <span class="n">h</span> <span class="o">/</span> <span class="n">A</span>
            <span class="n">c0</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">beta</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ModelParameters</span><span class="p">[</span><span class="s2">&quot;Density&quot;</span><span class="p">])))</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">)</span>
            <span class="n">r1</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ModelParameters</span><span class="p">[</span><span class="s2">&quot;Density&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">A</span><span class="p">)</span> <span class="o">*</span> <span class="n">c0</span>
            <span class="n">r2</span> <span class="o">=</span> <span class="n">rt</span> <span class="o">-</span> <span class="n">r1</span>
            <span class="k">if</span> <span class="n">r2</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">r2</span> <span class="o">=</span> <span class="mf">0.1e9</span>
                <span class="n">r1</span> <span class="o">=</span> <span class="n">rt</span> <span class="o">-</span> <span class="n">r2</span>
            <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ModelParameters</span><span class="p">[</span><span class="s2">&quot;Cperipheral&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ModelParameters</span><span class="p">[</span><span class="s2">&quot;RTotal&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">rt</span>
            <span class="n">i</span><span class="o">.</span><span class="n">SetWK</span><span class="p">(</span><span class="n">r1</span><span class="p">,</span> <span class="n">r2</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><p>Calculate the windkessel parameters for the outlets of the network.</p>
</div>


                            </div>
                            <div id="Patient.WriteSimFiles" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Patient.WriteSimFiles">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">WriteSimFiles</span><span class="signature">(self)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">WriteSimFiles</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Writing simulation files.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">UpdateTopology</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">SaveVesselAtlas</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">WriteTopologyFile</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">WriteParFile</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">WriteFlowProfiles</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">WriteRunFile</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">WriteModelParameters</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">WriteClotFile</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">WriteRegionMapping</span><span class="p">()</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="Patient.ExportSurface" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Patient.ExportSurface">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">ExportSurface</span><span class="signature">(self, file, graph)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">ExportSurface</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">graph</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Perfusion</span><span class="o">.</span><span class="n">ExportSurface</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">graph</span><span class="p">)</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="Patient.SelectPatient" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Patient.SelectPatient">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">SelectPatient</span><span class="signature">(self)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">SelectPatient</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Load input files</span>
        <span class="c1"># Randomly select a patient</span>
        <span class="n">segmentationfolder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">DataFilesFolder</span> <span class="o">+</span> <span class="s2">&quot;/Segmentations/&quot;</span>
        <span class="n">segfolders</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">segmentationfolder</span><span class="p">)]</span>
        <span class="n">selectedfolder</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">segfolders</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">segmentationfile</span> <span class="o">=</span> <span class="n">segmentationfolder</span> <span class="o">+</span> <span class="n">selectedfolder</span> <span class="o">+</span> <span class="s2">&quot;/Feature_Vessel.csv&quot;</span>
        <span class="n">infofile</span> <span class="o">=</span> <span class="n">segmentationfolder</span> <span class="o">+</span> <span class="n">selectedfolder</span> <span class="o">+</span> <span class="s2">&quot;/Image_info.txt&quot;</span>

        <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">segmentationfile</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">InputFolder</span><span class="p">)</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">infofile</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">InputFolder</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ModelParameters</span><span class="p">[</span><span class="s2">&quot;Patient_Segmentation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">selectedfolder</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Selected segmentation: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">selectedfolder</span><span class="p">)</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="Patient.SelectDonorNetwork" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Patient.SelectDonorNetwork">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">SelectDonorNetwork</span><span class="signature">(self)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">SelectDonorNetwork</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Select a network from the Brava set to extend the patient network.</span>
<span class="sd">        For now, the donor is randomly selected from the folder.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">scriptfolder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">DataFilesFolder</span>
        <span class="n">bravafolder</span> <span class="o">=</span> <span class="n">scriptfolder</span> <span class="o">+</span> <span class="s2">&quot;/Brava/&quot;</span>
        <span class="n">bravafiles</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">bravafolder</span><span class="p">)</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">bravafolder</span><span class="p">,</span> <span class="n">f</span><span class="p">))</span> <span class="k">if</span>
                      <span class="n">f</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span> <span class="o">==</span> <span class="s2">&quot;vtp&quot;</span><span class="p">]</span>
        <span class="n">selectedfile</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">bravafiles</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># selectedfile = &quot;BH0023_ColorCoded.CNG.vtp&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ModelParameters</span><span class="p">[</span><span class="s2">&quot;Donor_Network&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">selectedfile</span>
</pre></div>

        </details>

            <div class="docstring"><p>Select a network from the Brava set to extend the patient network.
For now, the donor is randomly selected from the folder.</p>
</div>


                            </div>
                            <div id="Patient.UpdateModelParameters" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Patient.UpdateModelParameters">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">UpdateModelParameters</span><span class="signature">(self)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">UpdateModelParameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ModelParameters</span><span class="p">[</span><span class="s2">&quot;Beat_Duration&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">60</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">PatientData</span><span class="p">[</span><span class="s2">&quot;HeartRate&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ModelParameters</span><span class="p">[</span><span class="s2">&quot;SISTOLIC_PRESSURE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PatientData</span><span class="p">[</span><span class="s2">&quot;SystolePressure&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ModelParameters</span><span class="p">[</span><span class="s2">&quot;DIASTOLIC_PRESSURE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PatientData</span><span class="p">[</span><span class="s2">&quot;DiastolePressure&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ModelParameters</span><span class="p">[</span><span class="s2">&quot;RTotal&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">PatientData</span><span class="p">[</span><span class="s2">&quot;SystolePressure&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">PatientData</span><span class="p">[</span>
            <span class="s2">&quot;DiastolePressure&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">/</span> <span class="mi">3</span><span class="p">))</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">PatientData</span><span class="p">[</span><span class="s2">&quot;MeanRightAtrialPressure&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span>
                                                 <span class="bp">self</span><span class="o">.</span><span class="n">PatientData</span><span class="p">[</span><span class="s2">&quot;StrokeVolume&quot;</span><span class="p">]</span> <span class="o">*</span>
                                                 <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">PatientData</span><span class="p">[</span><span class="s2">&quot;HeartRate&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">60</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e-6</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ModelParameters</span><span class="p">[</span><span class="s2">&quot;CTotal&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ModelParameters</span><span class="p">[</span><span class="s2">&quot;TimeConstantDiastolicDecay&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">ModelParameters</span><span class="p">[</span>
            <span class="s2">&quot;RTotal&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ModelParameters</span><span class="p">[</span><span class="s2">&quot;ScriptLocation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span> <span class="o">+</span> <span class="s2">&quot;/Check_Convergence.py&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ModelParameters</span><span class="p">[</span><span class="s2">&quot;OUT_PRESSURE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PatientData</span><span class="p">[</span><span class="s2">&quot;MeanRightAtrialPressure&quot;</span><span class="p">]</span>

        <span class="c1"># self.PatientData[&quot;collaterals&quot;]: collateral score, 0:absent, 1:poor, 2:moderate, 3:good</span>
        <span class="n">collateral_map</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span> <span class="mf">0.65</span><span class="p">}</span>  <span class="c1"># detailed collateral model: probability</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ModelParameters</span><span class="p">[</span><span class="s2">&quot;collateralpropability&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">collateral_map</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">PatientData</span><span class="p">[</span><span class="s2">&quot;CollateralScore&quot;</span><span class="p">]]</span>

        <span class="n">collateral_map</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="mf">0.14</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">}</span>  <span class="c1"># two-way coupled model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ModelParameters</span><span class="p">[</span><span class="s2">&quot;coarse_collaterals_number&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">collateral_map</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">PatientData</span><span class="p">[</span><span class="s2">&quot;CollateralScore&quot;</span><span class="p">]]</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="Patient.WriteFlowProfilesAlastruey2007" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Patient.WriteFlowProfilesAlastruey2007">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">WriteFlowProfilesAlastruey2007</span><span class="signature">(self)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">WriteFlowProfilesAlastruey2007</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Take patient parameters and generate flow profiles.</span>
<span class="sd">        Assumption is that the two inlets with the largest radius are the carotid arteries.</span>
<span class="sd">        Flowrate given here are ml/s</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Writing Flow Profiles.&quot;</span><span class="p">)</span>
        <span class="n">Aortafile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">ModellingFolder</span> <span class="o">+</span> <span class="s2">&quot;Aorta.txt&quot;</span>
        <span class="n">period</span> <span class="o">=</span> <span class="mi">60</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">PatientData</span><span class="p">[</span><span class="s2">&quot;HeartRate&quot;</span><span class="p">]</span>
        <span class="n">time</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>

        <span class="n">VolumeFlowRate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PatientData</span><span class="p">[</span><span class="s2">&quot;StrokeVolume&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">PatientData</span><span class="p">[</span><span class="s2">&quot;HeartRate&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">60</span><span class="p">)</span>
        <span class="c1"># AortaFlow = BloodflowEquations.FlowRateAorta(time, period, VolumeFlowRate)</span>
        <span class="n">scaling</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">integrate</span><span class="o">.</span><span class="n">simps</span><span class="p">(</span><span class="n">BloodFlowEquations</span><span class="o">.</span><span class="n">FlowRateAlastruey2007</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">time</span><span class="p">)</span>
        <span class="n">AortaFlow</span> <span class="o">=</span> <span class="n">BloodFlowEquations</span><span class="o">.</span><span class="n">FlowRateAlastruey2007</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">VolumeFlowRate</span> <span class="o">/</span> <span class="n">scaling</span><span class="p">)</span>
        <span class="c1"># AortaFlow = [self.PatientData[&quot;StrokeVolume&quot;] for i in AortaFlow]</span>
        <span class="c1"># totalflow = numpy.trapz(AortaFlow,time)</span>
        <span class="c1"># totalflows = simps(AortaFlow, time)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">Aortafile</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;1.0e-6</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">time</span><span class="p">)):</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="se">\t</span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">AortaFlow</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
</pre></div>

        </details>

            <div class="docstring"><p>Take patient parameters and generate flow profiles.
Assumption is that the two inlets with the largest radius are the carotid arteries.
Flowrate given here are ml/s</p>
</div>


                            </div>
                            <div id="Patient.WriteFlowProfiles" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Patient.WriteFlowProfiles">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">WriteFlowProfiles</span><span class="signature">(self)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">WriteFlowProfiles</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Take patient parameters and generate flow profiles.</span>
<span class="sd">        Assumption is that the two inlets with the largest radius are the carotid arteries.</span>
<span class="sd">        Flowrate given here are ml/s</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Writing Flow Profiles.&quot;</span><span class="p">)</span>
        <span class="n">Aortafile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">ModellingFolder</span> <span class="o">+</span> <span class="s2">&quot;Aorta.txt&quot;</span>
        <span class="n">period</span> <span class="o">=</span> <span class="mi">60</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">PatientData</span><span class="p">[</span><span class="s2">&quot;HeartRate&quot;</span><span class="p">]</span>
        <span class="n">time</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>

        <span class="n">VolumeFlowRate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PatientData</span><span class="p">[</span><span class="s2">&quot;StrokeVolume&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">PatientData</span><span class="p">[</span><span class="s2">&quot;HeartRate&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">60</span><span class="p">)</span>
        <span class="n">AortaFlow</span> <span class="o">=</span> <span class="n">BloodFlowEquations</span><span class="o">.</span><span class="n">FlowRateAorta</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">VolumeFlowRate</span><span class="p">)</span>
        <span class="c1"># scaling = scipy.integrate.simps(BloodflowEquations.FlowRateAlastruey2007(time,1), time)</span>
        <span class="c1"># AortaFlow = BloodflowEquations.FlowRateAlastruey2007(time, VolumeFlowRate/scaling)</span>
        <span class="c1"># AortaFlow = [self.PatientData[&quot;StrokeVolume&quot;] for i in AortaFlow]</span>
        <span class="c1"># totalflow = numpy.trapz(AortaFlow,time)</span>
        <span class="c1"># totalflows = simps(AortaFlow, time)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">Aortafile</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;1.0e-6</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">time</span><span class="p">)):</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="se">\t</span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">AortaFlow</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
</pre></div>

        </details>

            <div class="docstring"><p>Take patient parameters and generate flow profiles.
Assumption is that the two inlets with the largest radius are the carotid arteries.
Flowrate given here are ml/s</p>
</div>


                            </div>
                            <div id="Patient.VesselToMeshAllignmentSides" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Patient.VesselToMeshAllignmentSides">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">VesselToMeshAllignmentSides</span><span class="signature">(self, graph)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">VesselToMeshAllignmentSides</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">graph</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Optimizing alignment between the mesh and the outlets.&quot;</span><span class="p">)</span>

        <span class="n">pos</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">majornodesID</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">OutletNodes</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">Position</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">))</span> <span class="ow">and</span> <span class="n">node</span><span class="o">.</span><span class="n">MajorVesselID</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">pos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">Position</span><span class="p">)</span>
                <span class="n">majornodesID</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">MajorVesselID</span><span class="p">)</span>

        <span class="c1"># left and right sides of the pial surface</span>
        <span class="n">rightpialsurface</span> <span class="o">=</span> <span class="p">[</span><span class="n">index</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">graph</span><span class="o">.</span><span class="n">PialSurface</span><span class="p">)</span> <span class="k">if</span> <span class="n">graph</span><span class="o">.</span><span class="n">SideInfo</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">leftpialsurface</span> <span class="o">=</span> <span class="p">[</span><span class="n">index</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">graph</span><span class="o">.</span><span class="n">PialSurface</span><span class="p">)</span> <span class="k">if</span> <span class="n">graph</span><span class="o">.</span><span class="n">SideInfo</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span>

        <span class="c1"># [cow, - , &quot;R. ACA, A2&quot;, &quot;R. MCA&quot;, &quot;L. MCA&quot;, &quot;L. ACA, A2&quot;, &quot;R. PCA, P2&quot;, &quot;L. PCA, P2&quot;]</span>
        <span class="c1"># leftvessels = [4, 5, 7]</span>
        <span class="c1"># rightvessels = [2, 3, 6]</span>
        <span class="n">leftvessels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Perfusion</span><span class="o">.</span><span class="n">leftregionids</span>
        <span class="n">rightvessels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Perfusion</span><span class="o">.</span><span class="n">rightregionids</span>

        <span class="n">leftnodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">index</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span> <span class="k">if</span> <span class="n">majornodesID</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="ow">in</span> <span class="n">leftvessels</span><span class="p">]</span>
        <span class="n">rightnodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">index</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span> <span class="k">if</span> <span class="n">majornodesID</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="ow">in</span> <span class="n">rightvessels</span><span class="p">]</span>

        <span class="n">sys</span><span class="o">.</span><span class="n">setrecursionlimit</span><span class="p">(</span><span class="mi">10000</span><span class="p">)</span>
        <span class="n">KDTreeleft</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">spatial</span><span class="o">.</span><span class="n">KDTree</span><span class="p">([</span><span class="n">graph</span><span class="o">.</span><span class="n">PialSurface</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">leftpialsurface</span><span class="p">])</span>
        <span class="n">KDTreeright</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">spatial</span><span class="o">.</span><span class="n">KDTree</span><span class="p">([</span><span class="n">graph</span><span class="o">.</span><span class="n">PialSurface</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">rightpialsurface</span><span class="p">])</span>

        <span class="k">def</span> <span class="nf">optimfun</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
            <span class="n">scaling</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">translation</span> <span class="o">=</span> <span class="p">[</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">args</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span>
            <span class="n">rotation</span> <span class="o">=</span> <span class="p">[</span><span class="n">args</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">args</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">args</span><span class="p">[</span><span class="mi">6</span><span class="p">]]</span>
            <span class="c1"># Calculate the transform matrix</span>
            <span class="n">tmatrix</span> <span class="o">=</span> <span class="n">GeneralFunctions</span><span class="o">.</span><span class="n">TMatrix</span><span class="p">(</span><span class="n">scaling</span><span class="p">,</span> <span class="n">rotation</span><span class="p">,</span> <span class="n">translation</span><span class="p">)</span>
            <span class="c1"># Apply matrix to the nodes</span>
            <span class="n">tpos</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">pos</span><span class="p">:</span>
                <span class="n">vec</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="p">[</span><span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="p">[</span><span class="n">node</span><span class="p">[</span><span class="mi">2</span><span class="p">]],</span> <span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
                <span class="n">position</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">tmatrix</span><span class="p">,</span> <span class="n">vec</span><span class="p">)</span>
                <span class="n">nodenew</span> <span class="o">=</span> <span class="p">[</span><span class="n">position</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">position</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">position</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>
                <span class="n">tpos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nodenew</span><span class="p">)</span>

            <span class="n">meshdis</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">tpos</span><span class="p">]</span>

            <span class="n">MinDistanceR</span><span class="p">,</span> <span class="n">MinDistanceIndexR</span> <span class="o">=</span> <span class="n">KDTreeright</span><span class="o">.</span><span class="n">query</span><span class="p">([</span><span class="n">tpos</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">rightnodes</span><span class="p">],</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">MinDistanceL</span><span class="p">,</span> <span class="n">MinDistanceIndexL</span> <span class="o">=</span> <span class="n">KDTreeleft</span><span class="o">.</span><span class="n">query</span><span class="p">([</span><span class="n">tpos</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">leftnodes</span><span class="p">],</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">nodeindex</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rightnodes</span><span class="p">):</span>
                <span class="n">meshdis</span><span class="p">[</span><span class="n">nodeindex</span><span class="p">]</span> <span class="o">=</span> <span class="n">MinDistanceR</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">nodeindex</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">leftnodes</span><span class="p">):</span>
                <span class="n">meshdis</span><span class="p">[</span><span class="n">nodeindex</span><span class="p">]</span> <span class="o">=</span> <span class="n">MinDistanceL</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>

            <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">meshdis</span><span class="p">)</span>

        <span class="c1"># initial guess for the allignment</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">optimize</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">optimfun</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]),</span>
                                         <span class="n">method</span><span class="o">=</span><span class="s1">&#39;Nelder-Mead&#39;</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;disp&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>
        <span class="n">values</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">x</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Perfusion</span><span class="o">.</span><span class="n">AllignmentResult</span> <span class="o">=</span> <span class="n">result</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
        <span class="n">scaling</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">translation</span> <span class="o">=</span> <span class="p">[</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">values</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">values</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span>
        <span class="n">rotation</span> <span class="o">=</span> <span class="p">[</span><span class="n">values</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">values</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">values</span><span class="p">[</span><span class="mi">6</span><span class="p">]]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Perfusion</span><span class="o">.</span><span class="n">TMatrix</span> <span class="o">=</span> <span class="n">GeneralFunctions</span><span class="o">.</span><span class="n">TMatrix</span><span class="p">(</span><span class="n">scaling</span><span class="p">,</span> <span class="n">rotation</span><span class="p">,</span> <span class="n">translation</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ApplyTransformation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Perfusion</span><span class="o">.</span><span class="n">TMatrix</span><span class="p">)</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="Patient.ApplyTransformation" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Patient.ApplyTransformation">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">ApplyTransformation</span><span class="signature">(self, matrix)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">ApplyTransformation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">matrix</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">vesselnode</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Nodes</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">vesselnode</span><span class="o">.</span><span class="n">Position</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">node</span> <span class="o">=</span> <span class="n">vesselnode</span><span class="o">.</span><span class="n">Position</span>
                <span class="n">vec</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="p">[</span><span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="p">[</span><span class="n">node</span><span class="p">[</span><span class="mi">2</span><span class="p">]],</span> <span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
                <span class="n">position</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">matrix</span><span class="p">,</span> <span class="n">vec</span><span class="p">)</span>
                <span class="n">nodenew</span> <span class="o">=</span> <span class="p">[</span><span class="n">position</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">position</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">position</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>
                <span class="n">vesselnode</span><span class="o">.</span><span class="n">SetPosition</span><span class="p">(</span><span class="n">nodenew</span><span class="p">)</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="Patient.FindCouplingPoints" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Patient.FindCouplingPoints">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">FindCouplingPoints</span><span class="signature">(self)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">FindCouplingPoints</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Map the outlets to the nearest point on the surface.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">surfaceoutlets</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">OutletNodes</span> <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">MajorVesselID</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Finding outlets close to the surface.&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">surfaceoutlets</span><span class="p">):</span>
            <span class="n">couplingpoint</span> <span class="o">=</span> <span class="n">Perfusion</span><span class="o">.</span><span class="n">CouplingPoint</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Perfusion</span><span class="o">.</span><span class="n">AddCouplingPoint</span><span class="p">(</span><span class="n">couplingpoint</span><span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><p>Map the outlets to the nearest point on the surface.</p>
</div>


                            </div>
                            <div id="Patient.RemoveCoWOutletsFromPerfusion" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Patient.RemoveCoWOutletsFromPerfusion">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">RemoveCoWOutletsFromPerfusion</span><span class="signature">(self)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">RemoveCoWOutletsFromPerfusion</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The donor networks have outlets that do not get transferred.</span>
<span class="sd">        These need to be removed.</span>
<span class="sd">        If the coupling point node does not have a number, remove it from the list.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Removing coupling points outside topology.&quot;</span><span class="p">)</span>
        <span class="n">pointstoremove</span> <span class="o">=</span> <span class="p">[</span><span class="n">point</span> <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Perfusion</span><span class="o">.</span><span class="n">CouplingPoints</span> <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">point</span><span class="o">.</span><span class="n">Node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Nodes</span><span class="p">)]</span>
        <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Perfusion</span><span class="o">.</span><span class="n">RemoveCouplingPoint</span><span class="p">(</span><span class="n">point</span><span class="p">)</span> <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="n">pointstoremove</span><span class="p">]</span>
</pre></div>

        </details>

            <div class="docstring"><p>The donor networks have outlets that do not get transferred.
These need to be removed.
If the coupling point node does not have a number, remove it from the list.</p>
</div>


                            </div>
                            <div id="Patient.WriteCouplingPointsFile" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Patient.WriteCouplingPointsFile">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">WriteCouplingPointsFile</span><span class="signature">(self)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">WriteCouplingPointsFile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Writing coupling points to file.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">Perfusion</span><span class="o">.</span><span class="n">CouplingPoints</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">FindCouplingPoints</span><span class="p">()</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">ModellingFolder</span> <span class="o">+</span> <span class="s1">&#39;Coupling.csv&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;ID,Position,Direction,Radius,MeshPoint</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">couplingpoint</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Perfusion</span><span class="o">.</span><span class="n">CouplingPoints</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">couplingpoint</span><span class="o">.</span><span class="n">NodeID</span><span class="p">)</span>
                        <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">couplingpoint</span><span class="o">.</span><span class="n">Node</span><span class="o">.</span><span class="n">Position</span><span class="p">)</span>
                        <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">couplingpoint</span><span class="o">.</span><span class="n">Node</span><span class="o">.</span><span class="n">DirectionVector</span><span class="p">)</span>
                        <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">couplingpoint</span><span class="o">.</span><span class="n">Node</span><span class="o">.</span><span class="n">Position</span><span class="o">.</span><span class="n">Radius</span><span class="p">)</span>
                        <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">couplingpoint</span><span class="o">.</span><span class="n">PialSurfacePoint</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="Patient.WriteClotFile" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Patient.WriteClotFile">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">WriteClotFile</span><span class="signature">(self, name=&#39;Clots.txt&#39;)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">WriteClotFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Clots.txt&#39;</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Writing Clots to file.&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">ModellingFolder</span> <span class="o">+</span> <span class="n">name</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;ClotID,NodeID,Permeability,Porosity</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">clot</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Clots</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">clot</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">Number</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">clot</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">clot</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="Patient.WriteTopologyFile" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Patient.WriteTopologyFile">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">WriteTopologyFile</span><span class="signature">(self)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">WriteTopologyFile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">ModellingFolder</span> <span class="o">+</span> <span class="s2">&quot;System.top&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Writing Topology file to </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">file</span><span class="p">)</span>

        <span class="n">OutputFile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="n">OutputFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Name: System_0&#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Coordinates:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># Output Vessel position and radius</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Nodes</span><span class="p">:</span>
            <span class="n">OutputLine</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">Number</span><span class="p">)</span> \
                         <span class="o">+</span> <span class="s2">&quot; L:&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{0:0.5f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">LengthAlongVessel</span><span class="p">)</span> \
                         <span class="o">+</span> <span class="s2">&quot; R:&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{0:0.5f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">Radius</span><span class="p">)</span> \
                         <span class="o">+</span> <span class="s2">&quot; E:&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{0:0.1f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">YoungsModules</span> <span class="o">*</span> <span class="mf">1e-6</span><span class="p">)</span> \
                         <span class="o">+</span> <span class="s2">&quot; T:&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{0:d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">Type</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>

            <span class="n">OutputFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">OutputLine</span><span class="p">)</span>
        <span class="c1"># Output Connections</span>
        <span class="n">OutputFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Bonds:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Nodes</span><span class="p">:</span>
            <span class="n">BondsLine</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">for</span> <span class="n">bond</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">Connections</span><span class="p">:</span>
                <span class="n">BondsLine</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">bond</span><span class="o">.</span><span class="n">Number</span><span class="p">)</span>
            <span class="n">OutputFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">Number</span><span class="p">)</span> <span class="o">+</span> <span class="n">BondsLine</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">OutputFile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="Patient.WriteParFile" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Patient.WriteParFile">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">WriteParFile</span><span class="signature">(self)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">WriteParFile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">ModellingFolder</span> <span class="o">+</span> <span class="s2">&quot;System.par&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Writing parameter file to </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">file</span><span class="p">)</span>
        <span class="c1"># Output outlets</span>
        <span class="n">OutputFilePar</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="c1"># if self.Topology.OutletNodes[0].R1 is None:</span>
        <span class="c1">#     self.calculate_wk_parameters()</span>

        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">OutletNodes</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">R1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">OutputFilePar</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">Number</span><span class="p">)</span>
                                    <span class="o">+</span> <span class="s1">&#39; R1:&#39;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{0:0.5f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                                    <span class="o">+</span> <span class="s1">&#39; R2:&#39;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{0:0.5f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                                    <span class="o">+</span> <span class="s1">&#39; C:&#39;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{0:0.5f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">OutputFilePar</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">Number</span><span class="p">)</span>
                                    <span class="o">+</span> <span class="s1">&#39; R1:&#39;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{0:0.5f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">R1</span> <span class="o">*</span> <span class="mf">1e-9</span><span class="p">)</span>
                                    <span class="o">+</span> <span class="s1">&#39; R2:&#39;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{0:0.5f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">R2</span> <span class="o">*</span> <span class="mf">1e-9</span><span class="p">)</span>
                                    <span class="o">+</span> <span class="s1">&#39; C:&#39;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{0:0.5f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">C</span> <span class="o">*</span> <span class="mf">1e12</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">OutputFilePar</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="Patient.WriteRunFile" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Patient.WriteRunFile">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">WriteRunFile</span><span class="signature">(self)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">WriteRunFile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">ModellingFolder</span> <span class="o">+</span> <span class="s2">&quot;Run.txt&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Writing run file to </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">file</span><span class="p">)</span>
        <span class="c1"># Output Run file</span>
        <span class="n">OutputRunFile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="n">OutputRunFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&lt;System&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">OutputRunFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Topology: &#39;</span> <span class="o">+</span> <span class="s2">&quot;System.top&quot;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">InletLine</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">InletNodes</span><span class="p">:</span>
            <span class="n">InletLine</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Number</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span>
        <span class="n">OutputRunFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;InletFlux: &#39;</span> <span class="o">+</span> <span class="n">InletLine</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">OutputRunFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;OutletParams: &#39;</span> <span class="o">+</span> <span class="s2">&quot;System.par&quot;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">OutputRunFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Task: &#39;</span><span class="p">)</span>
        <span class="n">OutputRunFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;NumberCoupledPoints: 0&#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">modelparameterfile</span> <span class="o">=</span> <span class="s2">&quot;Model_parameters.txt&quot;</span>
        <span class="n">OutputRunFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Modelparameters: &#39;</span> <span class="o">+</span> <span class="n">modelparameterfile</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">OutputRunFile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="Patient.GenerateTreesAtCps" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Patient.GenerateTreesAtCps">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">GenerateTreesAtCps</span><span class="signature">(self, cutoff)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">GenerateTreesAtCps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cutoff</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Generating bifurcating arterial trees at the outlet nodes.&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Perfusion</span><span class="o">.</span><span class="n">CouplingPoints</span><span class="p">:</span>
            <span class="n">tree</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GenerateTree</span><span class="p">(</span><span class="nb">id</span><span class="o">.</span><span class="n">Node</span><span class="p">,</span> <span class="n">cutoff</span><span class="p">)</span>
            <span class="nb">id</span><span class="o">.</span><span class="n">Tree</span> <span class="o">=</span> <span class="n">tree</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">UpdateTopology</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Generated </span><span class="si">%d</span><span class="s2"> bifurcating trees.&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Trees</span><span class="p">))</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="Patient.GenerateTrees" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Patient.GenerateTrees">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">GenerateTrees</span><span class="signature">(self, cutoff)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">GenerateTrees</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cutoff</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Generating bifurcating arterial trees at the outlet nodes.&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">OutletNodes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">GenerateTree</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">cutoff</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Generated </span><span class="si">%d</span><span class="s2"> bifurcating trees.&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Trees</span><span class="p">))</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="Patient.getTotalEndsofTrees" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Patient.getTotalEndsofTrees">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">getTotalEndsofTrees</span><span class="signature">(self)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">getTotalEndsofTrees</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">numberofterminals</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">tree</span><span class="o">.</span><span class="n">EndNodes</span><span class="p">)</span> <span class="k">for</span> <span class="n">tree</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Trees</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Total number of terminal points of the arterial trees: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">numberofterminals</span><span class="p">)</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="Patient.PerfusionEndsNumber" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Patient.PerfusionEndsNumber">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">PerfusionEndsNumber</span><span class="signature">(self)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">PerfusionEndsNumber</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Calculating the number of terminal points per outlet.&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Perfusion</span><span class="o">.</span><span class="n">CouplingPoints</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Perfusion</span><span class="o">.</span><span class="n">CouplingPoints</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">NumberOfPialPoints</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Trees</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">EndNodes</span><span class="p">))</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="Patient.GenerateTree" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Patient.GenerateTree">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">GenerateTree</span><span class="signature">(self, node, cutoff=0.125)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">GenerateTree</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">cutoff</span><span class="o">=</span><span class="mf">0.125</span><span class="p">):</span>
        <span class="n">tree</span> <span class="o">=</span> <span class="n">Topology</span><span class="o">.</span><span class="n">Tree</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="n">tree</span><span class="o">.</span><span class="n">GenerateTree</span><span class="p">(</span><span class="n">cutoff</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Trees</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tree</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="Patient.TreesToTopology" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Patient.TreesToTopology">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">TreesToTopology</span><span class="signature">(self)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">TreesToTopology</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Creating a tree topology.&quot;</span><span class="p">)</span>
        <span class="n">treetop</span> <span class="o">=</span> <span class="n">Topology</span><span class="o">.</span><span class="n">Topology</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">tree</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Trees</span><span class="p">:</span>
            <span class="n">treetop</span><span class="o">.</span><span class="n">Nodes</span> <span class="o">+=</span> <span class="n">tree</span><span class="o">.</span><span class="n">Nodes</span>
        <span class="k">return</span> <span class="n">treetop</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="Patient.AddTreesToTop" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Patient.AddTreesToTop">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">AddTreesToTop</span><span class="signature">(self)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">AddTreesToTop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Adding trees to the vessel topology.&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">tree</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Trees</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tree</span><span class="o">.</span><span class="n">Nodes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">tree</span><span class="o">.</span><span class="n">ConnectTree</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Nodes</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">tree</span><span class="o">.</span><span class="n">Nodes</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">OutletNodes</span> <span class="o">+=</span> <span class="n">tree</span><span class="o">.</span><span class="n">EndNodes</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">OutletNodes</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">tree</span><span class="o">.</span><span class="n">InitialNode</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">BifurcationNodes</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">tree</span><span class="o">.</span><span class="n">BifurcationNodes</span><span class="p">)</span>
                <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">GetVesselNameFromNode</span><span class="p">(</span><span class="n">tree</span><span class="o">.</span><span class="n">InitialNode</span><span class="p">)</span>
                <span class="n">currentvesselnumber</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Vessels</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">ID</span>
                <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">SetID</span><span class="p">(</span><span class="n">currentvesselnumber</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tree</span><span class="o">.</span><span class="n">Vessels</span><span class="p">)]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Vessels</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">tree</span><span class="o">.</span><span class="n">Vessels</span><span class="p">)</span>
                <span class="p">[</span><span class="n">vessel</span><span class="o">.</span><span class="n">SetName</span><span class="p">(</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;Tree_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tree</span><span class="o">.</span><span class="n">Vessels</span><span class="p">)]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">UpdateTopology</span><span class="p">()</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="Patient.TreeEndsToEndNodes" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Patient.TreeEndsToEndNodes">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">TreeEndsToEndNodes</span><span class="signature">(self)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">TreeEndsToEndNodes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">tree</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Trees</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">OutletNodes</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">tree</span><span class="o">.</span><span class="n">InitialNode</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">OutletNodes</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">tree</span><span class="o">.</span><span class="n">EndNodes</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Removing resistance added by the merging of networks.&quot;</span><span class="p">)</span>
        <span class="n">visc</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ModelParameters</span><span class="p">[</span><span class="s2">&quot;BLOOD_VISC&quot;</span><span class="p">])</span>
        <span class="n">density</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ModelParameters</span><span class="p">[</span><span class="s2">&quot;Density&quot;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">tree</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Trees</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">GetVesselNameFromNode</span><span class="p">(</span><span class="n">tree</span><span class="o">.</span><span class="n">InitialNode</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">DownStreamResistance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">visc</span><span class="p">,</span> <span class="n">density</span><span class="p">)</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="Patient.LoadClusters" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Patient.LoadClusters">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">LoadClusters</span><span class="signature">(self)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">LoadClusters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">ModellingFolder</span> <span class="o">+</span> <span class="s2">&quot;Clusters.csv&quot;</span>
        <span class="n">clusters</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">)]</span>

        <span class="n">NodeID</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">clusters</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span>
        <span class="n">Position</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">clusters</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span>
        <span class="n">Position</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">2</span><span class="p">])]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">Position</span><span class="p">]</span>
        <span class="n">CouplingPointsN</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">clusters</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span>
        <span class="n">ClusterID</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">clusters</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span>
        <span class="n">areas</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">clusters</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span>
        <span class="n">majorvesselid</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">clusters</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span>
        <span class="c1"># nodes = [i[5] for i in clusters[1:]]</span>

        <span class="k">return</span> <span class="n">NodeID</span><span class="p">,</span> <span class="n">Position</span><span class="p">,</span> <span class="n">CouplingPointsN</span><span class="p">,</span> <span class="n">ClusterID</span><span class="p">,</span> <span class="n">areas</span><span class="p">,</span> <span class="n">majorvesselid</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="Patient.LoadSurfaceMapping" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Patient.LoadSurfaceMapping">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">LoadSurfaceMapping</span><span class="signature">(self, filename=&#39;SurfaceNodesMapping.csv&#39;)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">LoadSurfaceMapping</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s2">&quot;SurfaceNodesMapping.csv&quot;</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Loading surface mapping.&quot;</span><span class="p">)</span>
        <span class="n">file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">ModellingFolder</span> <span class="o">+</span> <span class="n">filename</span>
        <span class="k">if</span> <span class="n">file</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span> <span class="o">==</span> <span class="s2">&quot;csv&quot;</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">csvfile</span><span class="p">:</span>
                <span class="n">spamreader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">csvfile</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
                <span class="n">clusters</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">spamreader</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">csvfile</span><span class="p">:</span>
                <span class="n">spamreader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">csvfile</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">clusters</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">spamreader</span><span class="p">]</span>

        <span class="c1"># clusters = [i.strip(&#39;\n&#39;).split(&#39;,&#39;) for i in open(file)]</span>

        <span class="n">NodeID</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">clusters</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span>
        <span class="n">ClusterID</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">int</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">clusters</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span>
        <span class="n">Areas</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">clusters</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span>
        <span class="c1"># print(len(self.Perfusion.CouplingPoints) == len(set([y for x in ClusterID for y in x])))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Perfusion</span><span class="o">.</span><span class="n">CouplingPoints</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">y</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ClusterID</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">x</span><span class="p">])):</span>
            <span class="k">for</span> <span class="n">node</span><span class="p">,</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">NodeID</span><span class="p">,</span> <span class="n">ClusterID</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">id_number</span> <span class="ow">in</span> <span class="n">cluster</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">Perfusion</span><span class="o">.</span><span class="n">CouplingPoints</span><span class="p">[</span><span class="n">id_number</span><span class="p">]</span><span class="o">.</span><span class="n">SurfaceNodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">NodeID</span><span class="p">,</span> <span class="n">ClusterID</span><span class="p">,</span> <span class="n">Areas</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="Patient.DistributeFlowVertex" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Patient.DistributeFlowVertex">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">DistributeFlowVertex</span><span class="signature">(self)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">DistributeFlowVertex</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Distributing flow to the coupling points&quot;</span><span class="p">)</span>
        <span class="c1"># use this when the clustering is done with the primal graph, i.e. the vertices.</span>
        <span class="c1"># the only difference with the dual graph clustering is the type of data,</span>
        <span class="c1"># cell vs point and the cluster size might be different</span>
        <span class="n">nodeids</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">clusterids</span><span class="p">,</span> <span class="n">Areas</span><span class="p">,</span> <span class="n">majorvesselid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">LoadClusters</span><span class="p">()</span>
        <span class="n">surfacenodes</span><span class="p">,</span> <span class="n">clustermap</span><span class="p">,</span> <span class="n">triangleArea</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">LoadSurfaceMapping</span><span class="p">()</span>

        <span class="n">pointspercluster</span> <span class="o">=</span> <span class="p">[</span><span class="nb">sum</span><span class="p">([</span><span class="mi">1</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">clustermap</span> <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">id_number</span><span class="p">])</span> <span class="k">for</span> <span class="n">id_number</span> <span class="ow">in</span> <span class="n">clusterids</span><span class="p">]</span>

        <span class="n">reader</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkXMLPolyDataReader</span><span class="p">()</span>
        <span class="n">reader</span><span class="o">.</span><span class="n">SetFileName</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">ModellingFolder</span> <span class="o">+</span> <span class="s2">&quot;Clustering_mapped.vtp&quot;</span><span class="p">)</span>
        <span class="n">reader</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">()</span>
        <span class="n">resultsfolder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">ModellingFolder</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">resultsfolder</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">resultsfolder</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">timeindex</span><span class="p">,</span> <span class="n">timepoint</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">TimePoints</span><span class="p">):</span>
            <span class="n">flow</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkFloatArray</span><span class="p">()</span>
            <span class="n">flow</span><span class="o">.</span><span class="n">SetNumberOfComponents</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">flow</span><span class="o">.</span><span class="n">SetName</span><span class="p">(</span><span class="s2">&quot;Flow&quot;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">surfacenode</span> <span class="ow">in</span> <span class="n">surfacenodes</span><span class="p">:</span>
                <span class="n">cluster</span> <span class="o">=</span> <span class="n">clustermap</span><span class="p">[</span><span class="n">surfacenode</span><span class="p">]</span>
                <span class="n">fractionflow</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">cluster</span><span class="p">:</span>
                    <span class="n">outlet</span> <span class="o">=</span> <span class="n">nodeids</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">outletflow</span> <span class="o">=</span> <span class="n">timepoint</span><span class="o">.</span><span class="n">Flow</span><span class="p">[</span><span class="n">outlet</span><span class="p">]</span>
                    <span class="n">clustersize</span> <span class="o">=</span> <span class="n">pointspercluster</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">fractionflow</span> <span class="o">+=</span> <span class="n">outletflow</span> <span class="o">/</span> <span class="n">clustersize</span>

                <span class="n">flow</span><span class="o">.</span><span class="n">InsertNextValue</span><span class="p">(</span><span class="n">fractionflow</span><span class="p">)</span>

            <span class="n">writer</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkXMLPolyDataWriter</span><span class="p">()</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">resultsfolder</span> <span class="o">+</span> <span class="s2">&quot;FlowDistributed&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">timeindex</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.vtp&quot;</span>
            <span class="n">writer</span><span class="o">.</span><span class="n">SetFileName</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
            <span class="n">data</span><span class="o">.</span><span class="n">GetPointData</span><span class="p">()</span><span class="o">.</span><span class="n">AddArray</span><span class="p">(</span><span class="n">flow</span><span class="p">)</span>
            <span class="n">writer</span><span class="o">.</span><span class="n">SetInputData</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">writer</span><span class="o">.</span><span class="n">Write</span><span class="p">()</span>

        <span class="n">meanflow</span> <span class="o">=</span> <span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">tp</span><span class="o">.</span><span class="n">Flow</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="k">for</span> <span class="n">tp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">TimePoints</span><span class="p">])</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodeids</span><span class="p">]</span>
        <span class="n">flow</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkFloatArray</span><span class="p">()</span>
        <span class="n">flow</span><span class="o">.</span><span class="n">SetNumberOfComponents</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">flow</span><span class="o">.</span><span class="n">SetName</span><span class="p">(</span><span class="s2">&quot;Flow&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">surfacenode</span> <span class="ow">in</span> <span class="n">surfacenodes</span><span class="p">:</span>
            <span class="n">cluster</span> <span class="o">=</span> <span class="n">clustermap</span><span class="p">[</span><span class="n">surfacenode</span><span class="p">]</span>
            <span class="n">fractionflow</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">cluster</span><span class="p">:</span>
                <span class="n">outletflow</span> <span class="o">=</span> <span class="n">meanflow</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">clustersize</span> <span class="o">=</span> <span class="n">pointspercluster</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">fractionflow</span> <span class="o">+=</span> <span class="n">outletflow</span> <span class="o">/</span> <span class="n">clustersize</span>
            <span class="n">flow</span><span class="o">.</span><span class="n">InsertNextValue</span><span class="p">(</span><span class="n">fractionflow</span><span class="p">)</span>

        <span class="n">writer</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkXMLPolyDataWriter</span><span class="p">()</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">resultsfolder</span> <span class="o">+</span> <span class="s2">&quot;FlowDistributedMean.vtp&quot;</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">SetFileName</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">data</span><span class="o">.</span><span class="n">GetPointData</span><span class="p">()</span><span class="o">.</span><span class="n">AddArray</span><span class="p">(</span><span class="n">flow</span><span class="p">)</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">SetInputData</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">Write</span><span class="p">()</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="Patient.GetMeanFlowRates" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Patient.GetMeanFlowRates">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">GetMeanFlowRates</span><span class="signature">(self)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">GetMeanFlowRates</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">nodeids</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">clusterids</span><span class="p">,</span> <span class="n">areas</span><span class="p">,</span> <span class="n">majorvesselid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">LoadClusters</span><span class="p">()</span>
        <span class="n">time</span> <span class="o">=</span> <span class="p">[</span><span class="n">tp</span><span class="o">.</span><span class="n">WT</span> <span class="k">for</span> <span class="n">tp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">TimePoints</span><span class="p">]</span>
        <span class="n">totalflow</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">regionsflowvolume</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">)]</span>
        <span class="n">clusterflowrate</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">clusterPressure</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">nodeids</span><span class="p">):</span>
            <span class="n">flowdatanode</span> <span class="o">=</span> <span class="p">[</span><span class="n">tp</span><span class="o">.</span><span class="n">Flow</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="k">for</span> <span class="n">tp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">TimePoints</span><span class="p">]</span>
            <span class="n">flowvolume</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="n">flowdatanode</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span>
            <span class="n">flowrate</span> <span class="o">=</span> <span class="n">flowvolume</span> <span class="o">/</span> <span class="n">time</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">totalflow</span> <span class="o">+=</span> <span class="n">flowvolume</span>
            <span class="n">major</span> <span class="o">=</span> <span class="n">majorvesselid</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span>
            <span class="n">regionsflowvolume</span><span class="p">[</span><span class="n">major</span><span class="p">]</span> <span class="o">+=</span> <span class="n">flowvolume</span>
            <span class="n">clusterflowrate</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">flowrate</span><span class="p">)</span>

            <span class="n">pressuredatanode</span> <span class="o">=</span> <span class="p">[</span><span class="n">tp</span><span class="o">.</span><span class="n">Pressure</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="k">for</span> <span class="n">tp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">TimePoints</span><span class="p">]</span>
            <span class="n">pressureall</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="n">pressuredatanode</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span>
            <span class="n">pressurefinal</span> <span class="o">=</span> <span class="n">pressureall</span> <span class="o">/</span> <span class="n">time</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">clusterPressure</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pressurefinal</span><span class="p">)</span>

        <span class="n">regionsflowrateregion</span> <span class="o">=</span> <span class="p">[</span><span class="n">element</span> <span class="o">/</span> <span class="n">time</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">regionsflowvolume</span><span class="p">]</span>
        <span class="n">sumflow</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">flow</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">flow</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">clusterflowrate</span><span class="p">)</span> <span class="k">if</span> <span class="n">majorvesselid</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">regionsflowrateregion</span><span class="p">,</span> <span class="n">clusterflowrate</span><span class="p">,</span> <span class="n">clusterPressure</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="Patient.DistributeFlowTriangles" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Patient.DistributeFlowTriangles">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">DistributeFlowTriangles</span><span class="signature">(self)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">DistributeFlowTriangles</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Distributing flow to the coupling points&quot;</span><span class="p">)</span>
        <span class="c1"># use this when the clustering is done with the primal graph, i.e. the vertices.</span>
        <span class="c1"># the only difference with the dual graph clustering is the type of data,</span>
        <span class="c1"># cell vs point and the cluster size might be different</span>
        <span class="n">nodeids</span><span class="p">,</span> <span class="n">positions</span><span class="p">,</span> <span class="n">couplingpointsN</span><span class="p">,</span> <span class="n">clusterids</span><span class="p">,</span> <span class="n">areas</span><span class="p">,</span> <span class="n">majorvesselid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">LoadClusters</span><span class="p">()</span>
        <span class="n">surfacenodes</span><span class="p">,</span> <span class="n">clustermap</span><span class="p">,</span> <span class="n">triangleAreas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">LoadSurfaceMapping</span><span class="p">()</span>

        <span class="n">reader</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkXMLPolyDataReader</span><span class="p">()</span>
        <span class="n">reader</span><span class="o">.</span><span class="n">SetFileName</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">ModellingFolder</span> <span class="o">+</span> <span class="s2">&quot;Clustering.vtp&quot;</span><span class="p">)</span>
        <span class="n">reader</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">()</span>
        <span class="n">outputfolder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">ModellingFolder</span> <span class="o">+</span> <span class="s2">&quot;TimeSeries/&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">outputfolder</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">outputfolder</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">timeindex</span><span class="p">,</span> <span class="n">timepoint</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">TimePoints</span><span class="p">):</span>
            <span class="n">flow</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkFloatArray</span><span class="p">()</span>
            <span class="n">flow</span><span class="o">.</span><span class="n">SetNumberOfComponents</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">flow</span><span class="o">.</span><span class="n">SetName</span><span class="p">(</span><span class="s2">&quot;Volume Flow Rate (mL/s)&quot;</span><span class="p">)</span>

            <span class="n">pressure</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkFloatArray</span><span class="p">()</span>
            <span class="n">pressure</span><span class="o">.</span><span class="n">SetNumberOfComponents</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">pressure</span><span class="o">.</span><span class="n">SetName</span><span class="p">(</span><span class="s2">&quot;Pressure (Pa)&quot;</span><span class="p">)</span>

            <span class="n">flowrate</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkFloatArray</span><span class="p">()</span>
            <span class="n">flowrate</span><span class="o">.</span><span class="n">SetNumberOfComponents</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">flowrate</span><span class="o">.</span><span class="n">SetName</span><span class="p">(</span><span class="s2">&quot;Flow Velocity (m/s)&quot;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">clusters</span><span class="p">,</span> <span class="n">surfacenode</span><span class="p">,</span> <span class="n">triangleArea</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">clustermap</span><span class="p">,</span> <span class="n">surfacenodes</span><span class="p">,</span> <span class="n">triangleAreas</span><span class="p">):</span>
                <span class="n">FlowRatePerOutlet</span> <span class="o">=</span> <span class="p">[</span><span class="n">timepoint</span><span class="o">.</span><span class="n">Flow</span><span class="p">[</span><span class="n">nodeids</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">/</span> <span class="n">areas</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">clusters</span><span class="p">]</span>
                <span class="n">PressurePerCluster</span> <span class="o">=</span> <span class="p">[</span><span class="n">timepoint</span><span class="o">.</span><span class="n">Pressure</span><span class="p">[</span><span class="n">nodeids</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">clusters</span><span class="p">]</span>
                <span class="n">FlowPerTriangle</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">FlowRatePerOutlet</span><span class="p">)</span> <span class="o">*</span> <span class="n">triangleArea</span>

                <span class="n">flow</span><span class="o">.</span><span class="n">InsertNextValue</span><span class="p">(</span><span class="n">FlowPerTriangle</span><span class="p">)</span>
                <span class="n">flowrate</span><span class="o">.</span><span class="n">InsertNextValue</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">FlowRatePerOutlet</span><span class="p">))</span>
                <span class="n">pressure</span><span class="o">.</span><span class="n">InsertNextValue</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">PressurePerCluster</span><span class="p">))</span>

            <span class="n">writer</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkXMLPolyDataWriter</span><span class="p">()</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">outputfolder</span> <span class="o">+</span> <span class="s2">&quot;FlowDistributed&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">timeindex</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.vtp&quot;</span>
            <span class="n">writer</span><span class="o">.</span><span class="n">SetFileName</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
            <span class="n">data</span><span class="o">.</span><span class="n">GetCellData</span><span class="p">()</span><span class="o">.</span><span class="n">AddArray</span><span class="p">(</span><span class="n">flow</span><span class="p">)</span>
            <span class="n">data</span><span class="o">.</span><span class="n">GetCellData</span><span class="p">()</span><span class="o">.</span><span class="n">AddArray</span><span class="p">(</span><span class="n">flowrate</span><span class="p">)</span>
            <span class="n">data</span><span class="o">.</span><span class="n">GetCellData</span><span class="p">()</span><span class="o">.</span><span class="n">AddArray</span><span class="p">(</span><span class="n">pressure</span><span class="p">)</span>
            <span class="n">writer</span><span class="o">.</span><span class="n">SetInputData</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">writer</span><span class="o">.</span><span class="n">Write</span><span class="p">()</span>

        <span class="n">time</span> <span class="o">=</span> <span class="p">[</span><span class="n">tp</span><span class="o">.</span><span class="n">WT</span> <span class="k">for</span> <span class="n">tp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">TimePoints</span><span class="p">]</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">meanflowrate</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetMeanFlowRates</span><span class="p">()</span>
        <span class="n">flow</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkFloatArray</span><span class="p">()</span>
        <span class="n">flow</span><span class="o">.</span><span class="n">SetNumberOfComponents</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">flow</span><span class="o">.</span><span class="n">SetName</span><span class="p">(</span><span class="s2">&quot;Volume Flow Rate (mL/s)&quot;</span><span class="p">)</span>
        <span class="n">flowrate</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkFloatArray</span><span class="p">()</span>
        <span class="n">flowrate</span><span class="o">.</span><span class="n">SetNumberOfComponents</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">flowrate</span><span class="o">.</span><span class="n">SetName</span><span class="p">(</span><span class="s2">&quot;Flow Velocity (m/s)&quot;</span><span class="p">)</span>
        <span class="n">pressure</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkFloatArray</span><span class="p">()</span>
        <span class="n">pressure</span><span class="o">.</span><span class="n">SetNumberOfComponents</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">pressure</span><span class="o">.</span><span class="n">SetName</span><span class="p">(</span><span class="s2">&quot;Pressure (Pa)&quot;</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">ModellingFolder</span> <span class="o">+</span> <span class="s2">&quot;Results.pvd&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&lt;?xml version=</span><span class="se">\&quot;</span><span class="s2">1.0</span><span class="se">\&quot;</span><span class="s2">?&gt;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                <span class="s2">&quot;&lt;VTKFile type=</span><span class="se">\&quot;</span><span class="s2">Collection</span><span class="se">\&quot;</span><span class="s2"> version=</span><span class="se">\&quot;</span><span class="s2">0.1</span><span class="se">\&quot;</span><span class="s2"> byte_order=</span><span class="se">\&quot;</span><span class="s2">LittleEndian</span><span class="se">\&quot;</span><span class="s2"> compressor=</span><span class="se">\&quot;</span><span class="s2">vtkZLibDataCompressor</span><span class="se">\&quot;</span><span class="s2">&gt;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&lt;Collection&gt;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">timeindex</span><span class="p">,</span> <span class="n">timepoint</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">TimePoints</span><span class="p">):</span>
                <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;TimeSeries/FlowDistributed&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">timeindex</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.vtp&quot;</span>
                <span class="n">time</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">timepoint</span><span class="o">.</span><span class="n">WT</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&lt;DataSet timestep=</span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">time</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2"> group=</span><span class="se">\&quot;\&quot;</span><span class="s2"> part=</span><span class="se">\&quot;</span><span class="s2">0</span><span class="se">\&quot;</span><span class="s2"> file=</span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">/&gt;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&lt;/Collection&gt;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&lt;/VTKFile&gt;&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">clusters</span><span class="p">,</span> <span class="n">surfacenode</span><span class="p">,</span> <span class="n">triangleArea</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">clustermap</span><span class="p">,</span> <span class="n">surfacenodes</span><span class="p">,</span> <span class="n">triangleAreas</span><span class="p">):</span>
            <span class="n">FlowRatePerOutlet</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">MeanVolumeFlowRatePerNode</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">nodeids</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">/</span> <span class="n">areas</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">clusters</span><span class="p">]</span>
            <span class="n">PressurePerCluster</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">MeanPressurePerNode</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">nodeids</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">clusters</span><span class="p">]</span>
            <span class="n">FlowPerTriangle</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">FlowRatePerOutlet</span><span class="p">)</span> <span class="o">*</span> <span class="n">triangleArea</span>

            <span class="n">flow</span><span class="o">.</span><span class="n">InsertNextValue</span><span class="p">(</span><span class="n">FlowPerTriangle</span><span class="p">)</span>
            <span class="n">flowrate</span><span class="o">.</span><span class="n">InsertNextValue</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">FlowRatePerOutlet</span><span class="p">))</span>
            <span class="n">pressure</span><span class="o">.</span><span class="n">InsertNextValue</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">PressurePerCluster</span><span class="p">))</span>

        <span class="n">writer</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkXMLPolyDataWriter</span><span class="p">()</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">ModellingFolder</span> <span class="o">+</span> <span class="s2">&quot;FlowDistributedMean.vtp&quot;</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">SetFileName</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">data</span><span class="o">.</span><span class="n">GetCellData</span><span class="p">()</span><span class="o">.</span><span class="n">AddArray</span><span class="p">(</span><span class="n">flow</span><span class="p">)</span>
        <span class="n">data</span><span class="o">.</span><span class="n">GetCellData</span><span class="p">()</span><span class="o">.</span><span class="n">AddArray</span><span class="p">(</span><span class="n">flowrate</span><span class="p">)</span>
        <span class="n">data</span><span class="o">.</span><span class="n">GetCellData</span><span class="p">()</span><span class="o">.</span><span class="n">AddArray</span><span class="p">(</span><span class="n">pressure</span><span class="p">)</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">SetInputData</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">Write</span><span class="p">()</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="Patient.WriteTimeseriesVessels" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Patient.WriteTimeseriesVessels">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">WriteTimeseriesVessels</span><span class="signature">(self)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">WriteTimeseriesVessels</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">reader</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkXMLPolyDataReader</span><span class="p">()</span>
        <span class="n">reader</span><span class="o">.</span><span class="n">SetFileName</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">ModellingFolder</span> <span class="o">+</span> <span class="s2">&quot;Topology.vtp&quot;</span><span class="p">)</span>
        <span class="n">reader</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">()</span>
        <span class="n">outputfolder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">ModellingFolder</span> <span class="o">+</span> <span class="s2">&quot;TimeSeriesBF/&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">outputfolder</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">outputfolder</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">timeindex</span><span class="p">,</span> <span class="n">timepoint</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">Time</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">flow</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkFloatArray</span><span class="p">()</span>
            <span class="n">flow</span><span class="o">.</span><span class="n">SetNumberOfComponents</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">flow</span><span class="o">.</span><span class="n">SetName</span><span class="p">(</span><span class="s2">&quot;Volume Flowrate (mL/s)&quot;</span><span class="p">)</span>

            <span class="n">velocity</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkFloatArray</span><span class="p">()</span>
            <span class="n">velocity</span><span class="o">.</span><span class="n">SetNumberOfComponents</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">velocity</span><span class="o">.</span><span class="n">SetName</span><span class="p">(</span><span class="s2">&quot;Velocity (m/s)&quot;</span><span class="p">)</span>

            <span class="n">pressure</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkFloatArray</span><span class="p">()</span>
            <span class="n">pressure</span><span class="o">.</span><span class="n">SetNumberOfComponents</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">pressure</span><span class="o">.</span><span class="n">SetName</span><span class="p">(</span><span class="s2">&quot;Pressure (pa)&quot;</span><span class="p">)</span>

            <span class="n">radius</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkFloatArray</span><span class="p">()</span>
            <span class="n">radius</span><span class="o">.</span><span class="n">SetNumberOfComponents</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">radius</span><span class="o">.</span><span class="n">SetName</span><span class="p">(</span><span class="s2">&quot;Radius (mm)&quot;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">nodeindex</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">Pressure</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])):</span>
                <span class="n">flow</span><span class="o">.</span><span class="n">InsertNextValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">VolumeFlowRate</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">nodeindex</span><span class="p">][</span><span class="n">timeindex</span><span class="p">])</span>
                <span class="n">velocity</span><span class="o">.</span><span class="n">InsertNextValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">Velocity</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">nodeindex</span><span class="p">][</span><span class="n">timeindex</span><span class="p">])</span>
                <span class="n">pressure</span><span class="o">.</span><span class="n">InsertNextValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">Pressure</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">nodeindex</span><span class="p">][</span><span class="n">timeindex</span><span class="p">])</span>
                <span class="n">radius</span><span class="o">.</span><span class="n">InsertNextValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">Radius</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">nodeindex</span><span class="p">][</span><span class="n">timeindex</span><span class="p">])</span>

            <span class="n">writer</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkXMLPolyDataWriter</span><span class="p">()</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">outputfolder</span> <span class="o">+</span> <span class="s2">&quot;Bloodflow&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">timeindex</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.vtp&quot;</span>
            <span class="n">writer</span><span class="o">.</span><span class="n">SetFileName</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
            <span class="n">data</span><span class="o">.</span><span class="n">GetPointData</span><span class="p">()</span><span class="o">.</span><span class="n">AddArray</span><span class="p">(</span><span class="n">flow</span><span class="p">)</span>
            <span class="n">data</span><span class="o">.</span><span class="n">GetPointData</span><span class="p">()</span><span class="o">.</span><span class="n">AddArray</span><span class="p">(</span><span class="n">velocity</span><span class="p">)</span>
            <span class="n">data</span><span class="o">.</span><span class="n">GetPointData</span><span class="p">()</span><span class="o">.</span><span class="n">AddArray</span><span class="p">(</span><span class="n">pressure</span><span class="p">)</span>
            <span class="n">data</span><span class="o">.</span><span class="n">GetPointData</span><span class="p">()</span><span class="o">.</span><span class="n">AddArray</span><span class="p">(</span><span class="n">radius</span><span class="p">)</span>
            <span class="n">writer</span><span class="o">.</span><span class="n">SetInputData</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">writer</span><span class="o">.</span><span class="n">Write</span><span class="p">()</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">ModellingFolder</span> <span class="o">+</span> <span class="s2">&quot;ResultsBF.pvd&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&lt;?xml version=</span><span class="se">\&quot;</span><span class="s2">1.0</span><span class="se">\&quot;</span><span class="s2">?&gt;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                <span class="s2">&quot;&lt;VTKFile type=</span><span class="se">\&quot;</span><span class="s2">Collection</span><span class="se">\&quot;</span><span class="s2"> version=</span><span class="se">\&quot;</span><span class="s2">0.1</span><span class="se">\&quot;</span><span class="s2"> byte_order=</span><span class="se">\&quot;</span><span class="s2">LittleEndian</span><span class="se">\&quot;</span><span class="s2"> compressor=</span><span class="se">\&quot;</span><span class="s2">vtkZLibDataCompressor</span><span class="se">\&quot;</span><span class="s2">&gt;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&lt;Collection&gt;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">timeindex</span><span class="p">,</span> <span class="n">timepoint</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">TimePoints</span><span class="p">):</span>
                <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;TimeSeriesBF/Bloodflow&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">timeindex</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.vtp&quot;</span>
                <span class="n">time</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">timepoint</span><span class="o">.</span><span class="n">WT</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&lt;DataSet timestep=</span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">time</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2"> group=</span><span class="se">\&quot;\&quot;</span><span class="s2"> part=</span><span class="se">\&quot;</span><span class="s2">0</span><span class="se">\&quot;</span><span class="s2"> file=</span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">/&gt;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&lt;/Collection&gt;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&lt;/VTKFile&gt;&quot;</span><span class="p">)</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="Patient.ImportClotNodeFile" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Patient.ImportClotNodeFile">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">ImportClotNodeFile</span><span class="signature">(self)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">ImportClotNodeFile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">ModellingFolder</span> <span class="o">+</span> <span class="s2">&quot;Clots.txt&quot;</span>
        <span class="n">clotdata</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">)][</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">ClotID</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">clotdata</span><span class="p">]</span>
        <span class="n">NodeID</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">clotdata</span><span class="p">]</span>
        <span class="n">Permeability</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">clotdata</span><span class="p">]</span>
        <span class="n">Porosity</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">clotdata</span><span class="p">]</span>
        <span class="n">uniqueclots</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">ClotID</span><span class="p">)</span>
        <span class="n">clots</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">uniqueclots</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">id_number</span> <span class="ow">in</span> <span class="n">uniqueclots</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">clotid</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ClotID</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">clotid</span> <span class="o">==</span> <span class="n">id_number</span><span class="p">:</span>
                    <span class="n">clots</span><span class="p">[</span><span class="n">id_number</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">NodeID</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">Permeability</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">Porosity</span><span class="p">[</span><span class="n">index</span><span class="p">]))</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="Patient.ImportClots" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Patient.ImportClots">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">ImportClots</span><span class="signature">(self, file=&#39;&#39;)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">ImportClots</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">InputFolder</span> <span class="o">+</span> <span class="s2">&quot;Clots.txt&quot;</span>
        <span class="c1"># first add new nodes with at the location of the clot</span>
        <span class="c1"># then map the clot to the node</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">GeneralFunctions</span><span class="o">.</span><span class="n">is_non_zero_file</span><span class="p">(</span><span class="n">file</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No clotfile found.&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Importing Clots.&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="k">as</span> <span class="n">csvfile</span><span class="p">:</span>
            <span class="n">reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictReader</span><span class="p">(</span><span class="n">csvfile</span><span class="p">)</span>
            <span class="n">Clots</span> <span class="o">=</span> <span class="p">[</span><span class="n">clot</span> <span class="k">for</span> <span class="n">clot</span> <span class="ow">in</span> <span class="n">reader</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">clot</span> <span class="ow">in</span> <span class="n">Clots</span><span class="p">:</span>
            <span class="n">vesselname</span> <span class="o">=</span> <span class="n">clot</span><span class="p">[</span><span class="s1">&#39;Vesselname&#39;</span><span class="p">]</span>
            <span class="n">location</span> <span class="o">=</span> <span class="n">clot</span><span class="p">[</span><span class="s1">&#39;Clotlocation(mm)&#39;</span><span class="p">]</span>
            <span class="n">length</span> <span class="o">=</span> <span class="n">clot</span><span class="p">[</span><span class="s1">&#39;Clotlength(mm)&#39;</span><span class="p">]</span>
            <span class="n">permeability</span> <span class="o">=</span> <span class="n">clot</span><span class="p">[</span><span class="s1">&#39;Permeability&#39;</span><span class="p">]</span>
            <span class="n">porosity</span> <span class="o">=</span> <span class="n">clot</span><span class="p">[</span><span class="s1">&#39;Porosity&#39;</span><span class="p">]</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">vessel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">VesselAtlas</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">vesselname</span><span class="p">)]</span>
                <span class="n">numbergridnodes</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">vessel</span><span class="o">.</span><span class="n">Length</span> <span class="o">/</span> <span class="mf">0.5</span><span class="p">))</span>  <span class="c1"># update resolution to about 0.5mm</span>
                <span class="n">vessel</span><span class="o">.</span><span class="n">UpdateResolution</span><span class="p">(</span><span class="n">numbergridnodes</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">UpdateTopology</span><span class="p">()</span>
                <span class="n">location</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">permeability</span><span class="p">,</span> <span class="n">porosity</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">location</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">length</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">permeability</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span>
                    <span class="n">porosity</span><span class="p">)</span>

                <span class="c1"># this will break compatibility with the pulsatile model so only do this when using the steady state model.</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ModelParameters</span><span class="p">[</span><span class="s2">&quot;Model&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Steady&quot;</span><span class="p">:</span>
                    <span class="n">vessel</span><span class="o">.</span><span class="n">add_node_interp_length</span><span class="p">(</span><span class="n">location</span><span class="p">)</span>
                    <span class="n">vessel</span><span class="o">.</span><span class="n">add_node_interp_length</span><span class="p">(</span><span class="n">location</span><span class="o">+</span><span class="n">length</span><span class="p">)</span>

                <span class="c1"># nearest node in the vessel</span>
                <span class="n">clotnodes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                <span class="c1"># boundary</span>
                <span class="n">boundary1</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">argmin</span><span class="p">([</span><span class="nb">abs</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">LengthAlongVessel</span> <span class="o">-</span> <span class="n">location</span><span class="p">)</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">])</span>
                <span class="n">clotnodes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="n">boundary1</span><span class="p">])</span>
                <span class="c1"># internal nodes</span>
                <span class="p">[</span><span class="n">clotnodes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span> <span class="k">if</span>
                 <span class="n">node</span><span class="o">.</span><span class="n">LengthAlongVessel</span> <span class="o">&gt;=</span> <span class="n">location</span> <span class="ow">and</span> <span class="n">node</span><span class="o">.</span><span class="n">LengthAlongVessel</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">location</span> <span class="o">+</span> <span class="n">length</span><span class="p">)]</span>
                <span class="c1"># other boundary</span>
                <span class="n">boundary2</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span>
                    <span class="p">[</span><span class="nb">abs</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">LengthAlongVessel</span> <span class="o">-</span> <span class="p">(</span><span class="n">location</span> <span class="o">+</span> <span class="n">length</span><span class="p">))</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">])</span>
                <span class="n">clotnodes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="n">boundary2</span><span class="p">])</span>

                <span class="n">clotnodes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">clotnodes</span><span class="p">)</span>
                <span class="c1"># if clot extends past a bifurcation, map the clot nodes to the same clot</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Clots</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">clotnodes</span><span class="p">,</span> <span class="n">permeability</span><span class="p">,</span> <span class="n">porosity</span><span class="p">,</span> <span class="n">length</span><span class="p">))</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: Likely caused by the clot file listing non-existent vessels.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">UpdateTopology</span><span class="p">()</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="Patient.ShowResults" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Patient.ShowResults">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">ShowResults</span><span class="signature">(self)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">ShowResults</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># wait for results to be saved</span>
        <span class="c1"># while not is_non_zero_file(self.Results.File):</span>
        <span class="c1">#     print(&quot;Waiting for data.&quot;)</span>
        <span class="c1">#     time.sleep(1)</span>
        <span class="c1"># self.Results.LoadResults(self.Results.File)</span>
        <span class="c1"># open the results window</span>
        <span class="n">app</span> <span class="o">=</span> <span class="n">Results</span><span class="o">.</span><span class="n">QtWidgets</span><span class="o">.</span><span class="n">QApplication</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span>
        <span class="n">win</span> <span class="o">=</span> <span class="n">Results</span><span class="o">.</span><span class="n">ResultsWindow</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">app</span><span class="o">.</span><span class="n">exec</span><span class="p">()</span>
        <span class="c1"># sys.exit(app.exec_())</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="Patient.MappingSixMajorArteries" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Patient.MappingSixMajorArteries">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">MappingSixMajorArteries</span><span class="signature">(self)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">MappingSixMajorArteries</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Follow the major cerebreal arteries upstream and return the outlets.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Mapping the outlets of the six major cerebral arteries.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">RedefineDirection</span><span class="p">()</span>
        <span class="n">arteries</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;R. ACA, A2&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;R. MCA&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;L. MCA&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;L. ACA, A2&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;R. PCA, P2&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;L. PCA, P2&quot;</span><span class="p">,</span> <span class="p">]</span>

        <span class="n">upstream</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="n">arteries</span><span class="p">:</span>
            <span class="n">upstream</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">GetDownstreamVessels</span><span class="p">(</span><span class="n">vessel</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">region</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">upstream</span><span class="p">):</span>
            <span class="n">vessels</span> <span class="o">=</span> <span class="n">region</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="n">vessels</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">:</span>
                    <span class="n">node</span><span class="o">.</span><span class="n">MajorVesselID</span> <span class="o">=</span> <span class="n">index</span> <span class="o">+</span> <span class="mi">2</span>

        <span class="n">artertydict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Nodes</span><span class="p">):</span>
            <span class="n">artertydict</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">MajorVesselID</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Perfusion</span><span class="o">.</span><span class="n">MajorArteries</span> <span class="o">=</span> <span class="n">artertydict</span>

        <span class="n">outletarteries</span> <span class="o">=</span> <span class="p">[</span><span class="n">artertydict</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">OutletNodes</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">indexregion</span><span class="p">,</span> <span class="n">region</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">arteries</span><span class="p">):</span>
            <span class="n">numberofoutlets</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="n">out</span> <span class="k">for</span> <span class="n">out</span> <span class="ow">in</span> <span class="n">outletarteries</span> <span class="k">if</span> <span class="n">out</span> <span class="o">==</span> <span class="n">indexregion</span> <span class="o">+</span> <span class="mi">2</span><span class="p">])</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">region</span> <span class="o">+</span> <span class="s2">&quot;: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">numberofoutlets</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; outlets&quot;</span><span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><p>Follow the major cerebreal arteries upstream and return the outlets.</p>
</div>


                            </div>
                            <div id="Patient.ExportDualClustering" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Patient.ExportDualClustering">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">ExportDualClustering</span><span class="signature">(self, primal=&#39;GMsurface.vtp&#39;, dual=&#39;Clustering_mapped.vtp&#39;)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">ExportDualClustering</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">primal</span><span class="o">=</span><span class="s2">&quot;GMsurface.vtp&quot;</span><span class="p">,</span> <span class="n">dual</span><span class="o">=</span><span class="s2">&quot;Clustering_mapped.vtp&quot;</span><span class="p">):</span>
        <span class="c1"># import the primal graph</span>
        <span class="k">if</span> <span class="n">primal</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span> <span class="o">==</span> <span class="s2">&quot;vtp&quot;</span><span class="p">:</span>
            <span class="n">reader</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkXMLPolyDataReader</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">primal</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span> <span class="o">==</span> <span class="s2">&quot;ply&quot;</span><span class="p">:</span>
            <span class="n">reader</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkPLYReader</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: unreadable file.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">1</span>

        <span class="n">reader</span><span class="o">.</span><span class="n">SetFileName</span><span class="p">(</span><span class="n">primal</span><span class="p">)</span>
        <span class="n">reader</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span>
        <span class="n">primaldata</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">()</span>

        <span class="c1"># import the dual graph with the triangle colour</span>
        <span class="k">if</span> <span class="n">dual</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span> <span class="o">==</span> <span class="s2">&quot;vtp&quot;</span><span class="p">:</span>
            <span class="n">reader</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkXMLPolyDataReader</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">dual</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span> <span class="o">==</span> <span class="s2">&quot;ply&quot;</span><span class="p">:</span>
            <span class="n">reader</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkPLYReader</span><span class="p">()</span>
        <span class="n">reader</span><span class="o">.</span><span class="n">SetFileName</span><span class="p">(</span><span class="n">dual</span><span class="p">)</span>
        <span class="n">reader</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span>

        <span class="n">narray</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">()</span><span class="o">.</span><span class="n">GetPointData</span><span class="p">()</span><span class="o">.</span><span class="n">GetNumberOfArrays</span><span class="p">()</span>
        <span class="c1"># vertex colour of the dual graph is the triangle colour of the primal graph</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">narray</span><span class="p">):</span>
            <span class="n">arrayname</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">()</span><span class="o">.</span><span class="n">GetPointData</span><span class="p">()</span><span class="o">.</span><span class="n">GetArrayName</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">arrayname</span> <span class="o">==</span> <span class="s2">&quot;Colour&quot;</span><span class="p">:</span>
                <span class="n">clusteringdata</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">()</span><span class="o">.</span><span class="n">GetPointData</span><span class="p">()</span><span class="o">.</span><span class="n">GetArray</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">primaldata</span><span class="o">.</span><span class="n">GetCellData</span><span class="p">()</span><span class="o">.</span><span class="n">AddArray</span><span class="p">(</span><span class="n">clusteringdata</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">arrayname</span> <span class="o">==</span> <span class="s2">&quot;Major Cerebral Artery&quot;</span><span class="p">:</span>
                <span class="n">clusteringdata</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">()</span><span class="o">.</span><span class="n">GetPointData</span><span class="p">()</span><span class="o">.</span><span class="n">GetArray</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">primaldata</span><span class="o">.</span><span class="n">GetCellData</span><span class="p">()</span><span class="o">.</span><span class="n">AddArray</span><span class="p">(</span><span class="n">clusteringdata</span><span class="p">)</span>

        <span class="c1"># export to new file</span>
        <span class="n">writer</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkXMLPolyDataWriter</span><span class="p">()</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">ModellingFolder</span> <span class="o">+</span> <span class="s2">&quot;ClusteringByTriangle.vtp&quot;</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">SetFileName</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">SetInputData</span><span class="p">(</span><span class="n">primaldata</span><span class="p">)</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">Write</span><span class="p">()</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="Patient.ExportTriangleFlowData" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Patient.ExportTriangleFlowData">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">ExportTriangleFlowData</span><span class="signature">(self)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">ExportTriangleFlowData</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Exporting Flow Data.&quot;</span><span class="p">)</span>
        <span class="n">file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">ModellingFolder</span> <span class="o">+</span> <span class="s2">&quot;FlowDistributedMean.vtp&quot;</span>

        <span class="n">reader</span> <span class="o">=</span> <span class="n">vtk</span><span class="o">.</span><span class="n">vtkXMLPolyDataReader</span><span class="p">()</span>
        <span class="n">reader</span><span class="o">.</span><span class="n">SetFileName</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
        <span class="n">reader</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span>

        <span class="n">narray</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">()</span><span class="o">.</span><span class="n">GetCellData</span><span class="p">()</span><span class="o">.</span><span class="n">GetNumberOfArrays</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">narray</span><span class="p">):</span>
            <span class="n">arrayname</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">()</span><span class="o">.</span><span class="n">GetCellData</span><span class="p">()</span><span class="o">.</span><span class="n">GetArrayName</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">arrayname</span> <span class="o">==</span> <span class="s2">&quot;Major Cerebral Artery&quot;</span><span class="p">:</span>
                <span class="n">mapCA</span> <span class="o">=</span> <span class="n">vtk_to_numpy</span><span class="p">(</span><span class="n">reader</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">()</span><span class="o">.</span><span class="n">GetCellData</span><span class="p">()</span><span class="o">.</span><span class="n">GetArray</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">arrayname</span> <span class="o">==</span> <span class="s2">&quot;Volume Flow Rate (mL/s)&quot;</span><span class="p">:</span>
                <span class="n">flowdata</span> <span class="o">=</span> <span class="n">vtk_to_numpy</span><span class="p">(</span><span class="n">reader</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">()</span><span class="o">.</span><span class="n">GetCellData</span><span class="p">()</span><span class="o">.</span><span class="n">GetArray</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">arrayname</span> <span class="o">==</span> <span class="s2">&quot;Pressure (Pa)&quot;</span><span class="p">:</span>
                <span class="n">pressuredata</span> <span class="o">=</span> <span class="n">vtk_to_numpy</span><span class="p">(</span><span class="n">reader</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">()</span><span class="o">.</span><span class="n">GetCellData</span><span class="p">()</span><span class="o">.</span><span class="n">GetArray</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">arrayname</span> <span class="o">==</span> <span class="s2">&quot;Colour&quot;</span><span class="p">:</span>
                <span class="n">flowpercluster</span> <span class="o">=</span> <span class="n">vtk_to_numpy</span><span class="p">(</span><span class="n">reader</span><span class="o">.</span><span class="n">GetOutput</span><span class="p">()</span><span class="o">.</span><span class="n">GetCellData</span><span class="p">()</span><span class="o">.</span><span class="n">GetArray</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
                <span class="c1"># todo change for multiple elements per cluster</span>
                <span class="n">flowpercluster</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">flowpercluster</span><span class="p">]</span>

        <span class="n">flowrateperregion</span><span class="p">,</span> <span class="n">clusterflowrate</span><span class="p">,</span> <span class="n">clusterpressure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetMeanFlowRates</span><span class="p">()</span>

        <span class="n">trianglesperregion</span> <span class="o">=</span> <span class="p">[</span><span class="nb">sum</span><span class="p">([</span><span class="mi">1</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">mapCA</span> <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">cluster</span> <span class="o">+</span> <span class="mi">2</span><span class="p">])</span> <span class="k">for</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">)]</span>
        <span class="n">surfacenodes</span><span class="p">,</span> <span class="n">clustermap</span><span class="p">,</span> <span class="n">triangleAreas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">LoadSurfaceMapping</span><span class="p">()</span>

        <span class="n">numberofclusters</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">flowpercluster</span><span class="p">)))</span>
        <span class="n">trianglespercluster</span> <span class="o">=</span> <span class="p">[</span><span class="nb">sum</span><span class="p">([</span><span class="mi">1</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">flowpercluster</span> <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">cluster</span><span class="p">])</span> <span class="k">for</span> <span class="n">cluster</span> <span class="ow">in</span>
                               <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">numberofclusters</span><span class="p">)]</span>

        <span class="n">totalAreaPerCluster</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numberofclusters</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">clusterid</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">numberofclusters</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">triangle</span><span class="p">,</span> <span class="n">area</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">clustermap</span><span class="p">,</span> <span class="n">triangleAreas</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">clusterid</span> <span class="ow">in</span> <span class="n">triangle</span><span class="p">:</span>
                    <span class="n">totalAreaPerCluster</span><span class="p">[</span><span class="n">clusterid</span><span class="p">]</span> <span class="o">+=</span> <span class="n">area</span>

        <span class="n">flowPerAreaPerCluster</span> <span class="o">=</span> <span class="p">[</span><span class="n">clusterflowrate</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="n">totalAreaPerCluster</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">numberofclusters</span><span class="p">)]</span>

        <span class="n">flowPerTriangle</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">surfacenodes</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">triandleID</span><span class="p">,</span> <span class="n">trianglemapping</span><span class="p">,</span> <span class="n">area</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">surfacenodes</span><span class="p">,</span> <span class="n">clustermap</span><span class="p">,</span> <span class="n">triangleAreas</span><span class="p">):</span>
            <span class="n">flowPerTriangle</span><span class="p">[</span><span class="n">triandleID</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">flowPerAreaPerCluster</span><span class="p">[</span><span class="n">id_number</span><span class="p">]</span> <span class="o">*</span> <span class="n">area</span> <span class="k">for</span> <span class="n">id_number</span> <span class="ow">in</span> <span class="n">trianglemapping</span><span class="p">])</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">ModellingFolder</span> <span class="o">+</span> <span class="s2">&quot;TriangleToRegion.csv&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Triangle ID,Cluster ID,Region ID,Flowrate over the triangle(mL/s),Pressure(Pa)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">flow</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">surfacenodes</span><span class="p">,</span> <span class="n">flowPerTriangle</span><span class="p">):</span>
                <span class="n">clustersPerTriangle</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">clustermap</span><span class="p">[</span><span class="n">index</span><span class="p">]))</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">,</span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s2">,</span><span class="si">%d</span><span class="s2">,</span><span class="si">%.10f</span><span class="s2">,</span><span class="si">%.10f</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">index</span><span class="p">,</span> <span class="n">clustersPerTriangle</span><span class="p">,</span> <span class="n">mapCA</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">flow</span><span class="p">,</span> <span class="n">pressuredata</span><span class="p">[</span><span class="n">index</span><span class="p">]))</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">ModellingFolder</span> <span class="o">+</span> <span class="s2">&quot;RegionFlowData.csv&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Region ID,Flow rate over the region(mL/s),number of triangles</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">):</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">,</span><span class="si">%.10f</span><span class="s2">,</span><span class="si">%d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">flowrateperregion</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">trianglesperregion</span><span class="p">[</span><span class="n">index</span><span class="p">]))</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">ModellingFolder</span> <span class="o">+</span> <span class="s2">&quot;ClusterFlowData.csv&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Cluster ID,Flow rate over the region(mL/s),number of triangles,Pressure(Pa)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">numberofclusters</span><span class="p">):</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">,</span><span class="si">%.10f</span><span class="s2">,</span><span class="si">%d</span><span class="s2">,</span><span class="si">%.10f</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">index</span><span class="p">,</span> <span class="n">clusterflowrate</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">trianglespercluster</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">clusterpressure</span><span class="p">[</span><span class="n">index</span><span class="p">]))</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="Patient.MajorArteriesToPialSurfaceNN" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Patient.MajorArteriesToPialSurfaceNN">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">MajorArteriesToPialSurfaceNN</span><span class="signature">(self, graph)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">MajorArteriesToPialSurfaceNN</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">graph</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Map surface to to nearest node, colour based on nearest vessel.</span>
<span class="sd">        Output is nearest major vessel ID.</span>
<span class="sd">        Note that the left and right halves of the brain are taken into account</span>
<span class="sd">        :param graph: The surface graph to map with the major vessel id of the nearest vessel</span>
<span class="sd">        :return: graph.MajorVesselID is updated to the mapping.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Mapping the surface to the nearest major artery.&quot;</span><span class="p">)</span>
        <span class="n">majornodes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">majornodesID</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Vessels</span><span class="p">:</span>
            <span class="c1"># interpolation of nodes in the vessel</span>
            <span class="n">nodeslengths</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Length</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">vessel</span><span class="o">.</span><span class="n">InterpolationFunctions</span><span class="p">[</span><span class="mi">0</span><span class="p">](</span><span class="n">nodeslengths</span><span class="p">)</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">vessel</span><span class="o">.</span><span class="n">InterpolationFunctions</span><span class="p">[</span><span class="mi">1</span><span class="p">](</span><span class="n">nodeslengths</span><span class="p">)</span>
            <span class="n">z</span> <span class="o">=</span> <span class="n">vessel</span><span class="o">.</span><span class="n">InterpolationFunctions</span><span class="p">[</span><span class="mi">2</span><span class="p">](</span><span class="n">nodeslengths</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">xpos</span><span class="p">,</span> <span class="n">ypos</span><span class="p">,</span> <span class="n">zpos</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
                <span class="n">majornodes</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">xpos</span><span class="p">,</span> <span class="n">ypos</span><span class="p">,</span> <span class="n">zpos</span><span class="p">))</span>
                <span class="n">majornodesID</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vessel</span><span class="o">.</span><span class="n">MajorVesselID</span><span class="p">)</span>

        <span class="c1"># for index, node in enumerate(self.Topology.Nodes):</span>
        <span class="c1">#     if (not (node.Position is None)) and node.MajorVesselID &gt;= 0:</span>
        <span class="c1">#         majornodes.append(node.Position)</span>
        <span class="c1">#         majornodesID.append(node.MajorVesselID)</span>

        <span class="c1"># left and right sides of the pial surface</span>
        <span class="n">rightpialsurface</span> <span class="o">=</span> <span class="p">[</span><span class="n">index</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">graph</span><span class="o">.</span><span class="n">PialSurface</span><span class="p">)</span> <span class="k">if</span>
                            <span class="n">graph</span><span class="o">.</span><span class="n">SideInfo</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">leftpialsurface</span> <span class="o">=</span> <span class="p">[</span><span class="n">index</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">graph</span><span class="o">.</span><span class="n">PialSurface</span><span class="p">)</span> <span class="k">if</span>
                           <span class="n">graph</span><span class="o">.</span><span class="n">SideInfo</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span>

        <span class="c1"># [cow, - , &quot;R. ACA, A2&quot;, &quot;R. MCA&quot;, &quot;L. MCA&quot;, &quot;L. ACA, A2&quot;, &quot;R. PCA, P2&quot;, &quot;L. PCA, P2&quot;]</span>
        <span class="n">leftvessels</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">]</span>
        <span class="n">rightvessels</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">]</span>

        <span class="n">leftnodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">index</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">majornodes</span><span class="p">)</span> <span class="k">if</span> <span class="n">majornodesID</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="ow">in</span> <span class="n">leftvessels</span><span class="p">]</span>
        <span class="n">rightnodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">index</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">majornodes</span><span class="p">)</span> <span class="k">if</span> <span class="n">majornodesID</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="ow">in</span> <span class="n">rightvessels</span><span class="p">]</span>

        <span class="n">sys</span><span class="o">.</span><span class="n">setrecursionlimit</span><span class="p">(</span><span class="mi">10000</span><span class="p">)</span>
        <span class="n">KDTreeleft</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">spatial</span><span class="o">.</span><span class="n">KDTree</span><span class="p">([</span><span class="n">majornodes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">leftnodes</span><span class="p">])</span>
        <span class="n">KDTreeright</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">spatial</span><span class="o">.</span><span class="n">KDTree</span><span class="p">([</span><span class="n">majornodes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">rightnodes</span><span class="p">])</span>

        <span class="n">meshcolour</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">graph</span><span class="o">.</span><span class="n">PialSurface</span><span class="p">]</span>

        <span class="n">MinDistanceR</span><span class="p">,</span> <span class="n">MinDistanceIndexR</span> <span class="o">=</span> <span class="n">KDTreeright</span><span class="o">.</span><span class="n">query</span><span class="p">([</span><span class="n">graph</span><span class="o">.</span><span class="n">PialSurface</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">rightpialsurface</span><span class="p">],</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">MinDistanceL</span><span class="p">,</span> <span class="n">MinDistanceIndexL</span> <span class="o">=</span> <span class="n">KDTreeleft</span><span class="o">.</span><span class="n">query</span><span class="p">([</span><span class="n">graph</span><span class="o">.</span><span class="n">PialSurface</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">leftpialsurface</span><span class="p">],</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">nodeindex</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rightpialsurface</span><span class="p">):</span>
            <span class="n">meshcolour</span><span class="p">[</span><span class="n">nodeindex</span><span class="p">]</span> <span class="o">=</span> <span class="n">majornodesID</span><span class="p">[</span><span class="n">rightnodes</span><span class="p">[</span><span class="n">MinDistanceIndexR</span><span class="p">[</span><span class="n">index</span><span class="p">]]]</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">nodeindex</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">leftpialsurface</span><span class="p">):</span>
            <span class="n">meshcolour</span><span class="p">[</span><span class="n">nodeindex</span><span class="p">]</span> <span class="o">=</span> <span class="n">majornodesID</span><span class="p">[</span><span class="n">leftnodes</span><span class="p">[</span><span class="n">MinDistanceIndexL</span><span class="p">[</span><span class="n">index</span><span class="p">]]]</span>

        <span class="n">graph</span><span class="o">.</span><span class="n">MajorVesselID</span> <span class="o">=</span> <span class="n">meshcolour</span>
</pre></div>

        </details>

            <div class="docstring"><p>Map surface to to nearest node, colour based on nearest vessel.
Output is nearest major vessel ID.
Note that the left and right halves of the brain are taken into account
:param graph: The surface graph to map with the major vessel id of the nearest vessel
:return: graph.MajorVesselID is updated to the mapping.</p>
</div>


                            </div>
                            <div id="Patient.MajorArteriesToPialSurfaceOutlets" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Patient.MajorArteriesToPialSurfaceOutlets">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">MajorArteriesToPialSurfaceOutlets</span><span class="signature">(self, graph)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">MajorArteriesToPialSurfaceOutlets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">graph</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Mapping the surface to the nearest major artery.&quot;</span><span class="p">)</span>
        <span class="c1"># map to nearest node</span>
        <span class="c1"># colour based on nearest outlet node.</span>
        <span class="n">majornodes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">majornodesID</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">OutletNodes</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">Position</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">))</span> <span class="ow">and</span> <span class="n">node</span><span class="o">.</span><span class="n">MajorVesselID</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">majornodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">Position</span><span class="p">)</span>
                <span class="n">majornodesID</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">MajorVesselID</span><span class="p">)</span>

        <span class="c1"># left and right sides of the pial surface</span>
        <span class="n">rightpialsurface</span> <span class="o">=</span> <span class="p">[</span><span class="n">index</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">graph</span><span class="o">.</span><span class="n">PialSurface</span><span class="p">)</span> <span class="k">if</span>
                            <span class="n">graph</span><span class="o">.</span><span class="n">SideInfo</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">leftpialsurface</span> <span class="o">=</span> <span class="p">[</span><span class="n">index</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">graph</span><span class="o">.</span><span class="n">PialSurface</span><span class="p">)</span> <span class="k">if</span>
                           <span class="n">graph</span><span class="o">.</span><span class="n">SideInfo</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span>

        <span class="c1"># [cow, - , &quot;R. ACA, A2&quot;, &quot;R. MCA&quot;, &quot;L. MCA&quot;, &quot;L. ACA, A2&quot;, &quot;R. PCA, P2&quot;, &quot;L. PCA, P2&quot;]</span>
        <span class="n">leftvessels</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">]</span>
        <span class="n">rightvessels</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">]</span>

        <span class="n">leftnodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">index</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">majornodes</span><span class="p">)</span> <span class="k">if</span> <span class="n">majornodesID</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="ow">in</span> <span class="n">leftvessels</span><span class="p">]</span>
        <span class="n">rightnodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">index</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">majornodes</span><span class="p">)</span> <span class="k">if</span> <span class="n">majornodesID</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="ow">in</span> <span class="n">rightvessels</span><span class="p">]</span>

        <span class="n">sys</span><span class="o">.</span><span class="n">setrecursionlimit</span><span class="p">(</span><span class="mi">10000</span><span class="p">)</span>
        <span class="n">KDTreeleft</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">spatial</span><span class="o">.</span><span class="n">KDTree</span><span class="p">([</span><span class="n">majornodes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">leftnodes</span><span class="p">])</span>
        <span class="n">KDTreeright</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">spatial</span><span class="o">.</span><span class="n">KDTree</span><span class="p">([</span><span class="n">majornodes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">rightnodes</span><span class="p">])</span>

        <span class="n">meshcolour</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">graph</span><span class="o">.</span><span class="n">PialSurface</span><span class="p">]</span>

        <span class="n">MinDistanceR</span><span class="p">,</span> <span class="n">MinDistanceIndexR</span> <span class="o">=</span> <span class="n">KDTreeright</span><span class="o">.</span><span class="n">query</span><span class="p">([</span><span class="n">graph</span><span class="o">.</span><span class="n">PialSurface</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">rightpialsurface</span><span class="p">],</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">MinDistanceL</span><span class="p">,</span> <span class="n">MinDistanceIndexL</span> <span class="o">=</span> <span class="n">KDTreeleft</span><span class="o">.</span><span class="n">query</span><span class="p">([</span><span class="n">graph</span><span class="o">.</span><span class="n">PialSurface</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">leftpialsurface</span><span class="p">],</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">nodeindex</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rightpialsurface</span><span class="p">):</span>
            <span class="n">meshcolour</span><span class="p">[</span><span class="n">nodeindex</span><span class="p">]</span> <span class="o">=</span> <span class="n">majornodesID</span><span class="p">[</span><span class="n">rightnodes</span><span class="p">[</span><span class="n">MinDistanceIndexR</span><span class="p">[</span><span class="n">index</span><span class="p">]]]</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">nodeindex</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">leftpialsurface</span><span class="p">):</span>
            <span class="n">meshcolour</span><span class="p">[</span><span class="n">nodeindex</span><span class="p">]</span> <span class="o">=</span> <span class="n">majornodesID</span><span class="p">[</span><span class="n">leftnodes</span><span class="p">[</span><span class="n">MinDistanceIndexL</span><span class="p">[</span><span class="n">index</span><span class="p">]]]</span>

        <span class="n">graph</span><span class="o">.</span><span class="n">MajorVesselID</span> <span class="o">=</span> <span class="n">meshcolour</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="Patient.WriteRegionMapping" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Patient.WriteRegionMapping">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">WriteRegionMapping</span><span class="signature">(self, filename=&#39;RegionMap.csv&#39;)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">WriteRegionMapping</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s2">&quot;RegionMap.csv&quot;</span><span class="p">):</span>
        <span class="n">file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">ModellingFolder</span> <span class="o">+</span> <span class="n">filename</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Writing the mapping per region to file: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">file</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;NodeID,MajorVesselID</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Nodes</span><span class="p">):</span>
                <span class="n">regionid</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">MajorVesselID</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">Number</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">regionid</span><span class="p">))</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="Patient.LoadRegionMapping" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Patient.LoadRegionMapping">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">LoadRegionMapping</span><span class="signature">(self, filename=&#39;RegionMap.csv&#39;)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">LoadRegionMapping</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s2">&quot;RegionMap.csv&quot;</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Loading region map&quot;</span><span class="p">)</span>
        <span class="n">file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">ModellingFolder</span> <span class="o">+</span> <span class="n">filename</span>
        <span class="n">regiondata</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">)]</span>
        <span class="n">regiondict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">nodedata</span> <span class="ow">in</span> <span class="n">regiondata</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="n">regiondict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">nodedata</span><span class="p">[</span><span class="mi">0</span><span class="p">])]]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">nodedata</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Nodes</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">nodedata</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span><span class="o">.</span><span class="n">MajorVesselID</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">nodedata</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Perfusion</span><span class="o">.</span><span class="n">MajorArteries</span> <span class="o">=</span> <span class="n">regiondict</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="Patient.Initiate1DSteadyStateModel" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Patient.Initiate1DSteadyStateModel">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">Initiate1DSteadyStateModel</span><span class="signature">(self)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">Initiate1DSteadyStateModel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Initiating steady state model.&quot;</span><span class="p">)</span>
        <span class="n">referencepressure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PatientData</span><span class="p">[</span><span class="s2">&quot;DiastolePressure&quot;</span><span class="p">]</span>
        <span class="c1"># outpressure = self.ModelParameters[&quot;OUT_PRESSURE&quot;]</span>
        <span class="n">outpressure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PatientData</span><span class="p">[</span><span class="s2">&quot;MeanRightAtrialPressure&quot;</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">inlet</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">InletNodes</span><span class="p">:</span>
            <span class="n">inlet</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">InletFlowRate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PatientData</span><span class="p">[</span><span class="s2">&quot;StrokeVolume&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">PatientData</span><span class="p">[</span><span class="s2">&quot;HeartRate&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">60</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e-6</span>
            <span class="n">inlet</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">InletPressure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PatientData</span><span class="p">[</span><span class="s2">&quot;SystolePressure&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">PatientData</span><span class="p">[</span>
                <span class="s2">&quot;DiastolePressure&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Nodes</span><span class="p">:</span>
            <span class="n">node</span><span class="o">.</span><span class="n">RefRadius</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">Radius</span><span class="p">)</span>
            <span class="n">node</span><span class="o">.</span><span class="n">RefPressure</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">referencepressure</span><span class="p">)</span>
            <span class="n">node</span><span class="o">.</span><span class="n">SetPressureAreaEquation</span><span class="p">()</span>
            <span class="n">node</span><span class="o">.</span><span class="n">Pressure</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">node</span><span class="o">.</span><span class="n">FlowRate</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">node</span><span class="o">.</span><span class="n">Velocity</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Set pressure at the outlets (without windkessel)</span>
        <span class="k">for</span> <span class="n">outlet</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">OutletNodes</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">outlet</span><span class="o">.</span><span class="n">R1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">outlet</span><span class="o">.</span><span class="n">OutPressure</span> <span class="o">=</span> <span class="n">outlet</span><span class="o">.</span><span class="n">InputPressure</span>  <span class="c1"># set pressure here per outlet</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">outlet</span><span class="o">.</span><span class="n">OutPressure</span> <span class="o">=</span> <span class="n">outpressure</span>
            <span class="n">outlet</span><span class="o">.</span><span class="n">OutletFlowRate</span> <span class="o">=</span> <span class="mi">0</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="Patient.Solve1DSteadyState" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Patient.Solve1DSteadyState">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">Solve1DSteadyState</span><span class="signature">(
    self,
    clotactive=False,
    PressureInlets=False,
    coarseCollaterals=False,
    FlowRateOutlets=False,
    frictionconstant=22
)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">Solve1DSteadyState</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">clotactive</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">PressureInlets</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">coarseCollaterals</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                           <span class="n">FlowRateOutlets</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">frictionconstant</span><span class="o">=</span><span class="mi">22</span><span class="p">):</span>
        <span class="n">visc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ModelParameters</span><span class="p">[</span><span class="s2">&quot;BLOOD_VISC&quot;</span><span class="p">]</span>

        <span class="n">matrix</span><span class="p">,</span> <span class="n">inputvector</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">edges</span><span class="p">,</span> <span class="n">mapping</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Get1DsteadyNetwork</span><span class="p">(</span><span class="n">visc</span><span class="p">,</span> <span class="n">clotactive</span><span class="p">,</span> <span class="n">PressureInlets</span><span class="p">,</span>
                                                                                      <span class="n">coarseCollaterals</span><span class="p">,</span>
                                                                                      <span class="n">FlowRateOutlets</span><span class="p">,</span> <span class="n">frictionconstant</span><span class="p">)</span>
        <span class="n">oldnodes1</span><span class="p">,</span> <span class="n">oldnodes2</span> <span class="o">=</span> <span class="n">mapping</span>

        <span class="c1"># solve system</span>
        <span class="c1"># solution = scipy.linalg.solve(matrix.todense(), inputvector)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Solving system of size: </span><span class="si">{</span><span class="n">matrix</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">solve</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">factorized</span><span class="p">(</span><span class="n">matrix</span><span class="p">)</span>
        <span class="n">solution</span> <span class="o">=</span> <span class="n">solve</span><span class="p">(</span><span class="n">inputvector</span><span class="p">)</span>
        <span class="c1"># solution = spsolve(matrix, inputvector) # without pre-conditioning</span>
        <span class="c1"># print(f&quot;Condition number: {numpy.linalg.cond(matrix)}&quot;)</span>
        <span class="c1"># print(info)</span>
        <span class="c1"># set pressure to all nodes</span>
        <span class="c1"># clotnodes = [node for clot in self.Topology.Clots for node in clot[0]]</span>
        <span class="c1">#</span>
        <span class="c1"># for node in clotnodes:  # internal clot nodes are not part of the solution from the solver.</span>
        <span class="c1">#     node.Pressure = 0</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">nodes</span><span class="p">)):</span>
            <span class="n">nodes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">Pressure</span> <span class="o">=</span> <span class="n">solution</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">bif</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">BifurcationNodes</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">bif</span><span class="o">.</span><span class="n">Connections</span><span class="p">:</span>
                <span class="n">node</span><span class="o">.</span><span class="n">Pressure</span> <span class="o">=</span> <span class="n">bif</span><span class="o">.</span><span class="n">Pressure</span>

        <span class="c1"># update edges to include the dublicate ends again.</span>
        <span class="k">for</span> <span class="n">replace</span> <span class="ow">in</span> <span class="n">oldnodes1</span><span class="p">:</span>
            <span class="n">edges</span><span class="p">[</span><span class="n">replace</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">replace</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">replace</span> <span class="ow">in</span> <span class="n">oldnodes2</span><span class="p">:</span>
            <span class="n">edges</span><span class="p">[</span><span class="n">replace</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">replace</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># note that the collateral vessels alter the flow rates at the outlets.</span>
        <span class="c1"># the outlet flow rates therefore have to be summed over all connections</span>
        <span class="c1"># (should be zero for any bifurcation and internal vessel node)</span>
        <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">edges</span><span class="p">:</span>
            <span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">AccumulatedFlowRate</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">AccumulatedFlowRate</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">edges</span><span class="p">:</span>
            <span class="n">dp</span> <span class="o">=</span> <span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Pressure</span> <span class="o">-</span> <span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">Pressure</span>
            <span class="n">flowrate</span> <span class="o">=</span> <span class="n">dp</span> <span class="o">*</span> <span class="n">edge</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e6</span>
            <span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">FlowRate</span> <span class="o">=</span> <span class="n">flowrate</span>
            <span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">FlowRate</span> <span class="o">=</span> <span class="n">flowrate</span>
            <span class="n">radius</span> <span class="o">=</span> <span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Radius</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">Radius</span>
            <span class="n">velocity</span> <span class="o">=</span> <span class="n">flowrate</span> <span class="o">/</span> <span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">radius</span> <span class="o">*</span> <span class="n">radius</span><span class="p">)</span>
            <span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Velocity</span> <span class="o">=</span> <span class="n">velocity</span>
            <span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">Velocity</span> <span class="o">=</span> <span class="n">velocity</span>
            <span class="c1"># accumulated flow</span>
            <span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">AccumulatedFlowRate</span> <span class="o">-=</span> <span class="n">flowrate</span>
            <span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">AccumulatedFlowRate</span> <span class="o">+=</span> <span class="n">flowrate</span>

        <span class="k">if</span> <span class="n">clotactive</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">clot</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Clots</span><span class="p">:</span>
                <span class="n">clotnodes</span> <span class="o">=</span> <span class="n">clot</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">porocity</span> <span class="o">=</span> <span class="n">clot</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">clotnode</span> <span class="ow">in</span> <span class="n">clotnodes</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">porocity</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">clotnode</span><span class="o">.</span><span class="n">Velocity</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># effective area</span>
                        <span class="n">area</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">clotnode</span><span class="o">.</span><span class="n">RefRadius</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">pi</span>
                        <span class="n">clotnode</span><span class="o">.</span><span class="n">Velocity</span> <span class="o">=</span> <span class="n">clotnode</span><span class="o">.</span><span class="n">FlowRate</span> <span class="o">/</span> <span class="p">(</span><span class="n">area</span><span class="o">*</span><span class="n">porocity</span><span class="p">)</span>

            <span class="c1"># for edge in edges:</span>
            <span class="c1">#     if (edge[0] in clotnodes) and (edge[1] in clotnodes):</span>
            <span class="c1">#         if porocity == 0:</span>
            <span class="c1">#             edge[0].Velocity = 0</span>
            <span class="c1">#             edge[1].Velocity = 0</span>
            <span class="c1">#         else:</span>
            <span class="c1">#             edge[0].Velocity = edge[0].FlowRate/porocity</span>
            <span class="c1">#             edge[1].Velocity = edge[0].FlowRate/porocity</span>

        <span class="c1"># define flow rate at the outlet as the accumulation of flow (source term)</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">OutletNodes</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">R1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">node</span><span class="o">.</span><span class="n">FlowRate</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">WKNode</span><span class="o">.</span><span class="n">AccumulatedFlowRate</span>

        <span class="c1"># calculate new radius</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Nodes</span><span class="p">:</span>
            <span class="n">node</span><span class="o">.</span><span class="n">UpdateRadius</span><span class="p">()</span>
            <span class="c1"># vessel.CalculateMeanRadius()</span>

        <span class="n">solution</span> <span class="o">=</span> <span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">Pressure</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Nodes</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">solution</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="Patient.Solve1DSteadyStateNonLinear" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Patient.Solve1DSteadyStateNonLinear">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">Solve1DSteadyStateNonLinear</span><span class="signature">(self)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">Solve1DSteadyStateNonLinear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">visc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ModelParameters</span><span class="p">[</span><span class="s2">&quot;BLOOD_VISC&quot;</span><span class="p">]</span>

        <span class="n">solution</span><span class="p">,</span> <span class="n">nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">nonlinearmodel</span><span class="p">(</span><span class="n">visc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ModelParameters</span><span class="p">[</span><span class="s2">&quot;Density&quot;</span><span class="p">])</span>

        <span class="c1"># solve system</span>
        <span class="c1"># solution = scipy.linalg.solve(matrix.todense(), inputvector)</span>
        <span class="c1"># solved = numpy.allclose(matrix.dot(solution), inputvector)</span>

        <span class="c1"># set pressure to all nodes</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">nodes</span><span class="p">)):</span>
            <span class="n">nodes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">Pressure</span> <span class="o">=</span> <span class="n">solution</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="c1"># for bif in self.Topology.BifurcationNodes:</span>
        <span class="c1">#     for node in bif.Connections:</span>
        <span class="c1">#         node.Pressure = bif.Pressure</span>

        <span class="c1"># calculate new radius</span>
        <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Vessels</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span><span class="p">:</span>
                <span class="n">node</span><span class="o">.</span><span class="n">UpdateRadius</span><span class="p">()</span>
            <span class="n">vessel</span><span class="o">.</span><span class="n">CalculateMeanRadius</span><span class="p">()</span>

        <span class="n">solution</span> <span class="o">=</span> <span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">Pressure</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Nodes</span><span class="p">]</span>
        <span class="c1"># self.Topology.nonlinearmodel(visc, self.ModelParameters[&quot;Density&quot;])</span>
        <span class="k">return</span> <span class="n">solution</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="Patient.UpdateOutletResistanceToPialSurface" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Patient.UpdateOutletResistanceToPialSurface">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">UpdateOutletResistanceToPialSurface</span><span class="signature">(self, PialSurfacePressure=9000)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">UpdateOutletResistanceToPialSurface</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">PialSurfacePressure</span><span class="o">=</span><span class="mi">9000</span><span class="p">):</span>
        <span class="c1"># todo update  to include C and R2 for pulsatile simulations</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">cp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Perfusion</span><span class="o">.</span><span class="n">CouplingPoints</span><span class="p">):</span>
            <span class="n">newresistancetotal</span> <span class="o">=</span> <span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">Node</span><span class="o">.</span><span class="n">Pressure</span> <span class="o">-</span> <span class="n">PialSurfacePressure</span><span class="p">[</span><span class="n">index</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">Node</span><span class="o">.</span><span class="n">FlowRate</span> <span class="o">*</span> <span class="mf">1e-6</span><span class="p">)</span>
            <span class="n">cp</span><span class="o">.</span><span class="n">Node</span><span class="o">.</span><span class="n">R1</span> <span class="o">=</span> <span class="n">newresistancetotal</span>  <span class="c1"># - cp.Node.R1</span>
            <span class="n">cp</span><span class="o">.</span><span class="n">Node</span><span class="o">.</span><span class="n">R2</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Resistance: </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">newresistancetotal</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">newresistancetotal</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># for index, cp in enumerate(self.Perfusion.CouplingPoints):</span>
                <span class="c1">#     print(&quot;1D model: %f - Perfusion model: %f\n&quot; % (cp.Node.Pressure, PialSurfacePressure[index]))</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Error: Negative resistance. Pial surface pressure is higher than the arterial pressure.&quot;</span><span class="p">)</span>
            <span class="c1"># if cp.Node.R2 &lt; 0:</span>
            <span class="c1">#     cp.Node.R2 = 0</span>
            <span class="c1"># cp.Node.R1 = newresistancetotal - cp.Node.R2</span>
            <span class="c1"># print(&quot;Error: R2&lt;0. Setting R2 to 0.1e9 and updating R1.&quot;)</span>
            <span class="n">cp</span><span class="o">.</span><span class="n">Node</span><span class="o">.</span><span class="n">OutPressure</span> <span class="o">=</span> <span class="n">PialSurfacePressure</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>  <span class="c1"># pressure now fixed to this value at this node</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="Patient.UpdatePressureCouplingPoints" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Patient.UpdatePressureCouplingPoints">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">UpdatePressureCouplingPoints</span><span class="signature">(self, pressures)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">UpdatePressureCouplingPoints</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pressures</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the pressure at the coupling points to the perfusion model.</span>
<span class="sd">        :param pressures: (iterable or number) Pressure in pa to be assigned at the coupling point.</span>
<span class="sd">        Order of the pressures given should be in the same order as the coupling points.</span>
<span class="sd">        Coupling point index is equal to the cluster id.</span>
<span class="sd">        :return: Nothing</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">cp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Perfusion</span><span class="o">.</span><span class="n">CouplingPoints</span><span class="p">):</span>
                <span class="c1"># cp.Node.R1 = None  # remove wk elements</span>
                <span class="n">cp</span><span class="o">.</span><span class="n">Node</span><span class="o">.</span><span class="n">OutPressure</span> <span class="o">=</span> <span class="n">pressures</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>  <span class="c1"># pressure now fixed to this value at this node</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">cp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Perfusion</span><span class="o">.</span><span class="n">CouplingPoints</span><span class="p">):</span>
                <span class="c1"># cp.Node.R1 = None  # remove wk elements</span>
                <span class="n">cp</span><span class="o">.</span><span class="n">Node</span><span class="o">.</span><span class="n">OutPressure</span> <span class="o">=</span> <span class="n">pressures</span>  <span class="c1"># pressure now fixed to this value at this node</span>
</pre></div>

        </details>

            <div class="docstring"><p>Update the pressure at the coupling points to the perfusion model.
:param pressures: (iterable or number) Pressure in pa to be assigned at the coupling point.
Order of the pressures given should be in the same order as the coupling points.
Coupling point index is equal to the cluster id.
:return: Nothing</p>
</div>


                            </div>
                            <div id="Patient.UpdateFlowRateCouplingPoints" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Patient.UpdateFlowRateCouplingPoints">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">UpdateFlowRateCouplingPoints</span><span class="signature">(self, flowrates)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">UpdateFlowRateCouplingPoints</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flowrates</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the flowrate at the coupling points to the perfusion model.</span>
<span class="sd">        :param flowrates: (iterable or number) Flow rate in mL/s to be assigned at the coupling point.</span>
<span class="sd">        Order of the flowrate given should be in the same order as the coupling points.</span>
<span class="sd">        Coupling point index is equal to the cluster id.</span>
<span class="sd">        :return: Nothing</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">cp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Perfusion</span><span class="o">.</span><span class="n">CouplingPoints</span><span class="p">):</span>
                <span class="c1"># cp.Node.R1 = None  # remove wk elements</span>
                <span class="n">cp</span><span class="o">.</span><span class="n">Node</span><span class="o">.</span><span class="n">OutletFlowRate</span> <span class="o">=</span> <span class="n">flowrates</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>  <span class="c1"># flowrate now fixed to this value at this node</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">cp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Perfusion</span><span class="o">.</span><span class="n">CouplingPoints</span><span class="p">):</span>
                <span class="c1"># cp.Node.R1 = None  # remove wk elements</span>
                <span class="n">cp</span><span class="o">.</span><span class="n">Node</span><span class="o">.</span><span class="n">OutletFlowRate</span> <span class="o">=</span> <span class="n">flowrates</span>  <span class="c1"># flowrate now fixed to this value at this node</span>
</pre></div>

        </details>

            <div class="docstring"><p>Update the flowrate at the coupling points to the perfusion model.
:param flowrates: (iterable or number) Flow rate in mL/s to be assigned at the coupling point.
Order of the flowrate given should be in the same order as the coupling points.
Coupling point index is equal to the cluster id.
:return: Nothing</p>
</div>


                            </div>
                            <div id="Patient.Run1DSteadyStateModel" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Patient.Run1DSteadyStateModel">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">Run1DSteadyStateModel</span><span class="signature">(
    self,
    model=&#39;Linear&#39;,
    tol=1e-10,
    clotactive=False,
    PressureInlets=False,
    coarseCollaterals=False,
    FlowRateOutlets=False,
    frictionconstant=22,
    scale_resistance=True
)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">Run1DSteadyStateModel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="s2">&quot;Linear&quot;</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-10</span><span class="p">,</span> <span class="n">clotactive</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">PressureInlets</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                              <span class="n">coarseCollaterals</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">FlowRateOutlets</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">frictionconstant</span><span class="o">=</span><span class="mi">22</span><span class="p">,</span>
                              <span class="n">scale_resistance</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">clotactive</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Solving steady state: stroke scenario.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Solving steady state: healthy scenario.&quot;</span><span class="p">)</span>
        <span class="c1"># initialise all values</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="n">solutionold</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Solve1DSteadyState</span><span class="p">(</span><span class="n">clotactive</span><span class="p">,</span> <span class="n">PressureInlets</span><span class="p">,</span> <span class="n">coarseCollaterals</span><span class="p">,</span>
                                              <span class="n">FlowRateOutlets</span><span class="p">,</span> <span class="n">frictionconstant</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">model</span> <span class="o">==</span> <span class="s2">&quot;NonLinear&quot;</span><span class="p">:</span>
            <span class="n">solutionold</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Solve1DSteadyStateNonLinear</span><span class="p">()</span>
        <span class="c1"># iterate system again</span>
        <span class="nb">iter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">model</span> <span class="o">==</span> <span class="s2">&quot;Linear&quot;</span><span class="p">:</span>
                <span class="n">solutionnew</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Solve1DSteadyState</span><span class="p">(</span><span class="n">clotactive</span><span class="p">,</span> <span class="n">PressureInlets</span><span class="p">,</span> <span class="n">coarseCollaterals</span><span class="p">,</span>
                                                      <span class="n">FlowRateOutlets</span><span class="p">,</span> <span class="n">frictionconstant</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">model</span> <span class="o">==</span> <span class="s2">&quot;NonLinear&quot;</span><span class="p">:</span>
                <span class="n">solutionnew</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Solve1DSteadyStateNonLinear</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Please specify if model is Linear or NonLinear.&quot;</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="c1"># scale resistances to get both proper flow and pressure at the inlet</span>
            <span class="k">if</span> <span class="n">scale_resistance</span><span class="p">:</span>
                <span class="n">pressure_diff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">InletNodes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Pressure</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">InletNodes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">InletPressure</span>
                <span class="n">flow_rate_diff</span> <span class="o">=</span> <span class="mf">1e-6</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">InletNodes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">FlowRate</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">InletNodes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">InletFlowRate</span>
                <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">pressure_diff</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1e-6</span> <span class="ow">or</span> <span class="nb">abs</span><span class="p">(</span><span class="n">flow_rate_diff</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1e-6</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Detected a difference in inlet boundary conditions, scaling outlet resistance.&quot;</span><span class="p">)</span>
                    <span class="c1"># print(self.Topology.InletNodes[0][0].Pressure)</span>
                    <span class="c1"># print(self.Topology.InletNodes[0][0].InletPressure)</span>
                    <span class="c1"># print(1e-6 * self.Topology.InletNodes[0][0].FlowRate)</span>
                    <span class="c1"># print(self.Topology.InletNodes[0][0].InletFlowRate)</span>

                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Pressure ratio:</span><span class="si">{</span><span class="n">pressure_diff</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Flow Rate ratio:</span><span class="si">{</span><span class="n">flow_rate_diff</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">OutletNodes</span><span class="p">:</span>
                        <span class="c1"># print(node.R2)</span>
                        <span class="c1"># total resistance of the outlet needs to change, but R1 is constant</span>
                        <span class="c1"># scale R2 to compensate, (r1+r2)*p = r1+r2*F</span>
                        <span class="c1"># assumption is also that either pressure or flow rate diff is equal to one already</span>
                        <span class="n">fraction</span> <span class="o">=</span> <span class="p">((</span><span class="n">node</span><span class="o">.</span><span class="n">R1</span><span class="o">+</span><span class="n">node</span><span class="o">.</span><span class="n">R2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">pressure_diff</span><span class="o">*</span><span class="mi">1</span><span class="o">/</span><span class="n">flow_rate_diff</span><span class="p">)</span><span class="o">-</span><span class="n">node</span><span class="o">.</span><span class="n">R1</span><span class="p">)</span><span class="o">/</span><span class="n">node</span><span class="o">.</span><span class="n">R2</span>
                        <span class="n">node</span><span class="o">.</span><span class="n">R2</span> <span class="o">=</span> <span class="n">fraction</span><span class="o">*</span><span class="n">node</span><span class="o">.</span><span class="n">R2</span>
                    <span class="k">continue</span>
            <span class="n">difference</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span>
                <span class="p">[</span><span class="n">solutionold</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">solution</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">solution</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">solutionnew</span><span class="p">)])</span> <span class="o">/</span> <span class="n">numpy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">solutionnew</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Convergence criteria </span><span class="si">%0.12g</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">difference</span><span class="p">)</span>
            <span class="n">solutionold</span> <span class="o">=</span> <span class="n">solutionnew</span>
            <span class="nb">iter</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="k">if</span> <span class="n">difference</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Steady state convergence in </span><span class="si">%d</span><span class="s2"> iterations.&quot;</span> <span class="o">%</span> <span class="nb">iter</span><span class="p">)</span>
                <span class="n">time_elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Time elapsed </span><span class="si">%f</span><span class="s1"> seconds&#39;</span> <span class="o">%</span> <span class="n">time_elapsed</span><span class="p">)</span>
                <span class="k">break</span>

        <span class="c1"># calculate flowrate</span>
        <span class="c1"># visc = self.ModelParameters[&quot;BLOOD_VISC&quot;]</span>
        <span class="c1"># for vessel in self.Topology.Vessels:</span>
        <span class="c1">#     for i in range(1, len(vessel.Nodes)):</span>
        <span class="c1">#         dp = vessel.Nodes[i - 1].Pressure - vessel.Nodes[i].Pressure</span>
        <span class="c1">#         flowrate = dp * self.Topology.SegmentConductance(vessel.Nodes[i - 1], vessel.Nodes[i],</span>
        <span class="c1">#                                                          visc) * 1e6</span>
        <span class="c1">#         vessel.Nodes[i - 1].FlowRate = flowrate</span>
        <span class="c1">#         vessel.Nodes[i - 1].Velocity = flowrate / (</span>
        <span class="c1">#                 scipy.pi * vessel.Nodes[i - 1].Radius * vessel.Nodes[i - 1].Radius)</span>

        <span class="c1"># # vessel ends</span>
        <span class="c1"># for vessel in self.Topology.Vessels:</span>
        <span class="c1">#     dp = vessel.Nodes[-2].Pressure - vessel.Nodes[-1].Pressure</span>
        <span class="c1">#     flowrate = dp * self.Topology.SegmentConductance(vessel.Nodes[-1], vessel.Nodes[-2],</span>
        <span class="c1">#                                                      visc) * 1e6</span>
        <span class="c1">#     vessel.Nodes[- 1].FlowRate = flowrate</span>
        <span class="c1">#     vessel.Nodes[- 1].Velocity = flowrate / (</span>
        <span class="c1">#             scipy.pi * vessel.Nodes[- 1].Radius * vessel.Nodes[- 1].Radius)</span>
        <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Vessels</span><span class="p">:</span>
            <span class="n">vessel</span><span class="o">.</span><span class="n">CalculateMeanRadius</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">bif</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">BifurcationNodes</span><span class="p">:</span>
            <span class="n">bif</span><span class="o">.</span><span class="n">Pressure</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">node</span><span class="o">.</span><span class="n">Pressure</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">bif</span><span class="o">.</span><span class="n">Connections</span><span class="p">)])</span>
            <span class="n">bif</span><span class="o">.</span><span class="n">FlowRate</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># numpy.mean([node.FlowRate for node in list(bif.Connections)])</span>
            <span class="n">bif</span><span class="o">.</span><span class="n">Velocity</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># numpy.mean([node.Velocity for node in list(bif.Connections)])</span>

        <span class="k">if</span> <span class="n">coarseCollaterals</span><span class="p">:</span>
            <span class="n">totalflowrate</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Collaterals</span><span class="p">:</span>
                <span class="n">dp</span> <span class="o">=</span> <span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Pressure</span> <span class="o">-</span> <span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">Pressure</span>
                <span class="n">totalflowrate</span> <span class="o">+=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">dp</span> <span class="o">*</span> <span class="n">edge</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e6</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Total Collateral flow: </span><span class="si">{</span><span class="n">totalflowrate</span><span class="si">}</span><span class="s2"> mL/s&quot;</span><span class="p">)</span>
        <span class="c1"># for node in self.Topology.OutletNodes:</span>
        <span class="c1">#     print(node.WKNode.AccumulatedFlowRate)</span>
        <span class="c1"># totaloutflow = sum([node.WKNode.AccumulatedFlowRate for node in self.Topology.OutletNodes])</span>
        <span class="c1"># print(f&quot;Total outflow: {totaloutflow}&quot;)</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="Patient.Results1DSteadyStateModel" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Patient.Results1DSteadyStateModel">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">Results1DSteadyStateModel</span><span class="signature">(self)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">Results1DSteadyStateModel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># export to results</span>
        <span class="c1"># we get mean results per node by definition.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">MeanPressurePerNode</span> <span class="o">=</span> <span class="p">[[</span><span class="n">node</span><span class="o">.</span><span class="n">Pressure</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Nodes</span><span class="p">]]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">MeanVelocityPerNode</span> <span class="o">=</span> <span class="p">[[</span><span class="n">node</span><span class="o">.</span><span class="n">Velocity</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Nodes</span><span class="p">]]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">MeanVolumeFlowRatePerNode</span> <span class="o">=</span> <span class="p">[[</span><span class="n">node</span><span class="o">.</span><span class="n">FlowRate</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Nodes</span><span class="p">]]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">MeanRadiusPerNode</span> <span class="o">=</span> <span class="p">[[</span><span class="n">node</span><span class="o">.</span><span class="n">Radius</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Nodes</span><span class="p">]]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">PulsatilityIndexPressure</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Nodes</span><span class="p">]]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">PulsatilityIndexVelocity</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Nodes</span><span class="p">]]</span>

        <span class="n">vesselnames</span> <span class="o">=</span> <span class="p">[</span><span class="n">vessel</span><span class="o">.</span><span class="n">Name</span> <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Vessels</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">MeanResults</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">vesselnodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">vessel</span><span class="o">.</span><span class="n">Nodes</span> <span class="k">for</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Vessels</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">vessel</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">vesselnodes</span><span class="p">):</span>
            <span class="n">meanvalues</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">CalculateMeanVessel</span><span class="p">(</span><span class="n">vessel</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Results</span><span class="o">.</span><span class="n">MeanResults</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">vesselnames</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">meanvalues</span><span class="p">))</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="Patient.Export1DSteadyClusterFlowRate" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Patient.Export1DSteadyClusterFlowRate">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">Export1DSteadyClusterFlowRate</span><span class="signature">(self, file=&#39;ClusterFlowData.csv&#39;)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">Export1DSteadyClusterFlowRate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="s2">&quot;ClusterFlowData.csv&quot;</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">ModellingFolder</span> <span class="o">+</span> <span class="n">file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Cluster ID,Flow rate over the region(mL/s),number of triangles,Pressure(Pa)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">cp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Perfusion</span><span class="o">.</span><span class="n">CouplingPoints</span><span class="p">):</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">,</span><span class="si">%.10f</span><span class="s2">,</span><span class="si">%d</span><span class="s2">,</span><span class="si">%.10f</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">cp</span><span class="o">.</span><span class="n">Node</span><span class="o">.</span><span class="n">FlowRate</span><span class="p">,</span> <span class="n">cp</span><span class="o">.</span><span class="n">NumberOfTriangles</span><span class="p">,</span> <span class="n">cp</span><span class="o">.</span><span class="n">Node</span><span class="o">.</span><span class="n">Pressure</span><span class="p">))</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="Patient.ExportClotBFValues" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Patient.ExportClotBFValues">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">ExportClotBFValues</span><span class="signature">(self, file=&#39;BFClotValues.csv&#39;)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">ExportClotBFValues</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="s2">&quot;BFClotValues.csv&quot;</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Folders</span><span class="o">.</span><span class="n">ModellingFolder</span> <span class="o">+</span> <span class="n">file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Clot index,Flow rate(mL/s),Pressure drop(Pa),Proximal pressure (Pa),Distal pressure (Pa),Pressure ratio</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">clot</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Topology</span><span class="o">.</span><span class="n">Clots</span><span class="p">):</span>
                <span class="n">node1</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">clot</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="n">item</span><span class="o">.</span><span class="n">Number</span><span class="p">)</span>
                <span class="n">node2</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">clot</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="n">item</span><span class="o">.</span><span class="n">Number</span><span class="p">)</span>
                <span class="n">proximal_pressure</span> <span class="o">=</span> <span class="n">node1</span><span class="o">.</span><span class="n">Pressure</span>
                <span class="n">distal_pressure</span> <span class="o">=</span> <span class="n">node2</span><span class="o">.</span><span class="n">Pressure</span>
                <span class="n">pressure_drop</span> <span class="o">=</span> <span class="n">proximal_pressure</span> <span class="o">-</span> <span class="n">distal_pressure</span>
                <span class="n">pressure_ratio</span> <span class="o">=</span> <span class="n">distal_pressure</span><span class="o">/</span><span class="n">proximal_pressure</span>
                <span class="n">flow_rate</span> <span class="o">=</span> <span class="n">node1</span><span class="o">.</span><span class="n">FlowRate</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">,</span><span class="si">%.10f</span><span class="s2">,</span><span class="si">%.10f</span><span class="s2">,</span><span class="si">%.10f</span><span class="s2">,</span><span class="si">%.10f</span><span class="s2">,</span><span class="si">%.10f</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">flow_rate</span><span class="p">,</span> <span class="n">pressure_drop</span><span class="p">,</span> <span class="n">proximal_pressure</span><span class="p">,</span>
                                                                <span class="n">distal_pressure</span><span class="p">,</span> <span class="n">pressure_ratio</span><span class="p">))</span>
</pre></div>

        </details>

    

                            </div>
                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "../search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `../${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.type) {
                    case "function":
                        heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span><span class="signature">(${doc.parameters.join(", ")})</span>`;
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.type}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>